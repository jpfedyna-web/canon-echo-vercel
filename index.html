<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canon Echo | Workforce Health Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/PptxGenJS@3.12.0/dist/pptxgen.bundle.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: #0a0f1a; color: #e2e8f0; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes pulse-subtle { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .animate-pulse-subtle { animation: pulse-subtle 2s ease-in-out infinite; }
        .status-pending { color: #f59e0b; background: rgba(245, 158, 11, 0.15); }
        .status-active, .status-complete, .status-completed { color: #22c55e; background: rgba(34, 197, 94, 0.15); }
        .status-analyzing, .status-in_progress { color: #3b82f6; background: rgba(59, 130, 246, 0.15); }
        .status-rejected { color: #ef4444; background: rgba(239, 68, 68, 0.15); }
        .status-deferred { color: #8b5cf6; background: rgba(139, 92, 246, 0.15); }
        .status-approved { color: #10b981; background: rgba(16, 185, 129, 0.15); }
        .drop-zone { border: 2px dashed #475569; transition: all 0.2s ease; }
        .drop-zone:hover, .drop-zone.drag-over { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .checklist-item { transition: all 0.2s ease; }
        .checklist-item.completed { background: rgba(34, 197, 94, 0.1); border-color: rgba(34, 197, 94, 0.3); }
        .phase-card { border-left: 4px solid transparent; }
        .phase-card.phase-1 { border-left-color: #3b82f6; }
        .phase-card.phase-2 { border-left-color: #8b5cf6; }
        .phase-card.phase-3 { border-left-color: #22c55e; }
        .phase-card.phase-4 { border-left-color: #f59e0b; }
        .phase-card.phase-5 { border-left-color: #ec4899; }
        .portal-gradient { background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); }
        .insight-card { backdrop-filter: blur(10px); background: rgba(255,255,255,0.05); }
        .validation-error { border-color: #ef4444 !important; }
        .validation-warning { border-color: #f59e0b !important; }
        .validation-success { border-color: #22c55e !important; }
    </style>
    <script>tailwind.config = { theme: { extend: { colors: { slate: { 850: '#162032', 950: '#0a0f1a' } } } } }</script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;
        
        // ═══════════════════════════════════════════════════════════════════════════
        // ERROR BOUNDARY - Catches rendering errors and shows helpful message
        // ═══════════════════════════════════════════════════════════════════════════
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }
            
            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }
            
            componentDidCatch(error, errorInfo) {
                console.error('Component Error:', error, errorInfo);
                this.setState({ errorInfo });
            }
            
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="p-8 text-center">
                            <div className="bg-red-500/20 border border-red-500/50 rounded-xl p-8 max-w-lg mx-auto">
                                <div className="text-4xl mb-4">⚠️</div>
                                <h3 className="text-xl font-bold text-red-400 mb-3">Something went wrong</h3>
                                <p className="text-slate-300 mb-4">This component encountered an error.</p>
                                <details className="text-left bg-slate-900 rounded-lg p-4 text-xs overflow-auto max-h-40">
                                    <summary className="cursor-pointer text-slate-400 mb-2">Error Details</summary>
                                    <pre className="text-red-300 whitespace-pre-wrap">{this.state.error?.toString()}</pre>
                                </details>
                                <button 
                                    onClick={() => { this.setState({ hasError: false, error: null }); window.location.reload(); }}
                                    className="mt-4 px-4 py-2 bg-red-600 hover:bg-red-500 rounded-lg text-white font-medium">
                                    Reload Page
                                </button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // SUPABASE CONFIGURATION
        // ═══════════════════════════════════════════════════════════════════════════
        const SUPABASE_URL = 'https://ukpniztesqiwkhazcddp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVrcG5penRlc3Fpd2toYXpjZGRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4NTA2MDAsImV4cCI6MjA4NDQyNjYwMH0.OpV9KSoVBKwO1bQYqnGiBWHilyTiTPAxxngPW30CVu0';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ═══════════════════════════════════════════════════════════════════════════
        // ICONS
        // ═══════════════════════════════════════════════════════════════════════════
        const Icons = {
            clients: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>,
            uploads: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>,
            analyses: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>,
            plus: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
            refresh: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
            close: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
            check: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
            trash: <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
            eye: <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>,
            dashboard: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" /></svg>,
            file: <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
            sparkles: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>,
            loader: <svg className="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" /></svg>,
            download: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
            search: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
            pdf: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>,
            ppt: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 13v-1m4 1v-3m4 3V8M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" /></svg>,
            playbook: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>,
            implementations: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2" /></svg>,
            portal: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>,
            decisions: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            clock: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            shield: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>,
            star: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>,
            trending: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>,
            alert: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>,
            dollar: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            edit: <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>,
            command: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>,
            users: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
            pipeline: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" /></svg>,
            heartbeat: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>,
            bell: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>,
            rfp: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>,
            compare: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>,
            revenue: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            target: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>,
        };
        
        // ═══════════════════════════════════════════════════════════════════════════
        // SHARED COMPONENTS
        // ═══════════════════════════════════════════════════════════════════════════
        const StatusBadge = ({ status }) => <span className={`px-2 py-1 rounded-full text-xs font-medium status-${status?.toLowerCase() || 'pending'}`}>{status || 'pending'}</span>;
        const StatCard = ({ title, value, icon, color }) => (<div className="bg-slate-850 border border-slate-700/50 rounded-xl p-5"><div className="flex items-center justify-between mb-3"><span className="text-slate-400 text-sm font-medium">{title}</span><div className={`p-2 rounded-lg ${color}`}>{icon}</div></div><div className="text-3xl font-bold text-white">{value}</div></div>);
        const Modal = ({ isOpen, onClose, title, children, wide }) => { if (!isOpen) return null; return (<div className="fixed inset-0 z-50 flex items-center justify-center"><div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div><div className={`relative bg-slate-850 border border-slate-700 rounded-2xl w-full ${wide ? 'max-w-5xl' : 'max-w-lg'} mx-4 max-h-[90vh] overflow-hidden flex flex-col animate-fade-in`}><div className="flex items-center justify-between p-5 border-b border-slate-700"><h3 className="text-lg font-semibold text-white">{title}</h3><button onClick={onClose} className="p-1 hover:bg-slate-700 rounded-lg">{Icons.close}</button></div><div className="p-5 overflow-y-auto">{children}</div></div></div>); };
        
        const getWellnessFundTier = (employeeCount) => {
            const count = parseInt(employeeCount) || 0;
            if (count <= 50) return { min: 0, max: 5000, midpoint: 2500, display: '$0 - $5,000', suggested: '$2,500' };
            if (count <= 150) return { min: 5000, max: 15000, midpoint: 10000, display: '$5,000 - $15,000', suggested: '$10,000' };
            if (count <= 300) return { min: 15000, max: 20000, midpoint: 17500, display: '$15,000 - $20,000', suggested: '$17,500' };
            if (count <= 500) return { min: 20000, max: 30000, midpoint: 25000, display: '$20,000 - $30,000', suggested: '$25,000' };
            return { min: 30000, max: null, midpoint: 50000, display: '$30,000+', suggested: '$50,000+' };
        };

        // ═══════════════════════════════════════════════════════════════════════════
        // PLAYBOOK PHASES DEFINITION
        // ═══════════════════════════════════════════════════════════════════════════
        const PLAYBOOK_PHASES = [
            {
                id: 'discovery', phase: 1,
                title: 'Discovery & Qualification',
                description: 'Understand the client\'s current state and needs',
                timeEstimate: '30-45 min',
                items: [
                    { id: 'd1', text: 'Confirm company name, industry, and primary contact', critical: true },
                    { id: 'd2', text: 'Identify funding type (Fully Insured vs Self-Funded/ASO)', critical: true },
                    { id: 'd3', text: 'Obtain employee count and dependent information', critical: true },
                    { id: 'd4', text: 'Understand renewal timeline and decision-makers', critical: false },
                    { id: 'd5', text: 'Discuss current pain points and strategic priorities', critical: false },
                    { id: 'd6', text: 'Confirm wellness budget (if known) or establish range', critical: false },
                ]
            },
            {
                id: 'data-collection', phase: 2,
                title: 'Data Collection',
                description: 'Gather required census and supplementary data',
                timeEstimate: '15-30 min',
                items: [
                    { id: 'c1', text: 'Request census file (Excel/CSV format)', critical: true },
                    { id: 'c2', text: 'Verify census contains: DOB, Gender, Relationship, Zip Code', critical: true },
                    { id: 'c3', text: 'Confirm data is current (within 30 days of renewal)', critical: false },
                    { id: 'c4', text: 'Request claims data if available (for enhanced analysis)', critical: false },
                    { id: 'c5', text: 'Document any data limitations or caveats', critical: false },
                ]
            },
            {
                id: 'analysis', phase: 3,
                title: 'Canon Echo Analysis',
                description: 'Run AI-powered workforce health intelligence',
                timeEstimate: '5-10 min',
                items: [
                    { id: 'a1', text: 'Upload census to Canon Echo', critical: true },
                    { id: 'a2', text: 'Verify funding type is correctly identified', critical: true },
                    { id: 'a3', text: 'Enter wellness fund amount (if known)', critical: false },
                    { id: 'a4', text: 'Run analysis and review 18-slide output', critical: true },
                    { id: 'a5', text: 'Verify risk score and recommendations align with client context', critical: true },
                    { id: 'a6', text: 'Export PDF and PPT versions', critical: false },
                ]
            },
            {
                id: 'delivery', phase: 4,
                title: 'Report Delivery',
                description: 'Present findings with context and recommendations',
                timeEstimate: '45-60 min',
                items: [
                    { id: 'r1', text: 'Schedule presentation with key stakeholders', critical: true },
                    { id: 'r2', text: 'Customize talking points based on client priorities', critical: false },
                    { id: 'r3', text: 'Present Executive Summary and Risk Assessment', critical: true },
                    { id: 'r4', text: 'Review Generational Breakdown and health implications', critical: false },
                    { id: 'r5', text: 'Discuss Cost Mitigation Strategies (prioritize by feasibility)', critical: true },
                    { id: 'r6', text: 'Present Vendor Recommendations aligned to top risks', critical: false },
                    { id: 'r7', text: 'Share Client Portal access for ongoing reference', critical: false },
                ]
            },
            {
                id: 'follow-up', phase: 5,
                title: 'Follow-Up & Next Steps',
                description: 'Convert insights into action',
                timeEstimate: '15-30 min',
                items: [
                    { id: 'f1', text: 'Document key decisions and action items', critical: true },
                    { id: 'f2', text: 'Schedule follow-up within 2 weeks', critical: true },
                    { id: 'f3', text: 'Introduce relevant vendor partners (if requested)', critical: false },
                    { id: 'f4', text: 'Set calendar reminder for pre-renewal check-in', critical: false },
                    { id: 'f5', text: 'Update client status in Canon Echo', critical: false },
                ]
            }
        ];

        // ═══════════════════════════════════════════════════════════════════════════
        // PLAYBOOK WITH SUPABASE PERSISTENCE
        // ═══════════════════════════════════════════════════════════════════════════
        const PlaybookChecklist = ({ selectedClient, onSelectClient, clients }) => {
            const [activePhase, setActivePhase] = useState('discovery');
            const [completedItems, setCompletedItems] = useState({});
            const [notes, setNotes] = useState({});
            const [saving, setSaving] = useState(false);
            const [lastSaved, setLastSaved] = useState(null);
            
            // Load progress from Supabase
            useEffect(() => {
                const loadProgress = async () => {
                    if (!selectedClient) return;
                    
                    try {
                        // Load completed items
                        const { data: progressData } = await supabase
                            .from('playbook_progress')
                            .select('*')
                            .eq('client_id', selectedClient.id);
                        
                        if (progressData) {
                            const completed = {};
                            progressData.forEach(p => {
                                if (p.completed) completed[p.item_id] = true;
                            });
                            setCompletedItems(completed);
                        }
                        
                        // Load notes
                        const { data: notesData } = await supabase
                            .from('playbook_notes')
                            .select('*')
                            .eq('client_id', selectedClient.id);
                        
                        if (notesData) {
                            const notesObj = {};
                            notesData.forEach(n => {
                                notesObj[n.phase] = n.note_text;
                            });
                            setNotes(notesObj);
                        }
                    } catch (err) {
                        console.error('Error loading playbook progress:', err);
                        // Fallback to localStorage
                        const saved = localStorage.getItem(`playbook_${selectedClient.id}`);
                        if (saved) {
                            const { completed, notes: savedNotes } = JSON.parse(saved);
                            setCompletedItems(completed || {});
                            setNotes(savedNotes || {});
                        }
                    }
                };
                
                loadProgress();
            }, [selectedClient]);
            
            // Save progress to Supabase
            const saveProgress = async (newCompleted, newNotes) => {
                if (!selectedClient) return;
                setSaving(true);
                
                try {
                    // Upsert each completed item
                    for (const phase of PLAYBOOK_PHASES) {
                        for (const item of phase.items) {
                            const isCompleted = newCompleted[item.id] || false;
                            await supabase
                                .from('playbook_progress')
                                .upsert({
                                    client_id: selectedClient.id,
                                    phase: phase.phase,
                                    item_id: item.id,
                                    completed: isCompleted,
                                    completed_at: isCompleted ? new Date().toISOString() : null,
                                    updated_at: new Date().toISOString()
                                }, { onConflict: 'client_id,phase,item_id' });
                        }
                    }
                    
                    // Upsert notes for each phase
                    for (const phase of PLAYBOOK_PHASES) {
                        if (newNotes[phase.id]) {
                            await supabase
                                .from('playbook_notes')
                                .upsert({
                                    client_id: selectedClient.id,
                                    phase: phase.phase,
                                    note_text: newNotes[phase.id],
                                    updated_at: new Date().toISOString()
                                }, { onConflict: 'client_id,phase' });
                        }
                    }
                    
                    setLastSaved(new Date());
                } catch (err) {
                    console.error('Error saving to Supabase, falling back to localStorage:', err);
                    // Fallback to localStorage
                    localStorage.setItem(`playbook_${selectedClient.id}`, JSON.stringify({
                        completed: newCompleted,
                        notes: newNotes
                    }));
                }
                
                setSaving(false);
            };
            
            const toggleItem = (itemId) => {
                const newCompleted = { ...completedItems, [itemId]: !completedItems[itemId] };
                setCompletedItems(newCompleted);
                saveProgress(newCompleted, notes);
            };
            
            const updateNote = (phaseId, value) => {
                const newNotes = { ...notes, [phaseId]: value };
                setNotes(newNotes);
                // Debounce save
                clearTimeout(window.noteSaveTimeout);
                window.noteSaveTimeout = setTimeout(() => saveProgress(completedItems, newNotes), 1000);
            };
            
            const getPhaseProgress = (phase) => {
                const items = phase.items;
                const completed = items.filter(item => completedItems[item.id]).length;
                return { completed, total: items.length, percentage: Math.round((completed / items.length) * 100) };
            };
            
            const getTotalProgress = () => {
                const allItems = PLAYBOOK_PHASES.flatMap(p => p.items);
                const completed = allItems.filter(item => completedItems[item.id]).length;
                return { completed, total: allItems.length, percentage: Math.round((completed / allItems.length) * 100) };
            };
            
            const currentPhase = PLAYBOOK_PHASES.find(p => p.id === activePhase);
            const totalProgress = getTotalProgress();
            
            if (!selectedClient) {
                return (
                    <div className="space-y-6">
                        <div className="bg-gradient-to-r from-blue-600/20 to-purple-600/20 border border-blue-500/30 rounded-xl p-6">
                            <h3 className="text-xl font-bold text-white mb-2">Elite Service Playbook</h3>
                            <p className="text-slate-300 mb-4">Select a client to begin the systematic delivery workflow.</p>
                            <div className="text-sm text-slate-400">Progress now syncs to the cloud — works across all your devices.</div>
                        </div>
                        
                        <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-5">
                            <h4 className="font-semibold text-white mb-4">Select Client</h4>
                            <div className="space-y-2 max-h-64 overflow-y-auto">
                                {clients.map(client => (
                                    <button key={client.id} onClick={() => onSelectClient(client)}
                                        className="w-full flex items-center justify-between p-3 bg-slate-800/50 hover:bg-slate-700/50 rounded-lg text-left transition-colors">
                                        <div>
                                            <p className="text-white font-medium">{client.company_name}</p>
                                            <p className="text-slate-400 text-sm">{client.industry || 'No industry'} • {client.funding_type || 'Unknown funding'}</p>
                                        </div>
                                        <StatusBadge status={client.status} />
                                    </button>
                                ))}
                                {clients.length === 0 && <p className="text-slate-500 text-center py-4">No clients yet. Add a client to get started.</p>}
                            </div>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="space-y-6">
                    {/* Client Header with Progress */}
                    <div className="bg-gradient-to-r from-blue-600/20 to-purple-600/20 border border-blue-500/30 rounded-xl p-6">
                        <div className="flex items-center justify-between mb-4">
                            <div>
                                <h3 className="text-xl font-bold text-white">{selectedClient.company_name}</h3>
                                <p className="text-slate-300">{selectedClient.industry || 'No industry'} • {selectedClient.funding_type || 'Unknown'} • {selectedClient.employee_count || '?'} employees</p>
                            </div>
                            <div className="flex items-center gap-3">
                                {saving && <span className="text-blue-400 text-sm flex items-center gap-1">{Icons.loader} Saving...</span>}
                                {lastSaved && !saving && <span className="text-green-400 text-sm">✓ Saved</span>}
                                <button onClick={() => onSelectClient(null)} className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-white">Change Client</button>
                            </div>
                        </div>
                        
                        <div className="mt-4">
                            <div className="flex items-center justify-between mb-2">
                                <span className="text-sm text-slate-300">Overall Progress</span>
                                <span className="text-sm font-medium text-white">{totalProgress.completed}/{totalProgress.total} ({totalProgress.percentage}%)</span>
                            </div>
                            <div className="w-full bg-slate-700 rounded-full h-2">
                                <div className="bg-gradient-to-r from-blue-500 to-green-500 h-2 rounded-full transition-all duration-500" style={{ width: `${totalProgress.percentage}%` }}></div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Phase Navigation */}
                    <div className="flex gap-2 overflow-x-auto pb-2">
                        {PLAYBOOK_PHASES.map((phase) => {
                            const progress = getPhaseProgress(phase);
                            const isActive = activePhase === phase.id;
                            const isComplete = progress.percentage === 100;
                            return (
                                <button key={phase.id} onClick={() => setActivePhase(phase.id)}
                                    className={`flex-shrink-0 px-4 py-2 rounded-lg text-sm font-medium transition-all ${isActive ? 'bg-blue-600 text-white' : isComplete ? 'bg-green-600/20 text-green-400 border border-green-500/30' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>
                                    <span className="flex items-center gap-2">
                                        {isComplete && Icons.check}
                                        Phase {phase.phase}
                                        <span className="text-xs opacity-70">({progress.percentage}%)</span>
                                    </span>
                                </button>
                            );
                        })}
                    </div>
                    
                    {/* Current Phase Checklist */}
                    {currentPhase && (
                        <div className={`phase-card phase-${currentPhase.phase} bg-slate-850 border border-slate-700/50 rounded-xl overflow-hidden`}>
                            <div className="p-5 border-b border-slate-700/50">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <h4 className="text-lg font-semibold text-white">Phase {currentPhase.phase}: {currentPhase.title}</h4>
                                        <p className="text-slate-400 text-sm mt-1">{currentPhase.description}</p>
                                    </div>
                                    <div className="flex items-center gap-2 text-slate-400">
                                        {Icons.clock}
                                        <span className="text-sm">{currentPhase.timeEstimate}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="p-5 space-y-3">
                                {currentPhase.items.map((item) => (
                                    <div key={item.id} onClick={() => toggleItem(item.id)}
                                        className={`checklist-item flex items-start gap-3 p-3 rounded-lg border cursor-pointer transition-all ${completedItems[item.id] ? 'completed border-green-500/30' : 'border-slate-700 hover:border-slate-600 hover:bg-slate-800/50'}`}>
                                        <div className={`flex-shrink-0 w-5 h-5 rounded border-2 flex items-center justify-center mt-0.5 transition-colors ${completedItems[item.id] ? 'bg-green-500 border-green-500' : 'border-slate-500'}`}>
                                            {completedItems[item.id] && <svg className="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" /></svg>}
                                        </div>
                                        <div className="flex-1">
                                            <p className={completedItems[item.id] ? 'text-slate-400 line-through' : 'text-white'}>{item.text}</p>
                                            {item.critical && !completedItems[item.id] && <span className="inline-block mt-1 px-2 py-0.5 bg-amber-500/20 text-amber-400 text-xs rounded">Critical</span>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                            
                            <div className="p-5 border-t border-slate-700/50">
                                <label className="block text-sm font-medium text-slate-400 mb-2">Phase Notes</label>
                                <textarea value={notes[currentPhase.id] || ''} onChange={(e) => updateNote(currentPhase.id, e.target.value)}
                                    placeholder="Add notes for this phase..." rows={3}
                                    className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500 resize-none" />
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ═══════════════════════════════════════════════════════════════════════════
        // DECISION LOG COMPONENT - CLOSES THE OUTCOME LOOP
        // ═══════════════════════════════════════════════════════════════════════════
        const DecisionLog = ({ clients, analyses }) => {
            const [decisions, setDecisions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedClient, setSelectedClient] = useState(null);
            const [showAddDecision, setShowAddDecision] = useState(false);
            const [editingDecision, setEditingDecision] = useState(null);
            
            const fetchDecisions = useCallback(async () => {
                setLoading(true);
                try {
                    let query = supabase.from('decision_log').select('*').order('created_at', { ascending: false });
                    if (selectedClient) query = query.eq('client_id', selectedClient.id);
                    const { data } = await query;
                    setDecisions(data || []);
                } catch (err) {
                    console.error('Error fetching decisions:', err);
                }
                setLoading(false);
            }, [selectedClient]);
            
            useEffect(() => { fetchDecisions(); }, [fetchDecisions]);
            
            const getClientName = (clientId) => {
                const client = clients.find(c => c.id === clientId);
                return client?.company_name || 'Unknown';
            };
            
            const statusOptions = [
                { value: 'pending', label: 'Pending', color: 'amber' },
                { value: 'approved', label: 'Approved', color: 'green' },
                { value: 'in_progress', label: 'In Progress', color: 'blue' },
                { value: 'completed', label: 'Completed', color: 'green' },
                { value: 'rejected', label: 'Rejected', color: 'red' },
                { value: 'deferred', label: 'Deferred', color: 'purple' },
            ];
            
            const typeOptions = [
                { value: 'cost_mitigation', label: 'Cost Mitigation' },
                { value: 'vendor', label: 'Vendor Recommendation' },
                { value: 'screening', label: 'Screening Program' },
                { value: 'wellness', label: 'Wellness Initiative' },
                { value: 'other', label: 'Other' },
            ];
            
            const updateDecisionStatus = async (decisionId, newStatus) => {
                try {
                    await supabase.from('decision_log').update({ 
                        decision_status: newStatus,
                        decision_date: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    }).eq('id', decisionId);
                    fetchDecisions();
                } catch (err) {
                    console.error('Error updating decision:', err);
                }
            };
            
            const addDecision = async (data) => {
                try {
                    await supabase.from('decision_log').insert([{
                        client_id: data.client_id,
                        recommendation_type: data.type,
                        recommendation_title: data.title,
                        recommendation_detail: data.detail,
                        estimated_savings: data.estimated_savings || null,
                        decision_status: 'pending'
                    }]);
                    setShowAddDecision(false);
                    fetchDecisions();
                } catch (err) {
                    console.error('Error adding decision:', err);
                    alert('Error adding decision: ' + err.message);
                }
            };
            
            const updateOutcome = async (decisionId, outcomeData) => {
                try {
                    await supabase.from('decision_log').update({
                        outcome_status: outcomeData.status,
                        outcome_notes: outcomeData.notes,
                        actual_savings: outcomeData.actual_savings || null,
                        outcome_date: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    }).eq('id', decisionId);
                    setEditingDecision(null);
                    fetchDecisions();
                } catch (err) {
                    console.error('Error updating outcome:', err);
                }
            };
            
            // Calculate summary stats
            const stats = {
                total: decisions.length,
                pending: decisions.filter(d => d.decision_status === 'pending').length,
                completed: decisions.filter(d => d.decision_status === 'completed').length,
                totalSavings: decisions.reduce((sum, d) => sum + (parseFloat(d.actual_savings) || 0), 0),
            };
            
            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-green-600/20 to-blue-600/20 border border-green-500/30 rounded-xl p-6">
                        <h3 className="text-xl font-bold text-white mb-2">Decision Log</h3>
                        <p className="text-slate-300">Track recommendations, decisions, and outcomes to prove ROI.</p>
                    </div>
                    
                    {/* Stats */}
                    <div className="grid grid-cols-4 gap-4">
                        <StatCard title="Total Decisions" value={stats.total} icon={Icons.decisions} color="bg-blue-500/20 text-blue-400" />
                        <StatCard title="Pending" value={stats.pending} icon={Icons.clock} color="bg-amber-500/20 text-amber-400" />
                        <StatCard title="Completed" value={stats.completed} icon={Icons.check} color="bg-green-500/20 text-green-400" />
                        <StatCard title="Actual Savings" value={`$${stats.totalSavings.toLocaleString()}`} icon={Icons.dollar} color="bg-purple-500/20 text-purple-400" />
                    </div>
                    
                    {/* Filters and Add Button */}
                    <div className="flex items-center justify-between">
                        <select value={selectedClient?.id || ''} onChange={(e) => setSelectedClient(clients.find(c => c.id === e.target.value) || null)}
                            className="bg-slate-850 border border-slate-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
                            <option value="">All Clients</option>
                            {clients.map(c => <option key={c.id} value={c.id}>{c.company_name}</option>)}
                        </select>
                        
                        <button onClick={() => setShowAddDecision(true)} className="flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg font-medium">
                            {Icons.plus} Add Decision
                        </button>
                    </div>
                    
                    {/* Decision List */}
                    <div className="bg-slate-850 border border-slate-700/50 rounded-xl overflow-hidden">
                        {loading ? (
                            <div className="p-8 text-center text-slate-500">{Icons.loader} Loading...</div>
                        ) : decisions.length === 0 ? (
                            <div className="p-8 text-center text-slate-500">No decisions logged yet. Add your first recommendation!</div>
                        ) : (
                            <table className="w-full">
                                <thead>
                                    <tr className="border-b border-slate-700/50">
                                        <th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">Client</th>
                                        <th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">Recommendation</th>
                                        <th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">Type</th>
                                        <th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">Status</th>
                                        <th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">Est. Savings</th>
                                        <th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">Actual</th>
                                        <th className="text-right px-6 py-4 text-sm font-semibold text-slate-400">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {decisions.map((d, i) => (
                                        <tr key={d.id} className={`border-b border-slate-700/30 hover:bg-slate-700/20 ${i % 2 ? 'bg-slate-900/20' : ''}`}>
                                            <td className="px-6 py-4 text-white font-medium">{getClientName(d.client_id)}</td>
                                            <td className="px-6 py-4 text-slate-300">
                                                <p className="font-medium">{d.recommendation_title}</p>
                                                {d.recommendation_detail && <p className="text-sm text-slate-500 truncate max-w-xs">{d.recommendation_detail}</p>}
                                            </td>
                                            <td className="px-6 py-4 text-slate-300 text-sm">{typeOptions.find(t => t.value === d.recommendation_type)?.label || d.recommendation_type}</td>
                                            <td className="px-6 py-4">
                                                <select value={d.decision_status} onChange={(e) => updateDecisionStatus(d.id, e.target.value)}
                                                    className="bg-transparent border-none text-sm font-medium focus:outline-none cursor-pointer">
                                                    {statusOptions.map(s => <option key={s.value} value={s.value}>{s.label}</option>)}
                                                </select>
                                            </td>
                                            <td className="px-6 py-4 text-slate-300">{d.estimated_savings ? `$${parseFloat(d.estimated_savings).toLocaleString()}` : '—'}</td>
                                            <td className="px-6 py-4">
                                                {d.actual_savings ? (
                                                    <span className="text-green-400 font-medium">${parseFloat(d.actual_savings).toLocaleString()}</span>
                                                ) : d.decision_status === 'completed' ? (
                                                    <button onClick={() => setEditingDecision(d)} className="text-blue-400 text-sm hover:underline">+ Add outcome</button>
                                                ) : '—'}
                                            </td>
                                            <td className="px-6 py-4 text-right">
                                                <button onClick={() => setEditingDecision(d)} className="p-2 text-slate-400 hover:text-blue-400">{Icons.edit}</button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        )}
                    </div>
                    
                    {/* Add Decision Modal */}
                    <Modal isOpen={showAddDecision} onClose={() => setShowAddDecision(false)} title="Add Decision">
                        <AddDecisionForm clients={clients} onSubmit={addDecision} onCancel={() => setShowAddDecision(false)} typeOptions={typeOptions} />
                    </Modal>
                    
                    {/* Edit/Outcome Modal */}
                    <Modal isOpen={!!editingDecision} onClose={() => setEditingDecision(null)} title="Update Outcome">
                        {editingDecision && <OutcomeForm decision={editingDecision} onSubmit={(data) => updateOutcome(editingDecision.id, data)} onCancel={() => setEditingDecision(null)} />}
                    </Modal>
                </div>
            );
        };
        
        const AddDecisionForm = ({ clients, onSubmit, onCancel, typeOptions }) => {
            const [formData, setFormData] = useState({ client_id: '', type: 'cost_mitigation', title: '', detail: '', estimated_savings: '' });
            const handleSubmit = (e) => { e.preventDefault(); onSubmit(formData); };
            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium text-slate-400 mb-1">Client *</label>
                        <select required value={formData.client_id} onChange={(e) => setFormData({...formData, client_id: e.target.value})}
                            className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500">
                            <option value="">Select client...</option>
                            {clients.map(c => <option key={c.id} value={c.id}>{c.company_name}</option>)}
                        </select>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-slate-400 mb-1">Type *</label>
                        <select required value={formData.type} onChange={(e) => setFormData({...formData, type: e.target.value})}
                            className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500">
                            {typeOptions.map(t => <option key={t.value} value={t.value}>{t.label}</option>)}
                        </select>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-slate-400 mb-1">Recommendation Title *</label>
                        <input type="text" required value={formData.title} onChange={(e) => setFormData({...formData, title: e.target.value})}
                            placeholder="e.g., Implement tobacco surcharge" className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500" />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-slate-400 mb-1">Details</label>
                        <textarea value={formData.detail} onChange={(e) => setFormData({...formData, detail: e.target.value})}
                            placeholder="Additional context..." rows={3} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500 resize-none" />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-slate-400 mb-1">Estimated Savings ($)</label>
                        <input type="number" value={formData.estimated_savings} onChange={(e) => setFormData({...formData, estimated_savings: e.target.value})}
                            placeholder="e.g., 15000" className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500" />
                    </div>
                    <div className="flex gap-3 pt-2">
                        <button type="button" onClick={onCancel} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Cancel</button>
                        <button type="submit" className="flex-1 px-4 py-2.5 bg-green-600 hover:bg-green-500 rounded-lg font-medium">Add Decision</button>
                    </div>
                </form>
            );
        };
        
        const OutcomeForm = ({ decision, onSubmit, onCancel }) => {
            const [formData, setFormData] = useState({ status: decision.outcome_status || 'successful', notes: decision.outcome_notes || '', actual_savings: decision.actual_savings || '' });
            const handleSubmit = (e) => { e.preventDefault(); onSubmit(formData); };
            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="bg-slate-900/50 rounded-lg p-4 mb-4">
                        <p className="text-white font-medium">{decision.recommendation_title}</p>
                        <p className="text-slate-400 text-sm">{decision.recommendation_detail}</p>
                        {decision.estimated_savings && <p className="text-blue-400 text-sm mt-2">Estimated: ${parseFloat(decision.estimated_savings).toLocaleString()}</p>}
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-slate-400 mb-1">Outcome Status</label>
                        <select value={formData.status} onChange={(e) => setFormData({...formData, status: e.target.value})}
                            className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500">
                            <option value="successful">Successful</option>
                            <option value="partially_successful">Partially Successful</option>
                            <option value="unsuccessful">Unsuccessful</option>
                            <option value="too_early">Too Early to Tell</option>
                        </select>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-slate-400 mb-1">Actual Savings ($)</label>
                        <input type="number" value={formData.actual_savings} onChange={(e) => setFormData({...formData, actual_savings: e.target.value})}
                            placeholder="e.g., 12500" className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500" />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-slate-400 mb-1">Notes</label>
                        <textarea value={formData.notes} onChange={(e) => setFormData({...formData, notes: e.target.value})}
                            placeholder="What happened? What did we learn?" rows={3} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500 resize-none" />
                    </div>
                    <div className="flex gap-3 pt-2">
                        <button type="button" onClick={onCancel} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Cancel</button>
                        <button type="submit" className="flex-1 px-4 py-2.5 bg-green-600 hover:bg-green-500 rounded-lg font-medium">Save Outcome</button>
                    </div>
                </form>
            );
        };

        // ═══════════════════════════════════════════════════════════════════════════
        // CENSUS DATA VALIDATOR
        // ═══════════════════════════════════════════════════════════════════════════
        const validateCensusData = (data) => {
            const errors = [];
            const warnings = [];
            const validRows = [];
            const requiredFields = ['dob', 'date_of_birth', 'birth_date', 'birthdate'];
            const genderFields = ['gender', 'sex'];
            const relationshipFields = ['relationship', 'relation', 'type', 'coverage_type'];
            
            // Check if we have data
            if (!data || data.length === 0) {
                return { valid: false, errors: ['No data found in file'], warnings: [], validRows: [], summary: null };
            }
            
            // Normalize column names
            const columns = Object.keys(data[0]).map(c => c.toLowerCase().trim());
            
            // Check for required fields
            const hasDOB = columns.some(c => requiredFields.some(f => c.includes(f)));
            const hasGender = columns.some(c => genderFields.some(f => c.includes(f)));
            const hasRelationship = columns.some(c => relationshipFields.some(f => c.includes(f)));
            
            if (!hasDOB) errors.push('Missing Date of Birth column (required for age calculations)');
            if (!hasGender) warnings.push('Missing Gender column (recommended for screening analysis)');
            if (!hasRelationship) warnings.push('Missing Relationship column (recommended for dependent analysis)');
            
            // Validate each row
            let employeeCount = 0;
            let dependentCount = 0;
            let invalidDates = 0;
            
            data.forEach((row, index) => {
                const rowNum = index + 2; // Account for header row
                let isValid = true;
                
                // Check for empty rows
                const values = Object.values(row).filter(v => v !== null && v !== undefined && v !== '');
                if (values.length === 0) {
                    return; // Skip empty rows
                }
                
                // Try to find DOB
                let dob = null;
                for (const key of Object.keys(row)) {
                    const lowerKey = key.toLowerCase();
                    if (requiredFields.some(f => lowerKey.includes(f))) {
                        dob = row[key];
                        break;
                    }
                }
                
                if (dob) {
                    const parsed = new Date(dob);
                    if (isNaN(parsed.getTime())) {
                        invalidDates++;
                        isValid = false;
                    }
                }
                
                // Count employees vs dependents
                let relationship = null;
                for (const key of Object.keys(row)) {
                    const lowerKey = key.toLowerCase();
                    if (relationshipFields.some(f => lowerKey.includes(f))) {
                        relationship = (row[key] || '').toString().toLowerCase();
                        break;
                    }
                }
                
                if (relationship && (relationship.includes('employee') || relationship.includes('subscriber') || relationship.includes('self'))) {
                    employeeCount++;
                } else if (relationship) {
                    dependentCount++;
                } else {
                    employeeCount++; // Default to employee if no relationship
                }
                
                if (isValid) validRows.push(row);
            });
            
            if (invalidDates > 0) {
                warnings.push(`${invalidDates} rows have invalid or unparseable dates`);
            }
            
            const summary = {
                totalRows: data.length,
                validRows: validRows.length,
                employeeCount,
                dependentCount,
                totalLives: employeeCount + dependentCount
            };
            
            return {
                valid: errors.length === 0,
                errors,
                warnings,
                validRows,
                summary
            };
        };

        // ═══════════════════════════════════════════════════════════════════════════
        // UNIVERSAL DATA INTAKE SYSTEM - Reusable across all tools/agents
        // Supports: CSV, XLSX, XLS, TXT, JSON, ZIP (extracts and processes contents)
        // ═══════════════════════════════════════════════════════════════════════════
        
        // Supported file extensions
        const SUPPORTED_EXTENSIONS = ['csv', 'xlsx', 'xls', 'txt', 'json', 'zip'];
        const SUPPORTED_ACCEPT = '.csv,.xlsx,.xls,.txt,.json,.zip';
        
        const DATA_TYPES = [
            { id: 'census', name: 'Census Data', icon: '👥', description: 'Employee demographics', keywords: ['dob', 'date of birth', 'birth', 'gender', 'sex', 'employee', 'dependent', 'spouse', 'coverage tier', 'hire date'] },
            { id: 'claims', name: 'Claims Summary', icon: '📊', description: 'Medical & Rx claims', keywords: ['claim', 'paid', 'allowed', 'service category', 'inpatient', 'outpatient', 'emergency'] },
            { id: 'large_claimants', name: 'Large Claimants', icon: '🏥', description: 'High-cost members', keywords: ['diagnosis', 'claimant', 'high cost', 'catastrophic', 'condition', 'projected'] },
            { id: 'pharmacy', name: 'Pharmacy Data', icon: '💊', description: 'Rx utilization & costs', keywords: ['drug', 'medication', 'ndc', 'therapeutic', 'scripts', 'fills', 'generic', 'brand', 'specialty'] },
            { id: 'utilization', name: 'Utilization Metrics', icon: '📈', description: 'PMPM, admits, visits', keywords: ['pmpm', 'per 1000', 'admits', 'utilization', 'benchmark', 'metric', 'rate'] },
            { id: 'benefits', name: 'Benefit Design', icon: '📋', description: 'Plan details & copays', keywords: ['deductible', 'copay', 'coinsurance', 'oop', 'out of pocket', 'in network', 'out of network'] },
            { id: 'contributions', name: 'Contributions', icon: '💰', description: 'Premium cost sharing', keywords: ['premium', 'contribution', 'employer cost', 'employee cost', 'er contribution', 'ee contribution'] },
            { id: 'vendor', name: 'Other/Vendor', icon: '📁', description: 'Other reports', keywords: [] }
        ];
        
        const FIELD_MAPPINGS = {
            date_of_birth: ['dob', 'date of birth', 'birth date', 'birthdate', 'birth_date', 'dateofbirth', 'bday', 'birthday', 'employee dob', 'ee dob', 'member dob'],
            gender: ['gender', 'sex', 'm/f', 'male/female', 'employee gender', 'ee gender', 'member gender'],
            zip_code: ['zip', 'zip code', 'zipcode', 'postal', 'postal code', 'zip_code', 'employee zip', 'ee zip', 'home zip'],
            coverage_tier: ['tier', 'coverage', 'coverage tier', 'coverage level', 'plan tier', 'election', 'coverage type', 'ee/es/ec/fam'],
            salary: ['salary', 'annual salary', 'compensation', 'pay', 'earnings', 'wage', 'base salary'],
            department: ['department', 'dept', 'division', 'business unit', 'cost center'],
            hire_date: ['hire date', 'hire_date', 'hiredate', 'date of hire', 'start date', 'service date'],
            employee_id: ['employee id', 'ee id', 'emp id', 'employee number', 'emp #', 'ee #', 'id', 'member id'],
            first_name: ['first name', 'first_name', 'firstname', 'fname', 'first'],
            last_name: ['last name', 'last_name', 'lastname', 'lname', 'last', 'surname'],
            full_name: ['name', 'employee name', 'ee name', 'member name', 'full name', 'employee'],
            job_title: ['title', 'job title', 'position', 'job', 'role'],
            smoker: ['smoker', 'tobacco', 'tobacco user', 'smoking', 'nicotine'],
            dependent_count: ['dependents', 'dependent count', 'num dependents', '# dependents', 'dep count'],
            plan_type: ['plan', 'plan type', 'plan name', 'medical plan', 'plan option'],
            claim_category: ['category', 'claim category', 'service category', 'type', 'claim type', 'description'],
            claim_count: ['claims', 'claim count', 'count', 'number of claims', '# claims', 'volume'],
            total_paid: ['paid', 'total paid', 'amount paid', 'paid amount', 'total', 'allowed', 'cost', 'spend'],
            member_responsibility: ['member cost', 'member resp', 'patient cost', 'oop', 'out of pocket', 'member paid'],
            plan_paid: ['plan paid', 'plan cost', 'insurance paid', 'carrier paid', 'benefit paid'],
            drug_name: ['drug', 'drug name', 'medication', 'med', 'rx', 'prescription', 'product', 'ndc'],
            therapeutic_class: ['class', 'therapeutic class', 'drug class', 'category', 'therapy class'],
            scripts_filled: ['scripts', 'fills', 'rxs', 'prescriptions', 'script count', '# scripts'],
            members_using: ['members', 'patients', 'users', 'member count', 'unique members'],
            diagnosis: ['diagnosis', 'dx', 'condition', 'primary diagnosis', 'icd'],
            metric_name: ['metric', 'measure', 'name', 'kpi', 'indicator'],
            current_value: ['current', 'value', 'actual', 'result', 'current period'],
            benchmark: ['benchmark', 'bench', 'target', 'goal', 'industry', 'norm'],
            benefit_category: ['benefit', 'category', 'service', 'coverage'],
            total_premium: ['premium', 'total premium', 'monthly premium', 'rate', 'total cost'],
            employer_contribution: ['employer', 'er contribution', 'employer cost', 'er cost', 'company pays'],
            employee_contribution: ['employee', 'ee contribution', 'employee cost', 'ee cost', 'employee pays']
        };
        
        // Auto-detect data type from headers
        const detectDataType = (headers) => {
            const normalizedHeaders = headers.map(h => (h || '').toString().toLowerCase().trim()).join(' ');
            
            let bestMatch = { type: 'vendor', score: 0 };
            
            DATA_TYPES.forEach(type => {
                if (type.keywords.length === 0) return;
                let score = 0;
                type.keywords.forEach(keyword => {
                    if (normalizedHeaders.includes(keyword)) score += 10;
                });
                if (score > bestMatch.score) {
                    bestMatch = { type: type.id, score };
                }
            });
            
            return bestMatch.type;
        };
        
        const mapColumns = (headers, dataType) => {
            const mappings = [];
            const normalizedHeaders = headers.map(h => (h || '').toString().toLowerCase().trim());
            
            Object.entries(FIELD_MAPPINGS).forEach(([standardField, aliases]) => {
                normalizedHeaders.forEach((header, index) => {
                    if (!header) return;
                    let matchScore = 0;
                    if (aliases.some(a => header === a)) matchScore = 100;
                    else if (aliases.some(a => header.includes(a) || a.includes(header))) matchScore = 80;
                    
                    if (matchScore >= 60) {
                        mappings.push({ sourceIndex: index, sourceColumn: headers[index], standardField, confidence: matchScore, sampleData: null });
                    }
                });
            });
            
            const deduped = {};
            mappings.forEach(m => {
                const key = m.sourceIndex;
                if (!deduped[key] || deduped[key].confidence < m.confidence) deduped[key] = m;
            });
            
            return Object.values(deduped).sort((a, b) => a.sourceIndex - b.sourceIndex);
        };
        
        const UploadAnalyze = ({ client, onComplete, onCancel }) => {
            const [files, setFiles] = useState([]);
            const [processing, setProcessing] = useState(false);
            const [analyzing, setAnalyzing] = useState(false);
            const [results, setResults] = useState(null);
            const [error, setError] = useState(null);
            const [progress, setProgress] = useState('');
            const [expandedFile, setExpandedFile] = useState(null);
            
            // Parse single file (non-ZIP)
            const parseFile = async (file) => {
                const ext = file.name.split('.').pop().toLowerCase();
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    
                    if (ext === 'csv' || ext === 'txt') {
                        reader.onload = (e) => {
                            try {
                                const text = e.target.result;
                                const lines = text.split('\n').filter(line => line.trim());
                                if (lines.length === 0) { resolve({ error: 'File is empty' }); return; }
                                const delimiter = lines[0].includes('\t') ? '\t' : ',';
                                
                                let headerIndex = 0;
                                for (let i = 0; i < Math.min(5, lines.length); i++) {
                                    const cells = lines[i].split(delimiter);
                                    if (cells.filter(c => c.trim()).length >= 3) { headerIndex = i; break; }
                                }
                                
                                const headers = lines[headerIndex].split(delimiter).map(h => h.trim().replace(/"/g, ''));
                                const rows = lines.slice(headerIndex + 1).map(line => {
                                    const cells = line.split(delimiter).map(c => c.trim().replace(/"/g, ''));
                                    const row = {};
                                    headers.forEach((h, i) => row[h] = cells[i] || '');
                                    return row;
                                }).filter(row => Object.values(row).some(v => v));
                                
                                resolve({ headers, rows, rowCount: rows.length });
                            } catch (err) {
                                resolve({ error: `Error parsing file: ${err.message}` });
                            }
                        };
                        reader.readAsText(file);
                    } else if (['xlsx', 'xls'].includes(ext)) {
                        reader.onload = (e) => {
                            try {
                                const data = new Uint8Array(e.target.result);
                                const workbook = XLSX.read(data, { type: 'array' });
                                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                                
                                let headerIndex = 0;
                                for (let i = 0; i < Math.min(10, jsonData.length); i++) {
                                    if (jsonData[i] && jsonData[i].filter(c => c).length >= 3) { headerIndex = i; break; }
                                }
                                
                                const headers = (jsonData[headerIndex] || []).map(h => String(h || '').trim());
                                const rows = jsonData.slice(headerIndex + 1).map(row => {
                                    const obj = {};
                                    headers.forEach((h, i) => obj[h] = row[i] || '');
                                    return obj;
                                }).filter(row => Object.values(row).some(v => v));
                                
                                resolve({ headers, rows, rowCount: rows.length });
                            } catch (err) {
                                resolve({ error: `Error parsing Excel: ${err.message}` });
                            }
                        };
                        reader.readAsArrayBuffer(file);
                    } else if (ext === 'json') {
                        reader.onload = (e) => {
                            try {
                                const jsonData = JSON.parse(e.target.result);
                                const rows = Array.isArray(jsonData) ? jsonData : [jsonData];
                                const headers = [...new Set(rows.flatMap(r => Object.keys(r)))];
                                resolve({ headers, rows, rowCount: rows.length });
                            } catch (err) {
                                resolve({ error: `Error parsing JSON: ${err.message}` });
                            }
                        };
                        reader.readAsText(file);
                    } else {
                        resolve({ error: `Unsupported file type: .${ext}` });
                    }
                });
            };
            
            // Extract files from ZIP
            const extractZip = async (file) => {
                try {
                    const zip = await JSZip.loadAsync(file);
                    const extractedFiles = [];
                    
                    for (const [filename, zipEntry] of Object.entries(zip.files)) {
                        if (zipEntry.dir) continue;
                        
                        const ext = filename.split('.').pop().toLowerCase();
                        if (!['csv', 'xlsx', 'xls', 'txt', 'json'].includes(ext)) continue;
                        if (filename.startsWith('__MACOSX') || filename.startsWith('.') || filename.includes('/.')) continue;
                        
                        let content;
                        if (['xlsx', 'xls'].includes(ext)) {
                            content = await zipEntry.async('arraybuffer');
                        } else {
                            content = await zipEntry.async('string');
                        }
                        
                        const blob = new Blob([content]);
                        const extractedFile = new File([blob], filename.split('/').pop(), { type: blob.type });
                        extractedFiles.push({ file: extractedFile, sourceZip: file.name });
                    }
                    
                    return extractedFiles;
                } catch (err) {
                    return { error: `Error extracting ZIP: ${err.message}` };
                }
            };
            
            const handleFiles = async (newFiles) => {
                const fileArray = Array.from(newFiles);
                if (fileArray.length === 0) return;
                
                setProcessing(true);
                setError(null);
                setProgress('Processing files...');
                
                const processedFiles = [];
                const filesToProcess = [];
                
                // First pass: extract ZIPs, collect all files
                for (const file of fileArray) {
                    const ext = file.name.split('.').pop().toLowerCase();
                    
                    if (ext === 'zip') {
                        setProgress(`Extracting ${file.name}...`);
                        const extracted = await extractZip(file);
                        
                        if (extracted.error) {
                            processedFiles.push({
                                id: Math.random().toString(36).substr(2, 9),
                                name: file.name,
                                size: file.size,
                                status: 'error',
                                error: extracted.error,
                                dataType: null,
                                parsedData: null,
                                mappings: []
                            });
                        } else {
                            filesToProcess.push(...extracted);
                        }
                    } else {
                        filesToProcess.push({ file, sourceZip: null });
                    }
                }
                
                // Second pass: parse all files
                for (const { file, sourceZip } of filesToProcess) {
                    setProgress(`Processing ${file.name}...`);
                    
                    const fileObj = {
                        id: Math.random().toString(36).substr(2, 9),
                        file,
                        name: file.name,
                        size: file.size,
                        sourceZip,
                        status: 'processing',
                        dataType: null,
                        parsedData: null,
                        mappings: [],
                        error: null
                    };
                    
                    const result = await parseFile(file);
                    
                    if (result.error) {
                        fileObj.status = 'error';
                        fileObj.error = result.error;
                    } else {
                        fileObj.status = 'ready';
                        fileObj.parsedData = result;
                        fileObj.dataType = detectDataType(result.headers);
                        fileObj.mappings = mapColumns(result.headers, fileObj.dataType);
                        fileObj.mappings.forEach(m => {
                            const samples = result.rows.slice(0, 3).map(r => r[m.sourceColumn]).filter(v => v);
                            m.sampleData = samples.join(', ').substring(0, 40);
                        });
                    }
                    
                    processedFiles.push(fileObj);
                }
                
                setFiles(prev => [...prev, ...processedFiles]);
                setProcessing(false);
                setProgress('');
            };
            
            const updateFileType = (fileId, newType) => {
                setFiles(prev => prev.map(f => {
                    if (f.id === fileId) {
                        const newMappings = mapColumns(f.parsedData.headers, newType);
                        newMappings.forEach(m => {
                            const samples = f.parsedData.rows.slice(0, 3).map(r => r[m.sourceColumn]).filter(v => v);
                            m.sampleData = samples.join(', ').substring(0, 40);
                        });
                        return { ...f, dataType: newType, mappings: newMappings };
                    }
                    return f;
                }));
            };
            
            const removeFile = (fileId) => {
                setFiles(prev => prev.filter(f => f.id !== fileId));
            };
            
            const runAnalysis = async () => {
                const readyFiles = files.filter(f => f.status === 'ready');
                if (readyFiles.length === 0) return;
                
                setAnalyzing(true);
                setError(null);
                setProgress('Preparing data...');
                
                try {
                    // Combine all data by type
                    const normalizedData = {};
                    
                    readyFiles.forEach(f => {
                        const transformed = f.parsedData.rows.map(row => {
                            const normalized = {};
                            f.mappings.forEach(m => {
                                if (m.standardField) normalized[m.standardField] = row[m.sourceColumn];
                            });
                            return normalized;
                        });
                        
                        if (normalizedData[f.dataType]) {
                            normalizedData[f.dataType] = [...normalizedData[f.dataType], ...transformed];
                        } else {
                            normalizedData[f.dataType] = transformed;
                        }
                    });
                    
                    setProgress('Running AI analysis...');
                    
                    const censusData = normalizedData.census || normalizedData[Object.keys(normalizedData)[0]] || [];
                    const sample = censusData.slice(0, 100);
                    
                    const res = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            census_data: sample,
                            claims_data: normalizedData.claims || [],
                            pharmacy_data: normalizedData.pharmacy || [],
                            large_claimants: normalizedData.large_claimants || [],
                            utilization_data: normalizedData.utilization || [],
                            benefits_data: normalizedData.benefits || [],
                            contributions_data: normalizedData.contributions || [],
                            client_info: {
                                company_name: client.company_name,
                                industry: client.industry,
                                funding_type: client.funding_type,
                                employee_count: client.employee_count,
                                wellness_fund: client.wellness_fund
                            }
                        })
                    });
                    
                    if (!res.ok) throw new Error('Analysis failed');
                    const data = await res.json();
                    
                    setProgress('Saving results...');
                    
                    // Handle new HTML report format from Canon Echo API
                    if (data.success && data.report_html) {
                        // Store the HTML report
                        await supabase.from('analyses').insert([{
                            client_id: client.id,
                            findings: { report_html: data.report_html, metadata: data.metadata },
                            status: 'complete',
                            data_sources: Object.keys(normalizedData)
                        }]);
                        
                        // Set results to trigger HTML report display
                        setResults({ _isHtmlReport: true, html: data.report_html, metadata: data.metadata });
                        setProgress('');
                        setAnalyzing(false);
                        return;
                    }
                    
                    // Legacy JSON format fallback
                    await supabase.from('analyses').insert([{
                        client_id: client.id,
                        findings: data.analysis,
                        status: 'complete',
                        data_sources: Object.keys(normalizedData)
                    }]);
                    
                    for (const f of readyFiles) {
                        await supabase.from('uploads').insert([{
                            client_id: client.id,
                            file_name: f.name,
                            file_type: f.dataType,
                            row_count: f.parsedData.rowCount,
                            status: 'processed'
                        }]);
                    }
                    
                    await supabase.from('clients').update({ status: 'active' }).eq('id', client.id);
                    
                    await supabase.from('engagement_timeline').insert([{
                        client_id: client.id,
                        event_type: 'analysis_run',
                        event_title: 'Canon Echo Analysis Completed',
                        event_detail: `${readyFiles.length} files analyzed | Data: ${Object.keys(normalizedData).join(', ')} | Risk: ${data.analysis?.risk_assessment?.overall_score || 'N/A'}`
                    }]);
                    
                    setResults(data.analysis);
                    setProgress('');
                } catch (err) {
                    setError(err.message);
                    setProgress('');
                } finally {
                    setAnalyzing(false);
                }
            };
            
            const formatSize = (bytes) => {
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return Math.round(bytes / 1024) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            };
            
            const getFileIcon = (filename) => {
                const ext = filename.split('.').pop().toLowerCase();
                switch (ext) {
                    case 'xlsx': case 'xls': return '📊';
                    case 'csv': return '📄';
                    case 'zip': return '📦';
                    case 'json': return '🔷';
                    case 'txt': return '📝';
                    case 'pdf': return '📕';
                    default: return '📁';
                }
            };
            
            const getTypeInfo = (typeId) => DATA_TYPES.find(t => t.id === typeId) || DATA_TYPES[DATA_TYPES.length - 1];

            // Results view - Full Report Display
            if (results) {
                // NEW: Handle HTML Report Display
                if (results._isHtmlReport && results.html) {
                    return (
                        <div className="space-y-4">
                            {/* Success Header */}
                            <div className="bg-green-500/10 border border-green-500/30 rounded-xl p-4 text-center">
                                <p className="text-green-400 font-medium text-lg">✓ Workforce Health Intelligence Report Generated!</p>
                                <p className="text-slate-300 text-sm mt-1">{client?.company_name} • 16-Slide Executive Report</p>
                            </div>
                            
                            {/* Report Preview in iframe */}
                            <div className="bg-slate-900/50 rounded-xl overflow-hidden" style={{height: '60vh'}}>
                                <iframe
                                    srcDoc={results.html}
                                    title="Canon Echo Report"
                                    className="w-full h-full border-0"
                                    sandbox="allow-scripts allow-same-origin"
                                />
                            </div>
                            
                            {/* Action Buttons */}
                            <div className="flex gap-3 pt-2">
                                <button 
                                    onClick={() => {
                                        const blob = new Blob([results.html], { type: 'text/html' });
                                        const url = URL.createObjectURL(blob);
                                        const a = document.createElement('a');
                                        a.href = url;
                                        a.download = `Canon_Echo_Report_${client?.company_name?.replace(/\s+/g, '_') || 'Client'}_${new Date().toISOString().split('T')[0]}.html`;
                                        a.click();
                                        URL.revokeObjectURL(url);
                                    }}
                                    className="flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-500 rounded-lg font-medium flex items-center justify-center gap-2"
                                >
                                    <span>⬇️</span> Download Report
                                </button>
                                <button 
                                    onClick={() => {
                                        const win = window.open('', '_blank');
                                        win.document.write(results.html);
                                        win.document.close();
                                    }}
                                    className="flex-1 px-4 py-3 bg-purple-600 hover:bg-purple-500 rounded-lg font-medium flex items-center justify-center gap-2"
                                >
                                    <span>🔎</span> Open Full Screen
                                </button>
                                <button onClick={onComplete} className="px-6 py-3 bg-green-600 hover:bg-green-500 rounded-lg font-medium">
                                    Done
                                </button>
                            </div>
                        </div>
                    );
                }
                
                // Legacy JSON results display
                return (
                    <div className="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                        {/* Header */}
                        <div className="bg-green-500/10 border border-green-500/30 rounded-xl p-4 text-center">
                            <p className="text-green-400 font-medium text-lg">✓ Analysis Complete!</p>
                            <p className="text-slate-300 text-sm mt-1">{files.filter(f => f.status === 'ready').length} files processed • {client?.company_name}</p>
                        </div>
                        
                        {/* Executive Summary */}
                        {results.executive_summary && (
                            <div className="bg-slate-900/50 rounded-xl p-4">
                                <h4 className="text-sm font-semibold text-blue-400 mb-2">📋 Executive Summary</h4>
                                <p className="text-white text-sm leading-relaxed">{results.executive_summary}</p>
                            </div>
                        )}
                        
                        {/* Risk Assessment */}
                        {results.risk_assessment && (
                            <div className="bg-slate-900/50 rounded-xl p-4">
                                <h4 className="text-sm font-semibold text-amber-400 mb-3">⚠️ Risk Assessment</h4>
                                <div className="flex items-center gap-4 mb-3">
                                    <div className={`w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold ${
                                        results.risk_assessment.overall_score >= 75 ? 'bg-red-500/20 text-red-400 border-2 border-red-500' :
                                        results.risk_assessment.overall_score >= 50 ? 'bg-amber-500/20 text-amber-400 border-2 border-amber-500' :
                                        'bg-green-500/20 text-green-400 border-2 border-green-500'
                                    }`}>
                                        {results.risk_assessment.overall_score}
                                    </div>
                                    <div>
                                        <p className="text-white font-medium">{results.risk_assessment.risk_category} Risk</p>
                                        <p className="text-slate-400 text-sm">Overall risk score</p>
                                    </div>
                                </div>
                                {results.risk_assessment.key_risks && results.risk_assessment.key_risks.length > 0 && (
                                    <div className="mt-3 pt-3 border-t border-slate-700">
                                        <p className="text-slate-400 text-xs mb-2">Key Risk Factors:</p>
                                        <div className="space-y-1">
                                            {results.risk_assessment.key_risks.map((risk, i) => (
                                                <p key={i} className="text-red-300 text-sm">• {risk}</p>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {/* Census Profile */}
                        {results.census_profile && (
                            <div className="bg-slate-900/50 rounded-xl p-4">
                                <h4 className="text-sm font-semibold text-purple-400 mb-3">👥 Census Profile</h4>
                                <div className="grid grid-cols-2 gap-3">
                                    {results.census_profile.total_lives && (
                                        <div className="bg-slate-800/50 rounded-lg p-3">
                                            <p className="text-slate-400 text-xs">Total Lives</p>
                                            <p className="text-white text-lg font-semibold">{results.census_profile.total_lives}</p>
                                        </div>
                                    )}
                                    {results.census_profile.average_age && (
                                        <div className="bg-slate-800/50 rounded-lg p-3">
                                            <p className="text-slate-400 text-xs">Average Age</p>
                                            <p className="text-white text-lg font-semibold">{results.census_profile.average_age}</p>
                                        </div>
                                    )}
                                </div>
                                {results.census_profile.age_distribution && (
                                    <div className="mt-3 pt-3 border-t border-slate-700">
                                        <p className="text-slate-400 text-xs mb-2">Age Distribution:</p>
                                        <div className="flex gap-2">
                                            <span className="px-2 py-1 bg-blue-500/20 text-blue-300 rounded text-xs">Under 30: {results.census_profile.age_distribution.under_30 || 0}</span>
                                            <span className="px-2 py-1 bg-purple-500/20 text-purple-300 rounded text-xs">30-50: {results.census_profile.age_distribution['30_to_50'] || 0}</span>
                                            <span className="px-2 py-1 bg-amber-500/20 text-amber-300 rounded text-xs">Over 50: {results.census_profile.age_distribution.over_50 || 0}</span>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {/* Cost Drivers */}
                        {results.cost_drivers && results.cost_drivers.length > 0 && (
                            <div className="bg-slate-900/50 rounded-xl p-4">
                                <h4 className="text-sm font-semibold text-red-400 mb-3">💰 Cost Drivers</h4>
                                <div className="space-y-2">
                                    {results.cost_drivers.map((driver, i) => (
                                        <div key={i} className="flex items-center justify-between bg-slate-800/50 rounded-lg p-3">
                                            <span className="text-white text-sm">{typeof driver === 'string' ? driver : driver.driver}</span>
                                            {driver.impact && (
                                                <span className={`px-2 py-1 rounded text-xs ${
                                                    driver.impact === 'High' ? 'bg-red-500/20 text-red-300' :
                                                    driver.impact === 'Medium' ? 'bg-amber-500/20 text-amber-300' :
                                                    'bg-green-500/20 text-green-300'
                                                }`}>{driver.impact}</span>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {/* Pharmacy Insights */}
                        {results.pharmacy_insights && (
                            <div className="bg-slate-900/50 rounded-xl p-4">
                                <h4 className="text-sm font-semibold text-cyan-400 mb-3">💊 Pharmacy Insights</h4>
                                <div className="space-y-2 text-sm">
                                    {results.pharmacy_insights.specialty_drug_exposure && (
                                        <p className="text-slate-300">Specialty Drug Exposure: <span className="text-white font-medium">{results.pharmacy_insights.specialty_drug_exposure}</span></p>
                                    )}
                                    {results.pharmacy_insights.glp1_utilization && (
                                        <p className="text-slate-300">GLP-1 Utilization: <span className="text-amber-400 font-medium">{results.pharmacy_insights.glp1_utilization}</span></p>
                                    )}
                                    {results.pharmacy_insights.generic_rate && (
                                        <p className="text-slate-300">Generic Dispensing Rate: <span className="text-white font-medium">{results.pharmacy_insights.generic_rate}</span></p>
                                    )}
                                </div>
                            </div>
                        )}
                        
                        {/* Large Claimant Summary */}
                        {results.large_claimant_summary && (
                            <div className="bg-slate-900/50 rounded-xl p-4">
                                <h4 className="text-sm font-semibold text-orange-400 mb-3">🏥 Large Claimant Summary</h4>
                                <div className="space-y-2 text-sm">
                                    {results.large_claimant_summary.total_high_cost && (
                                        <p className="text-slate-300">High-Cost Claimants: <span className="text-white font-medium">{results.large_claimant_summary.total_high_cost}</span></p>
                                    )}
                                    {results.large_claimant_summary.concentration_risk && (
                                        <p className="text-slate-300">Concentration: <span className="text-amber-400 font-medium">{results.large_claimant_summary.concentration_risk}</span></p>
                                    )}
                                    {results.large_claimant_summary.conditions && results.large_claimant_summary.conditions.length > 0 && (
                                        <div className="flex flex-wrap gap-1 mt-2">
                                            {results.large_claimant_summary.conditions.map((c, i) => (
                                                <span key={i} className="px-2 py-1 bg-red-500/20 text-red-300 rounded text-xs">{c}</span>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        
                        {/* Recommendations */}
                        {results.recommendations && results.recommendations.length > 0 && (
                            <div className="bg-slate-900/50 rounded-xl p-4">
                                <h4 className="text-sm font-semibold text-green-400 mb-3">✅ Recommendations</h4>
                                <div className="space-y-3">
                                    {results.recommendations.map((rec, i) => (
                                        <div key={i} className="bg-slate-800/50 rounded-lg p-3 border-l-2 border-green-500">
                                            <div className="flex items-start gap-2">
                                                <span className="text-green-400 font-bold text-sm">#{rec.priority || i + 1}</span>
                                                <div>
                                                    <p className="text-white text-sm font-medium">{typeof rec === 'string' ? rec : rec.action}</p>
                                                    {rec.rationale && <p className="text-slate-400 text-xs mt-1">{rec.rationale}</p>}
                                                    {rec.potential_savings && <p className="text-green-400 text-xs mt-1">💵 {rec.potential_savings}</p>}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {/* Renewal Outlook */}
                        {results.renewal_outlook && (
                            <div className="bg-slate-900/50 rounded-xl p-4">
                                <h4 className="text-sm font-semibold text-indigo-400 mb-3">📅 Renewal Outlook</h4>
                                <div className="space-y-2 text-sm">
                                    {results.renewal_outlook.projected_trend && (
                                        <p className="text-slate-300">Projected Trend: <span className="text-white font-medium">{results.renewal_outlook.projected_trend}</span></p>
                                    )}
                                    {results.renewal_outlook.confidence && (
                                        <p className="text-slate-300">Confidence: <span className="text-white font-medium">{results.renewal_outlook.confidence}</span></p>
                                    )}
                                    {results.renewal_outlook.factors && results.renewal_outlook.factors.length > 0 && (
                                        <div className="mt-2">
                                            <p className="text-slate-400 text-xs mb-1">Key Factors:</p>
                                            {results.renewal_outlook.factors.map((f, i) => (
                                                <p key={i} className="text-slate-300 text-xs">• {f}</p>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        
                        {/* Action Buttons */}
                        <div className="flex gap-3 pt-2 sticky bottom-0 bg-slate-900/95 py-3 -mx-2 px-2">
                            <button onClick={onComplete} className="flex-1 px-4 py-3 bg-green-600 hover:bg-green-500 rounded-lg font-medium">
                                Done
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="space-y-4">
                    {/* Drop Zone - Always visible */}
                    <div
                        className="drop-zone rounded-xl p-8 text-center cursor-pointer border-2 border-dashed border-blue-500/40 hover:border-blue-500 hover:bg-blue-500/5 transition-all"
                        onClick={() => document.getElementById('bulk-file-input').click()}
                        onDrop={(e) => { e.preventDefault(); handleFiles(e.dataTransfer.files); }}
                        onDragOver={(e) => { e.preventDefault(); e.currentTarget.classList.add('border-blue-500', 'bg-blue-500/10'); }}
                        onDragLeave={(e) => { e.currentTarget.classList.remove('border-blue-500', 'bg-blue-500/10'); }}
                    >
                        <span className="text-5xl">📂</span>
                        <p className="text-white font-medium mt-3 text-lg">Drop all your files here</p>
                        <p className="text-slate-400 text-sm mt-1">Census, claims, pharmacy, utilization — drop everything at once</p>
                        <p className="text-slate-500 text-xs mt-2">ZIP files are automatically extracted • We auto-detect each file type</p>
                        <p className="text-slate-500 text-xs mt-3">We'll auto-detect what each file contains</p>
                        <div className="flex gap-2 justify-center mt-4">
                            <span className="px-2 py-1 bg-slate-700/50 rounded text-xs text-slate-400">.xlsx</span>
                            <span className="px-2 py-1 bg-slate-700/50 rounded text-xs text-slate-400">.csv</span>
                            <span className="px-2 py-1 bg-slate-700/50 rounded text-xs text-slate-400">.zip</span>
                            <span className="px-2 py-1 bg-slate-700/50 rounded text-xs text-slate-400">.txt</span>
                            <span className="px-2 py-1 bg-slate-700/50 rounded text-xs text-slate-400">.json</span>
                        </div>
                        <input id="bulk-file-input" type="file" accept=".csv,.xlsx,.xls,.txt,.json,.zip" className="hidden" multiple onChange={(e) => handleFiles(e.target.files)} />
                    </div>
                    
                    {processing && (
                        <div className="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4 text-blue-400 text-sm flex items-center gap-3">
                            {Icons.loader} Processing files...
                        </div>
                    )}
                    
                    {/* File List */}
                    {files.length > 0 && (
                        <div className="space-y-3">
                            <p className="text-slate-400 text-sm font-medium">{files.length} file{files.length > 1 ? 's' : ''} ready for analysis</p>
                            
                            {files.map((f) => {
                                const typeInfo = getTypeInfo(f.dataType);
                                const isExpanded = expandedFile === f.id;
                                
                                return (
                                    <div key={f.id} className="bg-slate-800/50 rounded-xl border border-slate-700/50 overflow-hidden">
                                        {/* File Header */}
                                        <div className="flex items-center gap-3 p-4">
                                            <span className="text-2xl">{getFileIcon(f.name)}</span>
                                            <div className="flex-1 min-w-0">
                                                <p className="text-white font-medium truncate">{f.name}</p>
                                                <p className="text-slate-500 text-xs">{formatSize(f.size)} • {f.parsedData?.rowCount || 0} rows{f.sourceZip && <span className="text-blue-400 ml-1">• from {f.sourceZip}</span>}</p>
                                            </div>
                                            
                                            {/* Data Type Selector */}
                                            <div className="flex items-center gap-2">
                                                <span className="text-xl">{typeInfo.icon}</span>
                                                <select
                                                    className="bg-slate-900 border border-slate-600 rounded-lg px-3 py-1.5 text-sm text-white"
                                                    value={f.dataType}
                                                    onChange={(e) => updateFileType(f.id, e.target.value)}
                                                >
                                                    {DATA_TYPES.map(t => (
                                                        <option key={t.id} value={t.id}>{t.name}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            
                                            {/* Status Badge */}
                                            {f.status === 'ready' && (
                                                <span className="px-2 py-1 bg-green-500/20 text-green-400 rounded text-xs">✓ Ready</span>
                                            )}
                                            {f.status === 'error' && (
                                                <span className="px-2 py-1 bg-red-500/20 text-red-400 rounded text-xs">Error</span>
                                            )}
                                            
                                            {/* Expand/Collapse */}
                                            <button
                                                className="p-2 text-slate-400 hover:text-white"
                                                onClick={() => setExpandedFile(isExpanded ? null : f.id)}
                                            >
                                                {isExpanded ? '▼' : '▶'}
                                            </button>
                                            
                                            {/* Remove */}
                                            <button
                                                className="p-2 text-slate-400 hover:text-red-400"
                                                onClick={() => removeFile(f.id)}
                                            >
                                                ✕
                                            </button>
                                        </div>
                                        
                                        {/* Expanded Details */}
                                        {isExpanded && f.mappings.length > 0 && (
                                            <div className="border-t border-slate-700/50 p-4 bg-slate-900/30">
                                                <p className="text-slate-400 text-xs mb-2">Column Mappings ({f.mappings.filter(m => m.confidence >= 80).length}/{f.mappings.length} auto-detected)</p>
                                                <div className="grid grid-cols-2 gap-2 max-h-32 overflow-y-auto">
                                                    {f.mappings.slice(0, 10).map((m, i) => (
                                                        <div key={i} className="flex items-center gap-2 text-xs">
                                                            <span className="text-slate-500 font-mono truncate max-w-20">{m.sourceColumn}</span>
                                                            <span className="text-slate-600">→</span>
                                                            <span className="text-green-400">{m.standardField}</span>
                                                        </div>
                                                    ))}
                                                    {f.mappings.length > 10 && (
                                                        <span className="text-slate-500 text-xs">+{f.mappings.length - 10} more</span>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* Error Message */}
                                        {f.error && (
                                            <div className="border-t border-red-500/30 p-3 bg-red-500/10">
                                                <p className="text-red-400 text-sm">{f.error}</p>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    )}
                    
                    {error && (
                        <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4 text-red-400 text-sm">{error}</div>
                    )}
                    
                    {progress && (
                        <div className="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4 text-blue-400 text-sm flex items-center gap-3">
                            {Icons.loader} {progress}
                        </div>
                    )}
                    
                    {/* Action Buttons */}
                    <div className="flex gap-3 pt-2">
                        <button onClick={onCancel} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">
                            Cancel
                        </button>
                        <button
                            onClick={runAnalysis}
                            disabled={analyzing || files.filter(f => f.status === 'ready').length === 0}
                            className="flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-500 disabled:bg-slate-600 disabled:cursor-not-allowed rounded-lg font-medium flex items-center justify-center gap-2"
                        >
                            {analyzing ? (
                                <>{Icons.loader} Analyzing...</>
                            ) : (
                                <>{Icons.sparkles} Run Analysis ({files.filter(f => f.status === 'ready').length} files)</>
                            )}
                        </button>
                    </div>
                </div>
            );
        };

        // ═══════════════════════════════════════════════════════════════════════════
        // CLIENT PORTAL (Preserved from v4.4)
        // ═══════════════════════════════════════════════════════════════════════════
        const ClientPortal = ({ clients, analyses }) => {
            const [portalClient, setPortalClient] = useState(null);
            const [accessCode, setAccessCode] = useState('');
            
            const generateAccessCode = (clientId) => `CE-${clientId.substring(0, 8).toUpperCase()}`;
            const getClientAnalyses = (clientId) => analyses.filter(a => a.client_id === clientId);
            
            const validateAccessCode = () => {
                const matchingClient = clients.find(c => generateAccessCode(c.id) === accessCode.toUpperCase());
                if (matchingClient) setPortalClient(matchingClient);
                else alert('Invalid access code');
            };
            
            if (portalClient) {
                const clientAnalyses = getClientAnalyses(portalClient.id);
                const latestAnalysis = clientAnalyses[0];
                const findings = latestAnalysis?.findings || {};
                
                return (
                    <div className="min-h-screen portal-gradient p-8">
                        <div className="max-w-4xl mx-auto space-y-6">
                            <div className="flex justify-between items-center">
                                <h2 className="text-2xl font-bold text-white">{portalClient.company_name}</h2>
                                <button onClick={() => setPortalClient(null)} className="text-slate-400 hover:text-white">Sign Out</button>
                            </div>
                            
                            <div className="grid grid-cols-3 gap-4">
                                <div className="insight-card rounded-xl p-5 border border-white/10">
                                    <p className="text-slate-400 text-sm">Total Lives</p>
                                    <p className="text-2xl font-bold text-white">{findings.census_profile?.total_lives || portalClient.employee_count || '—'}</p>
                                </div>
                                <div className="insight-card rounded-xl p-5 border border-white/10">
                                    <p className="text-slate-400 text-sm">Risk Score</p>
                                    <p className="text-2xl font-bold text-white">{findings.risk_assessment?.overall_score || '—'}</p>
                                </div>
                                <div className="insight-card rounded-xl p-5 border border-white/10">
                                    <p className="text-slate-400 text-sm">Funding Type</p>
                                    <p className="text-lg font-bold text-white">{portalClient.funding_type || '—'}</p>
                                </div>
                            </div>
                            
                            {findings.executive_summary && (
                                <div className="insight-card rounded-xl p-6 border border-white/10">
                                    <h3 className="text-lg font-semibold text-white mb-3">Executive Summary</h3>
                                    <p className="text-slate-300">{findings.executive_summary}</p>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="space-y-6">
                    <div className="bg-gradient-to-r from-purple-600/20 to-blue-600/20 border border-purple-500/30 rounded-xl p-6">
                        <h3 className="text-xl font-bold text-white mb-2">Client Portal</h3>
                        <p className="text-slate-300">Provide clients with secure access to their health intelligence.</p>
                    </div>
                    
                    <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-5">
                        <h4 className="font-semibold text-white mb-4">Preview as Client</h4>
                        <div className="space-y-2 max-h-64 overflow-y-auto">
                            {clients.map(client => (
                                <button key={client.id} onClick={() => setPortalClient(client)}
                                    className="w-full flex items-center justify-between p-3 bg-slate-800/50 hover:bg-slate-700/50 rounded-lg text-left">
                                    <div>
                                        <p className="text-white font-medium">{client.company_name}</p>
                                        <p className="text-slate-400 text-sm mono">{generateAccessCode(client.id)}</p>
                                    </div>
                                    {Icons.eye}
                                </button>
                            ))}
                        </div>
                    </div>
                    
                    <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-5">
                        <h4 className="font-semibold text-white mb-4">Client Access</h4>
                        <div className="flex gap-3">
                            <input type="text" value={accessCode} onChange={(e) => setAccessCode(e.target.value.toUpperCase())}
                                placeholder="Enter access code (CE-XXXXXXXX)" className="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white mono" />
                            <button onClick={validateAccessCode} className="px-6 py-3 bg-purple-600 hover:bg-purple-500 rounded-lg font-medium">Access</button>
                        </div>
                    </div>
                </div>
            );
        };

        // ═══════════════════════════════════════════════════════════════════════════
        // INTELLIGENCE FEED COMPONENT
        // ═══════════════════════════════════════════════════════════════════════════
        const IntelligenceFeed = ({ alerts, clients, onRefresh, onSelectClient, compact = false }) => {
            const [filter, setFilter] = useState('all'); // 'all', 'critical', 'warning', 'info'
            const [updating, setUpdating] = useState(null);
            
            const getClientName = (clientId) => clients.find(c => c.id === clientId)?.company_name || 'Unknown';
            
            const activeAlerts = alerts.filter(a => 
                a.status !== 'completed' && 
                a.status !== 'dismissed' &&
                (!a.snoozed_until || new Date(a.snoozed_until) < new Date()) &&
                (!a.expires_at || new Date(a.expires_at) > new Date())
            );
            
            const filteredAlerts = filter === 'all' 
                ? activeAlerts 
                : activeAlerts.filter(a => a.severity === filter);
            
            const sortedAlerts = [...filteredAlerts].sort((a, b) => {
                const severityOrder = { critical: 0, warning: 1, info: 2 };
                if (severityOrder[a.severity] !== severityOrder[b.severity]) {
                    return severityOrder[a.severity] - severityOrder[b.severity];
                }
                return new Date(b.generated_at) - new Date(a.generated_at);
            });
            
            const handleAction = async (alertId, action) => {
                setUpdating(alertId);
                try {
                    const updates = { updated_at: new Date().toISOString() };
                    
                    if (action === 'complete') {
                        updates.status = 'completed';
                        updates.completed_at = new Date().toISOString();
                    } else if (action === 'dismiss') {
                        updates.status = 'dismissed';
                        updates.dismissed_at = new Date().toISOString();
                    } else if (action === 'snooze') {
                        updates.status = 'snoozed';
                        const snoozeDate = new Date();
                        snoozeDate.setDate(snoozeDate.getDate() + 7);
                        updates.snoozed_until = snoozeDate.toISOString();
                    } else if (action === 'view') {
                        if (updates.status === 'new') updates.status = 'viewed';
                    }
                    
                    await supabase.from('agent_alerts').update(updates).eq('id', alertId);
                    onRefresh();
                } catch (err) {
                    console.error('Error updating alert:', err);
                }
                setUpdating(null);
            };
            
            const getSeverityStyles = (severity) => {
                switch (severity) {
                    case 'critical': return { bg: 'bg-red-500/10', border: 'border-red-500/30', icon: '🚨', text: 'text-red-400' };
                    case 'warning': return { bg: 'bg-amber-500/10', border: 'border-amber-500/30', icon: '⚠️', text: 'text-amber-400' };
                    default: return { bg: 'bg-blue-500/10', border: 'border-blue-500/30', icon: 'ℹ️', text: 'text-blue-400' };
                }
            };
            
            const getAgentLabel = (type) => {
                switch (type) {
                    case 'renewal_countdown': return 'Renewal';
                    case 'population_shift': return 'Population';
                    case 'compliance': return 'Compliance';
                    default: return 'Alert';
                }
            };
            
            const criticalCount = activeAlerts.filter(a => a.severity === 'critical').length;
            const warningCount = activeAlerts.filter(a => a.severity === 'warning').length;
            
            if (compact) {
                return (
                    <div className="bg-slate-850 border border-slate-700/50 rounded-xl overflow-hidden">
                        <div className="p-4 border-b border-slate-700/50 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <h3 className="font-semibold text-white">Intelligence Feed</h3>
                                {activeAlerts.length > 0 && (
                                    <span className="px-2 py-0.5 bg-blue-500/20 text-blue-400 text-xs rounded-full font-medium">
                                        {activeAlerts.length} active
                                    </span>
                                )}
                                {criticalCount > 0 && (
                                    <span className="px-2 py-0.5 bg-red-500/20 text-red-400 text-xs rounded-full font-medium">
                                        {criticalCount} critical
                                    </span>
                                )}
                            </div>
                        </div>
                        <div className="max-h-80 overflow-y-auto">
                            {sortedAlerts.slice(0, 5).map(alert => {
                                const styles = getSeverityStyles(alert.severity);
                                return (
                                    <div key={alert.id} className={`p-4 border-b border-slate-700/30 ${styles.bg} hover:bg-opacity-50 transition-colors`}>
                                        <div className="flex items-start gap-3">
                                            <span className="text-lg">{styles.icon}</span>
                                            <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className={`text-xs font-medium px-1.5 py-0.5 rounded ${styles.bg} ${styles.text}`}>
                                                        {getAgentLabel(alert.agent_type)}
                                                    </span>
                                                    <span className="text-slate-500 text-xs">{getClientName(alert.client_id)}</span>
                                                </div>
                                                <p className="text-white text-sm font-medium">{alert.title}</p>
                                                <p className="text-slate-400 text-xs mt-1 line-clamp-2">{alert.message}</p>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                            {activeAlerts.length === 0 && (
                                <div className="p-8 text-center text-slate-500">
                                    <p>No active alerts</p>
                                    <p className="text-xs mt-1">Agents are monitoring your clients</p>
                                </div>
                            )}
                        </div>
                        {activeAlerts.length > 5 && (
                            <div className="p-3 border-t border-slate-700/50 text-center">
                                <button className="text-blue-400 text-sm hover:underline">
                                    View all {activeAlerts.length} alerts →
                                </button>
                            </div>
                        )}
                    </div>
                );
            }
            
            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-indigo-600/20 to-cyan-600/20 border border-indigo-500/30 rounded-xl p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <h3 className="text-xl font-bold text-white mb-2">Intelligence Feed</h3>
                                <p className="text-slate-300">AI agents continuously monitor your clients and surface what needs attention.</p>
                            </div>
                            <div className="flex items-center gap-4">
                                {criticalCount > 0 && (
                                    <div className="text-center">
                                        <p className="text-2xl font-bold text-red-400">{criticalCount}</p>
                                        <p className="text-xs text-red-400/70">Critical</p>
                                    </div>
                                )}
                                {warningCount > 0 && (
                                    <div className="text-center">
                                        <p className="text-2xl font-bold text-amber-400">{warningCount}</p>
                                        <p className="text-xs text-amber-400/70">Warning</p>
                                    </div>
                                )}
                                <div className="text-center">
                                    <p className="text-2xl font-bold text-white">{activeAlerts.length}</p>
                                    <p className="text-xs text-slate-400">Total Active</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Filters */}
                    <div className="flex gap-2">
                        {['all', 'critical', 'warning', 'info'].map(f => (
                            <button key={f} onClick={() => setFilter(f)}
                                className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors capitalize ${filter === f ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>
                                {f} {f !== 'all' && `(${activeAlerts.filter(a => a.severity === f).length})`}
                            </button>
                        ))}
                    </div>
                    
                    {/* Alert List */}
                    <div className="space-y-3">
                        {sortedAlerts.map(alert => {
                            const styles = getSeverityStyles(alert.severity);
                            const details = alert.detail_json || {};
                            
                            return (
                                <div key={alert.id} className={`${styles.bg} border ${styles.border} rounded-xl p-5 transition-all hover:scale-[1.01]`}>
                                    <div className="flex items-start gap-4">
                                        <span className="text-2xl">{styles.icon}</span>
                                        <div className="flex-1">
                                            <div className="flex items-center gap-3 mb-2">
                                                <span className={`text-xs font-semibold px-2 py-1 rounded ${styles.bg} ${styles.text} border ${styles.border}`}>
                                                    {getAgentLabel(alert.agent_type)}
                                                </span>
                                                <span className="text-slate-400 text-sm">•</span>
                                                <button onClick={() => onSelectClient && onSelectClient(clients.find(c => c.id === alert.client_id))}
                                                    className="text-white font-medium hover:text-blue-400 transition-colors">
                                                    {getClientName(alert.client_id)}
                                                </button>
                                                <span className="text-slate-500 text-xs ml-auto">
                                                    {new Date(alert.generated_at).toLocaleDateString()}
                                                </span>
                                            </div>
                                            
                                            <h4 className="text-white font-semibold text-lg mb-1">{alert.title}</h4>
                                            <p className="text-slate-300">{alert.message}</p>
                                            
                                            {/* Detail chips */}
                                            {Object.keys(details).length > 0 && (
                                                <div className="flex flex-wrap gap-2 mt-3">
                                                    {details.days_until_renewal && (
                                                        <span className="px-2 py-1 bg-slate-800 rounded text-xs text-slate-300">
                                                            📅 {details.days_until_renewal} days until renewal
                                                        </span>
                                                    )}
                                                    {details.score_delta && (
                                                        <span className={`px-2 py-1 rounded text-xs ${details.score_delta > 0 ? 'bg-red-500/20 text-red-300' : 'bg-green-500/20 text-green-300'}`}>
                                                            📊 {details.score_delta > 0 ? '+' : ''}{details.score_delta} risk points
                                                        </span>
                                                    )}
                                                    {details.lives_delta && details.lives_delta !== 0 && (
                                                        <span className="px-2 py-1 bg-slate-800 rounded text-xs text-slate-300">
                                                            👥 {details.lives_delta > 0 ? '+' : ''}{details.lives_delta} lives
                                                        </span>
                                                    )}
                                                </div>
                                            )}
                                            
                                            {/* Actions */}
                                            <div className="flex items-center gap-2 mt-4">
                                                {alert.action_label && (
                                                    <button className="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm font-medium transition-colors">
                                                        {alert.action_label}
                                                    </button>
                                                )}
                                                <button onClick={() => handleAction(alert.id, 'complete')} disabled={updating === alert.id}
                                                    className="px-3 py-2 bg-green-600/20 hover:bg-green-600/30 text-green-400 rounded-lg text-sm font-medium transition-colors">
                                                    {updating === alert.id ? '...' : '✓ Complete'}
                                                </button>
                                                <button onClick={() => handleAction(alert.id, 'snooze')} disabled={updating === alert.id}
                                                    className="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg text-sm transition-colors">
                                                    Snooze 7d
                                                </button>
                                                <button onClick={() => handleAction(alert.id, 'dismiss')} disabled={updating === alert.id}
                                                    className="px-3 py-2 text-slate-500 hover:text-slate-300 text-sm transition-colors">
                                                    Dismiss
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                        
                        {sortedAlerts.length === 0 && (
                            <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-12 text-center">
                                <div className="text-4xl mb-4">✅</div>
                                <h4 className="text-white font-semibold text-lg mb-2">All Clear</h4>
                                <p className="text-slate-400">No {filter !== 'all' ? filter : 'active'} alerts at this time.</p>
                                <p className="text-slate-500 text-sm mt-2">Agents are continuously monitoring your clients.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // ═══════════════════════════════════════════════════════════════════════════
        // IMPLEMENTATION AGENT - VENDOR IMPLEMENTATION TRACKING
        // ═══════════════════════════════════════════════════════════════════════════
        
        const IMPLEMENTATION_TYPES = [
            { value: 'telemedicine', label: 'Telemedicine', icon: '🏥' },
            { value: 'wellness', label: 'Wellness Program', icon: '💪' },
            { value: 'pbm', label: 'PBM / Pharmacy', icon: '💊' },
            { value: 'mental_health', label: 'Mental Health / EAP', icon: '🧠' },
            { value: 'navigation', label: 'Care Navigation', icon: '🧭' },
            { value: 'diabetes', label: 'Diabetes Management', icon: '📊' },
            { value: 'msk', label: 'MSK / Physical Therapy', icon: '🦴' },
            { value: 'fertility', label: 'Fertility Benefits', icon: '👶' },
            { value: 'other', label: 'Other', icon: '📋' },
        ];
        
        const TASK_STATUSES = [
            { value: 'not_started', label: 'Not Started', icon: '⬜', color: 'slate' },
            { value: 'in_progress', label: 'In Progress', icon: '🔄', color: 'blue' },
            { value: 'blocked', label: 'Blocked', icon: '⚠️', color: 'red' },
            { value: 'complete', label: 'Complete', icon: '✅', color: 'green' },
        ];
        
        const OWNER_TYPES = [
            { value: 'client', label: 'Client', color: 'blue', bgClass: 'bg-blue-500/20 border-blue-500/30 text-blue-400' },
            { value: 'vendor', label: 'Vendor', color: 'orange', bgClass: 'bg-orange-500/20 border-orange-500/30 text-orange-400' },
            { value: 'consultant', label: 'Consultant', color: 'purple', bgClass: 'bg-purple-500/20 border-purple-500/30 text-purple-400' },
        ];
        
        const ProgressBar = ({ value, color, label, showLabel = true }) => {
            const colorClasses = {
                blue: 'from-blue-500 to-blue-400',
                orange: 'from-orange-500 to-orange-400',
                green: 'from-green-500 to-emerald-400',
                red: 'from-red-500 to-red-400',
            };
            return (
                <div className="space-y-1">
                    {showLabel && (
                        <div className="flex justify-between text-sm">
                            <span className="text-slate-400">{label}</span>
                            <span className="text-white font-medium">{value}%</span>
                        </div>
                    )}
                    <div className="h-2 bg-slate-700 rounded-full overflow-hidden">
                        <div className={`h-full bg-gradient-to-r ${colorClasses[color]} rounded-full transition-all duration-500`} style={{ width: `${value}%` }}></div>
                    </div>
                </div>
            );
        };
        
        const ImplementationCard = ({ impl, client, onSelect, onUpdate }) => {
            const type = IMPLEMENTATION_TYPES.find(t => t.value === impl.implementation_type) || IMPLEMENTATION_TYPES[8];
            const daysRemaining = impl.target_completion_date ? Math.ceil((new Date(impl.target_completion_date) - new Date()) / (1000 * 60 * 60 * 24)) : null;
            
            const getHealthColor = () => {
                if (impl.status === 'completed') return 'border-green-500/30 bg-green-500/5';
                if (impl.status === 'at_risk' || daysRemaining < 0) return 'border-red-500/30 bg-red-500/5';
                if (daysRemaining !== null && daysRemaining <= 7) return 'border-amber-500/30 bg-amber-500/5';
                return 'border-slate-700/50';
            };
            
            return (
                <div onClick={() => onSelect(impl)} className={`bg-slate-850 border ${getHealthColor()} rounded-xl p-5 cursor-pointer hover:scale-[1.01] transition-all`}>
                    <div className="flex items-start justify-between mb-4">
                        <div className="flex items-center gap-3">
                            <span className="text-2xl">{type.icon}</span>
                            <div>
                                <h4 className="text-white font-semibold">{impl.title}</h4>
                                <p className="text-slate-400 text-sm">{client?.company_name} • {impl.vendor_name || 'No vendor'}</p>
                            </div>
                        </div>
                        <div className="text-right">
                            {daysRemaining !== null && (
                                <p className={`text-sm font-medium ${daysRemaining < 0 ? 'text-red-400' : daysRemaining <= 7 ? 'text-amber-400' : 'text-slate-400'}`}>
                                    {daysRemaining < 0 ? `${Math.abs(daysRemaining)}d overdue` : daysRemaining === 0 ? 'Due today' : `${daysRemaining}d remaining`}
                                </p>
                            )}
                            <p className="text-slate-500 text-xs">{impl.target_completion_date ? new Date(impl.target_completion_date).toLocaleDateString() : 'No target date'}</p>
                        </div>
                    </div>
                    
                    <div className="space-y-3">
                        <ProgressBar value={impl.client_progress || 0} color="blue" label="🔵 Client" />
                        <ProgressBar value={impl.vendor_progress || 0} color="orange" label="🟠 Vendor" />
                        <ProgressBar value={impl.overall_progress || 0} color="green" label="🟢 Overall" />
                    </div>
                </div>
            );
        };
        
        const ImplementationDetail = ({ implementation, tasks, client, onClose, onUpdateTask, onAddTask, onDeleteTask, onUpdateImpl }) => {
            const [showAddTask, setShowAddTask] = useState(false);
            const [editingTask, setEditingTask] = useState(null);
            const [newTask, setNewTask] = useState({ title: '', owner_type: 'client', due_date: '', description: '' });
            const [activeTab, setActiveTab] = useState('all'); // 'all', 'client', 'vendor'
            
            const type = IMPLEMENTATION_TYPES.find(t => t.value === implementation.implementation_type) || IMPLEMENTATION_TYPES[8];
            const daysRemaining = implementation.target_completion_date ? Math.ceil((new Date(implementation.target_completion_date) - new Date()) / (1000 * 60 * 60 * 24)) : null;
            
            const filteredTasks = activeTab === 'all' ? tasks : tasks.filter(t => t.owner_type === activeTab);
            const sortedTasks = [...filteredTasks].sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0));
            
            const clientTasks = tasks.filter(t => t.owner_type === 'client');
            const vendorTasks = tasks.filter(t => t.owner_type === 'vendor');
            const clientComplete = clientTasks.filter(t => t.status === 'complete').length;
            const vendorComplete = vendorTasks.filter(t => t.status === 'complete').length;
            
            const handleAddTask = async () => {
                if (!newTask.title.trim()) return;
                await onAddTask({ ...newTask, implementation_id: implementation.id, sort_order: tasks.length });
                setNewTask({ title: '', owner_type: 'client', due_date: '', description: '' });
                setShowAddTask(false);
            };
            
            const cycleTaskStatus = async (task) => {
                const statusOrder = ['not_started', 'in_progress', 'blocked', 'complete'];
                const currentIndex = statusOrder.indexOf(task.status);
                const nextStatus = statusOrder[(currentIndex + 1) % statusOrder.length];
                await onUpdateTask(task.id, { status: nextStatus, completed_date: nextStatus === 'complete' ? new Date().toISOString() : null });
            };
            
            return (
                <div className="fixed inset-0 z-50 flex">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative ml-auto w-full max-w-3xl bg-slate-900 border-l border-slate-700 h-full overflow-hidden flex flex-col animate-fade-in">
                        {/* Header */}
                        <div className="p-6 border-b border-slate-700/50">
                            <div className="flex items-start justify-between mb-4">
                                <div className="flex items-center gap-3">
                                    <span className="text-3xl">{type.icon}</span>
                                    <div>
                                        <h2 className="text-xl font-bold text-white">{implementation.title}</h2>
                                        <p className="text-slate-400">{client?.company_name} • {implementation.vendor_name || 'No vendor assigned'}</p>
                                    </div>
                                </div>
                                <button onClick={onClose} className="p-2 hover:bg-slate-700 rounded-lg">{Icons.close}</button>
                            </div>
                            
                            {/* Progress Summary */}
                            <div className="grid grid-cols-3 gap-4 mt-4">
                                <div className="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4">
                                    <div className="flex items-center justify-between mb-2">
                                        <span className="text-blue-400 text-sm font-medium">🔵 Client</span>
                                        <span className="text-white font-bold">{implementation.client_progress || 0}%</span>
                                    </div>
                                    <ProgressBar value={implementation.client_progress || 0} color="blue" showLabel={false} />
                                    <p className="text-blue-300/70 text-xs mt-2">{clientComplete}/{clientTasks.length} tasks</p>
                                </div>
                                <div className="bg-orange-500/10 border border-orange-500/30 rounded-xl p-4">
                                    <div className="flex items-center justify-between mb-2">
                                        <span className="text-orange-400 text-sm font-medium">🟠 Vendor</span>
                                        <span className="text-white font-bold">{implementation.vendor_progress || 0}%</span>
                                    </div>
                                    <ProgressBar value={implementation.vendor_progress || 0} color="orange" showLabel={false} />
                                    <p className="text-orange-300/70 text-xs mt-2">{vendorComplete}/{vendorTasks.length} tasks</p>
                                </div>
                                <div className="bg-green-500/10 border border-green-500/30 rounded-xl p-4">
                                    <div className="flex items-center justify-between mb-2">
                                        <span className="text-green-400 text-sm font-medium">🟢 Overall</span>
                                        <span className="text-white font-bold">{implementation.overall_progress || 0}%</span>
                                    </div>
                                    <ProgressBar value={implementation.overall_progress || 0} color="green" showLabel={false} />
                                    <p className="text-green-300/70 text-xs mt-2">
                                        {daysRemaining !== null ? (
                                            daysRemaining < 0 ? <span className="text-red-400">{Math.abs(daysRemaining)}d overdue</span> :
                                            daysRemaining === 0 ? 'Due today' : `${daysRemaining}d remaining`
                                        ) : 'No target date'}
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        {/* Task Tabs */}
                        <div className="px-6 py-3 border-b border-slate-700/50 flex items-center justify-between">
                            <div className="flex gap-2">
                                {[
                                    { id: 'all', label: 'All Tasks' },
                                    { id: 'client', label: '🔵 Client' },
                                    { id: 'vendor', label: '🟠 Vendor' },
                                ].map(tab => (
                                    <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                                        className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${activeTab === tab.id ? 'bg-slate-700 text-white' : 'text-slate-400 hover:text-white'}`}>
                                        {tab.label}
                                    </button>
                                ))}
                            </div>
                            <button onClick={() => setShowAddTask(true)} className="flex items-center gap-2 px-3 py-1.5 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm font-medium">
                                {Icons.plus} Add Task
                            </button>
                        </div>
                        
                        {/* Task List */}
                        <div className="flex-1 overflow-y-auto p-6 space-y-2">
                            {sortedTasks.map(task => {
                                const status = TASK_STATUSES.find(s => s.value === task.status) || TASK_STATUSES[0];
                                const owner = OWNER_TYPES.find(o => o.value === task.owner_type) || OWNER_TYPES[0];
                                const isOverdue = task.due_date && new Date(task.due_date) < new Date() && task.status !== 'complete';
                                
                                return (
                                    <div key={task.id} className={`flex items-center gap-3 p-3 rounded-lg border transition-all ${task.status === 'complete' ? 'bg-green-500/5 border-green-500/20' : task.status === 'blocked' ? 'bg-red-500/5 border-red-500/20' : 'bg-slate-800/50 border-slate-700/50 hover:border-slate-600'}`}>
                                        <button onClick={() => cycleTaskStatus(task)} className="text-xl flex-shrink-0 hover:scale-110 transition-transform">
                                            {status.icon}
                                        </button>
                                        <div className="flex-1 min-w-0">
                                            <p className={`font-medium ${task.status === 'complete' ? 'text-slate-400 line-through' : 'text-white'}`}>{task.title}</p>
                                            <div className="flex items-center gap-2 mt-1">
                                                <span className={`text-xs px-1.5 py-0.5 rounded border ${owner.bgClass}`}>{owner.label}</span>
                                                {task.due_date && (
                                                    <span className={`text-xs ${isOverdue ? 'text-red-400' : 'text-slate-500'}`}>
                                                        Due: {new Date(task.due_date).toLocaleDateString()}
                                                    </span>
                                                )}
                                                {task.status === 'blocked' && task.blocked_reason && (
                                                    <span className="text-xs text-red-400">⚠️ {task.blocked_reason}</span>
                                                )}
                                            </div>
                                        </div>
                                        <button onClick={() => onDeleteTask(task.id)} className="p-1.5 text-slate-500 hover:text-red-400 opacity-0 group-hover:opacity-100">
                                            {Icons.trash}
                                        </button>
                                    </div>
                                );
                            })}
                            
                            {sortedTasks.length === 0 && (
                                <div className="text-center py-12 text-slate-500">
                                    <p>No tasks yet</p>
                                    <button onClick={() => setShowAddTask(true)} className="text-blue-400 text-sm mt-2 hover:underline">Add your first task</button>
                                </div>
                            )}
                        </div>
                        
                        {/* Add Task Form */}
                        {showAddTask && (
                            <div className="absolute inset-0 bg-black/50 flex items-center justify-center p-6">
                                <div className="bg-slate-850 border border-slate-700 rounded-xl p-6 w-full max-w-md">
                                    <h3 className="text-lg font-semibold text-white mb-4">Add Task</h3>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm text-slate-400 mb-1">Task Title *</label>
                                            <input type="text" value={newTask.title} onChange={(e) => setNewTask({...newTask, title: e.target.value})}
                                                placeholder="e.g., Sign vendor contract" className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500" />
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm text-slate-400 mb-1">Owner</label>
                                                <select value={newTask.owner_type} onChange={(e) => setNewTask({...newTask, owner_type: e.target.value})}
                                                    className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500">
                                                    {OWNER_TYPES.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm text-slate-400 mb-1">Due Date</label>
                                                <input type="date" value={newTask.due_date} onChange={(e) => setNewTask({...newTask, due_date: e.target.value})}
                                                    className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500" />
                                            </div>
                                        </div>
                                        <div className="flex gap-3 pt-2">
                                            <button onClick={() => setShowAddTask(false)} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Cancel</button>
                                            <button onClick={handleAddTask} className="flex-1 px-4 py-2.5 bg-blue-600 hover:bg-blue-500 rounded-lg font-medium">Add Task</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        
        const ImplementationAgent = ({ clients, selectedClientId = null }) => {
            const [implementations, setImplementations] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedImpl, setSelectedImpl] = useState(null);
            const [showAddImpl, setShowAddImpl] = useState(false);
            const [filterClient, setFilterClient] = useState(selectedClientId || '');
            const [filterStatus, setFilterStatus] = useState('active'); // 'all', 'active', 'completed'
            const [newImpl, setNewImpl] = useState({ client_id: '', title: '', vendor_name: '', implementation_type: 'telemedicine', target_completion_date: '', description: '' });
            
            const fetchData = useCallback(async () => {
                setLoading(true);
                try {
                    let implQuery = supabase.from('implementations').select('*').order('created_at', { ascending: false });
                    if (filterClient) implQuery = implQuery.eq('client_id', filterClient);
                    if (filterStatus === 'active') implQuery = implQuery.neq('status', 'completed').neq('status', 'cancelled');
                    if (filterStatus === 'completed') implQuery = implQuery.eq('status', 'completed');
                    
                    const { data: implData } = await implQuery;
                    setImplementations(implData || []);
                    
                    if (implData?.length > 0) {
                        const implIds = implData.map(i => i.id);
                        const { data: taskData } = await supabase.from('implementation_tasks').select('*').in('implementation_id', implIds).order('sort_order');
                        setTasks(taskData || []);
                    } else {
                        setTasks([]);
                    }
                } catch (err) { console.error(err); }
                setLoading(false);
            }, [filterClient, filterStatus]);
            
            useEffect(() => { fetchData(); }, [fetchData]);
            useEffect(() => { if (selectedClientId) setFilterClient(selectedClientId); }, [selectedClientId]);
            
            const getClientById = (id) => clients.find(c => c.id === id);
            const getImplTasks = (implId) => tasks.filter(t => t.implementation_id === implId);
            
            const handleAddImpl = async () => {
                if (!newImpl.client_id || !newImpl.title) return;
                try {
                    const { data, error } = await supabase.from('implementations').insert([newImpl]).select();
                    if (error) throw error;
                    setShowAddImpl(false);
                    setNewImpl({ client_id: '', title: '', vendor_name: '', implementation_type: 'telemedicine', target_completion_date: '', description: '' });
                    fetchData();
                } catch (err) { alert('Error: ' + err.message); }
            };
            
            const handleUpdateTask = async (taskId, updates) => {
                try {
                    await supabase.from('implementation_tasks').update({ ...updates, updated_at: new Date().toISOString() }).eq('id', taskId);
                    fetchData();
                } catch (err) { console.error(err); }
            };
            
            const handleAddTask = async (task) => {
                try {
                    await supabase.from('implementation_tasks').insert([task]);
                    fetchData();
                } catch (err) { alert('Error: ' + err.message); }
            };
            
            const handleDeleteTask = async (taskId) => {
                if (!confirm('Delete this task?')) return;
                try {
                    await supabase.from('implementation_tasks').delete().eq('id', taskId);
                    fetchData();
                } catch (err) { console.error(err); }
            };
            
            // Stats
            const activeImpls = implementations.filter(i => i.status !== 'completed' && i.status !== 'cancelled');
            const atRiskImpls = activeImpls.filter(i => {
                const daysRemaining = i.target_completion_date ? Math.ceil((new Date(i.target_completion_date) - new Date()) / (1000 * 60 * 60 * 24)) : null;
                return daysRemaining !== null && daysRemaining <= 7;
            });
            const blockedTasks = tasks.filter(t => t.status === 'blocked');
            
            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-emerald-600/20 to-blue-600/20 border border-emerald-500/30 rounded-xl p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <h3 className="text-xl font-bold text-white mb-2">Vendor Implementation Tracker</h3>
                                <p className="text-slate-300">Track implementation progress with clear client and vendor accountability.</p>
                            </div>
                            <button onClick={() => setShowAddImpl(true)} className="flex items-center gap-2 px-4 py-2.5 bg-emerald-600 hover:bg-emerald-500 rounded-lg font-medium">
                                {Icons.plus} New Implementation
                            </button>
                        </div>
                    </div>
                    
                    {/* Stats */}
                    <div className="grid grid-cols-4 gap-4">
                        <StatCard title="Active" value={activeImpls.length} icon={Icons.trending} color="bg-blue-500/20 text-blue-400" />
                        <StatCard title="At Risk" value={atRiskImpls.length} icon={Icons.alert} color="bg-amber-500/20 text-amber-400" />
                        <StatCard title="Blocked Tasks" value={blockedTasks.length} icon={Icons.shield} color="bg-red-500/20 text-red-400" />
                        <StatCard title="Completed" value={implementations.filter(i => i.status === 'completed').length} icon={Icons.check} color="bg-green-500/20 text-green-400" />
                    </div>
                    
                    {/* Filters */}
                    <div className="flex items-center gap-4">
                        <select value={filterClient} onChange={(e) => setFilterClient(e.target.value)}
                            className="bg-slate-850 border border-slate-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
                            <option value="">All Clients</option>
                            {clients.map(c => <option key={c.id} value={c.id}>{c.company_name}</option>)}
                        </select>
                        <div className="flex gap-2">
                            {['active', 'completed', 'all'].map(s => (
                                <button key={s} onClick={() => setFilterStatus(s)}
                                    className={`px-3 py-2 rounded-lg text-sm font-medium capitalize ${filterStatus === s ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>
                                    {s}
                                </button>
                            ))}
                        </div>
                    </div>
                    
                    {/* Implementation Grid */}
                    {loading ? (
                        <div className="text-center py-12 text-slate-500">{Icons.loader} Loading...</div>
                    ) : implementations.length === 0 ? (
                        <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-12 text-center">
                            <div className="text-4xl mb-4">📋</div>
                            <h4 className="text-white font-semibold text-lg mb-2">No Implementations</h4>
                            <p className="text-slate-400 mb-4">Start tracking vendor implementations to monitor progress.</p>
                            <button onClick={() => setShowAddImpl(true)} className="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg font-medium">
                                Create First Implementation
                            </button>
                        </div>
                    ) : (
                        <div className="grid grid-cols-2 gap-4">
                            {implementations.map(impl => (
                                <ImplementationCard key={impl.id} impl={impl} client={getClientById(impl.client_id)} onSelect={setSelectedImpl} />
                            ))}
                        </div>
                    )}
                    
                    {/* Detail Drawer */}
                    {selectedImpl && (
                        <ImplementationDetail
                            implementation={selectedImpl}
                            tasks={getImplTasks(selectedImpl.id)}
                            client={getClientById(selectedImpl.client_id)}
                            onClose={() => setSelectedImpl(null)}
                            onUpdateTask={handleUpdateTask}
                            onAddTask={handleAddTask}
                            onDeleteTask={handleDeleteTask}
                        />
                    )}
                    
                    {/* Add Implementation Modal */}
                    <Modal isOpen={showAddImpl} onClose={() => setShowAddImpl(false)} title="New Implementation">
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm text-slate-400 mb-1">Client *</label>
                                <select value={newImpl.client_id} onChange={(e) => setNewImpl({...newImpl, client_id: e.target.value})}
                                    className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500">
                                    <option value="">Select client...</option>
                                    {clients.map(c => <option key={c.id} value={c.id}>{c.company_name}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm text-slate-400 mb-1">Implementation Title *</label>
                                <input type="text" value={newImpl.title} onChange={(e) => setNewImpl({...newImpl, title: e.target.value})}
                                    placeholder="e.g., Telemedicine Program Launch" className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500" />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm text-slate-400 mb-1">Type</label>
                                    <select value={newImpl.implementation_type} onChange={(e) => setNewImpl({...newImpl, implementation_type: e.target.value})}
                                        className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500">
                                        {IMPLEMENTATION_TYPES.map(t => <option key={t.value} value={t.value}>{t.icon} {t.label}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm text-slate-400 mb-1">Vendor Name</label>
                                    <input type="text" value={newImpl.vendor_name} onChange={(e) => setNewImpl({...newImpl, vendor_name: e.target.value})}
                                        placeholder="e.g., Teladoc" className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm text-slate-400 mb-1">Target Completion Date</label>
                                <input type="date" value={newImpl.target_completion_date} onChange={(e) => setNewImpl({...newImpl, target_completion_date: e.target.value})}
                                    className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500" />
                            </div>
                            <div className="flex gap-3 pt-2">
                                <button onClick={() => setShowAddImpl(false)} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Cancel</button>
                                <button onClick={handleAddImpl} className="flex-1 px-4 py-2.5 bg-emerald-600 hover:bg-emerald-500 rounded-lg font-medium">Create Implementation</button>
                            </div>
                        </div>
                    </Modal>
                </div>
            );
        };

        // ═══════════════════════════════════════════════════════════════════════════
        // MARKETING AGENT - CONTENT GENERATION & MANAGEMENT
        // ═══════════════════════════════════════════════════════════════════════════
        
        const INSIGHT_TYPES = [
            { value: 'current_event', label: 'Current Event', icon: '📰' },
            { value: 'industry_data', label: 'Industry Data', icon: '📊' },
            { value: 'statistic', label: 'Statistic', icon: '🔢' },
            { value: 'case_study', label: 'Case Study', icon: '📋' },
            { value: 'trend', label: 'Trend', icon: '📈' },
        ];
        
        const INSIGHT_CATEGORIES = [
            { value: 'compliance', label: 'Compliance & Regulatory' },
            { value: 'cost', label: 'Cost & Savings' },
            { value: 'wellness', label: 'Wellness & Prevention' },
            { value: 'technology', label: 'Technology & Innovation' },
            { value: 'legislation', label: 'Legislation' },
            { value: 'market', label: 'Market Trends' },
        ];
        
        const PLATFORMS = [
            { value: 'linkedin_post', label: 'LinkedIn Post', icon: '💼', charLimit: 3000 },
            { value: 'linkedin_article', label: 'LinkedIn Article', icon: '📝', charLimit: null },
            { value: 'email', label: 'Email', icon: '📧', charLimit: null },
            { value: 'twitter', label: 'Twitter/X', icon: '🐦', charLimit: 280 },
            { value: 'blog', label: 'Blog Post', icon: '📰', charLimit: null },
            { value: 'newsletter', label: 'Newsletter', icon: '📬', charLimit: null },
        ];
        
        const CONTENT_STATUSES = [
            { value: 'draft', label: 'Draft', color: 'slate' },
            { value: 'review', label: 'In Review', color: 'amber' },
            { value: 'approved', label: 'Approved', color: 'blue' },
            { value: 'scheduled', label: 'Scheduled', color: 'purple' },
            { value: 'published', label: 'Published', color: 'green' },
            { value: 'archived', label: 'Archived', color: 'gray' },
        ];
        
        const MarketingAgent = ({ clients, analyses }) => {
            const [activeView, setActiveView] = useState('library'); // 'library', 'calendar', 'insights', 'voice', 'create'
            const [insights, setInsights] = useState([]);
            const [content, setContent] = useState([]);
            const [brandVoice, setBrandVoice] = useState(null);
            const [loading, setLoading] = useState(true);
            
            // Modals
            const [showAddInsight, setShowAddInsight] = useState(false);
            const [showCreateContent, setShowCreateContent] = useState(false);
            const [showEditVoice, setShowEditVoice] = useState(false);
            const [selectedContent, setSelectedContent] = useState(null);
            const [previewContent, setPreviewContent] = useState(null);
            
            // Filters
            const [filterPlatform, setFilterPlatform] = useState('');
            const [filterStatus, setFilterStatus] = useState('');
            const [filterMode, setFilterMode] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [calendarMonth, setCalendarMonth] = useState(new Date());
            
            const fetchData = useCallback(async () => {
                setLoading(true);
                try {
                    const [insightsRes, contentRes, voiceRes] = await Promise.all([
                        supabase.from('marketing_insights').select('*').eq('status', 'active').order('insight_date', { ascending: false }),
                        supabase.from('marketing_content').select('*').order('created_at', { ascending: false }),
                        supabase.from('brand_voice').select('*').eq('is_default', true).single()
                    ]);
                    setInsights(insightsRes.data || []);
                    setContent(contentRes.data || []);
                    setBrandVoice(voiceRes.data || null);
                } catch (err) { console.error(err); }
                setLoading(false);
            }, []);
            
            useEffect(() => { fetchData(); }, [fetchData]);
            
            // Filter content
            const filteredContent = content.filter(c => {
                if (filterPlatform && c.platform !== filterPlatform) return false;
                if (filterStatus && c.status !== filterStatus) return false;
                if (filterMode && c.mode !== filterMode) return false;
                if (searchTerm && !c.title.toLowerCase().includes(searchTerm.toLowerCase()) && !c.body?.toLowerCase().includes(searchTerm.toLowerCase())) return false;
                return true;
            });
            
            // Calendar helpers
            const getCalendarDays = () => {
                const year = calendarMonth.getFullYear();
                const month = calendarMonth.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startPadding = firstDay.getDay();
                const days = [];
                
                // Previous month padding
                for (let i = startPadding - 1; i >= 0; i--) {
                    const d = new Date(year, month, -i);
                    days.push({ date: d, isCurrentMonth: false });
                }
                // Current month
                for (let i = 1; i <= lastDay.getDate(); i++) {
                    days.push({ date: new Date(year, month, i), isCurrentMonth: true });
                }
                // Next month padding
                const remaining = 42 - days.length;
                for (let i = 1; i <= remaining; i++) {
                    days.push({ date: new Date(year, month + 1, i), isCurrentMonth: false });
                }
                return days;
            };
            
            const getContentForDate = (date) => {
                const dateStr = date.toISOString().split('T')[0];
                return content.filter(c => c.scheduled_date === dateStr);
            };
            
            const getGapDays = () => {
                const gaps = [];
                const today = new Date();
                for (let i = 0; i < 14; i++) {
                    const d = new Date(today);
                    d.setDate(d.getDate() + i);
                    if (d.getDay() !== 0 && d.getDay() !== 6) { // Skip weekends
                        const dayContent = getContentForDate(d);
                        if (dayContent.length === 0) gaps.push(d);
                    }
                }
                return gaps;
            };
            
            // Stats
            const stats = {
                totalContent: content.length,
                drafts: content.filter(c => c.status === 'draft').length,
                scheduled: content.filter(c => c.status === 'scheduled').length,
                published: content.filter(c => c.status === 'published').length,
                insights: insights.length,
                gaps: getGapDays().length,
            };
            
            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-pink-600/20 to-orange-600/20 border border-pink-500/30 rounded-xl p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <h3 className="text-xl font-bold text-white mb-2">Marketing Agent</h3>
                                <p className="text-slate-300">Generate multi-platform content from insights. Attract prospects & inform clients.</p>
                            </div>
                            <button onClick={() => setShowCreateContent(true)} className="flex items-center gap-2 px-4 py-2.5 bg-pink-600 hover:bg-pink-500 rounded-lg font-medium">
                                {Icons.sparkles} Create Content
                            </button>
                        </div>
                    </div>
                    
                    {/* Stats */}
                    <div className="grid grid-cols-6 gap-4">
                        <StatCard title="Total Content" value={stats.totalContent} icon={Icons.file} color="bg-blue-500/20 text-blue-400" />
                        <StatCard title="Drafts" value={stats.drafts} icon={Icons.edit} color="bg-slate-500/20 text-slate-400" />
                        <StatCard title="Scheduled" value={stats.scheduled} icon={Icons.clock} color="bg-purple-500/20 text-purple-400" />
                        <StatCard title="Published" value={stats.published} icon={Icons.check} color="bg-green-500/20 text-green-400" />
                        <StatCard title="Insights" value={stats.insights} icon={Icons.trending} color="bg-amber-500/20 text-amber-400" />
                        <StatCard title="Content Gaps" value={stats.gaps} icon={Icons.alert} color={stats.gaps > 3 ? "bg-red-500/20 text-red-400" : "bg-slate-500/20 text-slate-400"} />
                    </div>
                    
                    {/* View Tabs */}
                    <div className="flex items-center justify-between">
                        <div className="flex gap-2">
                            {[
                                { id: 'library', label: 'Content Library', icon: '📚' },
                                { id: 'calendar', label: 'Calendar', icon: '📅' },
                                { id: 'insights', label: 'Insights', icon: '💡' },
                                { id: 'voice', label: 'Brand Voice', icon: '🎤' },
                            ].map(tab => (
                                <button key={tab.id} onClick={() => setActiveView(tab.id)}
                                    className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 ${activeView === tab.id ? 'bg-pink-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>
                                    <span>{tab.icon}</span> {tab.label}
                                </button>
                            ))}
                        </div>
                        {activeView === 'insights' && (
                            <button onClick={() => setShowAddInsight(true)} className="flex items-center gap-2 px-3 py-2 bg-amber-600 hover:bg-amber-500 rounded-lg text-sm font-medium">
                                {Icons.plus} Add Insight
                            </button>
                        )}
                    </div>
                    
                    {loading ? <div className="text-center py-12 text-slate-500">{Icons.loader} Loading...</div> : (
                        <>
                            {/* Content Library View */}
                            {activeView === 'library' && (
                                <div className="space-y-4">
                                    {/* Filters */}
                                    <div className="flex gap-3 flex-wrap">
                                        <div className="relative flex-1 min-w-[200px]">
                                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-500">{Icons.search}</div>
                                            <input type="text" placeholder="Search content..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)}
                                                className="w-full bg-slate-850 border border-slate-700 rounded-lg pl-10 pr-4 py-2 text-white placeholder-slate-500 focus:outline-none focus:border-pink-500" />
                                        </div>
                                        <select value={filterMode} onChange={(e) => setFilterMode(e.target.value)}
                                            className="bg-slate-850 border border-slate-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-pink-500">
                                            <option value="">All Modes</option>
                                            <option value="prospect">🎯 Prospect</option>
                                            <option value="client">📢 Client</option>
                                        </select>
                                        <select value={filterPlatform} onChange={(e) => setFilterPlatform(e.target.value)}
                                            className="bg-slate-850 border border-slate-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-pink-500">
                                            <option value="">All Platforms</option>
                                            {PLATFORMS.map(p => <option key={p.value} value={p.value}>{p.icon} {p.label}</option>)}
                                        </select>
                                        <select value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)}
                                            className="bg-slate-850 border border-slate-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-pink-500">
                                            <option value="">All Status</option>
                                            {CONTENT_STATUSES.map(s => <option key={s.value} value={s.value}>{s.label}</option>)}
                                        </select>
                                    </div>
                                    
                                    {/* Content Grid */}
                                    <div className="grid grid-cols-1 gap-3">
                                        {filteredContent.map(item => {
                                            const platform = PLATFORMS.find(p => p.value === item.platform) || PLATFORMS[0];
                                            const status = CONTENT_STATUSES.find(s => s.value === item.status) || CONTENT_STATUSES[0];
                                            const client = clients.find(c => c.id === item.client_id);
                                            
                                            return (
                                                <div key={item.id} className="bg-slate-850 border border-slate-700/50 rounded-xl p-4 hover:border-slate-600 transition-colors">
                                                    <div className="flex items-start gap-4">
                                                        <span className="text-2xl">{platform.icon}</span>
                                                        <div className="flex-1 min-w-0">
                                                            <div className="flex items-center gap-2 mb-1">
                                                                <span className={`text-xs px-2 py-0.5 rounded ${item.mode === 'prospect' ? 'bg-pink-500/20 text-pink-400' : 'bg-blue-500/20 text-blue-400'}`}>
                                                                    {item.mode === 'prospect' ? '🎯 Prospect' : '📢 Client'}
                                                                </span>
                                                                <span className={`text-xs px-2 py-0.5 rounded bg-${status.color}-500/20 text-${status.color}-400`}>
                                                                    {status.label}
                                                                </span>
                                                                {client && <span className="text-xs text-slate-500">→ {client.company_name}</span>}
                                                            </div>
                                                            <h4 className="text-white font-medium mb-1">{item.title}</h4>
                                                            {item.headline && <p className="text-slate-400 text-sm mb-2 italic">"{item.headline}"</p>}
                                                            <p className="text-slate-500 text-sm line-clamp-2">{item.body?.substring(0, 150)}...</p>
                                                            <div className="flex items-center gap-4 mt-3 text-xs text-slate-500">
                                                                <span>{platform.label}</span>
                                                                {item.scheduled_date && <span>📅 {new Date(item.scheduled_date).toLocaleDateString()}</span>}
                                                                <span>{new Date(item.created_at).toLocaleDateString()}</span>
                                                            </div>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button onClick={() => setPreviewContent(item)} className="p-2 text-slate-400 hover:text-white hover:bg-slate-700 rounded-lg">{Icons.eye}</button>
                                                            <button onClick={() => setSelectedContent(item)} className="p-2 text-slate-400 hover:text-blue-400 hover:bg-slate-700 rounded-lg">{Icons.edit}</button>
                                                            <button onClick={() => navigator.clipboard.writeText(item.body)} className="p-2 text-slate-400 hover:text-green-400 hover:bg-slate-700 rounded-lg">
                                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        {filteredContent.length === 0 && (
                                            <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-12 text-center">
                                                <div className="text-4xl mb-4">📝</div>
                                                <h4 className="text-white font-semibold text-lg mb-2">No Content Yet</h4>
                                                <p className="text-slate-400 mb-4">Start creating content to build your library.</p>
                                                <button onClick={() => setShowCreateContent(true)} className="px-4 py-2 bg-pink-600 hover:bg-pink-500 rounded-lg font-medium">
                                                    Create Your First Content
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            
                            {/* Calendar View */}
                            {activeView === 'calendar' && (
                                <div className="space-y-4">
                                    {/* Gap Alert */}
                                    {stats.gaps > 0 && (
                                        <div className="bg-amber-500/10 border border-amber-500/30 rounded-xl p-4 flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <span className="text-2xl">⚠️</span>
                                                <div>
                                                    <p className="text-amber-400 font-medium">{stats.gaps} content gaps detected in the next 2 weeks</p>
                                                    <p className="text-amber-300/70 text-sm">Days without scheduled content: {getGapDays().map(d => d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })).join(', ')}</p>
                                                </div>
                                            </div>
                                            <button onClick={() => setShowCreateContent(true)} className="px-3 py-2 bg-amber-600 hover:bg-amber-500 rounded-lg text-sm font-medium">Fill Gaps</button>
                                        </div>
                                    )}
                                    
                                    {/* Calendar Header */}
                                    <div className="flex items-center justify-between">
                                        <button onClick={() => setCalendarMonth(new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() - 1))}
                                            className="p-2 hover:bg-slate-700 rounded-lg">◀</button>
                                        <h3 className="text-xl font-bold text-white">
                                            {calendarMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                                        </h3>
                                        <button onClick={() => setCalendarMonth(new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() + 1))}
                                            className="p-2 hover:bg-slate-700 rounded-lg">▶</button>
                                    </div>
                                    
                                    {/* Calendar Grid */}
                                    <div className="bg-slate-850 border border-slate-700/50 rounded-xl overflow-hidden">
                                        <div className="grid grid-cols-7 border-b border-slate-700/50">
                                            {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                                                <div key={day} className="p-3 text-center text-sm font-semibold text-slate-400 bg-slate-900/50">{day}</div>
                                            ))}
                                        </div>
                                        <div className="grid grid-cols-7">
                                            {getCalendarDays().map((day, i) => {
                                                const dayContent = getContentForDate(day.date);
                                                const isToday = day.date.toDateString() === new Date().toDateString();
                                                const isWeekend = day.date.getDay() === 0 || day.date.getDay() === 6;
                                                
                                                return (
                                                    <div key={i} className={`min-h-[100px] p-2 border-b border-r border-slate-700/30 ${!day.isCurrentMonth ? 'bg-slate-900/30 opacity-50' : ''} ${isToday ? 'bg-pink-500/10' : ''} ${isWeekend ? 'bg-slate-900/20' : ''}`}>
                                                        <div className={`text-sm font-medium mb-1 ${isToday ? 'text-pink-400' : 'text-slate-400'}`}>
                                                            {day.date.getDate()}
                                                        </div>
                                                        <div className="space-y-1">
                                                            {dayContent.slice(0, 3).map(c => {
                                                                const platform = PLATFORMS.find(p => p.value === c.platform);
                                                                return (
                                                                    <div key={c.id} onClick={() => setPreviewContent(c)}
                                                                        className={`text-xs p-1 rounded truncate cursor-pointer hover:opacity-80 ${c.mode === 'prospect' ? 'bg-pink-500/20 text-pink-300' : 'bg-blue-500/20 text-blue-300'}`}>
                                                                        {platform?.icon} {c.title.substring(0, 15)}...
                                                                    </div>
                                                                );
                                                            })}
                                                            {dayContent.length > 3 && (
                                                                <div className="text-xs text-slate-500">+{dayContent.length - 3} more</div>
                                                            )}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {/* Insights View */}
                            {activeView === 'insights' && (
                                <div className="space-y-4">
                                    <div className="grid grid-cols-1 gap-3">
                                        {insights.map(insight => {
                                            const type = INSIGHT_TYPES.find(t => t.value === insight.insight_type) || INSIGHT_TYPES[0];
                                            const category = INSIGHT_CATEGORIES.find(c => c.value === insight.category);
                                            
                                            return (
                                                <div key={insight.id} className="bg-slate-850 border border-slate-700/50 rounded-xl p-4 hover:border-slate-600 transition-colors">
                                                    <div className="flex items-start gap-4">
                                                        <span className="text-2xl">{type.icon}</span>
                                                        <div className="flex-1">
                                                            <div className="flex items-center gap-2 mb-1">
                                                                <span className="text-xs px-2 py-0.5 rounded bg-slate-700 text-slate-300">{type.label}</span>
                                                                {category && <span className="text-xs px-2 py-0.5 rounded bg-amber-500/20 text-amber-400">{category.label}</span>}
                                                                {insight.times_used > 0 && <span className="text-xs text-slate-500">Used {insight.times_used}x</span>}
                                                            </div>
                                                            <h4 className="text-white font-medium mb-1">{insight.title}</h4>
                                                            <p className="text-slate-400 text-sm mb-2">{insight.detail}</p>
                                                            <div className="flex items-center gap-4 text-xs text-slate-500">
                                                                {insight.source_name && <span>Source: {insight.source_name}</span>}
                                                                {insight.insight_date && <span>{new Date(insight.insight_date).toLocaleDateString()}</span>}
                                                                {insight.source_url && <a href={insight.source_url} target="_blank" rel="noopener noreferrer" className="text-blue-400 hover:underline">View Source →</a>}
                                                            </div>
                                                        </div>
                                                        <button onClick={() => { setShowCreateContent(true); }} className="px-3 py-1.5 bg-pink-600 hover:bg-pink-500 rounded-lg text-sm">Use</button>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        {insights.length === 0 && (
                                            <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-12 text-center">
                                                <div className="text-4xl mb-4">💡</div>
                                                <h4 className="text-white font-semibold text-lg mb-2">No Insights Yet</h4>
                                                <p className="text-slate-400 mb-4">Add industry insights, data points, and current events to fuel your content.</p>
                                                <button onClick={() => setShowAddInsight(true)} className="px-4 py-2 bg-amber-600 hover:bg-amber-500 rounded-lg font-medium">
                                                    Add Your First Insight
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            
                            {/* Brand Voice View */}
                            {activeView === 'voice' && (
                                <div className="space-y-6">
                                    <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-6">
                                        <div className="flex items-center justify-between mb-6">
                                            <h4 className="text-lg font-semibold text-white">Brand Voice Settings</h4>
                                            <button onClick={() => setShowEditVoice(true)} className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">{Icons.edit} Edit</button>
                                        </div>
                                        
                                        {brandVoice ? (
                                            <div className="grid grid-cols-2 gap-6">
                                                <div>
                                                    <p className="text-slate-400 text-sm mb-1">Voice Name</p>
                                                    <p className="text-white font-medium">{brandVoice.name}</p>
                                                </div>
                                                <div>
                                                    <p className="text-slate-400 text-sm mb-1">Tone</p>
                                                    <p className="text-white font-medium capitalize">{brandVoice.tone}</p>
                                                </div>
                                                <div>
                                                    <p className="text-slate-400 text-sm mb-1">Formality</p>
                                                    <p className="text-white font-medium capitalize">{brandVoice.formality}</p>
                                                </div>
                                                <div>
                                                    <p className="text-slate-400 text-sm mb-1">CTA Style</p>
                                                    <p className="text-white font-medium capitalize">{brandVoice.preferred_cta_style}</p>
                                                </div>
                                                <div className="col-span-2">
                                                    <p className="text-slate-400 text-sm mb-1">Personality Traits</p>
                                                    <div className="flex flex-wrap gap-2">
                                                        {brandVoice.personality_traits?.map((trait, i) => (
                                                            <span key={i} className="px-2 py-1 bg-pink-500/20 text-pink-400 rounded text-sm">{trait}</span>
                                                        ))}
                                                    </div>
                                                </div>
                                                <div className="col-span-2">
                                                    <p className="text-slate-400 text-sm mb-1">Words to Avoid</p>
                                                    <div className="flex flex-wrap gap-2">
                                                        {brandVoice.words_to_avoid?.map((word, i) => (
                                                            <span key={i} className="px-2 py-1 bg-red-500/20 text-red-400 rounded text-sm line-through">{word}</span>
                                                        ))}
                                                    </div>
                                                </div>
                                                <div className="col-span-2">
                                                    <p className="text-slate-400 text-sm mb-1">Custom Instructions</p>
                                                    <p className="text-slate-300 text-sm">{brandVoice.custom_instructions}</p>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="text-center py-8">
                                                <p className="text-slate-400 mb-4">No brand voice configured yet.</p>
                                                <button onClick={() => setShowEditVoice(true)} className="px-4 py-2 bg-pink-600 hover:bg-pink-500 rounded-lg font-medium">Configure Brand Voice</button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </>
                    )}
                    
                    {/* Add Insight Modal */}
                    <Modal isOpen={showAddInsight} onClose={() => setShowAddInsight(false)} title="Add Marketing Insight">
                        <AddInsightForm onSubmit={async (data) => {
                            try {
                                await supabase.from('marketing_insights').insert([data]);
                                setShowAddInsight(false);
                                fetchData();
                            } catch (err) { alert('Error: ' + err.message); }
                        }} onCancel={() => setShowAddInsight(false)} />
                    </Modal>
                    
                    {/* Create Content Modal */}
                    <Modal isOpen={showCreateContent} onClose={() => setShowCreateContent(false)} title="Create Content" wide>
                        <CreateContentForm 
                            insights={insights} 
                            clients={clients}
                            analyses={analyses}
                            brandVoice={brandVoice}
                            onSubmit={async (data) => {
                                try {
                                    await supabase.from('marketing_content').insert([data]);
                                    setShowCreateContent(false);
                                    fetchData();
                                } catch (err) { alert('Error: ' + err.message); }
                            }} 
                            onCancel={() => setShowCreateContent(false)} 
                        />
                    </Modal>
                    
                    {/* Preview Content Modal */}
                    <Modal isOpen={!!previewContent} onClose={() => setPreviewContent(null)} title="Content Preview" wide>
                        {previewContent && <ContentPreview content={previewContent} onStatusChange={async (status) => {
                            try {
                                await supabase.from('marketing_content').update({ status, updated_at: new Date().toISOString() }).eq('id', previewContent.id);
                                setPreviewContent(null);
                                fetchData();
                            } catch (err) { alert('Error: ' + err.message); }
                        }} onClose={() => setPreviewContent(null)} />}
                    </Modal>
                    
                    {/* Edit Brand Voice Modal */}
                    <Modal isOpen={showEditVoice} onClose={() => setShowEditVoice(false)} title="Edit Brand Voice">
                        <EditBrandVoiceForm 
                            brandVoice={brandVoice}
                            onSubmit={async (data) => {
                                try {
                                    if (brandVoice?.id) {
                                        await supabase.from('brand_voice').update({ ...data, updated_at: new Date().toISOString() }).eq('id', brandVoice.id);
                                    } else {
                                        await supabase.from('brand_voice').insert([{ ...data, is_default: true }]);
                                    }
                                    setShowEditVoice(false);
                                    fetchData();
                                } catch (err) { alert('Error: ' + err.message); }
                            }}
                            onCancel={() => setShowEditVoice(false)}
                        />
                    </Modal>
                </div>
            );
        };
        
        // Add Insight Form
        const AddInsightForm = ({ onSubmit, onCancel }) => {
            const [formData, setFormData] = useState({ insight_type: 'current_event', category: 'compliance', title: '', detail: '', source_name: '', source_url: '', insight_date: new Date().toISOString().split('T')[0] });
            const handleSubmit = (e) => { e.preventDefault(); onSubmit(formData); };
            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm text-slate-400 mb-1">Type *</label>
                            <select value={formData.insight_type} onChange={(e) => setFormData({...formData, insight_type: e.target.value})}
                                className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-pink-500">
                                {INSIGHT_TYPES.map(t => <option key={t.value} value={t.value}>{t.icon} {t.label}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm text-slate-400 mb-1">Category</label>
                            <select value={formData.category} onChange={(e) => setFormData({...formData, category: e.target.value})}
                                className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-pink-500">
                                {INSIGHT_CATEGORIES.map(c => <option key={c.value} value={c.value}>{c.label}</option>)}
                            </select>
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm text-slate-400 mb-1">Title *</label>
                        <input type="text" required value={formData.title} onChange={(e) => setFormData({...formData, title: e.target.value})}
                            placeholder="e.g., DOL Announces New Mental Health Parity Enforcement" className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-pink-500" />
                    </div>
                    <div>
                        <label className="block text-sm text-slate-400 mb-1">Detail *</label>
                        <textarea required value={formData.detail} onChange={(e) => setFormData({...formData, detail: e.target.value})}
                            placeholder="The key facts, statistics, or implications..." rows={4} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-pink-500 resize-none" />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm text-slate-400 mb-1">Source Name</label>
                            <input type="text" value={formData.source_name} onChange={(e) => setFormData({...formData, source_name: e.target.value})}
                                placeholder="e.g., KFF, DOL, Mercer" className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-pink-500" />
                        </div>
                        <div>
                            <label className="block text-sm text-slate-400 mb-1">Date</label>
                            <input type="date" value={formData.insight_date} onChange={(e) => setFormData({...formData, insight_date: e.target.value})}
                                className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-pink-500" />
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm text-slate-400 mb-1">Source URL</label>
                        <input type="url" value={formData.source_url} onChange={(e) => setFormData({...formData, source_url: e.target.value})}
                            placeholder="https://..." className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-pink-500" />
                    </div>
                    <div className="flex gap-3 pt-2">
                        <button type="button" onClick={onCancel} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Cancel</button>
                        <button type="submit" className="flex-1 px-4 py-2.5 bg-amber-600 hover:bg-amber-500 rounded-lg font-medium">Save Insight</button>
                    </div>
                </form>
            );
        };
        
        // Create Content Form
        const CreateContentForm = ({ insights, clients, analyses, brandVoice, onSubmit, onCancel }) => {
            const [step, setStep] = useState(1); // 1: Configure, 2: Generate, 3: Review
            const [formData, setFormData] = useState({ mode: 'prospect', platform: 'linkedin_post', client_id: '', selectedInsights: [], angle: '' });
            const [generatedContent, setGeneratedContent] = useState(null);
            const [generating, setGenerating] = useState(false);
            
            const selectedClient = clients.find(c => c.id === formData.client_id);
            const clientAnalysis = selectedClient ? analyses.find(a => a.client_id === selectedClient.id) : null;
            
            const generateContent = async () => {
                setGenerating(true);
                // Build prompt from selected insights and settings
                const selectedInsightData = insights.filter(i => formData.selectedInsights.includes(i.id));
                const insightText = selectedInsightData.map(i => `${i.title}: ${i.detail}`).join('\n\n');
                
                const platform = PLATFORMS.find(p => p.value === formData.platform);
                
                // Simulated AI generation (in production, this would call Claude API)
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                let headline = '';
                let body = '';
                let hashtags = [];
                
                if (formData.mode === 'prospect') {
                    headline = `What ${selectedInsightData[0]?.title || 'this trend'} means for your benefits strategy`;
                    body = `${selectedInsightData[0]?.detail || ''}\n\nMost employers are still using last year's playbook for next year's problems.\n\nHere's what forward-thinking HR leaders are doing differently:\n\n1. Moving from reactive to predictive benefits intelligence\n2. Using workforce health data to anticipate costs before they hit\n3. Building institutional memory that survives leadership changes\n\nThe employers who figure this out first will have a significant competitive advantage in talent retention.\n\nWhat's your biggest benefits challenge heading into 2026?`;
                    hashtags = ['#EmployeeBenefits', '#HRTech', '#WorkforceHealth', '#Benefits2026'];
                } else {
                    headline = `Important update: ${selectedInsightData[0]?.title || 'New development'}`;
                    body = `Hi ${selectedClient?.company_name || 'there'},\n\nI wanted to share an important development that directly affects your benefits program.\n\n${selectedInsightData[0]?.detail || ''}\n\nBased on your current workforce profile${clientAnalysis ? ` (risk score: ${clientAnalysis.findings?.risk_assessment?.overall_score || 'N/A'})` : ''}, here's what this means for you:\n\n• [Specific implication 1]\n• [Specific implication 2]\n\nI recommend we schedule a quick call to discuss how to address this proactively.\n\nBest regards`;
                }
                
                setGeneratedContent({
                    title: `${formData.mode === 'prospect' ? 'Prospect' : 'Client'}: ${selectedInsightData[0]?.title?.substring(0, 30) || 'New Content'}...`,
                    headline,
                    body,
                    hashtags,
                    platform: formData.platform,
                    mode: formData.mode,
                    client_id: formData.client_id || null,
                    insight_ids: formData.selectedInsights,
                    brand_voice_id: brandVoice?.id || null,
                    status: 'draft'
                });
                setStep(3);
                setGenerating(false);
            };
            
            const handleSave = (status) => {
                onSubmit({ ...generatedContent, status });
            };
            
            return (
                <div className="space-y-6">
                    {/* Progress Steps */}
                    <div className="flex items-center justify-center gap-4 mb-6">
                        {[1, 2, 3].map(s => (
                            <div key={s} className="flex items-center gap-2">
                                <div className={`w-8 h-8 rounded-full flex items-center justify-center font-medium ${step >= s ? 'bg-pink-600 text-white' : 'bg-slate-700 text-slate-400'}`}>{s}</div>
                                <span className={`text-sm ${step >= s ? 'text-white' : 'text-slate-500'}`}>
                                    {s === 1 ? 'Configure' : s === 2 ? 'Generate' : 'Review'}
                                </span>
                                {s < 3 && <div className={`w-12 h-0.5 ${step > s ? 'bg-pink-600' : 'bg-slate-700'}`}></div>}
                            </div>
                        ))}
                    </div>
                    
                    {/* Step 1: Configure */}
                    {step === 1 && (
                        <div className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm text-slate-400 mb-2">Mode *</label>
                                    <div className="flex gap-2">
                                        <button type="button" onClick={() => setFormData({...formData, mode: 'prospect', client_id: ''})}
                                            className={`flex-1 p-3 rounded-lg border text-center transition-colors ${formData.mode === 'prospect' ? 'bg-pink-500/20 border-pink-500/50 text-pink-400' : 'border-slate-700 text-slate-400 hover:border-slate-600'}`}>
                                            🎯 Prospect Attraction
                                        </button>
                                        <button type="button" onClick={() => setFormData({...formData, mode: 'client'})}
                                            className={`flex-1 p-3 rounded-lg border text-center transition-colors ${formData.mode === 'client' ? 'bg-blue-500/20 border-blue-500/50 text-blue-400' : 'border-slate-700 text-slate-400 hover:border-slate-600'}`}>
                                            📢 Client Update
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm text-slate-400 mb-2">Platform *</label>
                                    <select value={formData.platform} onChange={(e) => setFormData({...formData, platform: e.target.value})}
                                        className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-pink-500">
                                        {PLATFORMS.map(p => <option key={p.value} value={p.value}>{p.icon} {p.label}</option>)}
                                    </select>
                                </div>
                            </div>
                            
                            {formData.mode === 'client' && (
                                <div>
                                    <label className="block text-sm text-slate-400 mb-2">Target Client</label>
                                    <select value={formData.client_id} onChange={(e) => setFormData({...formData, client_id: e.target.value})}
                                        className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-pink-500">
                                        <option value="">General (All Clients)</option>
                                        {clients.map(c => <option key={c.id} value={c.id}>{c.company_name}</option>)}
                                    </select>
                                    {selectedClient && clientAnalysis && (
                                        <div className="mt-2 p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg text-sm">
                                            <p className="text-blue-400 font-medium">Client Data Available:</p>
                                            <p className="text-blue-300/70">Risk Score: {clientAnalysis.findings?.risk_assessment?.overall_score || 'N/A'} • {selectedClient.employee_count || '?'} employees • {selectedClient.industry || 'Unknown industry'}</p>
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            <div>
                                <label className="block text-sm text-slate-400 mb-2">Select Insights to Include</label>
                                <div className="max-h-48 overflow-y-auto space-y-2 border border-slate-700 rounded-lg p-3">
                                    {insights.map(insight => (
                                        <label key={insight.id} className="flex items-start gap-3 p-2 rounded hover:bg-slate-800/50 cursor-pointer">
                                            <input type="checkbox" checked={formData.selectedInsights.includes(insight.id)}
                                                onChange={(e) => {
                                                    if (e.target.checked) {
                                                        setFormData({...formData, selectedInsights: [...formData.selectedInsights, insight.id]});
                                                    } else {
                                                        setFormData({...formData, selectedInsights: formData.selectedInsights.filter(id => id !== insight.id)});
                                                    }
                                                }}
                                                className="mt-1" />
                                            <div>
                                                <p className="text-white text-sm font-medium">{insight.title}</p>
                                                <p className="text-slate-500 text-xs">{insight.detail.substring(0, 80)}...</p>
                                            </div>
                                        </label>
                                    ))}
                                    {insights.length === 0 && <p className="text-slate-500 text-sm text-center py-4">No insights yet. Add some first!</p>}
                                </div>
                            </div>
                            
                            <div>
                                <label className="block text-sm text-slate-400 mb-1">Angle / Hook (optional)</label>
                                <input type="text" value={formData.angle} onChange={(e) => setFormData({...formData, angle: e.target.value})}
                                    placeholder="e.g., Cost control in 2026, Why brokers are worried..." className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-pink-500" />
                            </div>
                            
                            <div className="flex gap-3 pt-2">
                                <button type="button" onClick={onCancel} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Cancel</button>
                                <button type="button" onClick={() => setStep(2)} disabled={formData.selectedInsights.length === 0}
                                    className="flex-1 px-4 py-2.5 bg-pink-600 hover:bg-pink-500 disabled:bg-slate-600 disabled:cursor-not-allowed rounded-lg font-medium">
                                    Next: Generate →
                                </button>
                            </div>
                        </div>
                    )}
                    
                    {/* Step 2: Generate */}
                    {step === 2 && (
                        <div className="space-y-4 text-center py-8">
                            {generating ? (
                                <>
                                    <div className="text-4xl animate-pulse">✨</div>
                                    <p className="text-white font-medium">Generating your content...</p>
                                    <p className="text-slate-400 text-sm">Using brand voice: {brandVoice?.name || 'Default'}</p>
                                </>
                            ) : (
                                <>
                                    <div className="text-4xl">🚀</div>
                                    <p className="text-white font-medium">Ready to generate</p>
                                    <p className="text-slate-400 text-sm mb-4">
                                        {formData.mode === 'prospect' ? '🎯 Prospect' : '📢 Client'} • {PLATFORMS.find(p => p.value === formData.platform)?.label} • {formData.selectedInsights.length} insight(s)
                                    </p>
                                    <div className="flex gap-3 justify-center">
                                        <button onClick={() => setStep(1)} className="px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">← Back</button>
                                        <button onClick={generateContent} className="px-6 py-2.5 bg-pink-600 hover:bg-pink-500 rounded-lg font-medium flex items-center gap-2">
                                            {Icons.sparkles} Generate Content
                                        </button>
                                    </div>
                                </>
                            )}
                        </div>
                    )}
                    
                    {/* Step 3: Review */}
                    {step === 3 && generatedContent && (
                        <div className="space-y-4">
                            <div className="bg-slate-900/50 rounded-xl p-4">
                                <div className="flex items-center gap-2 mb-3">
                                    <span className={`text-xs px-2 py-0.5 rounded ${generatedContent.mode === 'prospect' ? 'bg-pink-500/20 text-pink-400' : 'bg-blue-500/20 text-blue-400'}`}>
                                        {generatedContent.mode === 'prospect' ? '🎯 Prospect' : '📢 Client'}
                                    </span>
                                    <span className="text-xs text-slate-500">{PLATFORMS.find(p => p.value === generatedContent.platform)?.label}</span>
                                </div>
                                
                                <div className="mb-4">
                                    <label className="block text-sm text-slate-400 mb-1">Headline / Subject</label>
                                    <input type="text" value={generatedContent.headline} onChange={(e) => setGeneratedContent({...generatedContent, headline: e.target.value})}
                                        className="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-pink-500" />
                                </div>
                                
                                <div className="mb-4">
                                    <label className="block text-sm text-slate-400 mb-1">Body</label>
                                    <textarea value={generatedContent.body} onChange={(e) => setGeneratedContent({...generatedContent, body: e.target.value})}
                                        rows={10} className="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-pink-500 resize-none font-mono text-sm" />
                                    <p className="text-xs text-slate-500 mt-1">{generatedContent.body?.length || 0} characters</p>
                                </div>
                                
                                {generatedContent.hashtags?.length > 0 && (
                                    <div>
                                        <label className="block text-sm text-slate-400 mb-1">Hashtags</label>
                                        <p className="text-blue-400 text-sm">{generatedContent.hashtags.join(' ')}</p>
                                    </div>
                                )}
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm text-slate-400 mb-1">Schedule Date (optional)</label>
                                    <input type="date" value={generatedContent.scheduled_date || ''} onChange={(e) => setGeneratedContent({...generatedContent, scheduled_date: e.target.value})}
                                        className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-pink-500" />
                                </div>
                                <div>
                                    <label className="block text-sm text-slate-400 mb-1">Schedule Time</label>
                                    <input type="time" value={generatedContent.scheduled_time || ''} onChange={(e) => setGeneratedContent({...generatedContent, scheduled_time: e.target.value})}
                                        className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-pink-500" />
                                </div>
                            </div>
                            
                            <div className="flex gap-3 pt-2">
                                <button onClick={() => setStep(2)} className="px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">← Regenerate</button>
                                <button onClick={() => handleSave('draft')} className="flex-1 px-4 py-2.5 bg-slate-600 hover:bg-slate-500 rounded-lg font-medium">Save as Draft</button>
                                <button onClick={() => handleSave('review')} className="flex-1 px-4 py-2.5 bg-amber-600 hover:bg-amber-500 rounded-lg font-medium">Send to Review</button>
                                {generatedContent.scheduled_date && (
                                    <button onClick={() => handleSave('scheduled')} className="flex-1 px-4 py-2.5 bg-purple-600 hover:bg-purple-500 rounded-lg font-medium">Schedule</button>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        // Content Preview
        const ContentPreview = ({ content, onStatusChange, onClose }) => {
            const platform = PLATFORMS.find(p => p.value === content.platform) || PLATFORMS[0];
            const status = CONTENT_STATUSES.find(s => s.value === content.status) || CONTENT_STATUSES[0];
            
            return (
                <div className="space-y-4">
                    <div className="flex items-center gap-3 mb-4">
                        <span className="text-3xl">{platform.icon}</span>
                        <div>
                            <h4 className="text-white font-semibold">{content.title}</h4>
                            <div className="flex items-center gap-2 text-sm">
                                <span className={`px-2 py-0.5 rounded ${content.mode === 'prospect' ? 'bg-pink-500/20 text-pink-400' : 'bg-blue-500/20 text-blue-400'}`}>
                                    {content.mode === 'prospect' ? '🎯 Prospect' : '📢 Client'}
                                </span>
                                <span className={`px-2 py-0.5 rounded bg-${status.color}-500/20 text-${status.color}-400`}>{status.label}</span>
                            </div>
                        </div>
                    </div>
                    
                    {content.headline && (
                        <div className="bg-slate-900/50 rounded-lg p-3">
                            <p className="text-sm text-slate-400 mb-1">Headline</p>
                            <p className="text-white font-medium">{content.headline}</p>
                        </div>
                    )}
                    
                    <div className="bg-slate-900/50 rounded-lg p-4">
                        <p className="text-sm text-slate-400 mb-2">Content</p>
                        <pre className="text-white whitespace-pre-wrap font-sans text-sm">{content.body}</pre>
                    </div>
                    
                    {content.hashtags?.length > 0 && (
                        <p className="text-blue-400 text-sm">{content.hashtags.join(' ')}</p>
                    )}
                    
                    <div className="flex items-center gap-2 text-sm text-slate-500">
                        {content.scheduled_date && <span>📅 Scheduled: {new Date(content.scheduled_date).toLocaleDateString()}</span>}
                        <span>Created: {new Date(content.created_at).toLocaleDateString()}</span>
                    </div>
                    
                    <div className="flex flex-wrap gap-2 pt-4 border-t border-slate-700">
                        <p className="text-sm text-slate-400 w-full mb-2">Change Status:</p>
                        {CONTENT_STATUSES.filter(s => s.value !== content.status).map(s => (
                            <button key={s.value} onClick={() => onStatusChange(s.value)}
                                className={`px-3 py-1.5 rounded-lg text-sm bg-${s.color}-500/20 text-${s.color}-400 hover:bg-${s.color}-500/30`}>
                                {s.label}
                            </button>
                        ))}
                    </div>
                    
                    <div className="flex gap-3 pt-2">
                        <button onClick={() => navigator.clipboard.writeText(content.body)} className="flex-1 px-4 py-2.5 bg-green-600 hover:bg-green-500 rounded-lg font-medium">Copy Content</button>
                        <button onClick={onClose} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Close</button>
                    </div>
                </div>
            );
        };
        
        // ═══════════════════════════════════════════════════════════════════════════
        // RFP MARKETING AGENT - Vendor RFP Package Assembly
        // ═══════════════════════════════════════════════════════════════════════════
        
        const RFPMarketingAgent = ({ clientId, clients }) => {
            const [campaigns, setCampaigns] = useState([]);
            const [selectedCampaign, setSelectedCampaign] = useState(null);
            const [components, setComponents] = useState([]);
            const [submissions, setSubmissions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedClient, setSelectedClient] = useState(clientId || null);
            const [showNewCampaign, setShowNewCampaign] = useState(false);
            
            const client = clients?.find(c => c.id === selectedClient);
            
            const fetchData = useCallback(async () => {
                if (!selectedClient) { setLoading(false); return; }
                setLoading(true);
                try {
                    const { data } = await supabase.from('rfp_campaigns').select('*').eq('client_id', selectedClient).order('created_at', { ascending: false });
                    setCampaigns(data || []);
                    if (data?.[0] && !selectedCampaign) setSelectedCampaign(data[0]);
                } catch (err) {
                    console.error('Error fetching RFP campaigns:', err);
                }
                setLoading(false);
            }, [selectedClient]);
            
            const fetchCampaignDetails = useCallback(async () => {
                if (!selectedCampaign) return;
                try {
                    const [compsRes, subsRes] = await Promise.all([
                        supabase.from('rfp_data_components').select('*').eq('campaign_id', selectedCampaign.id).order('component_type'),
                        supabase.from('rfp_vendor_submissions').select('*').eq('campaign_id', selectedCampaign.id)
                    ]);
                    setComponents(compsRes.data || []);
                    setSubmissions(subsRes.data || []);
                } catch (err) {
                    console.error('Error fetching campaign details:', err);
                }
            }, [selectedCampaign]);
            
            useEffect(() => { fetchData(); }, [fetchData]);
            useEffect(() => { fetchCampaignDetails(); }, [fetchCampaignDetails]);
            
            const handleCreateCampaign = async (data) => {
                const { data: result } = await supabase.rpc('initialize_rfp_campaign', {
                    p_client_id: selectedClient,
                    p_campaign_name: data.campaign_name,
                    p_campaign_type: data.campaign_type,
                    p_effective_date: data.effective_date
                });
                setShowNewCampaign(false);
                fetchData();
            };
            
            const handleAutoPopulate = async () => {
                if (!selectedCampaign) return;
                await supabase.rpc('rfp_auto_populate', { p_campaign_id: selectedCampaign.id });
                fetchCampaignDetails();
                fetchData();
            };
            
            const readyComponents = components.filter(c => c.status === 'ready').length;
            const criticalComponents = components.filter(c => c.is_critical).length;
            const readyCritical = components.filter(c => c.is_critical && c.status === 'ready').length;
            
            return (
                <div className="space-y-6">
                    <div className="bg-gradient-to-r from-violet-600/20 to-purple-600/20 border border-violet-500/30 rounded-xl p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <h3 className="text-xl font-bold text-white mb-2">RFP Marketing Agent</h3>
                                <p className="text-slate-300">Assemble complete vendor RFP packages from all available client data.</p>
                            </div>
                            <div className="flex items-center gap-3">
                                <select value={selectedClient || ''} onChange={(e) => { setSelectedClient(e.target.value || null); setSelectedCampaign(null); }}
                                    className="bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white">
                                    <option value="">Select Client</option>
                                    {clients?.map(c => <option key={c.id} value={c.id}>{c.company_name}</option>)}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    {!selectedClient ? (
                        <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-12 text-center">
                            <div className="text-5xl mb-4">📋</div>
                            <h4 className="text-xl font-semibold text-white mb-2">Select a Client</h4>
                            <p className="text-slate-400">Choose a client to manage their RFP campaigns.</p>
                        </div>
                    ) : loading ? <div className="text-center py-12">{Icons.loader}</div> : (
                        <div className="grid grid-cols-4 gap-6">
                            {/* Campaign List */}
                            <div className="space-y-4">
                                <div className="flex justify-between items-center">
                                    <h5 className="text-white font-semibold">RFP Campaigns</h5>
                                    <button onClick={() => setShowNewCampaign(true)} className="p-2 bg-violet-600 hover:bg-violet-500 rounded-lg">{Icons.plus}</button>
                                </div>
                                <div className="space-y-2">
                                    {campaigns.map(camp => (
                                        <div key={camp.id} onClick={() => setSelectedCampaign(camp)}
                                            className={`p-3 rounded-lg cursor-pointer ${selectedCampaign?.id === camp.id ? 'bg-violet-600/30 border border-violet-500/50' : 'bg-slate-850 border border-slate-700/50 hover:bg-slate-800'}`}>
                                            <p className="text-white font-medium text-sm">{camp.campaign_name}</p>
                                            <p className="text-slate-500 text-xs">{camp.campaign_type} • <span className={`status-${camp.status?.replace(' ', '_')}`}>{camp.status}</span></p>
                                            {camp.data_completeness_score != null && <div className="mt-2 h-1.5 bg-slate-700 rounded-full overflow-hidden"><div className="h-full bg-violet-500 rounded-full" style={{width: `${camp.data_completeness_score}%`}}></div></div>}
                                        </div>
                                    ))}
                                    {campaigns.length === 0 && <p className="text-slate-500 text-sm text-center py-4">No campaigns yet</p>}
                                </div>
                            </div>
                            
                            {/* Campaign Details */}
                            <div className="col-span-3 space-y-4">
                                {selectedCampaign ? (
                                    <>
                                        <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-5">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <h4 className="text-xl font-bold text-white">{selectedCampaign.campaign_name}</h4>
                                                    <p className="text-slate-400">{selectedCampaign.campaign_type} • {client?.company_name}</p>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button onClick={handleAutoPopulate} className="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm">{Icons.sparkles} Auto-Populate Data</button>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-4 gap-4 mt-4">
                                                <div className="bg-slate-900/50 rounded-lg p-3 text-center">
                                                    <p className="text-2xl font-bold text-white">{selectedCampaign.data_completeness_score || 0}%</p>
                                                    <p className="text-slate-500 text-xs">Data Complete</p>
                                                </div>
                                                <div className="bg-slate-900/50 rounded-lg p-3 text-center">
                                                    <p className="text-2xl font-bold text-green-400">{readyCritical}/{criticalComponents}</p>
                                                    <p className="text-slate-500 text-xs">Critical Items</p>
                                                </div>
                                                <div className="bg-slate-900/50 rounded-lg p-3 text-center">
                                                    <p className="text-2xl font-bold text-violet-400">{submissions.length}</p>
                                                    <p className="text-slate-500 text-xs">Vendors</p>
                                                </div>
                                                <div className="bg-slate-900/50 rounded-lg p-3 text-center">
                                                    <p className="text-2xl font-bold text-amber-400">{submissions.filter(s => s.response_received).length}</p>
                                                    <p className="text-slate-500 text-xs">Quotes Received</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Data Components */}
                                        <div className="bg-slate-850 border border-slate-700/50 rounded-xl overflow-hidden">
                                            <div className="px-4 py-3 border-b border-slate-700/50"><h5 className="text-white font-semibold">Required Data Components</h5></div>
                                            <table className="w-full text-sm">
                                                <thead><tr className="border-b border-slate-700/50 text-slate-400">
                                                    <th className="text-left px-4 py-2">Component</th>
                                                    <th className="text-left px-4 py-2">Type</th>
                                                    <th className="text-center px-4 py-2">Critical</th>
                                                    <th className="text-center px-4 py-2">Status</th>
                                                    <th className="text-left px-4 py-2">Source</th>
                                                </tr></thead>
                                                <tbody>
                                                    {components.map(comp => (
                                                        <tr key={comp.id} className="border-b border-slate-700/30">
                                                            <td className="px-4 py-2 text-white">{comp.component_name}</td>
                                                            <td className="px-4 py-2 text-slate-400">{comp.component_type}</td>
                                                            <td className="px-4 py-2 text-center">{comp.is_critical ? <span className="text-amber-400">●</span> : <span className="text-slate-600">○</span>}</td>
                                                            <td className="px-4 py-2 text-center"><span className={`px-2 py-0.5 rounded text-xs ${comp.status === 'ready' ? 'bg-green-500/20 text-green-400' : comp.status === 'required' ? 'bg-red-500/20 text-red-400' : 'bg-slate-500/20 text-slate-400'}`}>{comp.status}</span></td>
                                                            <td className="px-4 py-2 text-slate-500 text-xs">{comp.data_table || comp.source_type || '—'}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </>
                                ) : <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-8 text-center text-slate-500">Select a campaign or create a new one</div>}
                            </div>
                        </div>
                    )}
                    
                    <Modal isOpen={showNewCampaign} onClose={() => setShowNewCampaign(false)} title="New RFP Campaign">
                        <NewRFPCampaignForm onSubmit={handleCreateCampaign} onCancel={() => setShowNewCampaign(false)} />
                    </Modal>
                </div>
            );
        };
        
        const NewRFPCampaignForm = ({ onSubmit, onCancel }) => {
            const [formData, setFormData] = useState({ campaign_name: '', campaign_type: 'medical', effective_date: '' });
            return (
                <form onSubmit={(e) => { e.preventDefault(); onSubmit(formData); }} className="space-y-4">
                    <div><label className="block text-sm text-slate-400 mb-1">Campaign Name</label>
                        <input type="text" required value={formData.campaign_name} onChange={(e) => setFormData({...formData, campaign_name: e.target.value})} placeholder="e.g., 2026 Medical RFP" className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    <div><label className="block text-sm text-slate-400 mb-1">RFP Type</label>
                        <select value={formData.campaign_type} onChange={(e) => setFormData({...formData, campaign_type: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white">
                            <option value="medical">Medical</option><option value="pharmacy">Pharmacy</option><option value="stop_loss">Stop Loss</option><option value="dental">Dental</option><option value="vision">Vision</option><option value="point_solution">Point Solution</option>
                        </select></div>
                    <div><label className="block text-sm text-slate-400 mb-1">Target Effective Date</label>
                        <input type="date" value={formData.effective_date} onChange={(e) => setFormData({...formData, effective_date: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    <div className="flex gap-3 pt-2">
                        <button type="button" onClick={onCancel} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Cancel</button>
                        <button type="submit" className="flex-1 px-4 py-2.5 bg-violet-600 hover:bg-violet-500 rounded-lg font-medium">Create Campaign</button>
                    </div>
                </form>
            );
        };
        
        // ═══════════════════════════════════════════════════════════════════════════
        // BENEFIT COMPARISON TOOL - SPD/SBC Line-by-Line Analysis
        // ═══════════════════════════════════════════════════════════════════════════
        
        const BenefitComparisonTool = ({ clientId, clients }) => {
            const [plans, setPlans] = useState([]);
            const [comparisons, setComparisons] = useState([]);
            const [categories, setCategories] = useState([]);
            const [selectedComparison, setSelectedComparison] = useState(null);
            const [results, setResults] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedClient, setSelectedClient] = useState(clientId || null);
            const [showAddPlan, setShowAddPlan] = useState(false);
            const [showNewComparison, setShowNewComparison] = useState(false);
            const [activeFilter, setActiveFilter] = useState('all');
            const [editingPlan, setEditingPlan] = useState(null);
            
            const client = clients?.find(c => c.id === selectedClient);
            
            const fetchData = useCallback(async () => {
                if (!selectedClient) { setLoading(false); return; }
                setLoading(true);
                try {
                    const [plansRes, compsRes, catsRes] = await Promise.all([
                        supabase.from('benefit_plans').select('*').eq('client_id', selectedClient).order('plan_type'),
                        supabase.from('plan_comparisons').select('*').eq('client_id', selectedClient).order('created_at', { ascending: false }),
                        supabase.from('benefit_categories').select('*').order('display_order')
                    ]);
                    setPlans(plansRes.data || []);
                    setComparisons(compsRes.data || []);
                    setCategories(catsRes.data || []);
                    if (compsRes.data?.[0] && !selectedComparison) setSelectedComparison(compsRes.data[0]);
                } catch (err) {
                    console.error('Error fetching benefit comparison data:', err);
                }
                setLoading(false);
            }, [selectedClient]);
            
            const fetchResults = useCallback(async () => {
                if (!selectedComparison) { setResults([]); return; }
                try {
                    const { data } = await supabase.from('comparison_results').select('*').eq('comparison_id', selectedComparison.id).order('display_order');
                    setResults(data || []);
                } catch (err) {
                    console.error('Error fetching comparison results:', err);
                }
            }, [selectedComparison]);
            
            useEffect(() => { fetchData(); }, [fetchData]);
            useEffect(() => { fetchResults(); }, [fetchResults]);
            
            const inForcePlan = plans.find(p => p.plan_type === 'in_force');
            const proposedPlans = plans.filter(p => p.plan_type === 'proposed');
            
            const filteredResults = results.filter(r => {
                if (activeFilter === 'all') return true;
                if (activeFilter === 'primary') return r.category_type === 'primary';
                if (activeFilter === 'secondary') return r.category_type === 'secondary';
                if (activeFilter === 'exclusions') return r.category_type === 'exclusion';
                if (activeFilter === 'differences') return r.difference_type !== 'same';
                if (activeFilter === 'material') return r.is_material_difference;
                return true;
            });
            
            const handleCreateComparison = async () => {
                if (!inForcePlan || proposedPlans.length === 0) return;
                const { data, error } = await supabase.from('plan_comparisons').insert([{
                    client_id: selectedClient,
                    comparison_name: `${client?.company_name} Plan Comparison - ${new Date().toLocaleDateString()}`,
                    base_plan_id: inForcePlan.id,
                    compare_plan_ids: proposedPlans.map(p => p.id),
                    status: 'draft'
                }]).select().single();
                if (data) {
                    await supabase.rpc('run_plan_comparison', { p_comparison_id: data.id });
                    setSelectedComparison(data);
                    fetchData();
                }
            };
            
            const getCategoryName = (code) => categories.find(c => c.category_code === code)?.category_name || code;
            
            const getDiffBadge = (type) => {
                const badges = {
                    'better': 'bg-green-500/20 text-green-400',
                    'worse': 'bg-red-500/20 text-red-400',
                    'same': 'bg-slate-500/20 text-slate-400',
                    'new_benefit': 'bg-blue-500/20 text-blue-400',
                    'removed_benefit': 'bg-amber-500/20 text-amber-400',
                    'different_structure': 'bg-purple-500/20 text-purple-400',
                    'needs_review': 'bg-yellow-500/20 text-yellow-400'
                };
                return badges[type] || badges['needs_review'];
            };
            
            return (
                <div className="space-y-6">
                    <div className="bg-gradient-to-r from-indigo-600/20 to-blue-600/20 border border-indigo-500/30 rounded-xl p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <h3 className="text-xl font-bold text-white mb-2">Benefit Comparison Tool</h3>
                                <p className="text-slate-300">Compare SPD, SBC, and benefit summaries line-by-line. Highlight all differences.</p>
                            </div>
                            <div className="flex items-center gap-3">
                                <select value={selectedClient || ''} onChange={(e) => { setSelectedClient(e.target.value || null); setSelectedComparison(null); }}
                                    className="bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white">
                                    <option value="">Select Client</option>
                                    {clients?.map(c => <option key={c.id} value={c.id}>{c.company_name}</option>)}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    {!selectedClient ? (
                        <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-12 text-center">
                            <div className="text-5xl mb-4">📊</div>
                            <h4 className="text-xl font-semibold text-white mb-2">Select a Client</h4>
                            <p className="text-slate-400">Choose a client to compare their in-force benefits against proposed plans.</p>
                        </div>
                    ) : loading ? <div className="text-center py-12">{Icons.loader}</div> : (
                        <div className="grid grid-cols-4 gap-6">
                            {/* Plans & Comparisons Sidebar */}
                            <div className="space-y-4">
                                <div>
                                    <div className="flex justify-between items-center mb-2">
                                        <h5 className="text-white font-semibold text-sm">Benefit Plans</h5>
                                        <button onClick={() => setShowAddPlan(true)} className="p-1.5 bg-indigo-600 hover:bg-indigo-500 rounded text-xs">{Icons.plus}</button>
                                    </div>
                                    <div className="space-y-2">
                                        {plans.map(plan => (
                                            <div key={plan.id} onClick={() => setEditingPlan(plan)}
                                                className={`p-3 rounded-lg cursor-pointer ${plan.plan_type === 'in_force' ? 'bg-blue-600/20 border border-blue-500/30' : 'bg-slate-850 border border-slate-700/50'} hover:bg-slate-800`}>
                                                <div className="flex justify-between items-start">
                                                    <p className="text-white text-sm font-medium">{plan.plan_name}</p>
                                                    <span className={`text-xs px-1.5 py-0.5 rounded ${plan.plan_type === 'in_force' ? 'bg-blue-500/30 text-blue-300' : 'bg-violet-500/30 text-violet-300'}`}>{plan.plan_type === 'in_force' ? 'Current' : 'Proposed'}</span>
                                                </div>
                                                <p className="text-slate-500 text-xs mt-1">{plan.carrier_name || 'No carrier'}</p>
                                            </div>
                                        ))}
                                        {plans.length === 0 && <p className="text-slate-500 text-xs text-center py-4">No plans added yet</p>}
                                    </div>
                                </div>
                                
                                <div className="border-t border-slate-700/50 pt-4">
                                    <h5 className="text-white font-semibold text-sm mb-2">Quick Actions</h5>
                                    <div className="space-y-2">
                                        <button onClick={() => setShowAddPlan(true)} className="w-full px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm text-left flex items-center gap-2">{Icons.plus} Add In-Force Plan</button>
                                        <button onClick={() => setShowAddPlan(true)} className="w-full px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm text-left flex items-center gap-2">{Icons.plus} Add Proposed Plan</button>
                                        {inForcePlan && proposedPlans.length > 0 && (
                                            <button onClick={handleCreateComparison} className="w-full px-3 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-sm text-left flex items-center gap-2">{Icons.sparkles} Run Comparison</button>
                                        )}
                                    </div>
                                </div>
                            </div>
                            
                            {/* Comparison Results */}
                            <div className="col-span-3 space-y-4">
                                {/* Comparison Header */}
                                {selectedComparison && (
                                    <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-4">
                                        <div className="flex justify-between items-center mb-4">
                                            <h4 className="text-lg font-bold text-white">{selectedComparison.comparison_name}</h4>
                                            <div className="flex gap-4 text-sm">
                                                <div className="text-center"><span className="text-green-400 font-bold">{selectedComparison.better_count || 0}</span><span className="text-slate-500 ml-1">Better</span></div>
                                                <div className="text-center"><span className="text-red-400 font-bold">{selectedComparison.worse_count || 0}</span><span className="text-slate-500 ml-1">Worse</span></div>
                                                <div className="text-center"><span className="text-slate-400 font-bold">{selectedComparison.same_count || 0}</span><span className="text-slate-500 ml-1">Same</span></div>
                                                <div className="text-center"><span className="text-blue-400 font-bold">{selectedComparison.new_benefit_count || 0}</span><span className="text-slate-500 ml-1">New</span></div>
                                            </div>
                                        </div>
                                        
                                        {/* Filters */}
                                        <div className="flex gap-2 flex-wrap">
                                            {[
                                                { id: 'all', label: 'All Categories' },
                                                { id: 'primary', label: 'Primary Benefits' },
                                                { id: 'secondary', label: 'Secondary Benefits' },
                                                { id: 'exclusions', label: 'Exclusions' },
                                                { id: 'differences', label: 'Differences Only' },
                                                { id: 'material', label: 'Material Only' }
                                            ].map(f => (
                                                <button key={f.id} onClick={() => setActiveFilter(f.id)}
                                                    className={`px-3 py-1.5 rounded-lg text-xs font-medium ${activeFilter === f.id ? 'bg-indigo-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>
                                                    {f.label}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                
                                {/* Results Table */}
                                {selectedComparison && results.length > 0 ? (
                                    <div className="bg-slate-850 border border-slate-700/50 rounded-xl overflow-hidden">
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm">
                                                <thead>
                                                    <tr className="bg-slate-900/50 border-b border-slate-700/50">
                                                        <th className="text-left px-4 py-3 text-slate-400 font-medium w-1/4">Benefit</th>
                                                        <th className="text-left px-4 py-3 text-blue-400 font-medium">In-Force (Current)</th>
                                                        {proposedPlans.map((p, i) => (
                                                            <th key={p.id} className="text-left px-4 py-3 text-violet-400 font-medium">{p.carrier_name || `Proposed ${i+1}`}</th>
                                                        ))}
                                                        <th className="text-center px-4 py-3 text-slate-400 font-medium w-24">Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {filteredResults.map((result, i) => {
                                                        const comparedVals = result.compared_values || [];
                                                        return (
                                                            <tr key={result.id} className={`border-b border-slate-700/30 ${result.is_material_difference ? 'bg-amber-500/5' : ''}`}>
                                                                <td className="px-4 py-3">
                                                                    <p className="text-white font-medium">{getCategoryName(result.category_code)}</p>
                                                                    <p className="text-slate-500 text-xs">{result.category_type}</p>
                                                                </td>
                                                                <td className="px-4 py-3">
                                                                    <p className="text-white">{result.base_in_network || '—'}</p>
                                                                    {result.base_out_network && <p className="text-slate-500 text-xs">OON: {result.base_out_network}</p>}
                                                                </td>
                                                                {comparedVals.map((cv, j) => (
                                                                    <td key={j} className="px-4 py-3">
                                                                        <p className={`${cv.in_network !== result.base_in_network ? 'text-amber-400 font-medium' : 'text-white'}`}>{cv.in_network || '—'}</p>
                                                                        {cv.out_network && <p className="text-slate-500 text-xs">OON: {cv.out_network}</p>}
                                                                        {cv.visit_limit && <p className="text-slate-500 text-xs">Limit: {cv.visit_limit} visits</p>}
                                                                    </td>
                                                                ))}
                                                                <td className="px-4 py-3 text-center">
                                                                    <span className={`text-xs px-2 py-1 rounded ${getDiffBadge(result.difference_type)}`}>
                                                                        {result.difference_type?.replace('_', ' ')}
                                                                    </span>
                                                                    {result.is_material_difference && <p className="text-amber-400 text-xs mt-1">⚠ Material</p>}
                                                                </td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                ) : selectedComparison ? (
                                    <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-8 text-center text-slate-500">No comparison results yet. Click "Run Comparison" to generate.</div>
                                ) : plans.length >= 2 ? (
                                    <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-12 text-center">
                                        <div className="text-5xl mb-4">⚖️</div>
                                        <h4 className="text-xl font-semibold text-white mb-2">Ready to Compare</h4>
                                        <p className="text-slate-400 mb-4">You have {plans.length} plans loaded. Run a comparison to see line-by-line differences.</p>
                                        <button onClick={handleCreateComparison} className="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-medium">Run Comparison</button>
                                    </div>
                                ) : (
                                    <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-12 text-center">
                                        <div className="text-5xl mb-4">📋</div>
                                        <h4 className="text-xl font-semibold text-white mb-2">Add Benefit Plans</h4>
                                        <p className="text-slate-400">Add at least one in-force plan and one proposed plan to enable comparison.</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                    
                    {/* Add Plan Modal */}
                    <Modal isOpen={showAddPlan} onClose={() => setShowAddPlan(false)} title="Add Benefit Plan">
                        <AddBenefitPlanForm clientId={selectedClient} categories={categories} onSubmit={async (data) => {
                            const { data: plan } = await supabase.rpc('create_benefit_plan', {
                                p_client_id: selectedClient,
                                p_plan_name: data.plan_name,
                                p_plan_type: data.plan_type,
                                p_carrier_name: data.carrier_name,
                                p_network_name: data.network_name
                            });
                            setShowAddPlan(false);
                            fetchData();
                        }} onCancel={() => setShowAddPlan(false)} />
                    </Modal>
                    
                    {/* Edit Plan Details Modal */}
                    <Modal isOpen={!!editingPlan} onClose={() => setEditingPlan(null)} title={`Edit: ${editingPlan?.plan_name}`} size="xl">
                        {editingPlan && <EditBenefitDetailsForm plan={editingPlan} categories={categories} onClose={() => { setEditingPlan(null); fetchData(); }} />}
                    </Modal>
                </div>
            );
        };
        
        const AddBenefitPlanForm = ({ clientId, categories, onSubmit, onCancel }) => {
            const [formData, setFormData] = useState({ plan_name: '', plan_type: 'in_force', carrier_name: '', network_name: '' });
            return (
                <form onSubmit={(e) => { e.preventDefault(); onSubmit(formData); }} className="space-y-4">
                    <div><label className="block text-sm text-slate-400 mb-1">Plan Name</label>
                        <input type="text" required value={formData.plan_name} onChange={(e) => setFormData({...formData, plan_name: e.target.value})} placeholder="e.g., Current PPO Plan" className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    <div><label className="block text-sm text-slate-400 mb-1">Plan Type</label>
                        <select value={formData.plan_type} onChange={(e) => setFormData({...formData, plan_type: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white">
                            <option value="in_force">In-Force (Current Plan)</option><option value="proposed">Proposed (Vendor Quote)</option><option value="renewal">Renewal Offer</option>
                        </select></div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm text-slate-400 mb-1">Carrier</label>
                            <input type="text" value={formData.carrier_name} onChange={(e) => setFormData({...formData, carrier_name: e.target.value})} placeholder="e.g., Cigna" className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                        <div><label className="block text-sm text-slate-400 mb-1">Network</label>
                            <input type="text" value={formData.network_name} onChange={(e) => setFormData({...formData, network_name: e.target.value})} placeholder="e.g., Open Access Plus" className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    </div>
                    <div className="flex gap-3 pt-2">
                        <button type="button" onClick={onCancel} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Cancel</button>
                        <button type="submit" className="flex-1 px-4 py-2.5 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-medium">Create Plan</button>
                    </div>
                </form>
            );
        };
        
        const EditBenefitDetailsForm = ({ plan, categories, onClose }) => {
            const [details, setDetails] = useState([]);
            const [loading, setLoading] = useState(true);
            const [filter, setFilter] = useState('primary');
            const [saving, setSaving] = useState(false);
            
            useEffect(() => {
                const fetchDetails = async () => {
                    const { data } = await supabase.from('benefit_details').select('*').eq('plan_id', plan.id);
                    setDetails(data || []);
                    setLoading(false);
                };
                fetchDetails();
            }, [plan.id]);
            
            const filteredCategories = categories.filter(c => filter === 'all' || c.category_type === filter);
            
            const getDetail = (categoryCode) => details.find(d => d.category_code === categoryCode) || {};
            
            const updateDetail = async (categoryCode, field, value) => {
                const detail = getDetail(categoryCode);
                const updates = { [field]: value, updated_at: new Date().toISOString() };
                
                if (detail.id) {
                    await supabase.from('benefit_details').update(updates).eq('id', detail.id);
                } else {
                    await supabase.from('benefit_details').insert([{ plan_id: plan.id, category_code: categoryCode, ...updates }]);
                }
                
                setDetails(prev => prev.map(d => d.category_code === categoryCode ? { ...d, ...updates } : d));
            };
            
            return (
                <div className="space-y-4">
                    <div className="flex gap-2 flex-wrap">
                        {['primary', 'secondary', 'exclusion', 'limitation', 'all'].map(f => (
                            <button key={f} onClick={() => setFilter(f)} className={`px-3 py-1.5 rounded-lg text-xs font-medium ${filter === f ? 'bg-indigo-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>
                                {f.charAt(0).toUpperCase() + f.slice(1)}
                            </button>
                        ))}
                    </div>
                    
                    {loading ? <div className="text-center py-8">{Icons.loader}</div> : (
                        <div className="max-h-96 overflow-y-auto space-y-2">
                            {filteredCategories.map(cat => {
                                const detail = getDetail(cat.category_code);
                                return (
                                    <div key={cat.category_code} className="bg-slate-900/50 rounded-lg p-3">
                                        <div className="flex items-center justify-between mb-2">
                                            <p className="text-white text-sm font-medium">{cat.category_name}</p>
                                            <span className={`text-xs px-1.5 py-0.5 rounded ${cat.is_core_benefit ? 'bg-amber-500/20 text-amber-400' : 'bg-slate-700 text-slate-400'}`}>{cat.is_core_benefit ? 'Core' : cat.category_type}</span>
                                        </div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div>
                                                <label className="block text-xs text-slate-500 mb-1">In-Network</label>
                                                <input type="text" value={detail.in_network_cost || ''} onChange={(e) => updateDetail(cat.category_code, 'in_network_cost', e.target.value)}
                                                    placeholder="e.g., $30 copay, 20%, Not covered" className="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1.5 text-white text-sm" />
                                            </div>
                                            <div>
                                                <label className="block text-xs text-slate-500 mb-1">Out-of-Network</label>
                                                <input type="text" value={detail.out_network_cost || ''} onChange={(e) => updateDetail(cat.category_code, 'out_network_cost', e.target.value)}
                                                    placeholder="e.g., 40%, Not covered" className="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1.5 text-white text-sm" />
                                            </div>
                                        </div>
                                        {(cat.category_type === 'limitation' || cat.category_code.includes('LIMIT') || cat.category_code.includes('THERAPY')) && (
                                            <div className="grid grid-cols-2 gap-3 mt-2">
                                                <div>
                                                    <label className="block text-xs text-slate-500 mb-1">Visit Limit</label>
                                                    <input type="number" value={detail.visit_limit || ''} onChange={(e) => updateDetail(cat.category_code, 'visit_limit', parseInt(e.target.value) || null)}
                                                        placeholder="e.g., 30" className="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1.5 text-white text-sm" />
                                                </div>
                                                <div>
                                                    <label className="block text-xs text-slate-500 mb-1">Dollar Limit</label>
                                                    <input type="number" value={detail.dollar_limit || ''} onChange={(e) => updateDetail(cat.category_code, 'dollar_limit', parseFloat(e.target.value) || null)}
                                                        placeholder="e.g., 5000" className="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1.5 text-white text-sm" />
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    )}
                    
                    <div className="flex justify-end pt-2">
                        <button onClick={onClose} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-medium">Done</button>
                    </div>
                </div>
            );
        };
        
        // ═══════════════════════════════════════════════════════════════════════════
        // REVENUE AGENT - Client Profitability Tracking
        // ═══════════════════════════════════════════════════════════════════════════
        
        const RevenueAgent = ({ clientId, clients }) => {
            const [revenueSources, setRevenueSources] = useState([]);
            const [transactions, setTransactions] = useState([]);
            const [profitability, setProfitability] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedClient, setSelectedClient] = useState(clientId || null);
            const [showAddSource, setShowAddSource] = useState(false);
            const [showAddTransaction, setShowAddTransaction] = useState(false);
            
            const client = clients?.find(c => c.id === selectedClient);
            
            const fetchData = useCallback(async () => {
                if (!selectedClient) { setLoading(false); return; }
                setLoading(true);
                try {
                    const [sourcesRes, transRes, profitRes] = await Promise.all([
                        supabase.from('client_revenue_sources').select('*').eq('client_id', selectedClient).eq('status', 'active'),
                        supabase.from('revenue_transactions').select('*, client_revenue_sources(source_name, source_type)').eq('client_id', selectedClient).order('transaction_date', { ascending: false }).limit(50),
                        supabase.from('client_profitability_summary').select('*').eq('client_id', selectedClient).order('period_start', { ascending: false }).limit(12)
                    ]);
                    setRevenueSources(sourcesRes.data || []);
                    setTransactions(transRes.data || []);
                    setProfitability(profitRes.data || []);
                } catch (err) {
                    console.error('Error fetching revenue data:', err);
                }
                setLoading(false);
            }, [selectedClient]);
            
            useEffect(() => { fetchData(); }, [fetchData]);
            
            const totalEstimatedAnnual = revenueSources.reduce((sum, s) => sum + (s.estimated_annual || 0), 0);
            const ytdRevenue = transactions.filter(t => new Date(t.transaction_date).getFullYear() === new Date().getFullYear()).reduce((sum, t) => sum + (t.net_amount || 0), 0);
            const latestMargin = profitability[0]?.profit_margin_pct;
            
            return (
                <div className="space-y-6">
                    <div className="bg-gradient-to-r from-green-600/20 to-emerald-600/20 border border-green-500/30 rounded-xl p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <h3 className="text-xl font-bold text-white mb-2">Revenue Agent</h3>
                                <p className="text-slate-300">Track client revenue, profitability, and financial performance over time.</p>
                            </div>
                            <div className="flex items-center gap-3">
                                <select value={selectedClient || ''} onChange={(e) => setSelectedClient(e.target.value || null)}
                                    className="bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white">
                                    <option value="">Select Client</option>
                                    {clients?.map(c => <option key={c.id} value={c.id}>{c.company_name}</option>)}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    {!selectedClient ? (
                        <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-12 text-center">
                            <div className="text-5xl mb-4">💰</div>
                            <h4 className="text-xl font-semibold text-white mb-2">Select a Client</h4>
                            <p className="text-slate-400">Choose a client to track their revenue and profitability.</p>
                        </div>
                    ) : loading ? <div className="text-center py-12">{Icons.loader}</div> : (
                        <>
                            {/* Summary Cards */}
                            <div className="grid grid-cols-4 gap-4">
                                <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-5">
                                    <p className="text-slate-400 text-sm">Estimated Annual Revenue</p>
                                    <p className="text-2xl font-bold text-white">{formatCurrency(totalEstimatedAnnual)}</p>
                                </div>
                                <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-5">
                                    <p className="text-slate-400 text-sm">YTD Revenue</p>
                                    <p className="text-2xl font-bold text-green-400">{formatCurrency(ytdRevenue)}</p>
                                </div>
                                <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-5">
                                    <p className="text-slate-400 text-sm">Revenue Sources</p>
                                    <p className="text-2xl font-bold text-blue-400">{revenueSources.length}</p>
                                </div>
                                <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-5">
                                    <p className="text-slate-400 text-sm">Latest Margin</p>
                                    <p className={`text-2xl font-bold ${latestMargin >= 0 ? 'text-green-400' : 'text-red-400'}`}>{latestMargin != null ? `${latestMargin.toFixed(1)}%` : '—'}</p>
                                </div>
                            </div>
                            
                            {/* Actions */}
                            <div className="flex gap-3">
                                <button onClick={() => setShowAddSource(true)} className="px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg text-sm">{Icons.plus} Add Revenue Source</button>
                                <button onClick={() => setShowAddTransaction(true)} className="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm">{Icons.plus} Record Transaction</button>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-6">
                                {/* Revenue Sources */}
                                <div className="bg-slate-850 border border-slate-700/50 rounded-xl overflow-hidden">
                                    <div className="px-4 py-3 border-b border-slate-700/50"><h5 className="text-white font-semibold">Active Revenue Sources</h5></div>
                                    <div className="divide-y divide-slate-700/50">
                                        {revenueSources.map(source => (
                                            <div key={source.id} className="p-4">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <p className="text-white font-medium">{source.source_name}</p>
                                                        <p className="text-slate-500 text-xs">{source.source_type} • {source.vendor_name || 'Direct'}</p>
                                                    </div>
                                                    <p className="text-green-400 font-medium">{formatCurrency(source.estimated_annual)}/yr</p>
                                                </div>
                                            </div>
                                        ))}
                                        {revenueSources.length === 0 && <div className="p-6 text-center text-slate-500">No revenue sources configured</div>}
                                    </div>
                                </div>
                                
                                {/* Recent Transactions */}
                                <div className="bg-slate-850 border border-slate-700/50 rounded-xl overflow-hidden">
                                    <div className="px-4 py-3 border-b border-slate-700/50"><h5 className="text-white font-semibold">Recent Transactions</h5></div>
                                    <div className="divide-y divide-slate-700/50 max-h-80 overflow-y-auto">
                                        {transactions.slice(0, 10).map(trans => (
                                            <div key={trans.id} className="p-3 flex justify-between items-center">
                                                <div>
                                                    <p className="text-white text-sm">{trans.client_revenue_sources?.source_name || 'Unknown'}</p>
                                                    <p className="text-slate-500 text-xs">{new Date(trans.transaction_date).toLocaleDateString()}</p>
                                                </div>
                                                <p className="text-green-400 font-medium">{formatCurrency(trans.net_amount)}</p>
                                            </div>
                                        ))}
                                        {transactions.length === 0 && <div className="p-6 text-center text-slate-500">No transactions recorded</div>}
                                    </div>
                                </div>
                            </div>
                        </>
                    )}
                    
                    <Modal isOpen={showAddSource} onClose={() => setShowAddSource(false)} title="Add Revenue Source">
                        <AddRevenueSourceForm clientId={selectedClient} onSubmit={async (data) => {
                            await supabase.from('client_revenue_sources').insert([{ ...data, client_id: selectedClient }]);
                            setShowAddSource(false); fetchData();
                        }} onCancel={() => setShowAddSource(false)} />
                    </Modal>
                    
                    <Modal isOpen={showAddTransaction} onClose={() => setShowAddTransaction(false)} title="Record Revenue Transaction">
                        <AddRevenueTransactionForm clientId={selectedClient} sources={revenueSources} onSubmit={async (data) => {
                            await supabase.from('revenue_transactions').insert([{ ...data, client_id: selectedClient, net_amount: data.gross_amount }]);
                            setShowAddTransaction(false); fetchData();
                        }} onCancel={() => setShowAddTransaction(false)} />
                    </Modal>
                </div>
            );
        };
        
        const AddRevenueSourceForm = ({ clientId, onSubmit, onCancel }) => {
            const [formData, setFormData] = useState({ source_name: '', source_type: 'commission_medical', vendor_name: '', estimated_annual: '', payment_type: 'commission_pct' });
            return (
                <form onSubmit={(e) => { e.preventDefault(); onSubmit(formData); }} className="space-y-4">
                    <div><label className="block text-sm text-slate-400 mb-1">Source Name</label>
                        <input type="text" required value={formData.source_name} onChange={(e) => setFormData({...formData, source_name: e.target.value})} placeholder="e.g., Medical Commission - Cigna" className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm text-slate-400 mb-1">Type</label>
                            <select value={formData.source_type} onChange={(e) => setFormData({...formData, source_type: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white">
                                <option value="commission_medical">Commission - Medical</option><option value="commission_dental">Commission - Dental</option><option value="commission_vision">Commission - Vision</option>
                                <option value="commission_life">Commission - Life</option><option value="commission_stop_loss">Commission - Stop Loss</option>
                                <option value="consulting_fee">Consulting Fee</option><option value="retainer">Retainer</option><option value="project_fee">Project Fee</option>
                            </select></div>
                        <div><label className="block text-sm text-slate-400 mb-1">Vendor/Carrier</label>
                            <input type="text" value={formData.vendor_name} onChange={(e) => setFormData({...formData, vendor_name: e.target.value})} placeholder="e.g., Cigna" className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    </div>
                    <div><label className="block text-sm text-slate-400 mb-1">Estimated Annual Revenue</label>
                        <input type="number" value={formData.estimated_annual} onChange={(e) => setFormData({...formData, estimated_annual: parseFloat(e.target.value)})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    <div className="flex gap-3 pt-2">
                        <button type="button" onClick={onCancel} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Cancel</button>
                        <button type="submit" className="flex-1 px-4 py-2.5 bg-green-600 hover:bg-green-500 rounded-lg font-medium">Add Source</button>
                    </div>
                </form>
            );
        };
        
        const AddRevenueTransactionForm = ({ clientId, sources, onSubmit, onCancel }) => {
            const [formData, setFormData] = useState({ source_id: '', transaction_date: new Date().toISOString().slice(0, 10), gross_amount: '', period_type: 'monthly' });
            return (
                <form onSubmit={(e) => { e.preventDefault(); onSubmit(formData); }} className="space-y-4">
                    <div><label className="block text-sm text-slate-400 mb-1">Revenue Source</label>
                        <select required value={formData.source_id} onChange={(e) => setFormData({...formData, source_id: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white">
                            <option value="">Select source...</option>
                            {sources.map(s => <option key={s.id} value={s.id}>{s.source_name}</option>)}
                        </select></div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm text-slate-400 mb-1">Transaction Date</label>
                            <input type="date" required value={formData.transaction_date} onChange={(e) => setFormData({...formData, transaction_date: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                        <div><label className="block text-sm text-slate-400 mb-1">Period Type</label>
                            <select value={formData.period_type} onChange={(e) => setFormData({...formData, period_type: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white">
                                <option value="monthly">Monthly</option><option value="quarterly">Quarterly</option><option value="annual">Annual</option>
                            </select></div>
                    </div>
                    <div><label className="block text-sm text-slate-400 mb-1">Amount</label>
                        <input type="number" required step="0.01" value={formData.gross_amount} onChange={(e) => setFormData({...formData, gross_amount: parseFloat(e.target.value)})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    <div className="flex gap-3 pt-2">
                        <button type="button" onClick={onCancel} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Cancel</button>
                        <button type="submit" className="flex-1 px-4 py-2.5 bg-blue-600 hover:bg-blue-500 rounded-lg font-medium">Record Transaction</button>
                    </div>
                </form>
            );
        };
        
        // ═══════════════════════════════════════════════════════════════════════════
        // ACTION PLAN TRACKER - Census Recommendations → Impact Measurement
        // ═══════════════════════════════════════════════════════════════════════════
        
        const ActionPlanTracker = ({ clientId, clients }) => {
            const [actionPlans, setActionPlans] = useState([]);
            const [recommendations, setRecommendations] = useState([]);
            const [selectedPlan, setSelectedPlan] = useState(null);
            const [tasks, setTasks] = useState([]);
            const [timeline, setTimeline] = useState([]);
            const [measurements, setMeasurements] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedClient, setSelectedClient] = useState(clientId || null);
            const [showAddMeasurement, setShowAddMeasurement] = useState(false);
            
            const client = clients?.find(c => c.id === selectedClient);
            
            const fetchData = useCallback(async () => {
                if (!selectedClient) { setLoading(false); return; }
                setLoading(true);
                try {
                    const [plansRes, recsRes] = await Promise.all([
                        supabase.from('action_plans').select('*').eq('client_id', selectedClient).order('created_at', { ascending: false }),
                        supabase.from('census_recommendations').select('*').eq('client_id', selectedClient).eq('election_status', 'proposed')
                    ]);
                    setActionPlans(plansRes.data || []);
                    setRecommendations(recsRes.data || []);
                } catch (err) {
                    console.error('Error fetching action plans:', err);
                }
                setLoading(false);
            }, [selectedClient]);
            
            const fetchPlanDetails = useCallback(async () => {
                if (!selectedPlan) return;
                try {
                    const [tasksRes, timelineRes, measurementsRes] = await Promise.all([
                        supabase.from('action_plan_tasks').select('*').eq('plan_id', selectedPlan.id).order('task_order'),
                        supabase.from('action_plan_timeline').select('*').eq('plan_id', selectedPlan.id).order('occurred_at', { ascending: false }),
                        supabase.from('action_plan_measurements').select('*').eq('plan_id', selectedPlan.id).order('measurement_date', { ascending: false })
                    ]);
                    setTasks(tasksRes.data || []);
                    setTimeline(timelineRes.data || []);
                    setMeasurements(measurementsRes.data || []);
                } catch (err) {
                    console.error('Error fetching plan details:', err);
                }
            }, [selectedPlan]);
            
            useEffect(() => { fetchData(); }, [fetchData]);
            useEffect(() => { fetchPlanDetails(); }, [fetchPlanDetails]);
            
            const handleElectRecommendation = async (recId) => {
                const { data } = await supabase.rpc('create_action_plan_from_recommendation', { p_recommendation_id: recId, p_elected_by: 'Consultant' });
                fetchData();
            };
            
            const handleRecordMeasurement = async (data) => {
                await supabase.rpc('record_action_plan_measurement', {
                    p_plan_id: selectedPlan.id,
                    p_metric_name: data.metric_name,
                    p_metric_value: data.metric_value,
                    p_measurement_type: data.measurement_type,
                    p_metric_unit: data.metric_unit
                });
                setShowAddMeasurement(false);
                fetchPlanDetails();
            };
            
            const activePlans = actionPlans.filter(p => ['in_progress', 'planning', 'elected'].includes(p.status));
            const completedPlans = actionPlans.filter(p => p.status === 'completed');
            const totalImpact = completedPlans.reduce((sum, p) => sum + (p.actual_annual_impact || 0), 0);
            
            return (
                <div className="space-y-6">
                    <div className="bg-gradient-to-r from-orange-600/20 to-amber-600/20 border border-orange-500/30 rounded-xl p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <h3 className="text-xl font-bold text-white mb-2">Action Plan Tracker</h3>
                                <p className="text-slate-300">Track recommendations to completion. Measure and prove impact. Tied to the living playbook.</p>
                            </div>
                            <div className="flex items-center gap-3">
                                <select value={selectedClient || ''} onChange={(e) => { setSelectedClient(e.target.value || null); setSelectedPlan(null); }}
                                    className="bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white">
                                    <option value="">Select Client</option>
                                    {clients?.map(c => <option key={c.id} value={c.id}>{c.company_name}</option>)}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    {!selectedClient ? (
                        <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-12 text-center">
                            <div className="text-5xl mb-4">🎯</div>
                            <h4 className="text-xl font-semibold text-white mb-2">Select a Client</h4>
                            <p className="text-slate-400">Choose a client to manage their action plans and measure impact.</p>
                        </div>
                    ) : loading ? <div className="text-center py-12">{Icons.loader}</div> : (
                        <>
                            {/* Summary */}
                            <div className="grid grid-cols-4 gap-4">
                                <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-5">
                                    <p className="text-slate-400 text-sm">Active Plans</p>
                                    <p className="text-2xl font-bold text-orange-400">{activePlans.length}</p>
                                </div>
                                <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-5">
                                    <p className="text-slate-400 text-sm">Completed</p>
                                    <p className="text-2xl font-bold text-green-400">{completedPlans.length}</p>
                                </div>
                                <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-5">
                                    <p className="text-slate-400 text-sm">Pending Recommendations</p>
                                    <p className="text-2xl font-bold text-blue-400">{recommendations.length}</p>
                                </div>
                                <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-5">
                                    <p className="text-slate-400 text-sm">Total Measured Impact</p>
                                    <p className="text-2xl font-bold text-emerald-400">{formatCurrency(totalImpact)}</p>
                                </div>
                            </div>
                            
                            {/* Pending Recommendations */}
                            {recommendations.length > 0 && (
                                <div className="bg-slate-850 border border-blue-500/30 rounded-xl overflow-hidden">
                                    <div className="px-4 py-3 bg-blue-500/10 border-b border-blue-500/30">
                                        <h5 className="text-blue-400 font-semibold">Pending Recommendations from Census Analysis</h5>
                                    </div>
                                    <div className="p-4 space-y-3">
                                        {recommendations.map(rec => (
                                            <div key={rec.id} className="bg-slate-900/50 rounded-lg p-4 flex justify-between items-start">
                                                <div>
                                                    <p className="text-white font-medium">{rec.recommendation_title}</p>
                                                    <p className="text-slate-400 text-sm mt-1">{rec.recommendation_detail}</p>
                                                    <div className="flex gap-2 mt-2">
                                                        <span className="text-xs px-2 py-0.5 rounded bg-slate-700 text-slate-300">{rec.category}</span>
                                                        <span className={`text-xs px-2 py-0.5 rounded ${rec.priority === 'high' ? 'bg-red-500/20 text-red-400' : 'bg-slate-700 text-slate-300'}`}>{rec.priority}</span>
                                                        {rec.supporting_data?.estimated_savings && <span className="text-xs px-2 py-0.5 rounded bg-green-500/20 text-green-400">Est. {formatCurrency(rec.supporting_data.estimated_savings)}/yr</span>}
                                                    </div>
                                                </div>
                                                <button onClick={() => handleElectRecommendation(rec.id)} className="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm font-medium whitespace-nowrap">Elect Plan</button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            <div className="grid grid-cols-3 gap-6">
                                {/* Plans List */}
                                <div className="space-y-3">
                                    <h5 className="text-white font-semibold">Action Plans</h5>
                                    {actionPlans.map(plan => (
                                        <div key={plan.id} onClick={() => setSelectedPlan(plan)}
                                            className={`p-4 rounded-lg cursor-pointer ${selectedPlan?.id === plan.id ? 'bg-orange-600/30 border border-orange-500/50' : 'bg-slate-850 border border-slate-700/50 hover:bg-slate-800'}`}>
                                            <div className="flex justify-between items-start">
                                                <p className="text-white font-medium text-sm">{plan.plan_name}</p>
                                                <span className={`text-xs px-2 py-0.5 rounded status-${plan.status?.replace(' ', '_')}`}>{plan.status}</span>
                                            </div>
                                            <p className="text-slate-500 text-xs mt-1">{plan.category}</p>
                                            {plan.actual_annual_impact && <p className="text-green-400 text-xs mt-1">Impact: {formatCurrency(plan.actual_annual_impact)}/yr</p>}
                                        </div>
                                    ))}
                                    {actionPlans.length === 0 && <p className="text-slate-500 text-sm">No action plans yet</p>}
                                </div>
                                
                                {/* Plan Details */}
                                <div className="col-span-2 space-y-4">
                                    {selectedPlan ? (
                                        <>
                                            <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-5">
                                                <div className="flex justify-between items-start mb-4">
                                                    <div>
                                                        <h4 className="text-lg font-bold text-white">{selectedPlan.plan_name}</h4>
                                                        <p className="text-slate-400 text-sm">{selectedPlan.description}</p>
                                                    </div>
                                                    <button onClick={() => setShowAddMeasurement(true)} className="px-3 py-2 bg-orange-600 hover:bg-orange-500 rounded-lg text-sm">Record Measurement</button>
                                                </div>
                                                <div className="grid grid-cols-3 gap-4">
                                                    <div className="bg-slate-900/50 rounded-lg p-3">
                                                        <p className="text-slate-500 text-xs">Expected Impact</p>
                                                        <p className="text-white font-medium">{selectedPlan.expected_annual_impact ? formatCurrency(selectedPlan.expected_annual_impact) : '—'}</p>
                                                    </div>
                                                    <div className="bg-slate-900/50 rounded-lg p-3">
                                                        <p className="text-slate-500 text-xs">Actual Impact</p>
                                                        <p className="text-green-400 font-medium">{selectedPlan.actual_annual_impact ? formatCurrency(selectedPlan.actual_annual_impact) : '—'}</p>
                                                    </div>
                                                    <div className="bg-slate-900/50 rounded-lg p-3">
                                                        <p className="text-slate-500 text-xs">ROI</p>
                                                        <p className={`font-medium ${selectedPlan.roi_pct >= 0 ? 'text-green-400' : 'text-red-400'}`}>{selectedPlan.roi_pct != null ? `${selectedPlan.roi_pct.toFixed(1)}%` : '—'}</p>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {/* Timeline - THE KEY TIMESTAMPED LOG */}
                                            <div className="bg-slate-850 border border-slate-700/50 rounded-xl overflow-hidden">
                                                <div className="px-4 py-3 border-b border-slate-700/50"><h5 className="text-white font-semibold">Timeline — What We Did, When, Why</h5></div>
                                                <div className="divide-y divide-slate-700/50 max-h-64 overflow-y-auto">
                                                    {timeline.map(event => (
                                                        <div key={event.id} className="p-3 flex gap-3">
                                                            <div className="text-slate-500 text-xs whitespace-nowrap w-24">{new Date(event.occurred_at).toLocaleDateString()}</div>
                                                            <div className="flex-1">
                                                                <p className="text-white text-sm">{event.event_title}</p>
                                                                {event.event_description && <p className="text-slate-400 text-xs mt-0.5">{event.event_description}</p>}
                                                            </div>
                                                        </div>
                                                    ))}
                                                    {timeline.length === 0 && <div className="p-6 text-center text-slate-500">No timeline events yet</div>}
                                                </div>
                                            </div>
                                            
                                            {/* Measurements */}
                                            {measurements.length > 0 && (
                                                <div className="bg-slate-850 border border-slate-700/50 rounded-xl overflow-hidden">
                                                    <div className="px-4 py-3 border-b border-slate-700/50"><h5 className="text-white font-semibold">Impact Measurements</h5></div>
                                                    <table className="w-full text-sm">
                                                        <thead><tr className="border-b border-slate-700/50 text-slate-400">
                                                            <th className="text-left px-4 py-2">Date</th><th className="text-left px-4 py-2">Metric</th><th className="text-right px-4 py-2">Value</th><th className="text-right px-4 py-2">vs Baseline</th>
                                                        </tr></thead>
                                                        <tbody>
                                                            {measurements.map(m => (
                                                                <tr key={m.id} className="border-b border-slate-700/30">
                                                                    <td className="px-4 py-2 text-slate-400">{new Date(m.measurement_date).toLocaleDateString()}</td>
                                                                    <td className="px-4 py-2 text-white">{m.metric_name}</td>
                                                                    <td className="px-4 py-2 text-right text-white">{m.metric_value} {m.metric_unit}</td>
                                                                    <td className={`px-4 py-2 text-right ${m.change_pct < 0 ? 'text-green-400' : m.change_pct > 0 ? 'text-red-400' : 'text-slate-400'}`}>{m.change_pct != null ? `${m.change_pct > 0 ? '+' : ''}${m.change_pct.toFixed(1)}%` : '—'}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            )}
                                        </>
                                    ) : <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-8 text-center text-slate-500">Select an action plan to view details</div>}
                                </div>
                            </div>
                        </>
                    )}
                    
                    <Modal isOpen={showAddMeasurement} onClose={() => setShowAddMeasurement(false)} title="Record Measurement">
                        <RecordMeasurementForm onSubmit={handleRecordMeasurement} onCancel={() => setShowAddMeasurement(false)} />
                    </Modal>
                </div>
            );
        };
        
        const RecordMeasurementForm = ({ onSubmit, onCancel }) => {
            const [formData, setFormData] = useState({ metric_name: '', metric_value: '', metric_unit: '', measurement_type: 'interim' });
            return (
                <form onSubmit={(e) => { e.preventDefault(); onSubmit(formData); }} className="space-y-4">
                    <div><label className="block text-sm text-slate-400 mb-1">Metric Name</label>
                        <input type="text" required value={formData.metric_name} onChange={(e) => setFormData({...formData, metric_name: e.target.value})} placeholder="e.g., ER Visits, Claims PEPM, Engagement Rate" className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm text-slate-400 mb-1">Value</label>
                            <input type="number" required step="0.01" value={formData.metric_value} onChange={(e) => setFormData({...formData, metric_value: parseFloat(e.target.value)})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                        <div><label className="block text-sm text-slate-400 mb-1">Unit</label>
                            <input type="text" value={formData.metric_unit} onChange={(e) => setFormData({...formData, metric_unit: e.target.value})} placeholder="e.g., %, $, per 1000" className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    </div>
                    <div><label className="block text-sm text-slate-400 mb-1">Measurement Type</label>
                        <select value={formData.measurement_type} onChange={(e) => setFormData({...formData, measurement_type: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white">
                            <option value="baseline">Baseline (Starting point)</option><option value="interim">Interim (In progress)</option><option value="final">Final (Completion)</option>
                        </select></div>
                    <div className="flex gap-3 pt-2">
                        <button type="button" onClick={onCancel} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Cancel</button>
                        <button type="submit" className="flex-1 px-4 py-2.5 bg-orange-600 hover:bg-orange-500 rounded-lg font-medium">Record Measurement</button>
                    </div>
                </form>
            );
        };

        // ═══════════════════════════════════════════════════════════════════════════
        // CLIENT MANAGER AGENT - Institutional Memory & Forward Planning
        // ═══════════════════════════════════════════════════════════════════════════
        
        const ClientManagerAgent = ({ clientId, clients }) => {
            const [activeSubTab, setActiveSubTab] = useState('overview');
            const [communications, setCommunications] = useState([]);
            const [meetings, setMeetings] = useState([]);
            const [issues, setIssues] = useState([]);
            const [compliance, setCompliance] = useState([]);
            const [forwardPlans, setForwardPlans] = useState([]);
            const [intelFeed, setIntelFeed] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedClient, setSelectedClient] = useState(clientId || null);
            
            // Modals
            const [showAddComm, setShowAddComm] = useState(false);
            const [showAddMeeting, setShowAddMeeting] = useState(false);
            const [showAddIssue, setShowAddIssue] = useState(false);
            const [showGeneratePlan, setShowGeneratePlan] = useState(false);
            
            const client = clients?.find(c => c.id === selectedClient);
            
            const fetchData = useCallback(async () => {
                if (!selectedClient) { setLoading(false); return; }
                setLoading(true);
                try {
                    const [commsRes, meetingsRes, issuesRes, complianceRes, plansRes, intelRes] = await Promise.all([
                        supabase.from('client_communications').select('*').eq('client_id', selectedClient).order('sent_at', { ascending: false }).limit(50),
                        supabase.from('client_meetings').select('*').eq('client_id', selectedClient).order('scheduled_at', { ascending: false }).limit(30),
                        supabase.from('service_issues').select('*').eq('client_id', selectedClient).order('reported_at', { ascending: false }),
                        supabase.from('compliance_reviews').select('*').eq('client_id', selectedClient).order('due_date'),
                        supabase.from('client_forward_plans').select('*').eq('client_id', selectedClient).order('generated_at', { ascending: false }).limit(5),
                        supabase.from('client_intelligence_feed').select('*').eq('client_id', selectedClient).order('created_at', { ascending: false }).limit(30)
                    ]);
                    setCommunications(commsRes.data || []);
                    setMeetings(meetingsRes.data || []);
                    setIssues(issuesRes.data || []);
                    setCompliance(complianceRes.data || []);
                    setForwardPlans(plansRes.data || []);
                    setIntelFeed(intelRes.data || []);
                } catch (err) {
                    console.error('Error fetching client manager data:', err);
                }
                setLoading(false);
            }, [selectedClient]);
            
            useEffect(() => { fetchData(); }, [fetchData]);
            
            const latestPlan = forwardPlans[0];
            const openIssues = issues.filter(i => !['resolved', 'closed'].includes(i.status));
            const upcomingCompliance = compliance.filter(c => c.due_date && new Date(c.due_date) > new Date() && !['compliant', 'closed'].includes(c.status));
            
            const subTabs = [
                { id: 'overview', label: 'Overview' },
                { id: 'communications', label: `Communications (${communications.length})` },
                { id: 'meetings', label: `Meetings (${meetings.length})` },
                { id: 'issues', label: `Issues (${openIssues.length})` },
                { id: 'compliance', label: 'Compliance' },
                { id: 'forward_plan', label: 'Forward Plan' },
                { id: 'intelligence', label: 'Intel Feed' }
            ];
            
            const handleGenerateForwardPlan = async () => {
                if (!selectedClient) return;
                try {
                    const { data, error } = await supabase.rpc('generate_client_forward_plan', { p_client_id: selectedClient });
                    if (error) throw error;
                    fetchData();
                    setShowGeneratePlan(false);
                } catch (err) {
                    console.error('Error generating plan:', err);
                }
            };
            
            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-cyan-600/20 to-teal-600/20 border border-cyan-500/30 rounded-xl p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <h3 className="text-xl font-bold text-white mb-2">Client Manager Agent</h3>
                                <p className="text-slate-300">Institutional memory and forward-looking intelligence for every client.</p>
                            </div>
                            <div className="flex items-center gap-3">
                                <select value={selectedClient || ''} onChange={(e) => setSelectedClient(e.target.value || null)}
                                    className="bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white">
                                    <option value="">Select Client</option>
                                    {clients?.map(c => <option key={c.id} value={c.id}>{c.company_name}</option>)}
                                </select>
                                <button onClick={fetchData} className="p-2 bg-cyan-600 hover:bg-cyan-500 rounded-lg">{Icons.refresh}</button>
                            </div>
                        </div>
                    </div>
                    
                    {!selectedClient ? (
                        <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-12 text-center">
                            <div className="text-5xl mb-4">🎯</div>
                            <h4 className="text-xl font-semibold text-white mb-2">Select a Client</h4>
                            <p className="text-slate-400">Choose a client above to view their complete relationship intelligence.</p>
                        </div>
                    ) : loading ? (
                        <div className="text-center py-12">{Icons.loader}</div>
                    ) : (
                        <>
                            {/* Client Header Card */}
                            <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-5">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <h4 className="text-2xl font-bold text-white">{client?.company_name}</h4>
                                        <p className="text-slate-400">{client?.industry} • {client?.total_employees || '—'} employees</p>
                                    </div>
                                    <div className="flex items-center gap-6">
                                        {client?.renewal_date && (
                                            <div className="text-center">
                                                <p className="text-sm text-slate-400">Renewal</p>
                                                <p className={`text-lg font-bold ${(new Date(client.renewal_date) - new Date()) / (1000*60*60*24) < 90 ? 'text-amber-400' : 'text-white'}`}>
                                                    {Math.ceil((new Date(client.renewal_date) - new Date()) / (1000*60*60*24))} days
                                                </p>
                                            </div>
                                        )}
                                        <div className="text-center">
                                            <p className="text-sm text-slate-400">Open Issues</p>
                                            <p className={`text-lg font-bold ${openIssues.length > 0 ? 'text-red-400' : 'text-green-400'}`}>{openIssues.length}</p>
                                        </div>
                                        <div className="text-center">
                                            <p className="text-sm text-slate-400">Compliance Items</p>
                                            <p className={`text-lg font-bold ${upcomingCompliance.length > 0 ? 'text-amber-400' : 'text-green-400'}`}>{upcomingCompliance.length}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Sub Navigation */}
                            <div className="flex gap-2 overflow-x-auto pb-2">
                                {subTabs.map(tab => (
                                    <button key={tab.id} onClick={() => setActiveSubTab(tab.id)}
                                        className={`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap ${activeSubTab === tab.id ? 'bg-cyan-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>
                                        {tab.label}
                                    </button>
                                ))}
                            </div>
                            
                            {/* Overview Tab */}
                            {activeSubTab === 'overview' && (
                                <div className="grid grid-cols-3 gap-6">
                                    {/* Recent Activity */}
                                    <div className="col-span-2 space-y-4">
                                        <h5 className="text-white font-semibold">Recent Activity Timeline</h5>
                                        <div className="bg-slate-850 border border-slate-700/50 rounded-xl divide-y divide-slate-700/50 max-h-96 overflow-y-auto">
                                            {[...communications.slice(0, 5), ...meetings.slice(0, 3)].sort((a, b) => new Date(b.sent_at || b.scheduled_at) - new Date(a.sent_at || a.scheduled_at)).map((item, i) => (
                                                <div key={i} className="p-3 flex items-start gap-3">
                                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs ${item.comm_type ? 'bg-blue-500/20 text-blue-400' : 'bg-purple-500/20 text-purple-400'}`}>
                                                        {item.comm_type ? '✉' : '📅'}
                                                    </div>
                                                    <div className="flex-1 min-w-0">
                                                        <p className="text-white text-sm font-medium truncate">{item.subject || item.title}</p>
                                                        <p className="text-slate-500 text-xs">{item.comm_type || item.meeting_type} • {new Date(item.sent_at || item.scheduled_at).toLocaleDateString()}</p>
                                                        {item.ai_summary && <p className="text-slate-400 text-xs mt-1 line-clamp-2">{item.ai_summary}</p>}
                                                    </div>
                                                    {item.ai_sentiment && (
                                                        <span className={`text-xs px-2 py-0.5 rounded ${item.ai_sentiment === 'positive' ? 'bg-green-500/20 text-green-400' : item.ai_sentiment === 'negative' ? 'bg-red-500/20 text-red-400' : 'bg-slate-500/20 text-slate-400'}`}>
                                                            {item.ai_sentiment}
                                                        </span>
                                                    )}
                                                </div>
                                            ))}
                                            {communications.length === 0 && meetings.length === 0 && (
                                                <div className="p-8 text-center text-slate-500">No recent activity</div>
                                            )}
                                        </div>
                                    </div>
                                    
                                    {/* Quick Actions & Status */}
                                    <div className="space-y-4">
                                        <h5 className="text-white font-semibold">Quick Actions</h5>
                                        <div className="space-y-2">
                                            <button onClick={() => setShowAddComm(true)} className="w-full px-4 py-2.5 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm font-medium flex items-center gap-2">
                                                {Icons.plus} Log Communication
                                            </button>
                                            <button onClick={() => setShowAddMeeting(true)} className="w-full px-4 py-2.5 bg-purple-600 hover:bg-purple-500 rounded-lg text-sm font-medium flex items-center gap-2">
                                                {Icons.plus} Add Meeting/Transcript
                                            </button>
                                            <button onClick={() => setShowAddIssue(true)} className="w-full px-4 py-2.5 bg-amber-600 hover:bg-amber-500 rounded-lg text-sm font-medium flex items-center gap-2">
                                                {Icons.plus} Log Service Issue
                                            </button>
                                            <button onClick={() => setShowGeneratePlan(true)} className="w-full px-4 py-2.5 bg-cyan-600 hover:bg-cyan-500 rounded-lg text-sm font-medium flex items-center gap-2">
                                                {Icons.sparkles} Generate Forward Plan
                                            </button>
                                        </div>
                                        
                                        {/* Latest Forward Plan Summary */}
                                        {latestPlan && (
                                            <div className="bg-slate-900/50 rounded-xl p-4 mt-4">
                                                <p className="text-slate-400 text-xs mb-2">Latest Forward Plan</p>
                                                <p className="text-white text-sm font-medium">{latestPlan.plan_name}</p>
                                                <p className="text-slate-500 text-xs">{new Date(latestPlan.generated_at).toLocaleDateString()}</p>
                                                <button onClick={() => setActiveSubTab('forward_plan')} className="text-cyan-400 text-xs mt-2 hover:underline">View full plan →</button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            
                            {/* Communications Tab */}
                            {activeSubTab === 'communications' && (
                                <div className="space-y-4">
                                    <div className="flex justify-between items-center">
                                        <h5 className="text-white font-semibold">Communication History</h5>
                                        <button onClick={() => setShowAddComm(true)} className="px-3 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm">{Icons.plus} Add</button>
                                    </div>
                                    <div className="bg-slate-850 border border-slate-700/50 rounded-xl overflow-hidden">
                                        <table className="w-full text-sm">
                                            <thead>
                                                <tr className="bg-slate-900/50 border-b border-slate-700/50 text-slate-400">
                                                    <th className="text-left px-4 py-3">Date</th>
                                                    <th className="text-left px-4 py-3">Type</th>
                                                    <th className="text-left px-4 py-3">Subject</th>
                                                    <th className="text-left px-4 py-3">From</th>
                                                    <th className="text-center px-4 py-3">Sentiment</th>
                                                    <th className="text-center px-4 py-3">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {communications.map(comm => (
                                                    <tr key={comm.id} className="border-b border-slate-700/30 hover:bg-slate-800/30">
                                                        <td className="px-4 py-3 text-slate-400">{new Date(comm.sent_at || comm.created_at).toLocaleDateString()}</td>
                                                        <td className="px-4 py-3"><span className={`px-2 py-0.5 rounded text-xs ${comm.comm_type?.includes('inbound') ? 'bg-green-500/20 text-green-400' : 'bg-blue-500/20 text-blue-400'}`}>{comm.comm_type}</span></td>
                                                        <td className="px-4 py-3 text-white max-w-xs truncate">{comm.subject}</td>
                                                        <td className="px-4 py-3 text-slate-400">{comm.from_name || comm.from_email}</td>
                                                        <td className="px-4 py-3 text-center">{comm.ai_sentiment ? <span className={`text-xs ${comm.ai_sentiment === 'positive' ? 'text-green-400' : comm.ai_sentiment === 'negative' ? 'text-red-400' : 'text-slate-400'}`}>{comm.ai_sentiment}</span> : <span className="text-slate-600">—</span>}</td>
                                                        <td className="px-4 py-3 text-center">{comm.ai_action_items?.length > 0 && <span className="text-amber-400 text-xs">{comm.ai_action_items.length} actions</span>}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}
                            
                            {/* Meetings Tab */}
                            {activeSubTab === 'meetings' && (
                                <div className="space-y-4">
                                    <div className="flex justify-between items-center">
                                        <h5 className="text-white font-semibold">Meetings & Transcripts</h5>
                                        <button onClick={() => setShowAddMeeting(true)} className="px-3 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg text-sm">{Icons.plus} Add Meeting</button>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        {meetings.map(meeting => (
                                            <div key={meeting.id} className={`bg-slate-850 border rounded-xl p-4 ${meeting.status === 'scheduled' ? 'border-purple-500/30' : 'border-slate-700/50'}`}>
                                                <div className="flex justify-between items-start mb-2">
                                                    <div>
                                                        <p className="text-white font-medium">{meeting.title}</p>
                                                        <p className="text-slate-500 text-xs">{meeting.meeting_type} • {meeting.location_type}</p>
                                                    </div>
                                                    <span className={`text-xs px-2 py-0.5 rounded status-${meeting.status}`}>{meeting.status}</span>
                                                </div>
                                                <p className="text-slate-400 text-sm">{new Date(meeting.scheduled_at).toLocaleString()}</p>
                                                {meeting.raw_transcript && <p className="text-green-400 text-xs mt-2">✓ Transcript available</p>}
                                                {meeting.ai_summary && <p className="text-slate-400 text-xs mt-2 line-clamp-2">{meeting.ai_summary}</p>}
                                                {meeting.ai_action_items?.length > 0 && <p className="text-amber-400 text-xs mt-1">{meeting.ai_action_items.length} action items extracted</p>}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            {/* Issues Tab */}
                            {activeSubTab === 'issues' && (
                                <div className="space-y-4">
                                    <div className="flex justify-between items-center">
                                        <h5 className="text-white font-semibold">Service Issues</h5>
                                        <button onClick={() => setShowAddIssue(true)} className="px-3 py-2 bg-amber-600 hover:bg-amber-500 rounded-lg text-sm">{Icons.plus} Log Issue</button>
                                    </div>
                                    <div className="bg-slate-850 border border-slate-700/50 rounded-xl overflow-hidden">
                                        <table className="w-full text-sm">
                                            <thead>
                                                <tr className="bg-slate-900/50 border-b border-slate-700/50 text-slate-400">
                                                    <th className="text-left px-4 py-3">Issue</th>
                                                    <th className="text-left px-4 py-3">Category</th>
                                                    <th className="text-center px-4 py-3">Severity</th>
                                                    <th className="text-center px-4 py-3">Status</th>
                                                    <th className="text-left px-4 py-3">Reported</th>
                                                    <th className="text-left px-4 py-3">Assigned</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {issues.map(issue => (
                                                    <tr key={issue.id} className="border-b border-slate-700/30 hover:bg-slate-800/30">
                                                        <td className="px-4 py-3 text-white">{issue.title}</td>
                                                        <td className="px-4 py-3 text-slate-400">{issue.category}</td>
                                                        <td className="px-4 py-3 text-center"><span className={`px-2 py-0.5 rounded text-xs ${issue.severity === 'critical' ? 'bg-red-500/20 text-red-400' : issue.severity === 'high' ? 'bg-amber-500/20 text-amber-400' : 'bg-slate-500/20 text-slate-400'}`}>{issue.severity}</span></td>
                                                        <td className="px-4 py-3 text-center"><span className={`px-2 py-0.5 rounded text-xs status-${issue.status?.replace(' ', '_')}`}>{issue.status}</span></td>
                                                        <td className="px-4 py-3 text-slate-400">{new Date(issue.reported_at).toLocaleDateString()}</td>
                                                        <td className="px-4 py-3 text-slate-400">{issue.assigned_to || '—'}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}
                            
                            {/* Compliance Tab */}
                            {activeSubTab === 'compliance' && (
                                <div className="space-y-4">
                                    <h5 className="text-white font-semibold">Compliance Reviews & Deadlines</h5>
                                    {compliance.length === 0 ? (
                                        <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-8 text-center text-slate-500">No compliance items tracked</div>
                                    ) : (
                                        <div className="grid grid-cols-2 gap-4">
                                            {compliance.map(item => (
                                                <div key={item.id} className={`bg-slate-850 border rounded-xl p-4 ${item.status === 'compliant' ? 'border-green-500/30' : item.due_date && new Date(item.due_date) < new Date(Date.now() + 30*24*60*60*1000) ? 'border-amber-500/30' : 'border-slate-700/50'}`}>
                                                    <div className="flex justify-between items-start mb-2">
                                                        <p className="text-white font-medium">{item.review_name}</p>
                                                        <span className={`text-xs px-2 py-0.5 rounded status-${item.status}`}>{item.status}</span>
                                                    </div>
                                                    <p className="text-slate-500 text-xs">{item.review_type}</p>
                                                    {item.due_date && <p className={`text-sm mt-2 ${new Date(item.due_date) < new Date() ? 'text-red-400' : 'text-slate-400'}`}>Due: {new Date(item.due_date).toLocaleDateString()}</p>}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            {/* Forward Plan Tab */}
                            {activeSubTab === 'forward_plan' && (
                                <div className="space-y-4">
                                    <div className="flex justify-between items-center">
                                        <h5 className="text-white font-semibold">Forward-Looking Plan</h5>
                                        <button onClick={() => setShowGeneratePlan(true)} className="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 rounded-lg text-sm flex items-center gap-2">{Icons.sparkles} Generate New Plan</button>
                                    </div>
                                    {latestPlan ? (
                                        <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-6 space-y-6">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <h4 className="text-xl font-bold text-white">{latestPlan.plan_name}</h4>
                                                    <p className="text-slate-400">Generated {new Date(latestPlan.generated_at).toLocaleDateString()} • {latestPlan.horizon_months}-month horizon</p>
                                                </div>
                                                <div className="text-right">
                                                    <p className="text-sm text-slate-400">Confidence</p>
                                                    <p className={`text-xl font-bold ${latestPlan.confidence_score >= 70 ? 'text-green-400' : latestPlan.confidence_score >= 50 ? 'text-amber-400' : 'text-red-400'}`}>{latestPlan.confidence_score}%</p>
                                                </div>
                                            </div>
                                            
                                            {latestPlan.current_state_summary && (
                                                <div>
                                                    <h5 className="text-white font-semibold mb-2">Current State Summary</h5>
                                                    <p className="text-slate-300">{latestPlan.current_state_summary}</p>
                                                </div>
                                            )}
                                            
                                            <div className="grid grid-cols-3 gap-4">
                                                {latestPlan.financial_snapshot && (
                                                    <div className="bg-slate-900/50 rounded-lg p-4">
                                                        <h6 className="text-slate-400 text-sm mb-2">Financial</h6>
                                                        <p className="text-white text-lg font-bold">{latestPlan.financial_snapshot.trend || '—'}</p>
                                                        {latestPlan.financial_snapshot.variance_pct && <p className={`text-sm ${latestPlan.financial_snapshot.variance_pct > 0 ? 'text-red-400' : 'text-green-400'}`}>{latestPlan.financial_snapshot.variance_pct > 0 ? '+' : ''}{latestPlan.financial_snapshot.variance_pct}% vs plan</p>}
                                                    </div>
                                                )}
                                                {latestPlan.relationship_health && (
                                                    <div className="bg-slate-900/50 rounded-lg p-4">
                                                        <h6 className="text-slate-400 text-sm mb-2">Relationship</h6>
                                                        <p className="text-white text-lg font-bold">{latestPlan.relationship_health.open_issues || 0} open issues</p>
                                                    </div>
                                                )}
                                                {latestPlan.compliance_status && (
                                                    <div className="bg-slate-900/50 rounded-lg p-4">
                                                        <h6 className="text-slate-400 text-sm mb-2">Compliance</h6>
                                                        <p className="text-white text-lg font-bold">{latestPlan.compliance_status.upcoming_deadlines?.length || 0} upcoming</p>
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {latestPlan.recommendations?.length > 0 && (
                                                <div>
                                                    <h5 className="text-white font-semibold mb-2">Recommendations</h5>
                                                    <div className="space-y-2">
                                                        {latestPlan.recommendations.map((rec, i) => (
                                                            <div key={i} className="bg-slate-900/50 rounded-lg p-3 flex items-start gap-3">
                                                                <span className="text-cyan-400">→</span>
                                                                <div>
                                                                    <p className="text-white">{rec.recommendation}</p>
                                                                    {rec.impact && <p className="text-slate-500 text-sm">Impact: {rec.impact}</p>}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                            
                                            {latestPlan.risks?.length > 0 && (
                                                <div>
                                                    <h5 className="text-white font-semibold mb-2">Identified Risks</h5>
                                                    <div className="space-y-2">
                                                        {latestPlan.risks.map((risk, i) => (
                                                            <div key={i} className="bg-red-500/10 border border-red-500/30 rounded-lg p-3">
                                                                <p className="text-white">{risk.risk}</p>
                                                                <p className="text-slate-400 text-sm">Mitigation: {risk.mitigation}</p>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-12 text-center">
                                            <div className="text-5xl mb-4">📋</div>
                                            <h4 className="text-xl font-semibold text-white mb-2">No Forward Plan Generated</h4>
                                            <p className="text-slate-400 mb-4">Generate an AI-powered forward-looking plan based on all available client intelligence.</p>
                                            <button onClick={() => setShowGeneratePlan(true)} className="px-6 py-3 bg-cyan-600 hover:bg-cyan-500 rounded-lg font-medium">{Icons.sparkles} Generate Forward Plan</button>
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            {/* Intelligence Feed Tab */}
                            {activeSubTab === 'intelligence' && (
                                <div className="space-y-4">
                                    <h5 className="text-white font-semibold">Intelligence Feed</h5>
                                    <div className="bg-slate-850 border border-slate-700/50 rounded-xl divide-y divide-slate-700/50 max-h-[600px] overflow-y-auto">
                                        {intelFeed.length === 0 ? (
                                            <div className="p-8 text-center text-slate-500">No intelligence items yet</div>
                                        ) : (
                                            intelFeed.map(intel => (
                                                <div key={intel.id} className="p-4">
                                                    <div className="flex items-start justify-between">
                                                        <div className="flex items-start gap-3">
                                                            <div className={`w-2 h-2 mt-2 rounded-full ${intel.importance === 'critical' ? 'bg-red-500' : intel.importance === 'high' ? 'bg-amber-500' : 'bg-blue-500'}`}></div>
                                                            <div>
                                                                <p className="text-white font-medium">{intel.title}</p>
                                                                {intel.summary && <p className="text-slate-400 text-sm mt-1">{intel.summary}</p>}
                                                                <p className="text-slate-500 text-xs mt-1">{intel.intel_type} • {new Date(intel.created_at).toLocaleDateString()}</p>
                                                            </div>
                                                        </div>
                                                        {intel.requires_action && !intel.action_completed && (
                                                            <span className="text-xs px-2 py-0.5 rounded bg-amber-500/20 text-amber-400">Action needed</span>
                                                        )}
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            )}
                        </>
                    )}
                    
                    {/* Add Communication Modal */}
                    <Modal isOpen={showAddComm} onClose={() => setShowAddComm(false)} title="Log Communication">
                        <AddCommunicationForm clientId={selectedClient} onSubmit={async (data) => {
                            await supabase.from('client_communications').insert([{ ...data, client_id: selectedClient }]);
                            setShowAddComm(false);
                            fetchData();
                        }} onCancel={() => setShowAddComm(false)} />
                    </Modal>
                    
                    {/* Add Meeting Modal */}
                    <Modal isOpen={showAddMeeting} onClose={() => setShowAddMeeting(false)} title="Add Meeting / Transcript">
                        <AddMeetingForm clientId={selectedClient} onSubmit={async (data) => {
                            await supabase.from('client_meetings').insert([{ ...data, client_id: selectedClient }]);
                            setShowAddMeeting(false);
                            fetchData();
                        }} onCancel={() => setShowAddMeeting(false)} />
                    </Modal>
                    
                    {/* Add Issue Modal */}
                    <Modal isOpen={showAddIssue} onClose={() => setShowAddIssue(false)} title="Log Service Issue">
                        <AddServiceIssueForm clientId={selectedClient} onSubmit={async (data) => {
                            await supabase.from('service_issues').insert([{ ...data, client_id: selectedClient }]);
                            setShowAddIssue(false);
                            fetchData();
                        }} onCancel={() => setShowAddIssue(false)} />
                    </Modal>
                    
                    {/* Generate Plan Confirmation */}
                    <Modal isOpen={showGeneratePlan} onClose={() => setShowGeneratePlan(false)} title="Generate Forward Plan">
                        <div className="space-y-4">
                            <p className="text-slate-300">This will analyze all available client data including:</p>
                            <ul className="text-slate-400 text-sm space-y-1 ml-4">
                                <li>• {communications.length} communications</li>
                                <li>• {meetings.length} meetings & transcripts</li>
                                <li>• {issues.length} service issues</li>
                                <li>• Financial projections & underwriting</li>
                                <li>• Compliance reviews & playbook progress</li>
                                <li>• All recorded decisions</li>
                            </ul>
                            <p className="text-slate-400 text-sm">The AI will synthesize this into a comprehensive forward-looking plan.</p>
                            <div className="flex gap-3 pt-2">
                                <button onClick={() => setShowGeneratePlan(false)} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Cancel</button>
                                <button onClick={handleGenerateForwardPlan} className="flex-1 px-4 py-2.5 bg-cyan-600 hover:bg-cyan-500 rounded-lg font-medium flex items-center justify-center gap-2">{Icons.sparkles} Generate Plan</button>
                            </div>
                        </div>
                    </Modal>
                </div>
            );
        };
        
        // Add Communication Form
        const AddCommunicationForm = ({ clientId, onSubmit, onCancel }) => {
            const [formData, setFormData] = useState({
                comm_type: 'email_inbound', subject: '', from_name: '', from_email: '',
                body_plain: '', sent_at: new Date().toISOString().slice(0, 16)
            });
            return (
                <form onSubmit={(e) => { e.preventDefault(); onSubmit({ ...formData, sent_at: new Date(formData.sent_at).toISOString() }); }} className="space-y-4">
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm text-slate-400 mb-1">Type</label>
                            <select value={formData.comm_type} onChange={(e) => setFormData({...formData, comm_type: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white">
                                <option value="email_inbound">Email (Received)</option><option value="email_outbound">Email (Sent)</option>
                                <option value="call">Phone Call</option><option value="text">Text Message</option>
                            </select></div>
                        <div><label className="block text-sm text-slate-400 mb-1">Date/Time</label>
                            <input type="datetime-local" value={formData.sent_at} onChange={(e) => setFormData({...formData, sent_at: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    </div>
                    <div><label className="block text-sm text-slate-400 mb-1">Subject</label>
                        <input type="text" required value={formData.subject} onChange={(e) => setFormData({...formData, subject: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm text-slate-400 mb-1">From Name</label>
                            <input type="text" value={formData.from_name} onChange={(e) => setFormData({...formData, from_name: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                        <div><label className="block text-sm text-slate-400 mb-1">From Email</label>
                            <input type="email" value={formData.from_email} onChange={(e) => setFormData({...formData, from_email: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    </div>
                    <div><label className="block text-sm text-slate-400 mb-1">Content</label>
                        <textarea rows={4} value={formData.body_plain} onChange={(e) => setFormData({...formData, body_plain: e.target.value})} placeholder="Paste email content or notes..." className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    <div className="flex gap-3 pt-2">
                        <button type="button" onClick={onCancel} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Cancel</button>
                        <button type="submit" className="flex-1 px-4 py-2.5 bg-blue-600 hover:bg-blue-500 rounded-lg font-medium">Save Communication</button>
                    </div>
                </form>
            );
        };
        
        // Add Meeting Form
        const AddMeetingForm = ({ clientId, onSubmit, onCancel }) => {
            const [formData, setFormData] = useState({
                meeting_type: 'strategy_call', title: '', scheduled_at: new Date().toISOString().slice(0, 16),
                duration_minutes: 60, location_type: 'zoom', raw_notes: '', raw_transcript: '', status: 'completed'
            });
            return (
                <form onSubmit={(e) => { e.preventDefault(); onSubmit({ ...formData, scheduled_at: new Date(formData.scheduled_at).toISOString() }); }} className="space-y-4">
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm text-slate-400 mb-1">Meeting Type</label>
                            <select value={formData.meeting_type} onChange={(e) => setFormData({...formData, meeting_type: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white">
                                <option value="strategy_call">Strategy Call</option><option value="renewal_review">Renewal Review</option>
                                <option value="qbr">QBR</option><option value="implementation_kickoff">Implementation Kickoff</option>
                                <option value="claims_review">Claims Review</option><option value="webinar">Webinar</option>
                                <option value="ad_hoc">Ad Hoc</option>
                            </select></div>
                        <div><label className="block text-sm text-slate-400 mb-1">Status</label>
                            <select value={formData.status} onChange={(e) => setFormData({...formData, status: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white">
                                <option value="scheduled">Scheduled</option><option value="completed">Completed</option><option value="cancelled">Cancelled</option>
                            </select></div>
                    </div>
                    <div><label className="block text-sm text-slate-400 mb-1">Meeting Title</label>
                        <input type="text" required value={formData.title} onChange={(e) => setFormData({...formData, title: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    <div className="grid grid-cols-3 gap-4">
                        <div><label className="block text-sm text-slate-400 mb-1">Date/Time</label>
                            <input type="datetime-local" value={formData.scheduled_at} onChange={(e) => setFormData({...formData, scheduled_at: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                        <div><label className="block text-sm text-slate-400 mb-1">Duration (min)</label>
                            <input type="number" value={formData.duration_minutes} onChange={(e) => setFormData({...formData, duration_minutes: parseInt(e.target.value)})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                        <div><label className="block text-sm text-slate-400 mb-1">Location</label>
                            <select value={formData.location_type} onChange={(e) => setFormData({...formData, location_type: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white">
                                <option value="zoom">Zoom</option><option value="teams">Teams</option><option value="phone">Phone</option><option value="in_person">In Person</option>
                            </select></div>
                    </div>
                    <div><label className="block text-sm text-slate-400 mb-1">Meeting Notes</label>
                        <textarea rows={3} value={formData.raw_notes} onChange={(e) => setFormData({...formData, raw_notes: e.target.value})} placeholder="Key points, decisions, action items..." className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    <div><label className="block text-sm text-slate-400 mb-1">AI Transcript (paste from Zoom, Otter, Fireflies, etc.)</label>
                        <textarea rows={4} value={formData.raw_transcript} onChange={(e) => setFormData({...formData, raw_transcript: e.target.value})} placeholder="Paste full transcript here for AI processing..." className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    <div className="flex gap-3 pt-2">
                        <button type="button" onClick={onCancel} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Cancel</button>
                        <button type="submit" className="flex-1 px-4 py-2.5 bg-purple-600 hover:bg-purple-500 rounded-lg font-medium">Save Meeting</button>
                    </div>
                </form>
            );
        };
        
        // Add Service Issue Form
        const AddServiceIssueForm = ({ clientId, onSubmit, onCancel }) => {
            const [formData, setFormData] = useState({
                title: '', category: 'claims_issue', severity: 'medium', description: '',
                reported_by: '', reported_via: 'email', assigned_to: ''
            });
            return (
                <form onSubmit={(e) => { e.preventDefault(); onSubmit(formData); }} className="space-y-4">
                    <div><label className="block text-sm text-slate-400 mb-1">Issue Title</label>
                        <input type="text" required value={formData.title} onChange={(e) => setFormData({...formData, title: e.target.value})} placeholder="Brief description of the issue" className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    <div className="grid grid-cols-3 gap-4">
                        <div><label className="block text-sm text-slate-400 mb-1">Category</label>
                            <select value={formData.category} onChange={(e) => setFormData({...formData, category: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white">
                                <option value="claims_issue">Claims Issue</option><option value="billing_error">Billing Error</option>
                                <option value="enrollment_problem">Enrollment Problem</option><option value="carrier_issue">Carrier Issue</option>
                                <option value="vendor_issue">Vendor Issue</option><option value="compliance_concern">Compliance Concern</option>
                                <option value="communication_gap">Communication Gap</option><option value="other">Other</option>
                            </select></div>
                        <div><label className="block text-sm text-slate-400 mb-1">Severity</label>
                            <select value={formData.severity} onChange={(e) => setFormData({...formData, severity: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white">
                                <option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option><option value="critical">Critical</option>
                            </select></div>
                        <div><label className="block text-sm text-slate-400 mb-1">Reported Via</label>
                            <select value={formData.reported_via} onChange={(e) => setFormData({...formData, reported_via: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white">
                                <option value="email">Email</option><option value="call">Call</option><option value="meeting">Meeting</option><option value="internal_discovery">Internal Discovery</option>
                            </select></div>
                    </div>
                    <div><label className="block text-sm text-slate-400 mb-1">Description</label>
                        <textarea rows={3} value={formData.description} onChange={(e) => setFormData({...formData, description: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm text-slate-400 mb-1">Reported By</label>
                            <input type="text" value={formData.reported_by} onChange={(e) => setFormData({...formData, reported_by: e.target.value})} placeholder="Client contact name" className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                        <div><label className="block text-sm text-slate-400 mb-1">Assigned To</label>
                            <input type="text" value={formData.assigned_to} onChange={(e) => setFormData({...formData, assigned_to: e.target.value})} placeholder="Team member" className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    </div>
                    <div className="flex gap-3 pt-2">
                        <button type="button" onClick={onCancel} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Cancel</button>
                        <button type="submit" className="flex-1 px-4 py-2.5 bg-amber-600 hover:bg-amber-500 rounded-lg font-medium">Log Issue</button>
                    </div>
                </form>
            );
        };

        // ═══════════════════════════════════════════════════════════════════════════
        // COMMAND CENTER - Central Hub for Human-in-Loop
        // ═══════════════════════════════════════════════════════════════════════════
        
        const CommandCenter = ({ clients, prospects }) => {
            const [pendingActions, setPendingActions] = useState([]);
            const [notifications, setNotifications] = useState([]);
            const [agentStatus, setAgentStatus] = useState([]);
            const [activityFeed, setActivityFeed] = useState([]);
            const [overview, setOverview] = useState(null);
            const [loading, setLoading] = useState(true);
            
            const fetchData = useCallback(async () => {
                setLoading(true);
                try {
                    const [actionsRes, notifRes, agentsRes, activityRes] = await Promise.all([
                        supabase.from('human_action_queue').select('*').eq('status', 'pending').order('priority').order('created_at'),
                        supabase.from('notifications').select('*').eq('is_read', false).order('created_at', { ascending: false }).limit(10),
                        supabase.from('agent_registry').select('*').order('agent_type', { ascending: true }),
                        supabase.from('agent_activity_log').select('*').order('created_at', { ascending: false }).limit(20)
                    ]);
                    setPendingActions(actionsRes.data || []);
                    setNotifications(notifRes.data || []);
                    setAgentStatus(agentsRes.data || []);
                    setActivityFeed(activityRes.data || []);
                    
                    // Calculate overview
                    setOverview({
                        pendingActions: actionsRes.data?.length || 0,
                        criticalActions: actionsRes.data?.filter(a => a.urgency === 'critical').length || 0,
                        unreadNotifications: notifRes.data?.length || 0,
                        activeAgents: agentsRes.data?.filter(a => a.status === 'active').length || 0,
                        totalAgents: agentsRes.data?.length || 0
                    });
                } catch (err) { console.error(err); }
                setLoading(false);
            }, []);
            
            useEffect(() => { fetchData(); const interval = setInterval(fetchData, 30000); return () => clearInterval(interval); }, [fetchData]);
            
            const handleResolveAction = async (actionId, resolution) => {
                await supabase.rpc('resolve_human_action', { p_action_id: actionId, p_resolved_by: 'user', p_resolution_action: resolution });
                fetchData();
            };
            
            const handleDismissNotification = async (notifId) => {
                await supabase.from('notifications').update({ is_read: true, read_at: new Date().toISOString() }).eq('id', notifId);
                fetchData();
            };
            
            const getClientName = (clientId) => clients?.find(c => c.id === clientId)?.company_name || 'Unknown';
            const getProspectName = (prospectId) => prospects?.find(p => p.id === prospectId)?.company_name || 'Unknown';
            
            const urgencyColors = { critical: 'red', high: 'amber', normal: 'blue', low: 'slate' };
            
            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-indigo-600/20 to-purple-600/20 border border-indigo-500/30 rounded-xl p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <h3 className="text-xl font-bold text-white mb-2">Command Center</h3>
                                <p className="text-slate-300">Multi-agent orchestration with human-in-the-loop control.</p>
                            </div>
                            <button onClick={fetchData} className="p-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg">{Icons.refresh}</button>
                        </div>
                    </div>
                    
                    {loading ? <div className="text-center py-12">{Icons.loader}</div> : (
                        <>
                            {/* Quick Stats */}
                            <div className="grid grid-cols-5 gap-4">
                                <div className={`bg-slate-850 border rounded-xl p-5 text-center ${overview?.criticalActions > 0 ? 'border-red-500/50 bg-red-500/10' : 'border-slate-700/50'}`}>
                                    <p className={`text-3xl font-bold ${overview?.criticalActions > 0 ? 'text-red-400' : 'text-white'}`}>{overview?.pendingActions || 0}</p>
                                    <p className="text-slate-400 text-sm">Pending Actions</p>
                                    {overview?.criticalActions > 0 && <p className="text-red-400 text-xs mt-1">{overview.criticalActions} critical</p>}
                                </div>
                                <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-5 text-center">
                                    <p className="text-3xl font-bold text-amber-400">{overview?.unreadNotifications || 0}</p>
                                    <p className="text-slate-400 text-sm">Notifications</p>
                                </div>
                                <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-5 text-center">
                                    <p className="text-3xl font-bold text-green-400">{overview?.activeAgents || 0}/{overview?.totalAgents || 0}</p>
                                    <p className="text-slate-400 text-sm">Agents Active</p>
                                </div>
                                <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-5 text-center">
                                    <p className="text-3xl font-bold text-blue-400">{clients?.length || 0}</p>
                                    <p className="text-slate-400 text-sm">Active Clients</p>
                                </div>
                                <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-5 text-center">
                                    <p className="text-3xl font-bold text-purple-400">{prospects?.length || 0}</p>
                                    <p className="text-slate-400 text-sm">Prospects</p>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-3 gap-6">
                                {/* Pending Actions */}
                                <div className="col-span-2 space-y-4">
                                    <h4 className="text-white font-semibold flex items-center gap-2">{Icons.alert} Actions Requiring Your Decision</h4>
                                    {pendingActions.length === 0 ? (
                                        <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-8 text-center">
                                            <div className="text-4xl mb-3">✅</div>
                                            <p className="text-slate-400">All caught up! No pending actions.</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-3">
                                            {pendingActions.map(action => (
                                                <div key={action.id} className={`bg-slate-850 border border-${urgencyColors[action.urgency]}-500/30 rounded-xl p-4`}>
                                                    <div className="flex items-start justify-between">
                                                        <div className="flex-1">
                                                            <div className="flex items-center gap-2 mb-1">
                                                                <span className={`text-xs px-2 py-0.5 rounded bg-${urgencyColors[action.urgency]}-500/20 text-${urgencyColors[action.urgency]}-400`}>{action.urgency}</span>
                                                                <span className="text-xs text-slate-500">{action.source_agent}</span>
                                                                {action.client_id && <span className="text-xs text-slate-500">• {getClientName(action.client_id)}</span>}
                                                            </div>
                                                            <h5 className="text-white font-medium">{action.title}</h5>
                                                            {action.description && <p className="text-slate-400 text-sm mt-1">{action.description}</p>}
                                                        </div>
                                                        <div className="flex gap-2 ml-4">
                                                            {(action.options || [{ label: 'Approve', action: 'approve' }, { label: 'Reject', action: 'reject' }]).map((opt, i) => (
                                                                <button key={i} onClick={() => handleResolveAction(action.id, opt.action)}
                                                                    className={`px-3 py-1.5 rounded-lg text-sm font-medium ${opt.action === 'approve' ? 'bg-green-600 hover:bg-green-500' : opt.action === 'reject' ? 'bg-red-600 hover:bg-red-500' : 'bg-slate-600 hover:bg-slate-500'}`}>
                                                                    {opt.label}
                                                                </button>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {/* Activity Feed */}
                                    <h4 className="text-white font-semibold flex items-center gap-2 mt-6">{Icons.clock} Recent Agent Activity</h4>
                                    <div className="bg-slate-850 border border-slate-700/50 rounded-xl divide-y divide-slate-700/50 max-h-80 overflow-y-auto">
                                        {activityFeed.length === 0 ? (
                                            <div className="p-8 text-center text-slate-500">No recent activity</div>
                                        ) : (
                                            activityFeed.map(activity => (
                                                <div key={activity.id} className="p-3 flex items-center gap-3">
                                                    <div className={`w-2 h-2 rounded-full ${activity.outcome === 'success' ? 'bg-green-500' : activity.outcome === 'failure' ? 'bg-red-500' : 'bg-amber-500'}`}></div>
                                                    <div className="flex-1 min-w-0">
                                                        <p className="text-white text-sm truncate">{activity.summary || activity.activity_type}</p>
                                                        <p className="text-slate-500 text-xs">{activity.agent_name} • {new Date(activity.created_at).toLocaleTimeString()}</p>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                                
                                {/* Right Column */}
                                <div className="space-y-4">
                                    {/* Notifications */}
                                    <h4 className="text-white font-semibold flex items-center gap-2">{Icons.bell} Notifications</h4>
                                    <div className="bg-slate-850 border border-slate-700/50 rounded-xl divide-y divide-slate-700/50 max-h-64 overflow-y-auto">
                                        {notifications.length === 0 ? (
                                            <div className="p-6 text-center text-slate-500 text-sm">No new notifications</div>
                                        ) : (
                                            notifications.map(notif => (
                                                <div key={notif.id} className="p-3 flex items-start gap-3">
                                                    <div className="flex-1">
                                                        <p className="text-white text-sm">{notif.title}</p>
                                                        <p className="text-slate-500 text-xs">{new Date(notif.created_at).toLocaleString()}</p>
                                                    </div>
                                                    <button onClick={() => handleDismissNotification(notif.id)} className="text-slate-500 hover:text-white">×</button>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                    
                                    {/* Agent Status */}
                                    <h4 className="text-white font-semibold flex items-center gap-2 mt-4">{Icons.heartbeat} Agent Status</h4>
                                    <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-4 space-y-2">
                                        {['monitoring', 'underwriting', 'marketing', 'sales'].map(type => {
                                            const agents = agentStatus.filter(a => a.agent_type === type);
                                            const active = agents.filter(a => a.status === 'active').length;
                                            return (
                                                <div key={type} className="flex items-center justify-between">
                                                    <span className="text-slate-400 capitalize text-sm">{type}</span>
                                                    <span className={`text-sm ${active === agents.length ? 'text-green-400' : 'text-amber-400'}`}>
                                                        {active}/{agents.length} active
                                                    </span>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        </>
                    )}
                </div>
            );
        };
        
        // ═══════════════════════════════════════════════════════════════════════════
        // CLAIMS MONITOR - Continuous Claims Tracking
        // ═══════════════════════════════════════════════════════════════════════════
        
        const ClaimsMonitor = ({ clientId, scenarioId }) => {
            const [claimsData, setClaimsData] = useState([]);
            const [largeClaims, setLargeClaims] = useState([]);
            const [projections, setProjections] = useState([]);
            const [showAddClaims, setShowAddClaims] = useState(false);
            const [showAddLargeClaim, setShowAddLargeClaim] = useState(false);
            const [loading, setLoading] = useState(true);
            
            const fetchData = useCallback(async () => {
                if (!clientId) return;
                setLoading(true);
                const [claimsRes, largeRes, projRes] = await Promise.all([
                    supabase.from('claims_data').select('*').eq('client_id', clientId).order('period_end', { ascending: false }),
                    supabase.from('large_claims').select('*').eq('client_id', clientId).order('total_incurred', { ascending: false }),
                    supabase.from('underwriting_projections').select('*').eq('client_id', clientId).order('projection_date', { ascending: false }).limit(12)
                ]);
                setClaimsData(claimsRes.data || []);
                setLargeClaims(largeRes.data || []);
                setProjections(projRes.data || []);
                setLoading(false);
            }, [clientId]);
            
            useEffect(() => { fetchData(); }, [fetchData]);
            
            const latestClaims = claimsData[0];
            const activeLargeClaims = largeClaims.filter(c => c.status === 'active');
            const totalLargeExposure = activeLargeClaims.reduce((sum, c) => sum + (c.total_incurred || 0), 0);
            
            return (
                <div className="space-y-4">
                    {/* Summary Cards */}
                    <div className="grid grid-cols-4 gap-4">
                        <div className="bg-slate-900/50 rounded-xl p-4">
                            <p className="text-slate-400 text-sm">Latest Claims PEPM</p>
                            <p className="text-2xl font-bold text-white">{latestClaims ? formatCurrency(latestClaims.claims_pepm) : '—'}</p>
                            <p className="text-slate-500 text-xs">Through {latestClaims?.period_end || '—'}</p>
                        </div>
                        <div className="bg-slate-900/50 rounded-xl p-4">
                            <p className="text-slate-400 text-sm">Trend vs Prior Year</p>
                            <p className={`text-2xl font-bold ${latestClaims?.claims_trend_pct > 0 ? 'text-red-400' : 'text-green-400'}`}>
                                {latestClaims?.claims_trend_pct ? `${latestClaims.claims_trend_pct > 0 ? '+' : ''}${latestClaims.claims_trend_pct}%` : '—'}
                            </p>
                        </div>
                        <div className="bg-slate-900/50 rounded-xl p-4">
                            <p className="text-slate-400 text-sm">Active Large Claims</p>
                            <p className="text-2xl font-bold text-amber-400">{activeLargeClaims.length}</p>
                        </div>
                        <div className="bg-slate-900/50 rounded-xl p-4">
                            <p className="text-slate-400 text-sm">Large Claims Exposure</p>
                            <p className="text-2xl font-bold text-red-400">{formatCurrency(totalLargeExposure)}</p>
                        </div>
                    </div>
                    
                    {/* Actions */}
                    <div className="flex gap-3">
                        <button onClick={() => setShowAddClaims(true)} className="px-3 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm">{Icons.plus} Add Claims Data</button>
                        <button onClick={() => setShowAddLargeClaim(true)} className="px-3 py-2 bg-amber-600 hover:bg-amber-500 rounded-lg text-sm">{Icons.plus} Log Large Claim</button>
                    </div>
                    
                    {/* Large Claims Table */}
                    {activeLargeClaims.length > 0 && (
                        <div className="bg-slate-850 border border-amber-500/30 rounded-xl overflow-hidden">
                            <div className="px-4 py-3 bg-amber-500/10 border-b border-amber-500/30">
                                <h5 className="text-amber-400 font-semibold">Active Large Claims</h5>
                            </div>
                            <table className="w-full text-sm">
                                <thead>
                                    <tr className="border-b border-slate-700/50 text-slate-400">
                                        <th className="text-left px-4 py-2">Category</th>
                                        <th className="text-right px-4 py-2">Total Incurred</th>
                                        <th className="text-right px-4 py-2">Over ISL</th>
                                        <th className="text-center px-4 py-2">Ongoing</th>
                                        <th className="text-right px-4 py-2">Projected</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {activeLargeClaims.map(claim => (
                                        <tr key={claim.id} className="border-b border-slate-700/30">
                                            <td className="px-4 py-2 text-white capitalize">{claim.diagnosis_category}</td>
                                            <td className="px-4 py-2 text-right text-white font-medium">{formatCurrency(claim.total_incurred)}</td>
                                            <td className="px-4 py-2 text-right text-red-400">{formatCurrency(claim.amount_over_isl)}</td>
                                            <td className="px-4 py-2 text-center">{claim.is_ongoing ? <span className="text-amber-400">●</span> : <span className="text-slate-500">—</span>}</td>
                                            <td className="px-4 py-2 text-right text-amber-400">{claim.projected_total ? formatCurrency(claim.projected_total) : '—'}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                    
                    {/* Projection History */}
                    {projections.length > 0 && (
                        <div className="bg-slate-850 border border-slate-700/50 rounded-xl overflow-hidden">
                            <div className="px-4 py-3 border-b border-slate-700/50">
                                <h5 className="text-white font-semibold">Projection History</h5>
                            </div>
                            <table className="w-full text-sm">
                                <thead>
                                    <tr className="border-b border-slate-700/50 text-slate-400">
                                        <th className="text-left px-4 py-2">Date</th>
                                        <th className="text-left px-4 py-2">Type</th>
                                        <th className="text-right px-4 py-2">Projected Total</th>
                                        <th className="text-right px-4 py-2">Max Exposure</th>
                                        <th className="text-right px-4 py-2">vs Budget</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {projections.slice(0, 6).map(proj => (
                                        <tr key={proj.id} className="border-b border-slate-700/30">
                                            <td className="px-4 py-2 text-white">{new Date(proj.projection_date).toLocaleDateString()}</td>
                                            <td className="px-4 py-2 text-slate-400 capitalize">{proj.projection_type?.replace(/_/g, ' ')}</td>
                                            <td className="px-4 py-2 text-right text-white font-medium">{formatCurrency(proj.projected_total)}</td>
                                            <td className="px-4 py-2 text-right text-amber-400">{formatCurrency(proj.max_exposure)}</td>
                                            <td className={`px-4 py-2 text-right font-medium ${proj.budget_variance >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                {proj.budget_variance ? formatCurrency(proj.budget_variance) : '—'}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                    
                    {/* Add Claims Modal */}
                    <Modal isOpen={showAddClaims} onClose={() => setShowAddClaims(false)} title="Add Monthly Claims Data">
                        <AddClaimsForm clientId={clientId} scenarioId={scenarioId} onSubmit={async (data) => {
                            await supabase.from('claims_data').insert([{ ...data, client_id: clientId, scenario_id: scenarioId }]);
                            setShowAddClaims(false);
                            fetchData();
                        }} onCancel={() => setShowAddClaims(false)} />
                    </Modal>
                    
                    {/* Add Large Claim Modal */}
                    <Modal isOpen={showAddLargeClaim} onClose={() => setShowAddLargeClaim(false)} title="Log Large Claim">
                        <AddLargeClaimForm clientId={clientId} onSubmit={async (data) => {
                            await supabase.from('large_claims').insert([{ ...data, client_id: clientId }]);
                            setShowAddLargeClaim(false);
                            fetchData();
                        }} onCancel={() => setShowAddLargeClaim(false)} />
                    </Modal>
                </div>
            );
        };
        
        // Add Claims Data Form
        const AddClaimsForm = ({ clientId, scenarioId, onSubmit, onCancel }) => {
            const [formData, setFormData] = useState({
                period_start: '', period_end: '', period_type: 'monthly',
                total_claims: '', medical_claims: '', rx_claims: '',
                member_months: '', employee_months: '',
                large_claims_count: 0, large_claims_total: 0,
                claims_trend_pct: '', data_source: 'carrier_feed'
            });
            const handleSubmit = (e) => {
                e.preventDefault();
                const data = { ...formData };
                // Calculate PEPM/PMPM
                if (data.total_claims && data.employee_months) data.claims_pepm = parseFloat(data.total_claims) / parseFloat(data.employee_months);
                if (data.total_claims && data.member_months) data.claims_pmpm = parseFloat(data.total_claims) / parseFloat(data.member_months);
                onSubmit(data);
            };
            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="grid grid-cols-3 gap-4">
                        <div><label className="block text-sm text-slate-400 mb-1">Period Start</label>
                            <input type="date" required value={formData.period_start} onChange={(e) => setFormData({...formData, period_start: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                        <div><label className="block text-sm text-slate-400 mb-1">Period End</label>
                            <input type="date" required value={formData.period_end} onChange={(e) => setFormData({...formData, period_end: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                        <div><label className="block text-sm text-slate-400 mb-1">Period Type</label>
                            <select value={formData.period_type} onChange={(e) => setFormData({...formData, period_type: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white">
                                <option value="monthly">Monthly</option><option value="quarterly">Quarterly</option><option value="ytd">YTD</option><option value="rolling_12">Rolling 12</option>
                            </select></div>
                    </div>
                    <div className="grid grid-cols-3 gap-4">
                        <div><label className="block text-sm text-slate-400 mb-1">Total Claims $</label>
                            <input type="number" required value={formData.total_claims} onChange={(e) => setFormData({...formData, total_claims: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                        <div><label className="block text-sm text-slate-400 mb-1">Employee Months</label>
                            <input type="number" value={formData.employee_months} onChange={(e) => setFormData({...formData, employee_months: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                        <div><label className="block text-sm text-slate-400 mb-1">Member Months</label>
                            <input type="number" value={formData.member_months} onChange={(e) => setFormData({...formData, member_months: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm text-slate-400 mb-1">Large Claims Count</label>
                            <input type="number" value={formData.large_claims_count} onChange={(e) => setFormData({...formData, large_claims_count: parseInt(e.target.value)})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                        <div><label className="block text-sm text-slate-400 mb-1">Trend vs Prior Year %</label>
                            <input type="number" step="0.1" value={formData.claims_trend_pct} onChange={(e) => setFormData({...formData, claims_trend_pct: e.target.value})} placeholder="e.g., 8.5" className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    </div>
                    <div className="flex gap-3 pt-2">
                        <button type="button" onClick={onCancel} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Cancel</button>
                        <button type="submit" className="flex-1 px-4 py-2.5 bg-blue-600 hover:bg-blue-500 rounded-lg font-medium">Save Claims Data</button>
                    </div>
                </form>
            );
        };
        
        // Add Large Claim Form
        const AddLargeClaimForm = ({ clientId, onSubmit, onCancel }) => {
            const [formData, setFormData] = useState({
                diagnosis_category: 'other', total_paid: '', total_incurred: '',
                isl_deductible: 150000, amount_over_isl: '',
                is_ongoing: true, projected_total: '', projection_notes: ''
            });
            const handleSubmit = (e) => {
                e.preventDefault();
                const data = { ...formData, status: 'active' };
                // Calculate amount over ISL
                if (data.total_incurred && data.isl_deductible) {
                    data.amount_over_isl = Math.max(0, parseFloat(data.total_incurred) - parseFloat(data.isl_deductible));
                }
                onSubmit(data);
            };
            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div><label className="block text-sm text-slate-400 mb-1">Diagnosis Category</label>
                        <select required value={formData.diagnosis_category} onChange={(e) => setFormData({...formData, diagnosis_category: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white">
                            <option value="cardiac">Cardiac</option><option value="oncology">Oncology</option><option value="neonatal">Neonatal</option>
                            <option value="transplant">Transplant</option><option value="trauma">Trauma</option><option value="musculoskeletal">Musculoskeletal</option>
                            <option value="neurological">Neurological</option><option value="other">Other</option>
                        </select></div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm text-slate-400 mb-1">Total Paid $</label>
                            <input type="number" required value={formData.total_paid} onChange={(e) => setFormData({...formData, total_paid: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                        <div><label className="block text-sm text-slate-400 mb-1">Total Incurred $ (w/ reserves)</label>
                            <input type="number" required value={formData.total_incurred} onChange={(e) => setFormData({...formData, total_incurred: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm text-slate-400 mb-1">ISL Deductible</label>
                            <select value={formData.isl_deductible} onChange={(e) => setFormData({...formData, isl_deductible: parseInt(e.target.value)})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white">
                                {ISL_DEDUCTIBLES.map(d => <option key={d} value={d}>${d.toLocaleString()}</option>)}
                            </select></div>
                        <div><label className="block text-sm text-slate-400 mb-1">Is Ongoing?</label>
                            <select value={formData.is_ongoing ? 'yes' : 'no'} onChange={(e) => setFormData({...formData, is_ongoing: e.target.value === 'yes'})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white">
                                <option value="yes">Yes - Treatment continuing</option><option value="no">No - Claim closed</option>
                            </select></div>
                    </div>
                    {formData.is_ongoing && (
                        <div><label className="block text-sm text-slate-400 mb-1">Projected Total (if ongoing)</label>
                            <input type="number" value={formData.projected_total} onChange={(e) => setFormData({...formData, projected_total: e.target.value})} placeholder="Estimated final cost" className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    )}
                    <div><label className="block text-sm text-slate-400 mb-1">Notes</label>
                        <textarea value={formData.projection_notes} onChange={(e) => setFormData({...formData, projection_notes: e.target.value})} rows={2} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    <div className="flex gap-3 pt-2">
                        <button type="button" onClick={onCancel} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Cancel</button>
                        <button type="submit" className="flex-1 px-4 py-2.5 bg-amber-600 hover:bg-amber-500 rounded-lg font-medium">Log Large Claim</button>
                    </div>
                </form>
            );
        };
        
        // ═══════════════════════════════════════════════════════════════════════════
        // SALES PIPELINE - Prospect & Deal Tracking
        // ═══════════════════════════════════════════════════════════════════════════
        
        const SalesPipeline = () => {
            const [prospects, setProspects] = useState([]);
            const [pipeline, setPipeline] = useState([]);
            const [showAddProspect, setShowAddProspect] = useState(false);
            const [selectedProspect, setSelectedProspect] = useState(null);
            const [loading, setLoading] = useState(true);
            const [viewMode, setViewMode] = useState('pipeline'); // 'pipeline', 'prospects', 'meetings'
            
            const fetchData = useCallback(async () => {
                setLoading(true);
                const [prospectsRes, pipelineRes] = await Promise.all([
                    supabase.from('prospects').select('*').order('created_at', { ascending: false }),
                    supabase.from('sales_pipeline').select('*, prospects(company_name)').order('expected_close_date')
                ]);
                setProspects(prospectsRes.data || []);
                setPipeline(pipelineRes.data || []);
                setLoading(false);
            }, []);
            
            useEffect(() => { fetchData(); }, [fetchData]);
            
            const stages = ['lead', 'qualified', 'discovery', 'proposal', 'negotiation', 'verbal_commit'];
            const stageColors = { lead: 'slate', qualified: 'blue', discovery: 'purple', proposal: 'amber', negotiation: 'orange', verbal_commit: 'green' };
            
            const pipelineByStage = stages.map(stage => ({
                stage,
                deals: pipeline.filter(d => d.stage === stage),
                totalValue: pipeline.filter(d => d.stage === stage).reduce((sum, d) => sum + (d.deal_value || 0), 0),
                weightedValue: pipeline.filter(d => d.stage === stage).reduce((sum, d) => sum + (d.weighted_value || 0), 0)
            }));
            
            const totalPipeline = pipeline.reduce((sum, d) => sum + (d.deal_value || 0), 0);
            const totalWeighted = pipeline.reduce((sum, d) => sum + (d.weighted_value || 0), 0);
            
            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-emerald-600/20 to-teal-600/20 border border-emerald-500/30 rounded-xl p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <h3 className="text-xl font-bold text-white mb-2">Sales Pipeline</h3>
                                <p className="text-slate-300">Track prospects from lead to close.</p>
                            </div>
                            <button onClick={() => setShowAddProspect(true)} className="flex items-center gap-2 px-4 py-2.5 bg-emerald-600 hover:bg-emerald-500 rounded-lg font-medium">
                                {Icons.plus} Add Prospect
                            </button>
                        </div>
                    </div>
                    
                    {/* Pipeline Summary */}
                    <div className="grid grid-cols-4 gap-4">
                        <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-5">
                            <p className="text-slate-400 text-sm">Total Prospects</p>
                            <p className="text-3xl font-bold text-white">{prospects.length}</p>
                        </div>
                        <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-5">
                            <p className="text-slate-400 text-sm">Active Deals</p>
                            <p className="text-3xl font-bold text-emerald-400">{pipeline.length}</p>
                        </div>
                        <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-5">
                            <p className="text-slate-400 text-sm">Pipeline Value</p>
                            <p className="text-3xl font-bold text-white">{formatCurrency(totalPipeline)}</p>
                        </div>
                        <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-5">
                            <p className="text-slate-400 text-sm">Weighted Forecast</p>
                            <p className="text-3xl font-bold text-blue-400">{formatCurrency(totalWeighted)}</p>
                        </div>
                    </div>
                    
                    {/* View Toggle */}
                    <div className="flex gap-2">
                        {[{ id: 'pipeline', label: 'Pipeline View' }, { id: 'prospects', label: 'All Prospects' }].map(v => (
                            <button key={v.id} onClick={() => setViewMode(v.id)}
                                className={`px-4 py-2 rounded-lg text-sm font-medium ${viewMode === v.id ? 'bg-emerald-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>
                                {v.label}
                            </button>
                        ))}
                    </div>
                    
                    {loading ? <div className="text-center py-12">{Icons.loader}</div> : viewMode === 'pipeline' ? (
                        /* Pipeline Board */
                        <div className="grid grid-cols-6 gap-4">
                            {pipelineByStage.map(({ stage, deals, totalValue }) => (
                                <div key={stage} className="bg-slate-850 border border-slate-700/50 rounded-xl overflow-hidden">
                                    <div className={`px-3 py-2 bg-${stageColors[stage]}-500/20 border-b border-${stageColors[stage]}-500/30`}>
                                        <p className={`text-${stageColors[stage]}-400 font-semibold capitalize text-sm`}>{stage.replace('_', ' ')}</p>
                                        <p className="text-slate-400 text-xs">{deals.length} deals • {formatCurrency(totalValue)}</p>
                                    </div>
                                    <div className="p-2 space-y-2 max-h-96 overflow-y-auto">
                                        {deals.map(deal => (
                                            <div key={deal.id} className="bg-slate-900/50 rounded-lg p-3 cursor-pointer hover:bg-slate-800/50">
                                                <p className="text-white font-medium text-sm truncate">{deal.prospects?.company_name || deal.deal_name}</p>
                                                <p className="text-slate-400 text-xs">{formatCurrency(deal.deal_value)}</p>
                                                {deal.expected_close_date && <p className="text-slate-500 text-xs">Close: {new Date(deal.expected_close_date).toLocaleDateString()}</p>}
                                            </div>
                                        ))}
                                        {deals.length === 0 && <p className="text-slate-600 text-xs text-center py-4">No deals</p>}
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        /* Prospects List */
                        <div className="bg-slate-850 border border-slate-700/50 rounded-xl overflow-hidden">
                            <table className="w-full text-sm">
                                <thead>
                                    <tr className="bg-slate-900/50 border-b border-slate-700/50 text-slate-400">
                                        <th className="text-left px-4 py-3">Company</th>
                                        <th className="text-left px-4 py-3">Industry</th>
                                        <th className="text-center px-4 py-3">Size</th>
                                        <th className="text-left px-4 py-3">Status</th>
                                        <th className="text-left px-4 py-3">Contact</th>
                                        <th className="text-left px-4 py-3">Source</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {prospects.map(p => (
                                        <tr key={p.id} className="border-b border-slate-700/30 hover:bg-slate-800/30 cursor-pointer" onClick={() => setSelectedProspect(p)}>
                                            <td className="px-4 py-3 text-white font-medium">{p.company_name}</td>
                                            <td className="px-4 py-3 text-slate-400">{p.industry || '—'}</td>
                                            <td className="px-4 py-3 text-center text-slate-400">{p.employee_count_estimate || '—'}</td>
                                            <td className="px-4 py-3"><span className={`px-2 py-0.5 rounded text-xs status-${p.status}`}>{p.status}</span></td>
                                            <td className="px-4 py-3 text-slate-400">{p.primary_contact_name || '—'}</td>
                                            <td className="px-4 py-3 text-slate-500 text-xs">{p.lead_source || '—'}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                    
                    {/* Add Prospect Modal */}
                    <Modal isOpen={showAddProspect} onClose={() => setShowAddProspect(false)} title="Add Prospect">
                        <AddProspectForm onSubmit={async (data) => {
                            await supabase.from('prospects').insert([data]);
                            setShowAddProspect(false);
                            fetchData();
                        }} onCancel={() => setShowAddProspect(false)} />
                    </Modal>
                </div>
            );
        };
        
        // Add Prospect Form
        const AddProspectForm = ({ onSubmit, onCancel }) => {
            const [formData, setFormData] = useState({
                company_name: '', industry: '', employee_count_estimate: '',
                headquarters_city: '', headquarters_state: '',
                estimated_funding_type: 'unknown',
                primary_contact_name: '', primary_contact_title: '', primary_contact_email: '',
                lead_source: 'outbound', status: 'new'
            });
            const handleSubmit = (e) => { e.preventDefault(); onSubmit(formData); };
            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div><label className="block text-sm text-slate-400 mb-1">Company Name *</label>
                        <input type="text" required value={formData.company_name} onChange={(e) => setFormData({...formData, company_name: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm text-slate-400 mb-1">Industry</label>
                            <input type="text" value={formData.industry} onChange={(e) => setFormData({...formData, industry: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                        <div><label className="block text-sm text-slate-400 mb-1">Employee Count</label>
                            <input type="number" value={formData.employee_count_estimate} onChange={(e) => setFormData({...formData, employee_count_estimate: parseInt(e.target.value)})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm text-slate-400 mb-1">Funding Type</label>
                            <select value={formData.estimated_funding_type} onChange={(e) => setFormData({...formData, estimated_funding_type: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white">
                                <option value="unknown">Unknown</option><option value="fully_insured">Fully Insured</option><option value="self_funded">Self-Funded</option>
                            </select></div>
                        <div><label className="block text-sm text-slate-400 mb-1">Lead Source</label>
                            <select value={formData.lead_source} onChange={(e) => setFormData({...formData, lead_source: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white">
                                <option value="outbound">Outbound</option><option value="inbound">Inbound</option><option value="referral">Referral</option><option value="event">Event</option><option value="linkedin">LinkedIn</option>
                            </select></div>
                    </div>
                    <div className="border-t border-slate-700 pt-4"><p className="text-sm text-slate-400 mb-2">Primary Contact</p>
                        <div className="grid grid-cols-2 gap-4">
                            <input type="text" value={formData.primary_contact_name} onChange={(e) => setFormData({...formData, primary_contact_name: e.target.value})} placeholder="Name" className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" />
                            <input type="text" value={formData.primary_contact_title} onChange={(e) => setFormData({...formData, primary_contact_title: e.target.value})} placeholder="Title" className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" />
                        </div>
                        <input type="email" value={formData.primary_contact_email} onChange={(e) => setFormData({...formData, primary_contact_email: e.target.value})} placeholder="Email" className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white mt-2" />
                    </div>
                    <div className="flex gap-3 pt-2">
                        <button type="button" onClick={onCancel} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Cancel</button>
                        <button type="submit" className="flex-1 px-4 py-2.5 bg-emerald-600 hover:bg-emerald-500 rounded-lg font-medium">Add Prospect</button>
                    </div>
                </form>
            );
        };

        // Edit Brand Voice Form
        const EditBrandVoiceForm = ({ brandVoice, onSubmit, onCancel }) => {
            const [formData, setFormData] = useState({
                name: brandVoice?.name || 'Canon Echo Voice',
                tone: brandVoice?.tone || 'professional',
                formality: brandVoice?.formality || 'moderate',
                personality_traits: brandVoice?.personality_traits || ['data-driven', 'trustworthy'],
                words_to_avoid: brandVoice?.words_to_avoid || [],
                preferred_cta_style: brandVoice?.preferred_cta_style || 'soft',
                use_statistics: brandVoice?.use_statistics ?? true,
                use_questions: brandVoice?.use_questions ?? true,
                custom_instructions: brandVoice?.custom_instructions || ''
            });
            const [newTrait, setNewTrait] = useState('');
            const [newAvoid, setNewAvoid] = useState('');
            
            const handleSubmit = (e) => { e.preventDefault(); onSubmit(formData); };
            
            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="block text-sm text-slate-400 mb-1">Voice Name</label>
                        <input type="text" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})}
                            className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-pink-500" />
                    </div>
                    
                    <div className="grid grid-cols-3 gap-4">
                        <div>
                            <label className="block text-sm text-slate-400 mb-1">Tone</label>
                            <select value={formData.tone} onChange={(e) => setFormData({...formData, tone: e.target.value})}
                                className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-pink-500">
                                <option value="professional">Professional</option>
                                <option value="conversational">Conversational</option>
                                <option value="authoritative">Authoritative</option>
                                <option value="friendly">Friendly</option>
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm text-slate-400 mb-1">Formality</label>
                            <select value={formData.formality} onChange={(e) => setFormData({...formData, formality: e.target.value})}
                                className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-pink-500">
                                <option value="formal">Formal</option>
                                <option value="moderate">Moderate</option>
                                <option value="casual">Casual</option>
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm text-slate-400 mb-1">CTA Style</label>
                            <select value={formData.preferred_cta_style} onChange={(e) => setFormData({...formData, preferred_cta_style: e.target.value})}
                                className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-pink-500">
                                <option value="soft">Soft (question-based)</option>
                                <option value="direct">Direct (action-based)</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label className="block text-sm text-slate-400 mb-1">Personality Traits</label>
                        <div className="flex flex-wrap gap-2 mb-2">
                            {formData.personality_traits.map((trait, i) => (
                                <span key={i} className="px-2 py-1 bg-pink-500/20 text-pink-400 rounded text-sm flex items-center gap-1">
                                    {trait}
                                    <button type="button" onClick={() => setFormData({...formData, personality_traits: formData.personality_traits.filter((_, idx) => idx !== i)})} className="hover:text-white">×</button>
                                </span>
                            ))}
                        </div>
                        <div className="flex gap-2">
                            <input type="text" value={newTrait} onChange={(e) => setNewTrait(e.target.value)} placeholder="Add trait..."
                                className="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-3 py-1.5 text-white text-sm focus:outline-none focus:border-pink-500" />
                            <button type="button" onClick={() => { if (newTrait) { setFormData({...formData, personality_traits: [...formData.personality_traits, newTrait]}); setNewTrait(''); }}}
                                className="px-3 py-1.5 bg-pink-600 hover:bg-pink-500 rounded-lg text-sm">Add</button>
                        </div>
                    </div>
                    
                    <div>
                        <label className="block text-sm text-slate-400 mb-1">Words to Avoid</label>
                        <div className="flex flex-wrap gap-2 mb-2">
                            {formData.words_to_avoid.map((word, i) => (
                                <span key={i} className="px-2 py-1 bg-red-500/20 text-red-400 rounded text-sm flex items-center gap-1 line-through">
                                    {word}
                                    <button type="button" onClick={() => setFormData({...formData, words_to_avoid: formData.words_to_avoid.filter((_, idx) => idx !== i)})} className="hover:text-white no-underline">×</button>
                                </span>
                            ))}
                        </div>
                        <div className="flex gap-2">
                            <input type="text" value={newAvoid} onChange={(e) => setNewAvoid(e.target.value)} placeholder="Add word to avoid..."
                                className="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-3 py-1.5 text-white text-sm focus:outline-none focus:border-pink-500" />
                            <button type="button" onClick={() => { if (newAvoid) { setFormData({...formData, words_to_avoid: [...formData.words_to_avoid, newAvoid]}); setNewAvoid(''); }}}
                                className="px-3 py-1.5 bg-red-600 hover:bg-red-500 rounded-lg text-sm">Add</button>
                        </div>
                    </div>
                    
                    <div>
                        <label className="block text-sm text-slate-400 mb-1">Custom Instructions</label>
                        <textarea value={formData.custom_instructions} onChange={(e) => setFormData({...formData, custom_instructions: e.target.value})}
                            placeholder="Additional guidance for AI content generation..." rows={3}
                            className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-pink-500 resize-none" />
                    </div>
                    
                    <div className="flex gap-3 pt-2">
                        <button type="button" onClick={onCancel} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Cancel</button>
                        <button type="submit" className="flex-1 px-4 py-2.5 bg-pink-600 hover:bg-pink-500 rounded-lg font-medium">Save Brand Voice</button>
                    </div>
                </form>
            );
        };

        // ═══════════════════════════════════════════════════════════════════════════
        // UNDERWRITING AGENT - FINANCIAL MODELING ENGINE
        // ═══════════════════════════════════════════════════════════════════════════
        
        const ISL_DEDUCTIBLES = [50000, 75000, 100000, 125000, 150000, 175000, 200000, 250000, 300000, 350000, 400000, 450000, 500000];
        const ASL_CORRIDORS = [110, 120, 125];
        
        const formatCurrency = (num) => {
            if (num === null || num === undefined) return '—';
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(num);
        };
        
        const formatPct = (num) => {
            if (num === null || num === undefined) return '—';
            return `${num >= 0 ? '+' : ''}${num.toFixed(1)}%`;
        };
        
        const UnderwritingAgent = ({ clients }) => {
            const [scenarios, setScenarios] = useState([]);
            const [plans, setPlans] = useState([]);
            const [fixedCosts, setFixedCosts] = useState(null);
            const [variableCosts, setVariableCosts] = useState(null);
            const [credits, setCredits] = useState(null);
            const [loading, setLoading] = useState(true);
            const [selectedScenario, setSelectedScenario] = useState(null);
            const [showNewScenario, setShowNewScenario] = useState(false);
            const [meetingMode, setMeetingMode] = useState(false);
            const [activeView, setActiveView] = useState('overview'); // 'overview', 'plans', 'costs', 'meeting'
            
            const fetchScenarios = useCallback(async () => {
                setLoading(true);
                const { data } = await supabase.from('underwriting_scenarios').select('*').order('created_at', { ascending: false });
                setScenarios(data || []);
                setLoading(false);
            }, []);
            
            const fetchScenarioDetails = useCallback(async (scenarioId) => {
                const [plansRes, fixedRes, varRes, creditsRes] = await Promise.all([
                    supabase.from('uw_plan_options').select('*').eq('scenario_id', scenarioId).order('sort_order'),
                    supabase.from('sf_fixed_costs').select('*').eq('scenario_id', scenarioId).single(),
                    supabase.from('sf_variable_costs').select('*').eq('scenario_id', scenarioId).single(),
                    supabase.from('sf_credits').select('*').eq('scenario_id', scenarioId).single()
                ]);
                setPlans(plansRes.data || []);
                setFixedCosts(fixedRes.data);
                setVariableCosts(varRes.data);
                setCredits(creditsRes.data);
            }, []);
            
            useEffect(() => { fetchScenarios(); }, [fetchScenarios]);
            useEffect(() => { if (selectedScenario) fetchScenarioDetails(selectedScenario.id); }, [selectedScenario, fetchScenarioDetails]);
            
            // Calculate plan costs
            const calculatePlanCosts = (plan, scenario) => {
                const monthly = (plan.enroll_ee_only || 0) * (plan.rate_ee_only || 0) +
                               (plan.enroll_ee_spouse || 0) * (plan.rate_ee_spouse || 0) +
                               (plan.enroll_ee_child || 0) * (plan.rate_ee_child || 0) +
                               (plan.enroll_family || 0) * (plan.rate_family || 0);
                const annual = monthly * 12;
                
                const priorMonthly = (plan.enroll_ee_only || 0) * (plan.prior_rate_ee_only || 0) +
                                    (plan.enroll_ee_spouse || 0) * (plan.prior_rate_ee_spouse || 0) +
                                    (plan.enroll_ee_child || 0) * (plan.prior_rate_ee_child || 0) +
                                    (plan.enroll_family || 0) * (plan.prior_rate_family || 0);
                const priorAnnual = priorMonthly * 12;
                const changePct = priorAnnual > 0 ? ((annual - priorAnnual) / priorAnnual * 100) : null;
                
                const totalEnrolled = (plan.enroll_ee_only || 0) + (plan.enroll_ee_spouse || 0) + (plan.enroll_ee_child || 0) + (plan.enroll_family || 0);
                const erPct = (scenario?.contribution_pct || 75) / 100;
                let erMonthly = 0;
                
                if (scenario?.contribution_strategy === 'pct_ee_only') {
                    erMonthly = totalEnrolled * (plan.rate_ee_only || 0) * erPct;
                } else {
                    erMonthly = monthly * erPct;
                }
                
                const eeMonthlyAvg = totalEnrolled > 0 ? (monthly - erMonthly) / totalEnrolled : 0;
                
                return { monthly, annual, priorAnnual, changePct, erAnnual: erMonthly * 12, eeMonthlyAvg, totalEnrolled };
            };
            
            // Calculate self-funded totals
            const calcSelfFundedTotals = () => {
                if (!selectedScenario || selectedScenario.funding_type !== 'self_funded') return null;
                
                const employees = selectedScenario.total_employees || 0;
                const members = selectedScenario.total_members || 0;
                const multiplier = selectedScenario.calc_mode === 'pmpm' ? members : employees;
                
                // Fixed costs
                let fixedTotal = 0;
                if (fixedCosts) {
                    const tpa = selectedScenario.calc_mode === 'pmpm' ? (fixedCosts.tpa_pmpm || 0) : (fixedCosts.tpa_pepm || 0);
                    const network = selectedScenario.calc_mode === 'pmpm' ? (fixedCosts.network_pmpm || 0) : (fixedCosts.network_pepm || 0);
                    const isl = selectedScenario.calc_mode === 'pmpm' ? (fixedCosts.isl_pmpm || 0) : (fixedCosts.isl_pepm || 0);
                    const asl = selectedScenario.calc_mode === 'pmpm' ? (fixedCosts.asl_pmpm || 0) : (fixedCosts.asl_pepm || 0);
                    const pointSolutions = (fixedCosts.point_solutions || []).reduce((sum, ps) => sum + (ps.annual || (ps.pepm * multiplier * 12) || 0), 0);
                    fixedTotal = (tpa + network + isl + asl) * multiplier * 12 + pointSolutions;
                }
                
                // Variable costs (claims)
                let variableTotal = 0;
                let maxExposure = 0;
                if (variableCosts) {
                    const claimsPEPM = variableCosts.use_projection === 'internal' 
                        ? (selectedScenario.calc_mode === 'pmpm' ? variableCosts.internal_claims_pmpm : variableCosts.internal_claims_pepm)
                        : (selectedScenario.calc_mode === 'pmpm' ? variableCosts.carrier_claims_pmpm : variableCosts.carrier_claims_pepm);
                    const estimatedClaims = (claimsPEPM || 0) * multiplier * 12;
                    
                    const maxClaimsPEPM = selectedScenario.calc_mode === 'pmpm' ? variableCosts.max_claims_pmpm : variableCosts.max_claims_pepm;
                    const maxClaims = (maxClaimsPEPM || 0) * multiplier * 12;
                    
                    const oon = variableCosts.oon_method === 'pct_claims' 
                        ? estimatedClaims * (variableCosts.oon_pct || 0) / 100
                        : (variableCosts.oon_flat || 0);
                    
                    variableTotal = estimatedClaims + oon;
                    maxExposure = maxClaims + oon;
                }
                
                // Credits
                let creditsTotal = 0;
                if (credits) {
                    if (credits.rx_rebate_method === 'flat_pepm') {
                        creditsTotal = (credits.rx_rebate_pepm || 0) * multiplier * 12;
                    } else if (credits.rx_rebate_method === 'pct_rx') {
                        creditsTotal = (credits.rx_spend_annual || 0) * (credits.rx_rebate_pct || 0) / 100;
                    } else if (credits.rx_rebate_method === 'per_script') {
                        creditsTotal = (credits.rx_script_count || 0) * (credits.rx_rebate_per_script || 0);
                    } else if (credits.rx_rebate_method === 'guaranteed_min') {
                        creditsTotal = credits.rx_guaranteed_min || 0;
                    }
                    creditsTotal += (credits.other_credits || []).reduce((sum, c) => sum + (c.amount || 0), 0);
                }
                
                return {
                    fixedTotal,
                    variableTotal,
                    creditsTotal,
                    projectedTotal: fixedTotal + variableTotal - creditsTotal,
                    maxExposure: fixedTotal + maxExposure - creditsTotal
                };
            };
            
            const sfTotals = calcSelfFundedTotals();
            
            // Budget comparison
            const getBudgetStatus = () => {
                if (!selectedScenario?.budget_annual) return null;
                let cost = 0;
                if (selectedScenario.funding_type === 'fully_insured') {
                    cost = plans.reduce((sum, p) => sum + (calculatePlanCosts(p, selectedScenario).erAnnual || 0), 0);
                } else if (sfTotals) {
                    cost = sfTotals.projectedTotal * (selectedScenario.contribution_pct || 100) / 100;
                }
                const variance = selectedScenario.budget_annual - cost;
                return { cost, variance, isUnder: variance >= 0 };
            };
            
            const budgetStatus = getBudgetStatus();
            
            const handleCreateScenario = async (data) => {
                try {
                    const { data: newScenario, error } = await supabase.from('underwriting_scenarios').insert([data]).select().single();
                    if (error) throw error;
                    
                    // If self-funded, create empty cost tables
                    if (data.funding_type === 'self_funded') {
                        await Promise.all([
                            supabase.from('sf_fixed_costs').insert([{ scenario_id: newScenario.id }]),
                            supabase.from('sf_variable_costs').insert([{ scenario_id: newScenario.id }]),
                            supabase.from('sf_credits').insert([{ scenario_id: newScenario.id }])
                        ]);
                    }
                    
                    setShowNewScenario(false);
                    fetchScenarios();
                    setSelectedScenario(newScenario);
                } catch (err) { alert('Error: ' + err.message); }
            };
            
            const handleUpdateScenario = async (updates) => {
                if (!selectedScenario) return;
                await supabase.from('underwriting_scenarios').update({ ...updates, updated_at: new Date().toISOString() }).eq('id', selectedScenario.id);
                setSelectedScenario({ ...selectedScenario, ...updates });
            };
            
            const handleAddPlan = async () => {
                if (!selectedScenario) return;
                const { data } = await supabase.from('uw_plan_options').insert([{
                    scenario_id: selectedScenario.id,
                    plan_name: `Plan ${plans.length + 1}`,
                    enroll_ee_only: selectedScenario.tier_ee_only || 0,
                    enroll_ee_spouse: selectedScenario.tier_ee_spouse || 0,
                    enroll_ee_child: selectedScenario.tier_ee_child || 0,
                    enroll_family: selectedScenario.tier_family || 0,
                    sort_order: plans.length
                }]).select();
                if (data) setPlans([...plans, data[0]]);
            };
            
            const handleUpdatePlan = async (planId, updates) => {
                await supabase.from('uw_plan_options').update({ ...updates, updated_at: new Date().toISOString() }).eq('id', planId);
                setPlans(plans.map(p => p.id === planId ? { ...p, ...updates } : p));
            };
            
            const handleDeletePlan = async (planId) => {
                if (!confirm('Delete this plan?')) return;
                await supabase.from('uw_plan_options').delete().eq('id', planId);
                setPlans(plans.filter(p => p.id !== planId));
            };
            
            const handleUpdateFixedCosts = async (updates) => {
                if (!fixedCosts?.id) return;
                await supabase.from('sf_fixed_costs').update({ ...updates, updated_at: new Date().toISOString() }).eq('id', fixedCosts.id);
                setFixedCosts({ ...fixedCosts, ...updates });
            };
            
            const handleUpdateVariableCosts = async (updates) => {
                if (!variableCosts?.id) return;
                await supabase.from('sf_variable_costs').update({ ...updates, updated_at: new Date().toISOString() }).eq('id', variableCosts.id);
                setVariableCosts({ ...variableCosts, ...updates });
            };
            
            const handleUpdateCredits = async (updates) => {
                if (!credits?.id) return;
                await supabase.from('sf_credits').update({ ...updates, updated_at: new Date().toISOString() }).eq('id', credits.id);
                setCredits({ ...credits, ...updates });
            };
            
            const getClientName = (clientId) => clients.find(c => c.id === clientId)?.company_name || 'Unknown';
            
            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-cyan-600/20 to-blue-600/20 border border-cyan-500/30 rounded-xl p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <h3 className="text-xl font-bold text-white mb-2">Underwriting Agent</h3>
                                <p className="text-slate-300">Real-time financial modeling for fully insured and self-funded plans.</p>
                            </div>
                            <div className="flex gap-3">
                                {selectedScenario && (
                                    <button onClick={() => setMeetingMode(!meetingMode)} className={`flex items-center gap-2 px-4 py-2.5 rounded-lg font-medium transition-colors ${meetingMode ? 'bg-green-600 hover:bg-green-500' : 'bg-slate-700 hover:bg-slate-600'}`}>
                                        🎯 {meetingMode ? 'Exit Meeting Mode' : 'Meeting Mode'}
                                    </button>
                                )}
                                <button onClick={() => setShowNewScenario(true)} className="flex items-center gap-2 px-4 py-2.5 bg-cyan-600 hover:bg-cyan-500 rounded-lg font-medium">
                                    {Icons.plus} New Scenario
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {loading ? <div className="text-center py-12 text-slate-500">{Icons.loader}</div> : !selectedScenario ? (
                        // Scenario List
                        <div className="space-y-4">
                            <h4 className="text-white font-semibold">Select a Scenario</h4>
                            {scenarios.length === 0 ? (
                                <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-12 text-center">
                                    <div className="text-4xl mb-4">📊</div>
                                    <h4 className="text-white font-semibold text-lg mb-2">No Scenarios Yet</h4>
                                    <p className="text-slate-400 mb-4">Create your first underwriting scenario to start financial modeling.</p>
                                    <button onClick={() => setShowNewScenario(true)} className="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 rounded-lg font-medium">Create Scenario</button>
                                </div>
                            ) : (
                                <div className="grid grid-cols-2 gap-4">
                                    {scenarios.map(s => (
                                        <div key={s.id} onClick={() => setSelectedScenario(s)} className="bg-slate-850 border border-slate-700/50 rounded-xl p-5 cursor-pointer hover:border-cyan-500/50 transition-colors">
                                            <div className="flex items-start justify-between mb-3">
                                                <div>
                                                    <h5 className="text-white font-semibold">{s.name}</h5>
                                                    <p className="text-slate-400 text-sm">{getClientName(s.client_id)}</p>
                                                </div>
                                                <span className={`text-xs px-2 py-1 rounded ${s.funding_type === 'self_funded' ? 'bg-purple-500/20 text-purple-400' : 'bg-blue-500/20 text-blue-400'}`}>
                                                    {s.funding_type === 'self_funded' ? 'Self-Funded' : 'Fully Insured'}
                                                </span>
                                            </div>
                                            <div className="grid grid-cols-3 gap-3 text-sm">
                                                <div><span className="text-slate-500">Employees:</span> <span className="text-white">{s.total_employees || '—'}</span></div>
                                                <div><span className="text-slate-500">Budget:</span> <span className="text-white">{s.budget_annual ? formatCurrency(s.budget_annual) : '—'}</span></div>
                                                <div><span className="text-slate-500">ER %:</span> <span className="text-white">{s.contribution_pct || 75}%</span></div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    ) : meetingMode ? (
                        // ═══════════════════════════════════════════════════════════════
                        // MEETING MODE - Big numbers, instant adjustments
                        // ═══════════════════════════════════════════════════════════════
                        <div className="space-y-6">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h4 className="text-2xl font-bold text-white">{selectedScenario.name}</h4>
                                    <p className="text-slate-400">{getClientName(selectedScenario.client_id)} • {selectedScenario.funding_type === 'self_funded' ? 'Self-Funded' : 'Fully Insured'}</p>
                                </div>
                                <button onClick={() => setSelectedScenario(null)} className="text-slate-400 hover:text-white">← Back</button>
                            </div>
                            
                            {/* Quick Adjust Bar */}
                            <div className="bg-slate-850 border border-cyan-500/30 rounded-xl p-6">
                                <div className="grid grid-cols-4 gap-6">
                                    <div>
                                        <label className="block text-sm text-slate-400 mb-2">Annual Budget</label>
                                        <input type="number" value={selectedScenario.budget_annual || ''} onChange={(e) => handleUpdateScenario({ budget_annual: parseFloat(e.target.value) || null })}
                                            className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-xl font-bold text-white focus:outline-none focus:border-cyan-500" />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-slate-400 mb-2">ER Contribution %</label>
                                        <input type="number" value={selectedScenario.contribution_pct || 75} onChange={(e) => handleUpdateScenario({ contribution_pct: parseFloat(e.target.value) })}
                                            className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-xl font-bold text-white focus:outline-none focus:border-cyan-500" />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-slate-400 mb-2">Employees</label>
                                        <input type="number" value={selectedScenario.total_employees || ''} onChange={(e) => handleUpdateScenario({ total_employees: parseInt(e.target.value) || null })}
                                            className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-xl font-bold text-white focus:outline-none focus:border-cyan-500" />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-slate-400 mb-2">Calc Mode</label>
                                        <select value={selectedScenario.calc_mode || 'pepm'} onChange={(e) => handleUpdateScenario({ calc_mode: e.target.value })}
                                            className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-xl font-bold text-white focus:outline-none focus:border-cyan-500">
                                            <option value="pepm">PEPM</option>
                                            <option value="pmpm">PMPM</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Big Numbers Display */}
                            <div className="grid grid-cols-3 gap-6">
                                <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-8 text-center">
                                    <p className="text-slate-400 mb-2">{selectedScenario.funding_type === 'self_funded' ? 'Projected Cost' : 'Total Premium'}</p>
                                    <p className="text-4xl font-bold text-white">{formatCurrency(selectedScenario.funding_type === 'self_funded' ? sfTotals?.projectedTotal : plans.reduce((sum, p) => sum + (calculatePlanCosts(p, selectedScenario).annual || 0), 0))}</p>
                                    <p className="text-slate-500 text-sm mt-2">Annual</p>
                                </div>
                                <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-8 text-center">
                                    <p className="text-slate-400 mb-2">{selectedScenario.funding_type === 'self_funded' ? 'Max Exposure' : 'Employer Cost'}</p>
                                    <p className="text-4xl font-bold text-amber-400">{formatCurrency(selectedScenario.funding_type === 'self_funded' ? sfTotals?.maxExposure : plans.reduce((sum, p) => sum + (calculatePlanCosts(p, selectedScenario).erAnnual || 0), 0))}</p>
                                    <p className="text-slate-500 text-sm mt-2">Annual</p>
                                </div>
                                <div className={`bg-slate-850 border rounded-xl p-8 text-center ${budgetStatus?.isUnder ? 'border-green-500/50' : 'border-red-500/50'}`}>
                                    <p className="text-slate-400 mb-2">vs Budget</p>
                                    <p className={`text-4xl font-bold ${budgetStatus?.isUnder ? 'text-green-400' : 'text-red-400'}`}>
                                        {budgetStatus ? `${budgetStatus.isUnder ? '' : '+'}${formatCurrency(Math.abs(budgetStatus.variance))}` : '—'}
                                    </p>
                                    <p className="text-slate-500 text-sm mt-2">{budgetStatus?.isUnder ? 'Under Budget' : 'Over Budget'}</p>
                                </div>
                            </div>
                            
                            {/* Self-Funded Quick Edit */}
                            {selectedScenario.funding_type === 'self_funded' && fixedCosts && variableCosts && (
                                <div className="grid grid-cols-2 gap-6">
                                    <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-6">
                                        <h5 className="text-white font-semibold mb-4">Fixed Costs</h5>
                                        <div className="space-y-3">
                                            <div className="flex justify-between items-center">
                                                <span className="text-slate-400">TPA Admin</span>
                                                <div className="flex items-center gap-2">
                                                    <input type="number" value={fixedCosts.tpa_pepm || ''} onChange={(e) => handleUpdateFixedCosts({ tpa_pepm: parseFloat(e.target.value) })}
                                                        className="w-20 bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-right" />
                                                    <span className="text-slate-500 text-sm">PEPM</span>
                                                </div>
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <span className="text-slate-400">Network Access</span>
                                                <div className="flex items-center gap-2">
                                                    <input type="number" value={fixedCosts.network_pepm || ''} onChange={(e) => handleUpdateFixedCosts({ network_pepm: parseFloat(e.target.value) })}
                                                        className="w-20 bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-right" />
                                                    <span className="text-slate-500 text-sm">PEPM</span>
                                                </div>
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <span className="text-slate-400">ISL (${(fixedCosts.isl_deductible || 150000).toLocaleString()} ded)</span>
                                                <div className="flex items-center gap-2">
                                                    <select value={fixedCosts.isl_deductible || 150000} onChange={(e) => handleUpdateFixedCosts({ isl_deductible: parseInt(e.target.value) })}
                                                        className="bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-sm">
                                                        {ISL_DEDUCTIBLES.map(d => <option key={d} value={d}>${d.toLocaleString()}</option>)}
                                                    </select>
                                                    <input type="number" value={fixedCosts.isl_pepm || ''} onChange={(e) => handleUpdateFixedCosts({ isl_pepm: parseFloat(e.target.value) })}
                                                        className="w-20 bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-right" />
                                                </div>
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <span className="text-slate-400">ASL ({fixedCosts.asl_corridor || 125}% corridor)</span>
                                                <div className="flex items-center gap-2">
                                                    <select value={fixedCosts.asl_corridor || 125} onChange={(e) => handleUpdateFixedCosts({ asl_corridor: parseInt(e.target.value) })}
                                                        className="bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-sm">
                                                        {ASL_CORRIDORS.map(c => <option key={c} value={c}>{c}%</option>)}
                                                    </select>
                                                    <input type="number" value={fixedCosts.asl_pepm || ''} onChange={(e) => handleUpdateFixedCosts({ asl_pepm: parseFloat(e.target.value) })}
                                                        className="w-20 bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-right" />
                                                </div>
                                            </div>
                                            <div className="pt-2 border-t border-slate-700">
                                                <div className="flex justify-between">
                                                    <span className="text-white font-medium">Total Fixed</span>
                                                    <span className="text-white font-bold">{formatCurrency(sfTotals?.fixedTotal)}/yr</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-6">
                                        <h5 className="text-white font-semibold mb-4">Claims & Credits</h5>
                                        <div className="space-y-3">
                                            <div className="flex justify-between items-center">
                                                <span className="text-slate-400">Carrier Projection</span>
                                                <div className="flex items-center gap-2">
                                                    <input type="number" value={variableCosts.carrier_claims_pepm || ''} onChange={(e) => handleUpdateVariableCosts({ carrier_claims_pepm: parseFloat(e.target.value) })}
                                                        className="w-24 bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-right" />
                                                    <span className="text-slate-500 text-sm">PEPM</span>
                                                </div>
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <span className="text-slate-400">Internal Projection</span>
                                                <div className="flex items-center gap-2">
                                                    <input type="number" value={variableCosts.internal_claims_pepm || ''} onChange={(e) => handleUpdateVariableCosts({ internal_claims_pepm: parseFloat(e.target.value) })}
                                                        className="w-24 bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-right" />
                                                    <span className="text-slate-500 text-sm">PEPM</span>
                                                </div>
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <span className="text-slate-400">Use Projection</span>
                                                <select value={variableCosts.use_projection || 'carrier'} onChange={(e) => handleUpdateVariableCosts({ use_projection: e.target.value })}
                                                    className="bg-slate-900 border border-slate-600 rounded px-3 py-1 text-white">
                                                    <option value="carrier">Carrier</option>
                                                    <option value="internal">Internal</option>
                                                </select>
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <span className="text-slate-400">Max Claims</span>
                                                <div className="flex items-center gap-2">
                                                    <input type="number" value={variableCosts.max_claims_pepm || ''} onChange={(e) => handleUpdateVariableCosts({ max_claims_pepm: parseFloat(e.target.value) })}
                                                        className="w-24 bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-right" />
                                                    <span className="text-slate-500 text-sm">PEPM</span>
                                                </div>
                                            </div>
                                            <div className="pt-2 border-t border-slate-700">
                                                <div className="flex justify-between items-center">
                                                    <span className="text-slate-400">Rx Rebates</span>
                                                    <div className="flex items-center gap-2">
                                                        <input type="number" value={credits?.rx_rebate_pepm || ''} onChange={(e) => handleUpdateCredits({ rx_rebate_pepm: parseFloat(e.target.value), rx_rebate_method: 'flat_pepm' })}
                                                            className="w-20 bg-slate-900 border border-green-600/50 rounded px-2 py-1 text-green-400 text-right" />
                                                        <span className="text-slate-500 text-sm">PEPM</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="pt-2 border-t border-slate-700">
                                                <div className="flex justify-between">
                                                    <span className="text-white font-medium">Net Variable</span>
                                                    <span className="text-white font-bold">{formatCurrency((sfTotals?.variableTotal || 0) - (sfTotals?.creditsTotal || 0))}/yr</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {/* Fully Insured Plan Cards */}
                            {selectedScenario.funding_type === 'fully_insured' && plans.length > 0 && (
                                <div className="space-y-4">
                                    <div className="flex items-center justify-between">
                                        <h5 className="text-white font-semibold">Plan Options</h5>
                                        <button onClick={handleAddPlan} className="text-sm text-cyan-400 hover:underline">+ Add Plan</button>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        {plans.map(plan => {
                                            const costs = calculatePlanCosts(plan, selectedScenario);
                                            return (
                                                <div key={plan.id} className="bg-slate-850 border border-slate-700/50 rounded-xl p-5">
                                                    <div className="flex justify-between items-start mb-4">
                                                        <input type="text" value={plan.plan_name} onChange={(e) => handleUpdatePlan(plan.id, { plan_name: e.target.value })}
                                                            className="bg-transparent text-white font-semibold text-lg focus:outline-none border-b border-transparent hover:border-slate-600 focus:border-cyan-500" />
                                                        {costs.changePct !== null && (
                                                            <span className={`text-sm font-medium ${costs.changePct > 0 ? 'text-red-400' : 'text-green-400'}`}>
                                                                {formatPct(costs.changePct)} YoY
                                                            </span>
                                                        )}
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-4 text-center">
                                                        <div className="bg-slate-900/50 rounded-lg p-3">
                                                            <p className="text-slate-400 text-xs mb-1">Monthly Premium</p>
                                                            <p className="text-white font-bold text-lg">{formatCurrency(costs.monthly)}</p>
                                                        </div>
                                                        <div className="bg-slate-900/50 rounded-lg p-3">
                                                            <p className="text-slate-400 text-xs mb-1">Annual Premium</p>
                                                            <p className="text-white font-bold text-lg">{formatCurrency(costs.annual)}</p>
                                                        </div>
                                                        <div className="bg-blue-500/10 rounded-lg p-3">
                                                            <p className="text-blue-400 text-xs mb-1">ER Annual</p>
                                                            <p className="text-blue-400 font-bold text-lg">{formatCurrency(costs.erAnnual)}</p>
                                                        </div>
                                                        <div className="bg-slate-900/50 rounded-lg p-3">
                                                            <p className="text-slate-400 text-xs mb-1">EE Avg/Mo</p>
                                                            <p className="text-white font-bold text-lg">{formatCurrency(costs.eeMonthlyAvg)}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}
                        </div>
                    ) : (
                        // ═══════════════════════════════════════════════════════════════
                        // STANDARD VIEW - Full detail editing
                        // ═══════════════════════════════════════════════════════════════
                        <div className="space-y-6">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h4 className="text-xl font-bold text-white">{selectedScenario.name}</h4>
                                    <p className="text-slate-400">{getClientName(selectedScenario.client_id)} • {selectedScenario.funding_type === 'self_funded' ? 'Self-Funded' : 'Fully Insured'}</p>
                                </div>
                                <button onClick={() => setSelectedScenario(null)} className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">← All Scenarios</button>
                            </div>
                            
                            {/* Tabs */}
                            <div className="flex gap-2 border-b border-slate-700 pb-2">
                                {['overview', selectedScenario.funding_type === 'fully_insured' ? 'plans' : 'costs'].map(tab => (
                                    <button key={tab} onClick={() => setActiveView(tab)}
                                        className={`px-4 py-2 rounded-t-lg font-medium capitalize ${activeView === tab ? 'bg-slate-700 text-white' : 'text-slate-400 hover:text-white'}`}>
                                        {tab}
                                    </button>
                                ))}
                            </div>
                            
                            {/* Overview Tab */}
                            {activeView === 'overview' && (
                                <div className="grid grid-cols-2 gap-6">
                                    <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-6 space-y-4">
                                        <h5 className="text-white font-semibold">Scenario Settings</h5>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm text-slate-400 mb-1">Employees</label>
                                                <input type="number" value={selectedScenario.total_employees || ''} onChange={(e) => handleUpdateScenario({ total_employees: parseInt(e.target.value) })}
                                                    className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" />
                                            </div>
                                            <div>
                                                <label className="block text-sm text-slate-400 mb-1">Members (w/ deps)</label>
                                                <input type="number" value={selectedScenario.total_members || ''} onChange={(e) => handleUpdateScenario({ total_members: parseInt(e.target.value) })}
                                                    className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" />
                                            </div>
                                            <div>
                                                <label className="block text-sm text-slate-400 mb-1">ER Contribution %</label>
                                                <input type="number" value={selectedScenario.contribution_pct || 75} onChange={(e) => handleUpdateScenario({ contribution_pct: parseFloat(e.target.value) })}
                                                    className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" />
                                            </div>
                                            <div>
                                                <label className="block text-sm text-slate-400 mb-1">Annual Budget</label>
                                                <input type="number" value={selectedScenario.budget_annual || ''} onChange={(e) => handleUpdateScenario({ budget_annual: parseFloat(e.target.value) })}
                                                    className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white" />
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-sm text-slate-400 mb-1">Contribution Strategy</label>
                                            <select value={selectedScenario.contribution_strategy || 'pct_ee_only'} onChange={(e) => handleUpdateScenario({ contribution_strategy: e.target.value })}
                                                className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white">
                                                <option value="pct_ee_only">% of EE-Only (all tiers)</option>
                                                <option value="pct_each_tier">% of Each Tier</option>
                                                <option value="flat_dollar">Flat Dollar</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm text-slate-400 mb-1">Calculation Basis</label>
                                            <select value={selectedScenario.calc_mode || 'pepm'} onChange={(e) => handleUpdateScenario({ calc_mode: e.target.value })}
                                                className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white">
                                                <option value="pepm">PEPM (Per Employee Per Month)</option>
                                                <option value="pmpm">PMPM (Per Member Per Month)</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-slate-850 border border-slate-700/50 rounded-xl p-6 space-y-4">
                                        <h5 className="text-white font-semibold">Tier Distribution</h5>
                                        <div className="space-y-3">
                                            {[['ee_only', 'Employee Only'], ['ee_spouse', 'Employee + Spouse'], ['ee_child', 'Employee + Child(ren)'], ['family', 'Family']].map(([key, label]) => (
                                                <div key={key} className="flex items-center justify-between">
                                                    <span className="text-slate-400">{label}</span>
                                                    <input type="number" value={selectedScenario[`tier_${key}`] || ''} onChange={(e) => handleUpdateScenario({ [`tier_${key}`]: parseInt(e.target.value) || 0 })}
                                                        className="w-24 bg-slate-900 border border-slate-700 rounded px-3 py-1.5 text-white text-right" />
                                                </div>
                                            ))}
                                            <div className="pt-2 border-t border-slate-700 flex justify-between">
                                                <span className="text-white font-medium">Total</span>
                                                <span className="text-white font-bold">{(selectedScenario.tier_ee_only || 0) + (selectedScenario.tier_ee_spouse || 0) + (selectedScenario.tier_ee_child || 0) + (selectedScenario.tier_family || 0)}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {/* Fully Insured Plans Tab */}
                            {activeView === 'plans' && selectedScenario.funding_type === 'fully_insured' && (
                                <div className="space-y-4">
                                    <div className="flex justify-between items-center">
                                        <h5 className="text-white font-semibold">Plan Options ({plans.length})</h5>
                                        <button onClick={handleAddPlan} className="px-3 py-1.5 bg-cyan-600 hover:bg-cyan-500 rounded-lg text-sm">{Icons.plus} Add Plan</button>
                                    </div>
                                    
                                    {/* Plans Table */}
                                    <div className="bg-slate-850 border border-slate-700/50 rounded-xl overflow-hidden">
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm">
                                                <thead>
                                                    <tr className="bg-slate-900/50 border-b border-slate-700">
                                                        <th className="text-left px-4 py-3 text-slate-400 font-medium">Plan</th>
                                                        <th className="text-right px-3 py-3 text-slate-400 font-medium">EE Only</th>
                                                        <th className="text-right px-3 py-3 text-slate-400 font-medium">EE+Spouse</th>
                                                        <th className="text-right px-3 py-3 text-slate-400 font-medium">EE+Child</th>
                                                        <th className="text-right px-3 py-3 text-slate-400 font-medium">Family</th>
                                                        <th className="text-right px-4 py-3 text-slate-400 font-medium">Monthly</th>
                                                        <th className="text-right px-4 py-3 text-slate-400 font-medium">Annual</th>
                                                        <th className="text-right px-4 py-3 text-slate-400 font-medium">YoY %</th>
                                                        <th className="text-right px-4 py-3 text-slate-400 font-medium">ER Annual</th>
                                                        <th className="px-2 py-3"></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {plans.map((plan, i) => {
                                                        const costs = calculatePlanCosts(plan, selectedScenario);
                                                        return (
                                                            <tr key={plan.id} className={`border-b border-slate-700/30 ${i % 2 ? 'bg-slate-900/20' : ''}`}>
                                                                <td className="px-4 py-2">
                                                                    <input type="text" value={plan.plan_name} onChange={(e) => handleUpdatePlan(plan.id, { plan_name: e.target.value })}
                                                                        className="bg-transparent text-white font-medium focus:outline-none w-32" />
                                                                </td>
                                                                <td className="px-3 py-2">
                                                                    <input type="number" value={plan.rate_ee_only || ''} onChange={(e) => handleUpdatePlan(plan.id, { rate_ee_only: parseFloat(e.target.value) })}
                                                                        className="w-20 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-white text-right" placeholder="$" />
                                                                </td>
                                                                <td className="px-3 py-2">
                                                                    <input type="number" value={plan.rate_ee_spouse || ''} onChange={(e) => handleUpdatePlan(plan.id, { rate_ee_spouse: parseFloat(e.target.value) })}
                                                                        className="w-20 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-white text-right" />
                                                                </td>
                                                                <td className="px-3 py-2">
                                                                    <input type="number" value={plan.rate_ee_child || ''} onChange={(e) => handleUpdatePlan(plan.id, { rate_ee_child: parseFloat(e.target.value) })}
                                                                        className="w-20 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-white text-right" />
                                                                </td>
                                                                <td className="px-3 py-2">
                                                                    <input type="number" value={plan.rate_family || ''} onChange={(e) => handleUpdatePlan(plan.id, { rate_family: parseFloat(e.target.value) })}
                                                                        className="w-20 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-white text-right" />
                                                                </td>
                                                                <td className="px-4 py-2 text-right text-white font-medium">{formatCurrency(costs.monthly)}</td>
                                                                <td className="px-4 py-2 text-right text-white font-bold">{formatCurrency(costs.annual)}</td>
                                                                <td className={`px-4 py-2 text-right font-medium ${costs.changePct > 0 ? 'text-red-400' : costs.changePct < 0 ? 'text-green-400' : 'text-slate-400'}`}>
                                                                    {costs.changePct !== null ? formatPct(costs.changePct) : '—'}
                                                                </td>
                                                                <td className="px-4 py-2 text-right text-cyan-400 font-bold">{formatCurrency(costs.erAnnual)}</td>
                                                                <td className="px-2 py-2">
                                                                    <button onClick={() => handleDeletePlan(plan.id)} className="text-slate-500 hover:text-red-400">{Icons.trash}</button>
                                                                </td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                                <tfoot>
                                                    <tr className="bg-slate-900/50">
                                                        <td colSpan="5" className="px-4 py-3 text-white font-semibold">Total (All Plans)</td>
                                                        <td className="px-4 py-3 text-right text-white font-bold">{formatCurrency(plans.reduce((sum, p) => sum + (calculatePlanCosts(p, selectedScenario).monthly || 0), 0))}</td>
                                                        <td className="px-4 py-3 text-right text-white font-bold">{formatCurrency(plans.reduce((sum, p) => sum + (calculatePlanCosts(p, selectedScenario).annual || 0), 0))}</td>
                                                        <td className="px-4 py-3"></td>
                                                        <td className="px-4 py-3 text-right text-cyan-400 font-bold">{formatCurrency(plans.reduce((sum, p) => sum + (calculatePlanCosts(p, selectedScenario).erAnnual || 0), 0))}</td>
                                                        <td></td>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    {/* Prior Year Rates Section */}
                                    <details className="bg-slate-850 border border-slate-700/50 rounded-xl">
                                        <summary className="px-6 py-4 cursor-pointer text-white font-semibold">Prior Year Rates (for comparison)</summary>
                                        <div className="px-6 pb-4">
                                            <table className="w-full text-sm">
                                                <thead>
                                                    <tr className="border-b border-slate-700">
                                                        <th className="text-left py-2 text-slate-400">Plan</th>
                                                        <th className="text-right py-2 text-slate-400">Prior EE</th>
                                                        <th className="text-right py-2 text-slate-400">Prior EE+Sp</th>
                                                        <th className="text-right py-2 text-slate-400">Prior EE+Ch</th>
                                                        <th className="text-right py-2 text-slate-400">Prior Fam</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {plans.map(plan => (
                                                        <tr key={plan.id} className="border-b border-slate-700/30">
                                                            <td className="py-2 text-white">{plan.plan_name}</td>
                                                            <td className="py-2"><input type="number" value={plan.prior_rate_ee_only || ''} onChange={(e) => handleUpdatePlan(plan.id, { prior_rate_ee_only: parseFloat(e.target.value) })} className="w-20 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-white text-right" /></td>
                                                            <td className="py-2"><input type="number" value={plan.prior_rate_ee_spouse || ''} onChange={(e) => handleUpdatePlan(plan.id, { prior_rate_ee_spouse: parseFloat(e.target.value) })} className="w-20 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-white text-right" /></td>
                                                            <td className="py-2"><input type="number" value={plan.prior_rate_ee_child || ''} onChange={(e) => handleUpdatePlan(plan.id, { prior_rate_ee_child: parseFloat(e.target.value) })} className="w-20 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-white text-right" /></td>
                                                            <td className="py-2"><input type="number" value={plan.prior_rate_family || ''} onChange={(e) => handleUpdatePlan(plan.id, { prior_rate_family: parseFloat(e.target.value) })} className="w-20 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-white text-right" /></td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </details>
                                </div>
                            )}
                            
                            {/* Self-Funded Costs Tab */}
                            {activeView === 'costs' && selectedScenario.funding_type === 'self_funded' && sfTotals && (
                                <div className="grid grid-cols-3 gap-6">
                                    {/* Fixed Costs */}
                                    <div className="bg-slate-850 border border-blue-500/30 rounded-xl p-5">
                                        <h5 className="text-blue-400 font-semibold mb-4">Fixed Costs</h5>
                                        {fixedCosts && (
                                            <div className="space-y-3 text-sm">
                                                <div className="flex justify-between"><span className="text-slate-400">TPA Admin</span><span className="text-white">{formatCurrency((fixedCosts.tpa_pepm || 0) * (selectedScenario.total_employees || 0) * 12)}</span></div>
                                                <div className="flex justify-between"><span className="text-slate-400">Network</span><span className="text-white">{formatCurrency((fixedCosts.network_pepm || 0) * (selectedScenario.total_employees || 0) * 12)}</span></div>
                                                <div className="flex justify-between"><span className="text-slate-400">ISL (${(fixedCosts.isl_deductible || 0).toLocaleString()})</span><span className="text-white">{formatCurrency((fixedCosts.isl_pepm || 0) * (selectedScenario.total_employees || 0) * 12)}</span></div>
                                                <div className="flex justify-between"><span className="text-slate-400">ASL ({fixedCosts.asl_corridor || 125}%)</span><span className="text-white">{formatCurrency((fixedCosts.asl_pepm || 0) * (selectedScenario.total_employees || 0) * 12)}</span></div>
                                                <div className="pt-2 border-t border-slate-700 flex justify-between font-semibold">
                                                    <span className="text-blue-400">Total Fixed</span>
                                                    <span className="text-blue-400">{formatCurrency(sfTotals.fixedTotal)}</span>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Variable Costs */}
                                    <div className="bg-slate-850 border border-amber-500/30 rounded-xl p-5">
                                        <h5 className="text-amber-400 font-semibold mb-4">Variable Costs</h5>
                                        {variableCosts && (
                                            <div className="space-y-3 text-sm">
                                                <div className="flex justify-between"><span className="text-slate-400">Est. Claims ({variableCosts.use_projection})</span><span className="text-white">{formatCurrency(sfTotals.variableTotal)}</span></div>
                                                <div className="flex justify-between"><span className="text-slate-400">Max Claims</span><span className="text-amber-400">{formatCurrency(sfTotals.maxExposure - sfTotals.fixedTotal + sfTotals.creditsTotal)}</span></div>
                                                <div className="pt-2 border-t border-slate-700 flex justify-between font-semibold">
                                                    <span className="text-amber-400">Total Variable</span>
                                                    <span className="text-amber-400">{formatCurrency(sfTotals.variableTotal)}</span>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Credits */}
                                    <div className="bg-slate-850 border border-green-500/30 rounded-xl p-5">
                                        <h5 className="text-green-400 font-semibold mb-4">Credits</h5>
                                        {credits && (
                                            <div className="space-y-3 text-sm">
                                                <div className="flex justify-between"><span className="text-slate-400">Rx Rebates</span><span className="text-green-400">({formatCurrency(sfTotals.creditsTotal)})</span></div>
                                                <div className="pt-2 border-t border-slate-700 flex justify-between font-semibold">
                                                    <span className="text-green-400">Total Credits</span>
                                                    <span className="text-green-400">({formatCurrency(sfTotals.creditsTotal)})</span>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Summary Row */}
                                    <div className="col-span-3 bg-slate-900 border border-slate-600 rounded-xl p-6">
                                        <div className="grid grid-cols-4 gap-6 text-center">
                                            <div>
                                                <p className="text-slate-400 mb-1">Fixed</p>
                                                <p className="text-2xl font-bold text-blue-400">{formatCurrency(sfTotals.fixedTotal)}</p>
                                            </div>
                                            <div>
                                                <p className="text-slate-400 mb-1">+ Variable</p>
                                                <p className="text-2xl font-bold text-amber-400">{formatCurrency(sfTotals.variableTotal)}</p>
                                            </div>
                                            <div>
                                                <p className="text-slate-400 mb-1">- Credits</p>
                                                <p className="text-2xl font-bold text-green-400">({formatCurrency(sfTotals.creditsTotal)})</p>
                                            </div>
                                            <div className="border-l border-slate-700 pl-6">
                                                <p className="text-slate-400 mb-1">= Projected Total</p>
                                                <p className="text-3xl font-bold text-white">{formatCurrency(sfTotals.projectedTotal)}</p>
                                                <p className="text-slate-500 text-sm mt-1">Max: {formatCurrency(sfTotals.maxExposure)}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                    
                    {/* New Scenario Modal */}
                    <Modal isOpen={showNewScenario} onClose={() => setShowNewScenario(false)} title="New Underwriting Scenario">
                        <NewScenarioForm clients={clients} onSubmit={handleCreateScenario} onCancel={() => setShowNewScenario(false)} />
                    </Modal>
                </div>
            );
        };
        
        // New Scenario Form
        const NewScenarioForm = ({ clients, onSubmit, onCancel }) => {
            const [formData, setFormData] = useState({ client_id: '', name: '', funding_type: 'fully_insured', total_employees: '', total_members: '', contribution_pct: 75, budget_annual: '' });
            const handleSubmit = (e) => { e.preventDefault(); onSubmit({ ...formData, total_employees: parseInt(formData.total_employees) || null, total_members: parseInt(formData.total_members) || null, budget_annual: parseFloat(formData.budget_annual) || null }); };
            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="block text-sm text-slate-400 mb-1">Client *</label>
                        <select required value={formData.client_id} onChange={(e) => setFormData({...formData, client_id: e.target.value})}
                            className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white">
                            <option value="">Select client...</option>
                            {clients.map(c => <option key={c.id} value={c.id}>{c.company_name}</option>)}
                        </select>
                    </div>
                    <div>
                        <label className="block text-sm text-slate-400 mb-1">Scenario Name *</label>
                        <input type="text" required value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})}
                            placeholder="e.g., 2026 Renewal Analysis" className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white" />
                    </div>
                    <div>
                        <label className="block text-sm text-slate-400 mb-2">Funding Type *</label>
                        <div className="flex gap-3">
                            <button type="button" onClick={() => setFormData({...formData, funding_type: 'fully_insured'})}
                                className={`flex-1 p-3 rounded-lg border text-center ${formData.funding_type === 'fully_insured' ? 'bg-blue-500/20 border-blue-500/50 text-blue-400' : 'border-slate-700 text-slate-400'}`}>
                                Fully Insured
                            </button>
                            <button type="button" onClick={() => setFormData({...formData, funding_type: 'self_funded'})}
                                className={`flex-1 p-3 rounded-lg border text-center ${formData.funding_type === 'self_funded' ? 'bg-purple-500/20 border-purple-500/50 text-purple-400' : 'border-slate-700 text-slate-400'}`}>
                                Self-Funded
                            </button>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm text-slate-400 mb-1">Employees</label>
                            <input type="number" value={formData.total_employees} onChange={(e) => setFormData({...formData, total_employees: e.target.value})}
                                className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white" />
                        </div>
                        <div>
                            <label className="block text-sm text-slate-400 mb-1">Members (w/ dependents)</label>
                            <input type="number" value={formData.total_members} onChange={(e) => setFormData({...formData, total_members: e.target.value})}
                                className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white" />
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm text-slate-400 mb-1">ER Contribution %</label>
                            <input type="number" value={formData.contribution_pct} onChange={(e) => setFormData({...formData, contribution_pct: parseFloat(e.target.value)})}
                                className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white" />
                        </div>
                        <div>
                            <label className="block text-sm text-slate-400 mb-1">Annual Budget</label>
                            <input type="number" value={formData.budget_annual} onChange={(e) => setFormData({...formData, budget_annual: e.target.value})}
                                placeholder="Optional" className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white" />
                        </div>
                    </div>
                    <div className="flex gap-3 pt-2">
                        <button type="button" onClick={onCancel} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Cancel</button>
                        <button type="submit" className="flex-1 px-4 py-2.5 bg-cyan-600 hover:bg-cyan-500 rounded-lg font-medium">Create Scenario</button>
                    </div>
                </form>
            );
        };

        // ═══════════════════════════════════════════════════════════════════════════
        // ADD CLIENT FORM
        // ═══════════════════════════════════════════════════════════════════════════
        const AddClientForm = ({ onSubmit, onCancel }) => {
            const [formData, setFormData] = useState({ company_name: '', contact_name: '', contact_email: '', industry: '', funding_type: '', employee_count: '', wellness_fund: '', renewal_date: '', status: 'pending' });
            const handleSubmit = (e) => { e.preventDefault(); onSubmit({ ...formData, employee_count: parseInt(formData.employee_count) || null, wellness_fund: parseInt(formData.wellness_fund) || null, renewal_date: formData.renewal_date || null }); };
            const tier = getWellnessFundTier(formData.employee_count);
            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div><label className="block text-sm font-medium text-slate-400 mb-1">Company Name *</label><input type="text" required value={formData.company_name} onChange={(e) => setFormData({...formData, company_name: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500" /></div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm font-medium text-slate-400 mb-1">Contact Name</label><input type="text" value={formData.contact_name} onChange={(e) => setFormData({...formData, contact_name: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500" /></div>
                        <div><label className="block text-sm font-medium text-slate-400 mb-1">Contact Email</label><input type="email" value={formData.contact_email} onChange={(e) => setFormData({...formData, contact_email: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500" /></div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm font-medium text-slate-400 mb-1">Industry</label><input type="text" value={formData.industry} onChange={(e) => setFormData({...formData, industry: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500" placeholder="e.g., Technology" /></div>
                        <div><label className="block text-sm font-medium text-slate-400 mb-1">Funding Type</label><select value={formData.funding_type} onChange={(e) => setFormData({...formData, funding_type: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500"><option value="">Select...</option><option value="Self-Funded">Self-Funded (ASO)</option><option value="Fully Insured">Fully Insured</option></select></div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm font-medium text-slate-400 mb-1">Employee Count</label><input type="number" value={formData.employee_count} onChange={(e) => setFormData({...formData, employee_count: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500" /></div>
                        <div><label className="block text-sm font-medium text-slate-400 mb-1">Wellness Fund ($)</label><input type="number" value={formData.wellness_fund} onChange={(e) => setFormData({...formData, wellness_fund: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500" /></div>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-slate-400 mb-1">Renewal Date</label>
                        <input type="date" value={formData.renewal_date} onChange={(e) => setFormData({...formData, renewal_date: e.target.value})} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500" />
                        <p className="text-xs text-slate-500 mt-1">Enables automatic renewal countdown alerts</p>
                    </div>
                    {formData.employee_count && <div className="bg-blue-500/10 border border-blue-500/30 rounded-xl p-3 text-blue-400 text-sm">💡 Benchmark: {tier.display} | Suggested: {tier.suggested}</div>}
                    <div className="flex gap-3 pt-2">
                        <button type="button" onClick={onCancel} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Cancel</button>
                        <button type="submit" className="flex-1 px-4 py-2.5 bg-blue-600 hover:bg-blue-500 rounded-lg font-medium">Add Client</button>
                    </div>
                </form>
            );
        };

        // ═══════════════════════════════════════════════════════════════════════════
        // MAIN APP
        // ═══════════════════════════════════════════════════════════════════════════
        const App = () => {
            const [activeTab, setActiveTab] = useState('command');
            const [clients, setClients] = useState([]);
            const [uploads, setUploads] = useState([]);
            const [analyses, setAnalyses] = useState([]);
            const [alerts, setAlerts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showAddClient, setShowAddClient] = useState(false);
            const [selectedClient, setSelectedClient] = useState(null);
            const [selectedClientId, setSelectedClientId] = useState(null);
            const [analyzeClient, setAnalyzeClient] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [playbookClient, setPlaybookClient] = useState(null);
            
            const fetchData = useCallback(async () => {
                setLoading(true);
                try {
                    const [c, u, a, al] = await Promise.all([
                        supabase.from('clients').select('*').order('created_at', { ascending: false }),
                        supabase.from('uploads').select('*').order('uploaded_at', { ascending: false }),
                        supabase.from('analyses').select('*').order('created_at', { ascending: false }),
                        supabase.from('agent_alerts').select('*').order('generated_at', { ascending: false })
                    ]);
                    setClients(c.data || []);
                    setUploads(u.data || []);
                    setAnalyses(a.data || []);
                    setAlerts(al.data || []);
                    
                    // Run agents after data loads
                    if (c.data?.length > 0) {
                        await runRenewalAgent(c.data);
                        await runPopulationShiftAgent(c.data, a.data || []);
                    }
                } catch (err) { console.error(err); }
                finally { setLoading(false); }
            }, []);
            
            // Agent #1: Renewal Countdown
            const runRenewalAgent = async (clientList) => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                for (const client of clientList) {
                    if (!client.renewal_date || client.status === 'inactive') continue;
                    
                    const renewalDate = new Date(client.renewal_date);
                    const daysUntil = Math.ceil((renewalDate - today) / (1000 * 60 * 60 * 24));
                    
                    if (daysUntil <= 0 || daysUntil > 120) continue;
                    
                    let alertConfig = null;
                    const year = renewalDate.getFullYear();
                    
                    if (daysUntil <= 30) {
                        alertConfig = {
                            alert_key: `renewal_30_${year}`,
                            severity: 'critical',
                            title: '🚨 Final Decision Window',
                            message: `Renewal in ${daysUntil} days. Immediate action required to finalize benefits decisions.`,
                            action_type: 'urgent_review',
                            action_label: 'Review Now'
                        };
                    } else if (daysUntil <= 60) {
                        alertConfig = {
                            alert_key: `renewal_60_${year}`,
                            severity: 'warning',
                            title: '⚠️ Decision Deadline Approaching',
                            message: `Renewal in ${daysUntil} days. Finalize recommendations and schedule decision meeting.`,
                            action_type: 'schedule_meeting',
                            action_label: 'Schedule Meeting'
                        };
                    } else if (daysUntil <= 90) {
                        alertConfig = {
                            alert_key: `renewal_90_${year}`,
                            severity: 'warning',
                            title: '📋 Carrier Marketing Period Open',
                            message: `Renewal in ${daysUntil} days. Begin carrier negotiations and review alternative options.`,
                            action_type: 'review_options',
                            action_label: 'Review Options'
                        };
                    } else if (daysUntil <= 120) {
                        alertConfig = {
                            alert_key: `renewal_120_${year}`,
                            severity: 'info',
                            title: '📊 Census Update Recommended',
                            message: `Renewal in ${daysUntil} days. Request updated census data for fresh Canon Echo analysis.`,
                            action_type: 'request_census',
                            action_label: 'Request Census'
                        };
                    }
                    
                    if (alertConfig) {
                        try {
                            await supabase.from('agent_alerts').upsert({
                                client_id: client.id,
                                agent_type: 'renewal_countdown',
                                ...alertConfig,
                                detail_json: { days_until_renewal: daysUntil, renewal_date: client.renewal_date },
                                expires_at: new Date(renewalDate.getTime() + 24 * 60 * 60 * 1000).toISOString()
                            }, { onConflict: 'client_id,alert_key' });
                        } catch (err) { console.log('Alert upsert skipped:', err.message); }
                    }
                }
            };
            
            // Agent #2: Population Health Shift
            const runPopulationShiftAgent = async (clientList, analysesList) => {
                for (const client of clientList) {
                    const clientAnalyses = analysesList
                        .filter(a => a.client_id === client.id && a.status === 'complete')
                        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    
                    if (clientAnalyses.length < 2) continue;
                    
                    const current = clientAnalyses[0];
                    const previous = clientAnalyses[1];
                    
                    const currentScore = current.findings?.risk_assessment?.overall_score;
                    const previousScore = previous.findings?.risk_assessment?.overall_score;
                    
                    if (!currentScore || !previousScore) continue;
                    
                    const scoreDelta = currentScore - previousScore;
                    const currentLives = current.findings?.census_profile?.total_lives || 0;
                    const previousLives = previous.findings?.census_profile?.total_lives || 0;
                    const livesDelta = currentLives - previousLives;
                    
                    // Alert if risk score changed by 5+ points
                    if (Math.abs(scoreDelta) >= 5) {
                        const direction = scoreDelta > 0 ? 'increased' : 'decreased';
                        const severity = scoreDelta > 0 ? 'warning' : 'info';
                        const emoji = scoreDelta > 0 ? '📈' : '📉';
                        
                        const alertKey = `pop_shift_${current.id.substring(0, 8)}`;
                        
                        try {
                            await supabase.from('agent_alerts').upsert({
                                client_id: client.id,
                                agent_type: 'population_shift',
                                alert_key: alertKey,
                                severity: severity,
                                title: `${emoji} Population Health Shift Detected`,
                                message: `Risk score ${direction} from ${previousScore} to ${currentScore} (${scoreDelta > 0 ? '+' : ''}${scoreDelta} points) since last analysis. ${livesDelta !== 0 ? `Population changed by ${livesDelta > 0 ? '+' : ''}${livesDelta} lives.` : ''}`,
                                action_type: 'review_analysis',
                                action_label: 'Review Changes',
                                detail_json: {
                                    current_score: currentScore,
                                    previous_score: previousScore,
                                    score_delta: scoreDelta,
                                    current_lives: currentLives,
                                    previous_lives: previousLives,
                                    lives_delta: livesDelta,
                                    current_analysis_date: current.created_at,
                                    previous_analysis_date: previous.created_at
                                }
                            }, { onConflict: 'client_id,alert_key' });
                        } catch (err) { console.log('Population shift alert skipped:', err.message); }
                    }
                }
            };
            
            useEffect(() => { fetchData(); }, [fetchData]);
            
            const handleAddClient = async (data) => {
                try {
                    const { data: d, error: e } = await supabase.from('clients').insert([data]).select();
                    if (e) throw e;
                    setClients([d[0], ...clients]);
                    setShowAddClient(false);
                } catch (err) { alert('Error: ' + err.message); }
            };
            
            const handleDeleteClient = async (id) => {
                if (!confirm('Delete this client?')) return;
                try {
                    await supabase.from('clients').delete().eq('id', id);
                    setClients(clients.filter(c => c.id !== id));
                } catch (err) { alert('Error: ' + err.message); }
            };
            
            const getClientById = (id) => clients.find(c => c.id === id);
            const filteredClients = clients.filter(c => c.company_name?.toLowerCase().includes(searchTerm.toLowerCase()));
            const stats = {
                totalClients: clients.length,
                activeClients: clients.filter(c => c.status === 'active').length,
                pendingUploads: uploads.filter(u => u.status === 'pending').length,
                completedAnalyses: analyses.filter(a => a.status === 'complete').length
            };
            
            const navItems = [
                { id: 'command', label: 'Command Center', icon: Icons.command },
                { id: 'client_manager', label: 'Client Manager', icon: Icons.users },
                { id: 'action_plans', label: 'Action Plans', icon: Icons.target },
                { id: 'rfp_marketing', label: 'RFP Marketing', icon: Icons.rfp },
                { id: 'benefit_compare', label: 'Benefit Compare', icon: Icons.compare },
                { id: 'revenue', label: 'Revenue', icon: Icons.revenue },
                { id: 'dashboard', label: 'Dashboard', icon: Icons.dashboard },
                { id: 'intelligence', label: 'Intelligence', icon: Icons.trending, badge: alerts.filter(a => a.status !== 'completed' && a.status !== 'dismissed' && a.severity === 'critical').length || null },
                { id: 'clients', label: 'Clients', icon: Icons.clients },
                { id: 'pipeline', label: 'Sales Pipeline', icon: Icons.pipeline },
                { id: 'underwriting', label: 'Underwriting', icon: Icons.analyses },
                { id: 'implementations', label: 'Implementations', icon: Icons.implementations },
                { id: 'marketing', label: 'Marketing', icon: Icons.star },
                { id: 'playbook', label: 'Playbook', icon: Icons.playbook },
                { id: 'decisions', label: 'Decision Log', icon: Icons.decisions },
                { id: 'portal', label: 'Client Portal', icon: Icons.portal },
                { id: 'analyses', label: 'Census Analysis', icon: Icons.sparkles }
            ];
            
            return (
                <div className="min-h-screen flex">
                    {/* Sidebar */}
                    <div className="w-64 bg-slate-850 border-r border-slate-700/50 flex flex-col">
                        <div className="p-5 border-b border-slate-700/50">
                            <h1 className="text-xl font-bold text-white flex items-center gap-2"><span className="text-2xl">◉</span>Canon Echo</h1>
                            <p className="text-slate-500 text-sm mt-1">Workforce Health Intelligence</p>
                        </div>
                        <nav className="flex-1 p-3">
                            {navItems.map(item => (
                                <button key={item.id} onClick={() => setActiveTab(item.id)}
                                    className={`w-full flex items-center gap-3 px-4 py-2.5 rounded-lg text-left mb-1 ${activeTab === item.id ? 'bg-blue-600/20 text-blue-400 border border-blue-500/30' : 'text-slate-400 hover:bg-slate-700/50'}`}>
                                    {item.icon}
                                    <span className="font-medium flex-1">{item.label}</span>
                                    {item.badge > 0 && (
                                        <span className="px-1.5 py-0.5 bg-red-500 text-white text-xs rounded-full font-bold min-w-[20px] text-center">
                                            {item.badge}
                                        </span>
                                    )}
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t border-slate-700/50">
                            <div className="bg-slate-900/50 rounded-xl p-4">
                                <div className="flex items-center gap-2">
                                    <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse-subtle"></div>
                                    <span className="text-sm text-slate-300">Canon Echo v4.5</span>
                                </div>
                                <p className="text-xs text-slate-500 mt-1">AI Agents Active</p>
                            </div>
                        </div>
                    </div>
                    
                    {/* Main Content */}
                    <div className="flex-1 overflow-auto">
                        <div className="sticky top-0 z-10 bg-slate-950/80 backdrop-blur-xl border-b border-slate-700/50 px-8 py-4 flex items-center justify-between">
                            <h2 className="text-2xl font-bold text-white capitalize">
                                {activeTab === 'command' ? 'Command Center' : activeTab === 'client_manager' ? 'Client Manager Agent' : activeTab === 'action_plans' ? 'Action Plan Tracker' : activeTab === 'rfp_marketing' ? 'RFP Marketing Agent' : activeTab === 'benefit_compare' ? 'Benefit Comparison Tool' : activeTab === 'revenue' ? 'Revenue Tracker' : activeTab === 'pipeline' ? 'Sales Pipeline' : activeTab === 'playbook' ? 'Elite Service Playbook' : activeTab === 'decisions' ? 'Decision Log' : activeTab === 'portal' ? 'Client Portal' : activeTab === 'intelligence' ? 'Intelligence Feed' : activeTab === 'implementations' ? 'Vendor Implementations' : activeTab === 'marketing' ? 'Marketing Agent' : activeTab === 'underwriting' ? 'Underwriting Agent' : activeTab === 'analyses' ? 'Census Analysis' : activeTab}
                            </h2>
                            <div className="flex items-center gap-3">
                                <button onClick={fetchData} className="p-2 text-slate-400 hover:text-white hover:bg-slate-700 rounded-lg">{Icons.refresh}</button>
                                {activeTab === 'clients' && <button onClick={() => setShowAddClient(true)} className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg font-medium">{Icons.plus} Add Client</button>}
                            </div>
                        </div>
                        
                        <div className="p-8">
                            {loading ? <div className="text-center py-20 text-slate-500">{Icons.loader} Loading...</div> : (
                                <>
                                    {activeTab === 'command' && (
                                        <CommandCenter clients={clients} prospects={[]} />
                                    )}
                                    
                                    {activeTab === 'client_manager' && (
                                        <ErrorBoundary>
                                            <ClientManagerAgent clientId={selectedClientId} clients={clients} />
                                        </ErrorBoundary>
                                    )}
                                    
                                    {activeTab === 'action_plans' && (
                                        <ErrorBoundary>
                                            <ActionPlanTracker clientId={selectedClientId} clients={clients} />
                                        </ErrorBoundary>
                                    )}
                                    
                                    {activeTab === 'rfp_marketing' && (
                                        <ErrorBoundary>
                                            <RFPMarketingAgent clientId={selectedClientId} clients={clients} />
                                        </ErrorBoundary>
                                    )}
                                    
                                    {activeTab === 'benefit_compare' && (
                                        <ErrorBoundary>
                                            <BenefitComparisonTool clientId={selectedClientId} clients={clients} />
                                        </ErrorBoundary>
                                    )}
                                    
                                    {activeTab === 'revenue' && (
                                        <ErrorBoundary>
                                            <RevenueAgent clientId={selectedClientId} clients={clients} />
                                        </ErrorBoundary>
                                    )}
                                    
                                    {activeTab === 'pipeline' && (
                                        <SalesPipeline />
                                    )}
                                    
                                    {activeTab === 'dashboard' && (
                                        <div className="space-y-8">
                                            <div className="grid grid-cols-4 gap-6">
                                                <StatCard title="Total Clients" value={stats.totalClients} icon={Icons.clients} color="bg-blue-500/20 text-blue-400" />
                                                <StatCard title="Active" value={stats.activeClients} icon={Icons.check} color="bg-green-500/20 text-green-400" />
                                                <StatCard title="Active Alerts" value={alerts.filter(a => a.status !== 'completed' && a.status !== 'dismissed').length} icon={Icons.alert} color="bg-amber-500/20 text-amber-400" />
                                                <StatCard title="Analyses" value={stats.completedAnalyses} icon={Icons.analyses} color="bg-purple-500/20 text-purple-400" />
                                            </div>
                                            <div className="grid grid-cols-2 gap-6">
                                                <IntelligenceFeed alerts={alerts} clients={clients} onRefresh={fetchData} compact={true} />
                                                <div className="bg-slate-850 border border-slate-700/50 rounded-xl">
                                                    <div className="p-5 border-b border-slate-700/50"><h3 className="font-semibold text-white">Recent Clients</h3></div>
                                                    <div className="p-2">
                                                        {clients.slice(0,5).map(c => (
                                                            <div key={c.id} onClick={() => setAnalyzeClient(c)} className="p-3 hover:bg-slate-700/30 rounded-lg cursor-pointer flex items-center justify-between">
                                                                <div>
                                                                    <p className="text-white font-medium">{c.company_name}</p>
                                                                    {c.renewal_date && (
                                                                        <p className="text-slate-500 text-xs">Renewal: {new Date(c.renewal_date).toLocaleDateString()}</p>
                                                                    )}
                                                                </div>
                                                                <StatusBadge status={c.status} />
                                                            </div>
                                                        ))}
                                                        {clients.length === 0 && <p className="p-3 text-slate-500">No clients yet</p>}
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="bg-slate-850 border border-slate-700/50 rounded-xl">
                                                <div className="p-5 border-b border-slate-700/50"><h3 className="font-semibold text-white">Recent Analyses</h3></div>
                                                <div className="p-2">
                                                    {analyses.slice(0,5).map(a => (
                                                        <div key={a.id} className="p-3 hover:bg-slate-700/30 rounded-lg flex items-center justify-between">
                                                            <div>
                                                                <p className="text-white font-medium">{getClientById(a.client_id)?.company_name || 'Unknown'}</p>
                                                                <p className="text-slate-500 text-sm">{new Date(a.created_at).toLocaleDateString()}</p>
                                                            </div>
                                                            <div className="text-right">
                                                                <p className="text-lg font-bold text-white">{a.findings?.risk_assessment?.overall_score || '—'}</p>
                                                                <p className="text-slate-500 text-xs">Risk Score</p>
                                                            </div>
                                                        </div>
                                                    ))}
                                                    {analyses.length === 0 && <p className="p-3 text-slate-500">No analyses yet</p>}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {activeTab === 'intelligence' && (
                                        <IntelligenceFeed alerts={alerts} clients={clients} onRefresh={fetchData} onSelectClient={(c) => { setAnalyzeClient(c); }} />
                                    )}
                                    
                                    {activeTab === 'implementations' && (
                                        <ImplementationAgent clients={clients} />
                                    )}
                                    
                                    {activeTab === 'marketing' && (
                                        <MarketingAgent clients={clients} analyses={analyses} />
                                    )}
                                    
                                    {activeTab === 'underwriting' && (
                                        <UnderwritingAgent clients={clients} />
                                    )}
                                    
                                    {activeTab === 'clients' && (
                                        <div className="space-y-6">
                                            <div className="relative">
                                                <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-500">{Icons.search}</div>
                                                <input type="text" placeholder="Search clients..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)}
                                                    className="w-full bg-slate-850 border border-slate-700 rounded-xl pl-12 pr-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500" />
                                            </div>
                                            <div className="bg-slate-850 border border-slate-700/50 rounded-xl overflow-hidden">
                                                <table className="w-full">
                                                    <thead>
                                                        <tr className="border-b border-slate-700/50">
                                                            <th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">Company</th>
                                                            <th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">Industry</th>
                                                            <th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">Funding</th>
                                                            <th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">Employees</th>
                                                            <th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">Renewal</th>
                                                            <th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">Status</th>
                                                            <th className="text-right px-6 py-4 text-sm font-semibold text-slate-400">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {filteredClients.map((c, i) => {
                                                            const daysUntilRenewal = c.renewal_date ? Math.ceil((new Date(c.renewal_date) - new Date()) / (1000 * 60 * 60 * 24)) : null;
                                                            return (
                                                            <tr key={c.id} className={`border-b border-slate-700/30 hover:bg-slate-700/20 ${i % 2 ? 'bg-slate-900/20' : ''}`}>
                                                                <td className="px-6 py-4 text-white font-medium">{c.company_name}</td>
                                                                <td className="px-6 py-4 text-slate-300">{c.industry || '—'}</td>
                                                                <td className="px-6 py-4 text-slate-300">{c.funding_type || '—'}</td>
                                                                <td className="px-6 py-4 text-slate-300">{c.employee_count?.toLocaleString() || '—'}</td>
                                                                <td className="px-6 py-4">
                                                                    {c.renewal_date ? (
                                                                        <span className={`text-sm ${daysUntilRenewal <= 30 ? 'text-red-400 font-medium' : daysUntilRenewal <= 90 ? 'text-amber-400' : 'text-slate-300'}`}>
                                                                            {new Date(c.renewal_date).toLocaleDateString()}
                                                                            {daysUntilRenewal > 0 && <span className="text-slate-500 text-xs ml-1">({daysUntilRenewal}d)</span>}
                                                                        </span>
                                                                    ) : '—'}
                                                                </td>
                                                                <td className="px-6 py-4"><StatusBadge status={c.status} /></td>
                                                                <td className="px-6 py-4 text-right">
                                                                    <button onClick={() => setAnalyzeClient(c)} className="p-2 text-slate-400 hover:text-blue-400">{Icons.sparkles}</button>
                                                                    <button onClick={() => handleDeleteClient(c.id)} className="p-2 text-slate-400 hover:text-red-400">{Icons.trash}</button>
                                                                </td>
                                                            </tr>
                                                        )})}
                                                        {filteredClients.length === 0 && <tr><td colSpan="7" className="px-6 py-8 text-center text-slate-500">No clients found</td></tr>}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {activeTab === 'playbook' && <PlaybookChecklist selectedClient={playbookClient} onSelectClient={setPlaybookClient} clients={clients} />}
                                    
                                    {activeTab === 'decisions' && <DecisionLog clients={clients} analyses={analyses} />}
                                    
                                    {activeTab === 'portal' && <ClientPortal clients={clients} analyses={analyses} />}
                                    
                                    {activeTab === 'analyses' && (
                                        <div className="bg-slate-850 border border-slate-700/50 rounded-xl overflow-hidden">
                                            <table className="w-full">
                                                <thead>
                                                    <tr className="border-b border-slate-700/50">
                                                        <th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">Client</th>
                                                        <th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">Date</th>
                                                        <th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">Risk Score</th>
                                                        <th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {analyses.map((a, i) => (
                                                        <tr key={a.id} className={`border-b border-slate-700/30 hover:bg-slate-700/20 ${i % 2 ? 'bg-slate-900/20' : ''}`}>
                                                            <td className="px-6 py-4 text-white font-medium">{getClientById(a.client_id)?.company_name || 'Unknown'}</td>
                                                            <td className="px-6 py-4 text-slate-300 mono text-sm">{new Date(a.created_at).toLocaleDateString()}</td>
                                                            <td className="px-6 py-4 text-slate-300">{a.findings?.risk_assessment?.overall_score || '—'}</td>
                                                            <td className="px-6 py-4"><StatusBadge status={a.status} /></td>
                                                        </tr>
                                                    ))}
                                                    {analyses.length === 0 && <tr><td colSpan="4" className="px-6 py-8 text-center text-slate-500">No analyses yet</td></tr>}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    </div>
                    
                    {/* Modals */}
                    <Modal isOpen={showAddClient} onClose={() => setShowAddClient(false)} title="Add Client">
                        <AddClientForm onSubmit={handleAddClient} onCancel={() => setShowAddClient(false)} />
                    </Modal>
                    
                    <Modal isOpen={!!analyzeClient} onClose={() => setAnalyzeClient(null)} title={`Analyze: ${analyzeClient?.company_name || ''}`} wide>
                        {analyzeClient && <UploadAnalyze client={analyzeClient} onComplete={() => { setAnalyzeClient(null); fetchData(); }} onCancel={() => setAnalyzeClient(null)} />}
                    </Modal>
                </div>
            );
        };
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
