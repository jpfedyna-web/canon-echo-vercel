<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canon Echo | Workforce Health Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- PDF Export Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- PPT Export Library -->
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/PptxGenJS@3.12.0/dist/pptxgen.bundle.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: #0a0f1a; color: #e2e8f0; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes pulse-subtle { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .animate-pulse-subtle { animation: pulse-subtle 2s ease-in-out infinite; }
        .status-pending { color: #f59e0b; background: rgba(245, 158, 11, 0.15); }
        .status-active, .status-complete { color: #22c55e; background: rgba(34, 197, 94, 0.15); }
        .status-analyzing { color: #3b82f6; background: rgba(59, 130, 246, 0.15); }
        .drop-zone { border: 2px dashed #475569; transition: all 0.2s ease; }
        .drop-zone:hover, .drop-zone.drag-over { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
    </style>
    <script>tailwind.config = { theme: { extend: { colors: { slate: { 850: '#162032', 950: '#0a0f1a' } } } } }</script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;
        const SUPABASE_URL = 'https://ukpniztesqiwkhazcddp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVrcG5penRlc3Fpd2toYXpjZGRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4NTA2MDAsImV4cCI6MjA4NDQyNjYwMH0.OpV9KSoVBKwO1bQYqnGiBWHilyTiTPAxxngPW30CVu0';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const Icons = {
            clients: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>,
            uploads: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>,
            analyses: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>,
            plus: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
            refresh: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
            close: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
            check: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
            trash: <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
            eye: <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>,
            dashboard: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" /></svg>,
            file: <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
            sparkles: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>,
            loader: <svg className="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" /></svg>,
            download: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
            search: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
            pdf: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>,
            ppt: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 13v-1m4 1v-3m4 3V8M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" /></svg>,
        };
        
        const StatusBadge = ({ status }) => <span className={`px-2 py-1 rounded-full text-xs font-medium status-${status?.toLowerCase() || 'pending'}`}>{status || 'pending'}</span>;
        const StatCard = ({ title, value, icon, color }) => (<div className="bg-slate-850 border border-slate-700/50 rounded-xl p-5"><div className="flex items-center justify-between mb-3"><span className="text-slate-400 text-sm font-medium">{title}</span><div className={`p-2 rounded-lg ${color}`}>{icon}</div></div><div className="text-3xl font-bold text-white">{value}</div></div>);
        const Modal = ({ isOpen, onClose, title, children, wide }) => { if (!isOpen) return null; return (<div className="fixed inset-0 z-50 flex items-center justify-center"><div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div><div className={`relative bg-slate-850 border border-slate-700 rounded-2xl w-full ${wide ? 'max-w-5xl' : 'max-w-lg'} mx-4 max-h-[90vh] overflow-hidden flex flex-col animate-fade-in`}><div className="flex items-center justify-between p-5 border-b border-slate-700"><h3 className="text-lg font-semibold text-white">{title}</h3><button onClick={onClose} className="p-1 hover:bg-slate-700 rounded-lg">{Icons.close}</button></div><div className="p-5 overflow-y-auto">{children}</div></div></div>); };
        
        // v4.3 WELLNESS FUND TIERS
        const getWellnessFundTier = (employeeCount) => {
            const count = parseInt(employeeCount) || 0;
            if (count <= 50) return { min: 0, max: 5000, midpoint: 2500, display: '$0 - $5,000', suggested: '$2,500' };
            if (count <= 150) return { min: 5000, max: 15000, midpoint: 10000, display: '$5,000 - $15,000', suggested: '$10,000' };
            if (count <= 300) return { min: 15000, max: 20000, midpoint: 17500, display: '$15,000 - $20,000', suggested: '$17,500' };
            if (count <= 500) return { min: 20000, max: 30000, midpoint: 25000, display: '$20,000 - $30,000', suggested: '$25,000' };
            return { min: 30000, max: null, midpoint: 50000, display: '$30,000+', suggested: '$50,000+' };
        };
        
        // Add Client Form with Wellness Fund
        const AddClientForm = ({ onSubmit, onCancel }) => {
            const [formData, setFormData] = useState({ company_name: '', contact_name: '', contact_email: '', industry: '', funding_type: '', employee_count: '', wellness_fund: '' });
            const handleSubmit = (e) => { e.preventDefault(); onSubmit({ ...formData, employee_count: formData.employee_count ? parseInt(formData.employee_count) : null, wellness_fund: formData.wellness_fund ? parseInt(formData.wellness_fund) : null }); };
            const tier = getWellnessFundTier(formData.employee_count);
            
            return (<form onSubmit={handleSubmit} className="space-y-4"><div><label className="block text-sm font-medium text-slate-300 mb-1">Company Name *</label><input type="text" required value={formData.company_name} onChange={(e) => setFormData({...formData, company_name: e.target.value})} className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2.5 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500" placeholder="Acme Corporation" /></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-medium text-slate-300 mb-1">Contact Name</label><input type="text" value={formData.contact_name} onChange={(e) => setFormData({...formData, contact_name: e.target.value})} className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2.5 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500" placeholder="John Smith" /></div><div><label className="block text-sm font-medium text-slate-300 mb-1">Contact Email</label><input type="email" value={formData.contact_email} onChange={(e) => setFormData({...formData, contact_email: e.target.value})} className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2.5 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500" placeholder="john@acme.com" /></div></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-medium text-slate-300 mb-1">Industry</label><input type="text" value={formData.industry} onChange={(e) => setFormData({...formData, industry: e.target.value})} className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2.5 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500" placeholder="Manufacturing" /></div><div><label className="block text-sm font-medium text-slate-300 mb-1">Funding Type</label><select value={formData.funding_type} onChange={(e) => setFormData({...formData, funding_type: e.target.value})} className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500"><option value="">Select...</option><option value="Fully Insured">Fully Insured</option><option value="Self-Funded">Self-Funded (ASO)</option><option value="Level-Funded">Level-Funded</option></select></div></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-medium text-slate-300 mb-1">Employee Count</label><input type="number" value={formData.employee_count} onChange={(e) => setFormData({...formData, employee_count: e.target.value})} className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2.5 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500" placeholder="250" /></div><div><label className="block text-sm font-medium text-slate-300 mb-1">Wellness Fund (Annual $)</label><input type="number" value={formData.wellness_fund} onChange={(e) => setFormData({...formData, wellness_fund: e.target.value})} className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2.5 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500" placeholder="Optional" /></div></div>{formData.employee_count && <div className="bg-amber-500/10 border border-amber-500/30 rounded-lg p-3"><p className="text-amber-400 text-sm">ðŸ’¡ <strong>Suggested:</strong> {tier.suggested} | <strong>Range:</strong> {tier.display}</p></div>}<p className="text-xs text-slate-500">If you don't know the wellness fund, leave blank and we'll show the suggested range.</p><div className="flex gap-3 pt-4"><button type="button" onClick={onCancel} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Cancel</button><button type="submit" className="flex-1 px-4 py-2.5 bg-blue-600 hover:bg-blue-500 rounded-lg font-medium">Add Client</button></div></form>);
        };
        
        // ============================================================
        // COMPREHENSIVE EXECUTIVE REPORT GENERATOR - v4.3
        // FIXES:
        // 1. Tiered wellness fund with midpoint suggestion
        // 2. Fixed "undefined" in Industry Intelligence
        // 3. Fixed double %% on generations
        // 4. Fixed Executive Health rendering
        // ============================================================
        const generateFullReportHTML = (findings, client) => {
            const f = findings || {};
            const cp = f.census_profile || {};
            const gen = f.generational_breakdown || {};
            const ra = f.risk_assessment || {};
            const cs = f.cancer_screening || {};
            const fa = f.funding_analysis || {};
            const ec = f.executive_concierge || {};
            const cm = f.confidence_matrix || [];
            const intel = f.industry_intelligence || {};
            const actions = f.action_plan || [];
            const closing = f.closing || {};
            
            // v4.1 sections
            const wfd = f.wellness_fund_deployment || {};
            const costMit = f.cost_mitigation_strategies || {};
            const enhancedInsights = f.enhanced_data_insights || [];
            const hasClaimsData = f.has_claims_data || false;
            const hasRxData = f.has_rx_data || false;
            const hasUtilizationData = f.has_utilization_data || false;
            const hasEnhancedData = hasClaimsData || hasRxData || hasUtilizationData || enhancedInsights.length > 0;
            
            const employees = parseInt(cp.total_employees) || client?.employee_count || 200;
            const dependents = parseInt(cp.total_dependents) || Math.round(employees * 1.4);
            const totalLives = parseInt(cp.total_covered_lives) || employees + dependents;
            const avgAge = cp.average_age || 42;
            const today = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            const fundingType = fa.type || client?.funding_type || 'Self-Funded';
            const isFullyInsured = fundingType.toLowerCase().includes('fully');
            const isSelfFunded = fundingType.toLowerCase().includes('self') || fundingType.toLowerCase().includes('aso');
            const riskScore = parseInt(ra.overall_score) || 55;
            const riskColor = riskScore < 40 ? '#22c55e' : riskScore < 70 ? '#f59e0b' : '#ef4444';
            
            // v4.3 FIX #1: TIERED WELLNESS FUND WITH MIDPOINT
            const wellnessTier = getWellnessFundTier(employees);
            const clientWellnessFund = client?.wellness_fund || null;
            const hasClientFund = clientWellnessFund !== null && clientWellnessFund > 0;
            
            let fundStatus = 'unknown';
            if (hasClientFund) {
                if (wellnessTier.max === null) {
                    fundStatus = clientWellnessFund >= wellnessTier.min ? 'within' : 'below';
                } else if (clientWellnessFund >= wellnessTier.min && clientWellnessFund <= wellnessTier.max) {
                    fundStatus = 'within';
                } else if (clientWellnessFund > wellnessTier.max) {
                    fundStatus = 'above';
                } else {
                    fundStatus = 'below';
                }
            }
            
            // v4.3 FIX #3: Clean percentage - remove double %% signs
            const cleanPct = (val) => {
                if (val === undefined || val === null) return '';
                let str = String(val);
                // Remove all % signs first, then we won't add one in the template
                str = str.replace(/%/g, '').trim();
                return str;
            };
            
            const genZ = gen.gen_z || { percentage: 15, count: Math.round(employees * 0.15), health_stats: [] };
            const mill = gen.millennials || { percentage: 25, count: Math.round(employees * 0.25), health_stats: [] };
            const genX = gen.gen_x || { percentage: 35, count: Math.round(employees * 0.35), health_stats: [] };
            const boom = gen.boomers || { percentage: 25, count: Math.round(employees * 0.25), health_stats: [] };
            
            const fundsAvail = fa.funds_available || {};
            const displayWellnessFund = hasClientFund ? clientWellnessFund : wellnessTier.midpoint;
            const innovationFund = fundsAvail.innovation_fund?.amount || (isSelfFunded ? employees * 75 : 0);
            const potentialSavings = fundsAvail.potential_savings?.amount || (employees * 225);
            
            const defaultScreenings = [
                { type: "Colorectal Cancer", eligible_count: Math.round(employees * 0.4), early_detection_survival: "91%", late_detection_survival: "14%", eligible_criteria: "Ages 45-75" },
                { type: "Breast Cancer", eligible_count: Math.round(employees * 0.22), early_detection_survival: "99%", late_detection_survival: "29%", eligible_criteria: "Women 40-74" },
                { type: "Cervical Cancer", eligible_count: Math.round(employees * 0.25), early_detection_survival: "92%", late_detection_survival: "17%", eligible_criteria: "Women 21-65" },
                { type: "Lung Cancer", eligible_count: Math.round(employees * 0.08), early_detection_survival: "60%", late_detection_survival: "6%", eligible_criteria: "Smokers 50-80" }
            ];
            const screenings = cs.screenings?.length > 0 ? cs.screenings : defaultScreenings;
            
            const defaultConfidence = [
                { metric: "Employee demographics", value: "From census", confidence: "ACTUAL", icon: "âœ…", source: "Census file" },
                { metric: "Generational distribution", value: "Calculated", confidence: "ACTUAL", icon: "âœ…", source: "Birthdates" },
                { metric: "Screening eligibility", value: "By age/gender", confidence: "ACTUAL", icon: "âœ…", source: "USPSTF guidelines" },
                { metric: "Chronic disease prevalence", value: "Estimated", confidence: "MODELED", icon: "âš ï¸", source: "CDC NHANES 2022" },
                { metric: "Mental health prevalence", value: "Estimated", confidence: "MODELED", icon: "âš ï¸", source: "NIMH 2022" },
                { metric: "Individual health status", value: "Unknown", confidence: "REQUIRES_CLAIMS", icon: "â“", source: "Needs claims data" }
            ];
            const confidenceData = cm.length > 0 ? cm : defaultConfidence;
            
            // v4.3 FIX #2: Industry Intelligence - robust undefined handling
            // Helper to safely get value with multiple fallback keys
            const safeVal = (obj, keys, fallback = '') => {
                if (!obj || typeof obj !== 'object') return fallback;
                for (const key of keys) {
                    if (obj[key] !== undefined && obj[key] !== null && obj[key] !== 'undefined') {
                        return obj[key];
                    }
                }
                return fallback;
            };
            
            const defaultIntel = [
                { category: "Cost Trends", headline: "Healthcare Costs Rising 7-9% in 2025", insight: "Medical and pharmacy trend continuing to outpace inflation. GLP-1s driving significant pharmacy spend.", canon_position: "Cost increases are not inevitable. Employers using direct contracting, transparent PBMs, and care navigation are 50% more likely to have below-average costs." },
                { category: "GLP-1 Coverage", headline: "Weight Loss Medications at Inflection Point", insight: "Semaglutide and tirzepatide utilization growing 40%+ annually. Employers wrestling with coverage decisions.", canon_position: "Blanket exclusion is shortsighted. Cover GLP-1s with clinical criteria (BMI, comorbidities) plus required participation in metabolic health program." },
                { category: "Carrier Updates", headline: "Major Carriers Adjusting Networks", insight: "UnitedHealthcare, Cigna, and Aetna all making network changes. Review provider access carefully.", canon_position: "Review at renewal. Ensure your employees' key providers remain in-network." },
                { category: "Vendor Spotlight", headline: "Fertility Benefits Expansion", insight: "Progyny, Carrot, Maven leading fertility/family-forming benefits space. Becoming table stakes for talent.", canon_position: "Consider for your population. ROI includes reduced turnover and improved recruitment." }
            ];
            
            let intelData = [];
            
            // Check if intel is an array
            if (Array.isArray(intel) && intel.length > 0) {
                intelData = intel.map(item => ({
                    category: safeVal(item, ['category', 'type', 'topic'], 'Industry Update'),
                    headline: safeVal(item, ['headline', 'title', 'trend', 'update', 'name'], 'Healthcare Update'),
                    insight: safeVal(item, ['insight', 'detail', 'details', 'description', 'summary', 'impact'], 'Monitor developments closely.'),
                    canon_position: safeVal(item, ['canon_position', 'position', 'action', 'recommendation', 'our_position'], 'Review and assess impact on your plan.')
                }));
            } 
            // Check if intel is an object with nested arrays
            else if (intel && typeof intel === 'object') {
                // Healthcare trends
                if (Array.isArray(intel.healthcare_trends)) {
                    intel.healthcare_trends.forEach(t => {
                        if (t && typeof t === 'object') {
                            intelData.push({
                                category: safeVal(t, ['category'], 'Healthcare Trends'),
                                headline: safeVal(t, ['headline', 'title', 'trend', 'name'], 'Healthcare Trend'),
                                insight: safeVal(t, ['insight', 'detail', 'details', 'description', 'impact'], 'Developing trend to monitor.'),
                                canon_position: safeVal(t, ['canon_position', 'position', 'action', 'recommendation'], 'Monitor and assess.')
                            });
                        }
                    });
                }
                // Carrier updates
                if (Array.isArray(intel.carrier_updates)) {
                    intel.carrier_updates.forEach(c => {
                        if (c && typeof c === 'object') {
                            intelData.push({
                                category: safeVal(c, ['carrier', 'name', 'category'], 'Carrier Update'),
                                headline: safeVal(c, ['headline', 'title', 'update', 'change'], 'Carrier Update'),
                                insight: safeVal(c, ['insight', 'detail', 'details', 'description', 'impact'], 'Review at renewal.'),
                                canon_position: safeVal(c, ['canon_position', 'position', 'action', 'recommendation'], 'Review at renewal.')
                            });
                        }
                    });
                }
                // Vendor spotlight
                if (Array.isArray(intel.vendor_spotlight)) {
                    intel.vendor_spotlight.forEach(v => {
                        if (v && typeof v === 'object') {
                            intelData.push({
                                category: 'Vendor Spotlight',
                                headline: safeVal(v, ['vendor', 'name', 'headline', 'title'], 'Vendor Update'),
                                insight: safeVal(v, ['insight', 'detail', 'details', 'description', 'value_prop'], 'Consider for your population.'),
                                canon_position: safeVal(v, ['canon_position', 'position', 'action', 'recommendation'], 'Consider for your population.')
                            });
                        }
                    });
                }
            }
            
            // If we still don't have intel data, use defaults
            if (intelData.length === 0) {
                intelData = defaultIntel;
            }
            
            // Ensure we have at least 4 items
            while (intelData.length < 4) {
                intelData.push(defaultIntel[intelData.length % defaultIntel.length]);
            }
            
            const defaultActions = [
                { action_number: 1, title: "Cancer Screening Activation", why_now: `${Math.round(employees * 0.6)} screening opportunities identified`, funding_source: isFullyInsured ? "Carrier Wellness" : "Wellness Fund", tactics: [
                    { letter: "A", name: "At-Home Colorectal Kits", description: "Mail FIT/Cologuard kits to employees 45-75", eligible_count: Math.round(employees * 0.4), estimated_cost: "$35-50/kit", vendor_recommendations: [{vendor: "Cologuard", why: "Highest brand recognition"}, {vendor: "LetsGetChecked", why: "Good UX, dashboard"}] },
                    { letter: "B", name: "Mobile Mammography Event", description: "On-site screening, 15-minute appointments", eligible_count: Math.round(employees * 0.22), estimated_cost: "$4,500 minimum", vendor_recommendations: [{vendor: "Alliance Mobile Health", why: "National coverage"}] },
                    { letter: "C", name: "Birthday-Month Reminders", description: "Personalized screening outreach", eligible_count: employees, estimated_cost: "$15/person", vendor_recommendations: [{vendor: "Accolade", why: "High-touch navigation"}, {vendor: "Quantum Health", why: "Claims impact focus"}] }
                ]},
                { action_number: 2, title: "Diabetes Prevention Program", why_now: `Estimated ${Math.round(totalLives * 0.35)} prediabetic individuals`, funding_source: isFullyInsured ? "Carrier Programs" : "Innovation Fund", tactics: [
                    { letter: "A", name: "CDC-Recognized DPP", description: "16-week program, 58% risk reduction proven", eligible_count: Math.round(employees * 0.3), estimated_cost: "$500/person", vendor_recommendations: [{vendor: "Omada Health", why: "Original digital DPP"}, {vendor: "Vida Health", why: "Multi-condition support"}] },
                    { letter: "B", name: "Metabolic Health Challenge", description: "4-week nutrition competition", eligible_count: employees, estimated_cost: "$40/person", vendor_recommendations: [{vendor: "Virgin Pulse", why: "Strong challenge mechanics"}] },
                    { letter: "C", name: "CGM Pilot Program", description: "Glucose monitors for highest-risk", eligible_count: 20, estimated_cost: "$300/person", vendor_recommendations: [{vendor: "Levels", why: "Best consumer UX"}, {vendor: "Nutrisense", why: "Includes dietitian"}] }
                ]},
                { action_number: 3, title: "Mental Health Activation", why_now: "Gen Z 42% affected, EAP at 3-5% utilization", funding_source: isFullyInsured ? "EAP Enhancement" : "Wellness Fund", tactics: [
                    { letter: "A", name: "Leadership 'It's OK' Campaign", description: "Senior leader shares personal MH story", eligible_count: employees, estimated_cost: "$1,500", vendor_recommendations: [{vendor: "One Mind at Work", why: "Free resources"}] },
                    { letter: "B", name: "Text-Based Therapy Platform", description: "Digital MH matching Gen Z preferences", eligible_count: Math.round(employees * 0.15), estimated_cost: "$6-12 PEPM", vendor_recommendations: [{vendor: "Lyra Health", why: "Highest clinical quality"}, {vendor: "Spring Health", why: "Strong ROI data"}] },
                    { letter: "C", name: "Manager MH Training", description: "2-hour awareness workshop", eligible_count: Math.round(employees * 0.15), estimated_cost: "$5,000", vendor_recommendations: [{vendor: "Mental Health First Aid", why: "Gold standard curriculum"}] }
                ]}
            ];
            const actionData = actions.length > 0 ? actions : defaultActions;
            
            // Population-level vendor recommendations
            const defaultVendorRecs = {
                headline: "Population Health Vendor Recommendations",
                intro: "Based on your workforce demographics, these vendors are positioned to help your entire employee population:",
                priority_recommendations: [
                    { category: "Care Navigation", why_you_need_it: "Help employees find right care at right time", top_picks: [{vendor: "Accolade", positioning: "Premium", cost_range: "$8-15 PEPM"}, {vendor: "Quantum Health", positioning: "Value", cost_range: "$6-12 PEPM"}] },
                    { category: "Mental Health", why_you_need_it: "Address 42% Gen Z anxiety/depression", top_picks: [{vendor: "Lyra Health", positioning: "Best Clinical", cost_range: "$7-12 PEPM"}, {vendor: "Spring Health", positioning: "ROI Focus", cost_range: "$6-10 PEPM"}] },
                    { category: "Diabetes Prevention", why_you_need_it: "Reach 30-40% prediabetic", top_picks: [{vendor: "Omada Health", positioning: "Proven DPP", cost_range: "$500/person"}, {vendor: "Virta Health", positioning: "Reversal", cost_range: "$400/month"}] },
                    { category: "Musculoskeletal", why_you_need_it: "Address #2 cost driver after chronic disease", top_picks: [{vendor: "Hinge Health", positioning: "Market Leader", cost_range: "$3-6 PEPM"}, {vendor: "Sword Health", positioning: "AI-Powered", cost_range: "$3-5 PEPM"}] }
                ],
                next_steps: ["Schedule vendor discovery calls", "Request case studies for your industry", "Ask for pilot pricing (10-15% of population)", "Establish baseline metrics before launch"]
            };
            const vendorRecsData = ec.priority_recommendations ? ec : defaultVendorRecs;
            
            // v4.3 FIX #4: Executive Health Programs - ensure rendering
            const defaultExecHealth = {
                headline: "Executive Health Programs",
                intro: "Comprehensive, concierge-level physicals for your C-suite and key leaders. These are NOT standard physicalsâ€”they are half-day to full-day deep-dive assessments with world-class physicians.",
                why_it_matters: "Key person risk is real. Protecting your top 5-10 executives with world-class preventive care is both a retention tool and a fiduciary responsibility. These programs detect issues years before symptoms appear.",
                programs: [
                    { provider: "Mayo Clinic Executive Health", location: "Rochester, MN / Scottsdale, AZ / Jacksonville, FL", cost_range: "$5,000 - $10,000", duration: "Full day", highlights: "Gold standard in executive health. Comprehensive diagnostics, immediate specialist access, personalized wellness plan." },
                    { provider: "Cleveland Clinic Executive Health", location: "Cleveland, OH / Weston, FL", cost_range: "$4,000 - $8,000", duration: "Full day", highlights: "World-renowned cardiology. Advanced cardiac imaging, stress testing, nutrition consult." },
                    { provider: "Johns Hopkins Executive Health", location: "Baltimore, MD", cost_range: "$3,500 - $6,000", duration: "Half to full day", highlights: "Academic medical center expertise. Research-backed protocols." },
                    { provider: "NYU Langone Executive Physicals", location: "New York, NY", cost_range: "$3,000 - $6,000", duration: "Half day", highlights: "Three package tiers. Convenient Manhattan locations. Concierge coordination." },
                    { provider: "Inova 360Â° Concierge Medicine", location: "Washington DC / Northern VA", cost_range: "$2,500 - $5,000", duration: "Half day", highlights: "4-year progressive assessment cycle. Relationship-driven care." },
                    { provider: "Atlantic Health Executive Health", location: "New Jersey", cost_range: "$3,000 - $5,000", duration: "Full day", highlights: "All-inclusive one-day program. Optional overnight at The Bernards Inn." }
                ],
                recommendation: "Offer executive physicals to your top 5-10 leaders annually. The ROI is clear: retention signal, early detection, and key person protection."
            };
            const execHealthData = f.executive_health_program || defaultExecHealth;
            
            // Wellness Fund Deployment
            const defaultWFD = {
                headline: "Strategic Wellness Fund Deployment",
                key_message: "This doesn't cost you anything newâ€”strategic redeployment of existing budget.",
                allocations: [
                    { finding: "Mental Health Activation", allocation: isSelfFunded ? `$${Math.round(displayWellnessFund * 0.30).toLocaleString()}` : "EAP Enhancement", roi_projection: "3:1 ROI within 18 months", pct: "30%" },
                    { finding: "Cancer Screening Push", allocation: isSelfFunded ? `$${Math.round(displayWellnessFund * 0.25).toLocaleString()}` : "Carrier Wellness", roi_projection: "Early detection saves $50K+ per case", pct: "25%" },
                    { finding: "Diabetes Prevention", allocation: isSelfFunded ? `$${Math.round(displayWellnessFund * 0.25).toLocaleString()}` : "Carrier Programs", roi_projection: "58% risk reduction proven", pct: "25%" },
                    { finding: "Musculoskeletal / Other", allocation: isSelfFunded ? `$${Math.round(displayWellnessFund * 0.20).toLocaleString()}` : "Existing Benefits", roi_projection: "Reduce surgery rates 30%", pct: "20%" }
                ]
            };
            const wfdData = wfd.allocations ? wfd : defaultWFD;
            
            // Cost Mitigation Strategies
            const defaultCostMit = {
                headline: "Cost Mitigation Strategies",
                intro: "Evidence-based strategies to reduce healthcare spend while maintaining quality.",
                strategies: [
                    { strategy: "Tobacco Surcharge", typical_savings: "$4,000/year per smoker", complexity: "LOW", compliance_notes: "Up to 50% premium allowed under ACA. Must offer cessation program.", recommended_for: "All" },
                    { strategy: "Spousal Surcharge", typical_savings: "15-30% spousal enrollment reduction", complexity: "MEDIUM", compliance_notes: "$50-150/month if spouse has other coverage available.", recommended_for: "All" },
                    { strategy: "Dependent Audit", typical_savings: "3-8% dependent removal", complexity: "LOW", compliance_notes: "Removes ineligible dependents. $3-7K savings per removal.", recommended_for: "All" },
                    { strategy: "Telehealth Expansion", typical_savings: "$15.65 PMPM", complexity: "LOW", compliance_notes: "Reduces ER visits. Employee-friendly.", recommended_for: "All" },
                    { strategy: "Reference-Based Pricing", typical_savings: "15-30% on facility costs", complexity: "HIGH", compliance_notes: "Pay % of Medicare vs negotiated rates. Balance billing risk.", recommended_for: "Self-Funded" },
                    { strategy: "PBM Carve-Out", typical_savings: "10-15% on Rx spend", complexity: "MEDIUM", compliance_notes: "73% of employers moving this direction. Requires transparency.", recommended_for: "Self-Funded" }
                ],
                priority_ranking: [
                    { rank: 1, strategy: "Dependent Audit", reason: "Low effort, immediate savings" },
                    { rank: 2, strategy: "Telehealth Expansion", reason: "Employee-friendly, quick wins" },
                    { rank: 3, strategy: "Tobacco Surcharge", reason: "Proven savings if compliant" }
                ]
            };
            const costMitData = costMit.strategies ? costMit : defaultCostMit;
            
            // Enhanced Data Insights
            const defaultEnhancedInsights = [
                { insight_number: 1, category: "High-Cost Claimants", finding: "Top 5% of claimants drive 50% of costs", demographic_connection: "Concentrated in Gen X (45-55) with multiple chronic conditions", action: "Implement care management outreach", estimated_impact: "$150K-300K annual savings" },
                { insight_number: 2, category: "Rx Utilization", finding: "GLP-1 utilization growing 40% YoY", demographic_connection: "Millennials and Gen X primary users", action: "Add prior auth + lifestyle program requirement", estimated_impact: "Control 10-15% of Rx trend" }
            ];
            const enhancedInsightsData = enhancedInsights.length > 0 ? enhancedInsights : (hasEnhancedData ? defaultEnhancedInsights : []);

            return `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Workforce Health Intelligence | ${client?.company_name || 'Client'} | Canon Echo</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,sans-serif;background:#000;color:#fff}
.slide{min-height:100vh;padding:60px 80px;display:flex;flex-direction:column;justify-content:center;position:relative;overflow:hidden;page-break-after:always}
@media print{.slide{min-height:100vh;padding:40px 60px}}
.cover{background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);text-align:center}
.cover .company{font-size:14px;text-transform:uppercase;letter-spacing:4px;color:#64748b;margin-bottom:40px}
.cover h1{font-size:64px;font-weight:800;line-height:1.1;margin-bottom:30px}
.cover h1 span{color:#f59e0b}
.cover .subtitle{font-size:20px;color:#94a3b8;font-weight:300}
.cover .funding-badge{display:inline-block;margin-top:30px;padding:8px 20px;background:rgba(59,130,246,0.2);border:1px solid rgba(59,130,246,0.3);border-radius:20px;font-size:12px;color:#60a5fa}
.ai-tag{position:absolute;bottom:60px;left:50%;transform:translateX(-50%);background:rgba(245,158,11,0.15);border:1px solid rgba(245,158,11,0.3);padding:10px 24px;border-radius:30px;font-size:12px;letter-spacing:2px;color:#f59e0b}
.mission-slide{background:linear-gradient(135deg,#1e3a5f 0%,#1e40af 100%);text-align:center}
.mission-slide h2{font-size:14px;text-transform:uppercase;letter-spacing:4px;color:rgba(255,255,255,0.5);margin-bottom:40px}
.mission-slide .quote{font-size:36px;font-weight:300;line-height:1.5;max-width:900px;margin:0 auto 50px auto}
.mission-slide .quote em{color:#f59e0b;font-style:normal}
.mission-values{display:flex;justify-content:center;gap:60px;margin-top:50px}
.mission-value{text-align:center}
.mission-value .icon{font-size:32px;margin-bottom:16px}
.mission-value h3{font-size:16px;font-weight:600;margin-bottom:8px}
.mission-value p{font-size:14px;color:rgba(255,255,255,0.6);max-width:200px}
.section-slide{background:#0f172a}
.section-slide h2{font-size:14px;text-transform:uppercase;letter-spacing:4px;color:#64748b;margin-bottom:12px}
.section-slide .headline{font-size:42px;font-weight:800;margin-bottom:16px;line-height:1.2}
.section-slide .subhead{font-size:16px;color:#94a3b8;margin-bottom:40px;max-width:800px}
.census-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:24px;margin-bottom:40px}
.census-stat{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:32px;text-align:center}
.census-stat .value{font-size:56px;font-weight:800;margin-bottom:8px}
.census-stat .value.blue{color:#3b82f6}
.census-stat .value.amber{color:#f59e0b}
.census-stat .value.green{color:#22c55e}
.census-stat .label{font-size:14px;color:#94a3b8;font-weight:500}
.census-stat .detail{font-size:12px;color:#64748b;margin-top:8px}
.insight-box{background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:16px;padding:28px;display:flex;align-items:start;gap:20px}
.insight-box .icon{font-size:28px;flex-shrink:0}
.insight-box .content h4{font-size:16px;font-weight:600;margin-bottom:10px;color:#60a5fa}
.insight-box .content p{font-size:14px;color:#cbd5e1;line-height:1.6}
.funding-card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:20px;padding:36px;margin-bottom:24px}
.funding-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:28px}
.funding-type{font-size:22px;font-weight:700}
.funding-badge-green{padding:8px 16px;background:rgba(34,197,94,0.2);color:#4ade80;border-radius:20px;font-size:12px;font-weight:600}
.funding-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}
.fund-box{background:rgba(255,255,255,0.03);border-radius:16px;padding:24px;text-align:center}
.fund-box .fund-amount{font-size:32px;font-weight:700;color:#4ade80;margin-bottom:10px}
.fund-box .fund-label{font-size:14px;color:#94a3b8;margin-bottom:8px;font-weight:500}
.fund-box .fund-desc{font-size:12px;color:#64748b}
.gen-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px}
.gen-card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:24px}
.gen-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.gen-name{font-size:15px;font-weight:700}
.gen-pct{font-size:28px;font-weight:800}
.gen-card.genz .gen-pct{color:#a855f7}
.gen-card.millennial .gen-pct{color:#3b82f6}
.gen-card.genx .gen-pct{color:#f59e0b}
.gen-card.boomer .gen-pct{color:#ef4444}
.gen-meta{font-size:11px;color:#64748b;margin-bottom:16px}
.gen-insight{background:rgba(255,255,255,0.03);border-radius:10px;padding:14px;margin-bottom:10px}
.gen-insight .insight-stat{font-size:22px;font-weight:700;color:#f59e0b;margin-bottom:6px}
.gen-insight .insight-text{font-size:11px;color:#94a3b8;line-height:1.5}
.cancer-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:40px}
.cancer-card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:28px;text-align:center}
.cancer-card .type{font-size:16px;font-weight:700;margin-bottom:20px;color:#f59e0b}
.cancer-card .survival{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:10px}
.cancer-card .survival .early{font-size:36px;font-weight:800;color:#22c55e}
.cancer-card .survival .vs{font-size:14px;color:#64748b}
.cancer-card .survival .late{font-size:36px;font-weight:800;color:#ef4444}
.cancer-card .survival-label{font-size:11px;color:#64748b;margin-bottom:20px;text-transform:uppercase;letter-spacing:1px}
.cancer-card .eligible{font-size:14px;color:#94a3b8}
.cancer-card .eligible strong{color:#fff}
.confidence-table{width:100%;border-collapse:collapse;margin-bottom:24px}
.confidence-table th{text-align:left;padding:14px 18px;background:rgba(255,255,255,0.05);font-size:12px;text-transform:uppercase;letter-spacing:1px;color:#64748b}
.confidence-table td{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.05);font-size:13px}
.confidence-badge{padding:5px 12px;border-radius:12px;font-size:11px;font-weight:600}
.confidence-badge.actual{background:rgba(34,197,94,0.2);color:#4ade80}
.confidence-badge.modeled{background:rgba(245,158,11,0.2);color:#fbbf24}
.confidence-badge.requires_claims{background:rgba(239,68,68,0.2);color:#f87171}
.risk-slide{background:linear-gradient(135deg,#450a0a 0%,#7f1d1d 50%,#0f172a 100%)}
.risk-display{display:flex;align-items:center;gap:60px;margin-bottom:40px}
.risk-circle{width:200px;height:200px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;border:10px solid}
.risk-circle .score{font-size:72px;font-weight:800}
.risk-circle .label{font-size:12px;text-transform:uppercase;letter-spacing:2px;opacity:0.7}
.risk-details{flex:1}
.risk-item{background:rgba(255,255,255,0.05);border-radius:14px;padding:22px;margin-bottom:18px}
.risk-item h4{font-size:17px;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:10px}
.risk-item .severity{font-size:11px;padding:3px 10px;border-radius:10px;background:rgba(239,68,68,0.2);color:#f87171}
.risk-item p{font-size:13px;color:rgba(255,255,255,0.75);line-height:1.5}
.intel-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:24px}
.intel-card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:28px}
.intel-header{display:flex;justify-content:space-between;margin-bottom:14px}
.intel-category{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#f59e0b;font-weight:600}
.intel-card h4{font-size:16px;font-weight:600;margin-bottom:14px;line-height:1.3}
.intel-card .intel-impact{font-size:13px;color:#94a3b8;line-height:1.6;margin-bottom:18px}
.canon-position{font-size:13px;color:#60a5fa;padding:14px;background:rgba(59,130,246,0.1);border-radius:10px;line-height:1.5}
.action-slide{background:#0f172a}
.action-slide .headline{display:flex;align-items:center;gap:20px;font-size:38px;font-weight:800;margin-bottom:12px}
.action-number{width:56px;height:56px;background:#f59e0b;color:#000;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:24px;flex-shrink:0}
.action-slide .why-now{font-size:15px;color:#fbbf24;margin-bottom:8px;font-weight:500}
.action-slide .context{font-size:14px;color:#94a3b8;margin-bottom:32px}
.funding-source{display:inline-block;margin-left:16px;padding:5px 14px;background:rgba(74,222,128,0.2);color:#4ade80;border-radius:20px;font-size:11px;font-weight:600}
.action-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:24px}
.action-card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:28px}
.action-label{font-size:11px;text-transform:uppercase;letter-spacing:2px;color:#f59e0b;margin-bottom:14px;font-weight:600}
.action-card h3{font-size:17px;font-weight:700;margin-bottom:14px;line-height:1.3}
.action-detail{font-size:13px;color:rgba(255,255,255,0.7);line-height:1.6;margin-bottom:18px}
.action-metrics{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
.action-metric{background:rgba(255,255,255,0.05);border-radius:10px;padding:12px;text-align:center}
.metric-value{font-size:20px;font-weight:700;color:#4ade80}
.metric-label{font-size:9px;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:1px}
.vendor-tag{font-size:11px;color:#60a5fa;background:rgba(59,130,246,0.1);padding:10px 14px;border-radius:8px;line-height:1.5}
.concierge-slide{background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%)}
.concierge-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:24px;margin-bottom:36px}
.concierge-card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:28px}
.concierge-card .cat{font-size:12px;text-transform:uppercase;letter-spacing:1px;color:#f59e0b;margin-bottom:10px;font-weight:600}
.concierge-card .need{font-size:14px;color:#94a3b8;margin-bottom:20px;line-height:1.5}
.vendor-pick{background:rgba(255,255,255,0.03);border-radius:12px;padding:16px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.05)}
.vendor-pick .vendor-name{font-size:15px;font-weight:600;color:#fff;margin-bottom:4px}
.vendor-pick .vendor-positioning{font-size:11px;color:#f59e0b;margin-bottom:6px}
.vendor-pick .vendor-cost{font-size:12px;color:#4ade80;font-weight:500}
.next-steps-box{background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:16px;padding:28px}
.next-steps-box h4{font-size:16px;font-weight:600;color:#f59e0b;margin-bottom:20px}
.next-steps-box ol{padding-left:24px}
.next-steps-box li{font-size:14px;color:#e2e8f0;margin-bottom:12px;line-height:1.5}
.cta-slide{background:linear-gradient(135deg,#1e3a5f 0%,#1e40af 100%);text-align:center}
.cta-slide h2{font-size:48px;font-weight:800;margin-bottom:28px;line-height:1.2}
.cta-slide .urgency{font-size:16px;color:#fbbf24;margin-bottom:20px;font-weight:500}
.cta-slide p{font-size:18px;color:rgba(255,255,255,0.85);max-width:750px;margin:0 auto 20px auto;font-weight:300;line-height:1.6}
.cta-slide .human-reminder{font-size:15px;color:rgba(255,255,255,0.7);max-width:700px;margin:0 auto 30px auto;font-style:italic;line-height:1.6}
.cta-mission{font-size:16px;color:#f59e0b;margin-bottom:44px;font-weight:600}
.cta-buttons{display:flex;gap:24px;justify-content:center}
.cta-btn{padding:18px 40px;border-radius:10px;font-size:14px;font-weight:600;text-transform:uppercase;letter-spacing:1px;cursor:pointer;border:none;transition:all 0.2s}
.cta-btn.primary{background:#f59e0b;color:#000}
.cta-btn.secondary{background:transparent;border:2px solid rgba(255,255,255,0.3);color:#fff}
.page-num{position:absolute;bottom:30px;right:50px;font-size:12px;color:rgba(255,255,255,0.3)}
.data-date{position:absolute;bottom:30px;left:50px;font-size:10px;color:rgba(255,255,255,0.2)}

/* v4.1+ STYLES */
.zero-cost-banner{background:linear-gradient(135deg,rgba(34,197,94,0.2) 0%,rgba(16,185,129,0.1) 100%);border:2px solid rgba(34,197,94,0.4);border-radius:16px;padding:24px;text-align:center;margin-bottom:32px}
.zero-cost-banner .amount{font-size:48px;font-weight:800;color:#4ade80}
.zero-cost-banner .label{font-size:14px;color:#94a3b8;margin-top:8px}
.zero-cost-banner .emphasis{font-size:16px;color:#22c55e;font-weight:600;margin-top:12px}
.allocation-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:32px}
.allocation-card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:24px}
.allocation-card .finding-name{font-size:16px;font-weight:700;color:#fff;margin-bottom:12px}
.allocation-card .allocation-amount{font-size:24px;font-weight:700;color:#4ade80;margin-bottom:8px}
.allocation-card .roi{font-size:13px;color:#60a5fa;margin-bottom:6px}
.strategy-table{width:100%;border-collapse:collapse;margin-bottom:24px}
.strategy-table th{text-align:left;padding:14px 16px;background:rgba(255,255,255,0.05);font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#64748b}
.strategy-table td{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.05);font-size:13px}
.strategy-table .strategy-name{font-weight:600;color:#fff}
.strategy-table .savings{color:#4ade80;font-weight:500}
.complexity-badge{padding:4px 10px;border-radius:10px;font-size:10px;font-weight:600;text-transform:uppercase}
.complexity-badge.low{background:rgba(34,197,94,0.2);color:#4ade80}
.complexity-badge.medium{background:rgba(245,158,11,0.2);color:#fbbf24}
.complexity-badge.high{background:rgba(239,68,68,0.2);color:#f87171}
.priority-list{display:flex;gap:16px;margin-top:24px}
.priority-item{flex:1;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:12px;padding:16px;text-align:center}
.priority-item .rank{font-size:28px;font-weight:800;color:#f59e0b}
.priority-item .name{font-size:14px;font-weight:600;color:#fff;margin:8px 0}
.priority-item .reason{font-size:11px;color:#94a3b8}
.enhanced-insights-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px}
.enhanced-insight-card{background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.3);border-radius:16px;padding:24px}
.enhanced-insight-card .insight-num{font-size:12px;color:#a78bfa;font-weight:600;margin-bottom:8px}
.enhanced-insight-card .category{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#f59e0b;margin-bottom:12px}
.enhanced-insight-card .finding{font-size:16px;font-weight:600;color:#fff;margin-bottom:12px;line-height:1.4}
.enhanced-insight-card .demographic{font-size:13px;color:#94a3b8;margin-bottom:12px;line-height:1.5}
.enhanced-insight-card .action-box{background:rgba(59,130,246,0.1);border-radius:10px;padding:12px;margin-bottom:10px}
.enhanced-insight-card .action-box .action-text{font-size:12px;color:#60a5fa}
.enhanced-insight-card .impact{font-size:13px;color:#4ade80;font-weight:500}
.data-source-badge{display:inline-block;padding:6px 14px;background:rgba(139,92,246,0.2);border:1px solid rgba(139,92,246,0.4);border-radius:20px;font-size:11px;color:#a78bfa;margin-bottom:24px}

/* v4.3 STYLES */
.fund-comparison{display:grid;grid-template-columns:1fr 1fr;gap:32px;margin-bottom:32px}
.fund-comparison-box{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:32px;text-align:center}
.fund-comparison-box.client{border-color:rgba(59,130,246,0.4)}
.fund-comparison-box.benchmark{border-color:rgba(245,158,11,0.4)}
.fund-comparison-box .fund-label{font-size:12px;text-transform:uppercase;letter-spacing:2px;color:#64748b;margin-bottom:12px}
.fund-comparison-box .fund-value{font-size:42px;font-weight:800;margin-bottom:8px}
.fund-comparison-box.client .fund-value{color:#3b82f6}
.fund-comparison-box.benchmark .fund-value{color:#f59e0b}
.fund-comparison-box .fund-source{font-size:13px;color:#94a3b8}
.fund-comparison-box .fund-suggested{font-size:14px;color:#4ade80;margin-top:8px;font-weight:600}
.fund-status{text-align:center;padding:20px;border-radius:12px;margin-bottom:32px}
.fund-status.above,.fund-status.within{background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3)}
.fund-status.below{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3)}
.fund-status.unknown{background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3)}
.fund-status .status-icon{font-size:24px;margin-bottom:8px}
.fund-status .status-text{font-size:16px;font-weight:600}
.fund-status.above .status-text,.fund-status.within .status-text{color:#4ade80}
.fund-status.below .status-text{color:#f87171}
.fund-status.unknown .status-text{color:#60a5fa}

.exec-health-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:32px}
.exec-health-card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:24px}
.exec-health-card .provider{font-size:17px;font-weight:700;color:#fff;margin-bottom:8px}
.exec-health-card .location{font-size:12px;color:#64748b;margin-bottom:12px}
.exec-health-card .cost-duration{display:flex;justify-content:space-between;margin-bottom:12px}
.exec-health-card .cost{font-size:16px;font-weight:600;color:#4ade80}
.exec-health-card .duration{font-size:12px;color:#94a3b8;padding:4px 10px;background:rgba(255,255,255,0.05);border-radius:8px}
.exec-health-card .highlights{font-size:13px;color:#cbd5e1;line-height:1.5}
.exec-health-why{background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:12px;padding:20px;margin-bottom:24px}
.exec-health-why h4{font-size:14px;font-weight:600;color:#f59e0b;margin-bottom:10px}
.exec-health-why p{font-size:14px;color:#e2e8f0;line-height:1.6}
</style>
</head>
<body>

<!-- SLIDE 1: COVER -->
<div class="slide cover">
<div class="company">${client?.company_name || 'Client Company'}</div>
<h1>Workforce Health<br><span>Intelligence</span></h1>
<p class="subtitle">A data-driven view of your ${employees.toLocaleString()} employees + dependents</p>
<div class="funding-badge">${fundingType}</div>
<div class="ai-tag">âœ¦ AI-POWERED PATTERN ANALYSIS</div>
<div class="data-date">Analysis Date: ${today} | Data: Census + Benchmarks</div>
</div>

<!-- SLIDE 2: MISSION -->
<div class="slide mission-slide">
<h2>Before We Begin</h2>
<div class="quote">"Behind every data point is a <em>person</em>â€”someone's parent,<br>someone's partner, someone who deserves to know<br>what we can see before it's too late to act."</div>
<div class="mission-values">
<div class="mission-value"><div class="icon">ðŸ‘ï¸</div><h3>See Earlier</h3><p>Patterns emerge in data long before symptoms appear</p></div>
<div class="mission-value"><div class="icon">ðŸ¤</div><h3>Act Together</h3><p>Insights mean nothing without a path forward</p></div>
<div class="mission-value"><div class="icon">â¤ï¸</div><h3>Human First</h3><p>Putting the Human back in Human Capital</p></div>
</div>
<div class="page-num">01</div>
</div>

<!-- SLIDE 3: CENSUS PROFILE -->
<div class="slide section-slide">
<h2>Your Workforce at a Glance</h2>
<div class="headline">What the Census Reveals</div>
<div class="subhead">Before we see a single claim, your demographic data tells a powerful story</div>
<div class="census-grid">
<div class="census-stat"><div class="value blue">${employees.toLocaleString()}</div><div class="label">Enrolled Employees</div><div class="detail">+ estimated ${dependents.toLocaleString()} dependents</div></div>
<div class="census-stat"><div class="value amber">${totalLives.toLocaleString()}</div><div class="label">Total Covered Lives</div><div class="detail">Your plan's full population</div></div>
<div class="census-stat"><div class="value green">${avgAge}</div><div class="label">Average Age</div><div class="detail">${avgAge > 42 ? 'Older than' : avgAge < 42 ? 'Younger than' : 'At'} industry avg (42)</div></div>
</div>
<div class="insight-box"><div class="icon">ðŸ’¡</div><div class="content"><h4>Key Census Insight</h4><p>${cp.key_insight || f.executive_summary || `Your workforce demographics reveal important patterns. With an average age of ${avgAge} and ${employees} employees, your population has specific health considerations that should guide benefits strategy.`}</p></div></div>
<div class="page-num">02</div>
</div>

${hasEnhancedData ? `
<!-- SLIDE: ENHANCED DATA INSIGHTS -->
<div class="slide section-slide">
<h2>Data-Driven Insights</h2>
<div class="headline">What Your Claims Data Reveals</div>
<div class="data-source-badge">ðŸ“Š Analysis includes: ${hasClaimsData ? 'Claims' : ''}${hasClaimsData && hasRxData ? ' + ' : ''}${hasRxData ? 'Rx' : ''}${(hasClaimsData || hasRxData) && hasUtilizationData ? ' + ' : ''}${hasUtilizationData ? 'Utilization' : ''}</div>
<div class="subhead">Top insights from your actual data</div>
<div class="enhanced-insights-grid">
${enhancedInsightsData.slice(0,4).map((ins, i) => `
<div class="enhanced-insight-card">
<div class="insight-num">INSIGHT #${ins.insight_number || i+1}</div>
<div class="category">${ins.category || 'Insight'}</div>
<div class="finding">${ins.finding || 'Finding'}</div>
<div class="demographic">ðŸ“ ${ins.demographic_connection || 'Across population'}</div>
<div class="action-box"><div class="action-text">âžœ ${ins.action || 'Take action'}</div></div>
<div class="impact">ðŸ’° ${ins.estimated_impact || 'TBD'}</div>
</div>
`).join('')}
</div>
<div class="page-num">03</div>
</div>
` : ''}

<!-- SLIDE: FUNDING TYPE -->
<div class="slide section-slide">
<h2>Your Plan Structure</h2>
<div class="headline">${fundingType}: ${isFullyInsured ? 'Working Within Your Structure' : isSelfFunded ? 'Maximum Flexibility' : 'Moderate Flexibility'}</div>
<div class="funding-card">
<div class="funding-header"><div class="funding-type">${isFullyInsured ? 'Available Carrier Resources' : 'Available Funds'}</div><div class="funding-badge-green">${isFullyInsured ? 'Carrier Programs' : 'High Flexibility'}</div></div>
${isFullyInsured ? `
<div class="funding-grid">
<div class="fund-box"><div class="fund-amount">Carrier</div><div class="fund-label">Wellness Credits</div><div class="fund-desc">Programs from your carrier</div></div>
<div class="fund-box"><div class="fund-amount">EAP</div><div class="fund-label">Included</div><div class="fund-desc">Employee Assistance</div></div>
<div class="fund-box"><div class="fund-amount">Engagement</div><div class="fund-label">Focus Area</div><div class="fund-desc">Maximize existing benefits</div></div>
</div>
` : `
<div class="funding-grid">
<div class="fund-box"><div class="fund-amount">${hasClientFund ? '$' + clientWellnessFund.toLocaleString() : wellnessTier.display}</div><div class="fund-label">Wellness Fund</div><div class="fund-desc">${hasClientFund ? 'Client Provided' : 'Suggested Range'}</div></div>
<div class="fund-box"><div class="fund-amount">$${Math.round(innovationFund).toLocaleString()}</div><div class="fund-label">Innovation Fund</div><div class="fund-desc">Pilot programs</div></div>
<div class="fund-box"><div class="fund-amount">$${Math.round(potentialSavings).toLocaleString()}</div><div class="fund-label">Potential Savings</div><div class="fund-desc">ROI opportunity</div></div>
</div>
`}
</div>
<div class="page-num">${hasEnhancedData ? '04' : '03'}</div>
</div>

<!-- SLIDE: GENERATIONAL OVERVIEW -->
<div class="slide section-slide">
<h2>Your Workforce Profile</h2>
<div class="headline">Four Generations. Different Risks. One Strategy.</div>
<div class="gen-grid">
<div class="gen-card genz"><div class="gen-header"><div class="gen-name">Gen Z</div><div class="gen-pct">${cleanPct(genZ.percentage || 15)}%</div></div><div class="gen-meta">~${genZ.count || Math.round(employees * 0.15)} employees | Ages 18-27</div>${(genZ.health_stats || [{stat:'42%',insight:'Report anxiety/depression'},{stat:'67%',insight:'No established PCP'}]).slice(0,2).map(s => `<div class="gen-insight"><div class="insight-stat">${s.stat || ''}</div><div class="insight-text">${s.insight || ''}</div></div>`).join('')}</div>
<div class="gen-card millennial"><div class="gen-header"><div class="gen-name">Millennials</div><div class="gen-pct">${cleanPct(mill.percentage || 25)}%</div></div><div class="gen-meta">~${mill.count || Math.round(employees * 0.25)} employees | Ages 28-43</div>${(mill.health_stats || [{stat:'38%',insight:'Already prediabetic'},{stat:'52%',insight:'Skip preventive care'}]).slice(0,2).map(s => `<div class="gen-insight"><div class="insight-stat">${s.stat || ''}</div><div class="insight-text">${s.insight || ''}</div></div>`).join('')}</div>
<div class="gen-card genx"><div class="gen-header"><div class="gen-name">Gen X</div><div class="gen-pct">${cleanPct(genX.percentage || 35)}%</div></div><div class="gen-meta">~${genX.count || Math.round(employees * 0.35)} employees | Ages 44-59</div>${(genX.health_stats || [{stat:'47%',insight:'Managing 2+ chronic conditions'},{stat:'28%',insight:'Overdue for cancer screening'}]).slice(0,2).map(s => `<div class="gen-insight"><div class="insight-stat">${s.stat || ''}</div><div class="insight-text">${s.insight || ''}</div></div>`).join('')}</div>
<div class="gen-card boomer"><div class="gen-header"><div class="gen-name">Boomers</div><div class="gen-pct">${cleanPct(boom.percentage || 25)}%</div></div><div class="gen-meta">~${boom.count || Math.round(employees * 0.25)} employees | Ages 60+</div>${(boom.health_stats || [{stat:'4.2',insight:'Average prescriptions'},{stat:'$47K',insight:'Annual spendâ€”40% influenceable'}]).slice(0,2).map(s => `<div class="gen-insight"><div class="insight-stat">${s.stat || ''}</div><div class="insight-text">${s.insight || ''}</div></div>`).join('')}</div>
</div>
<div class="page-num">${hasEnhancedData ? '05' : '04'}</div>
</div>

<!-- SLIDE: CANCER SCREENING -->
<div class="slide section-slide">
<h2>The Stakes Are Real</h2>
<div class="headline">${cs.headline || 'Early Detection Changes Everything'}</div>
<div class="subhead">${cs.urgency_statement || 'Your workforce has significant screening opportunities.'}</div>
<div class="cancer-grid">
${screenings.slice(0,4).map(s => `<div class="cancer-card"><div class="type">${s.type || 'Screening'}</div><div class="survival"><span class="early">${s.early_detection_survival || '90%'}</span><span class="vs">vs</span><span class="late">${s.late_detection_survival || '20%'}</span></div><div class="survival-label">5-year survival</div><div class="eligible"><strong>~${s.eligible_count || 'â€”'}</strong><br>${s.eligible_criteria || 'Eligible'}</div></div>`).join('')}
</div>
<div style="text-align:center;font-size:17px;color:rgba(255,255,255,0.9);padding:20px;background:rgba(255,255,255,0.03);border-radius:12px"><strong>Every screening is covered at 100%.</strong> The only barriers are awarenessâ€”and action.</div>
<div class="page-num">${hasEnhancedData ? '06' : '05'}</div>
</div>

<!-- SLIDE: CONFIDENCE TABLE -->
<div class="slide section-slide">
<h2>What We Know vs. What We're Estimating</h2>
<div class="headline">Transparency Builds Trust</div>
<table class="confidence-table">
<thead><tr><th>Metric</th><th>Value</th><th>Confidence</th><th>Source</th></tr></thead>
<tbody>
${confidenceData.map(c => `<tr><td>${c.metric || ''}</td><td>${c.value || ''}</td><td><span class="confidence-badge ${(c.confidence || '').toLowerCase().replace('_', '')}">${c.icon || ''} ${c.confidence === 'ACTUAL' ? 'Actual' : c.confidence === 'MODELED' ? 'Modeled' : 'Requires Claims'}</span></td><td>${c.source || ''}</td></tr>`).join('')}
</tbody>
</table>
<div class="page-num">${hasEnhancedData ? '07' : '06'}</div>
</div>

<!-- SLIDE: RISK ASSESSMENT -->
<div class="slide risk-slide">
<h2>Population Health Risk</h2>
<div class="headline" style="margin-bottom:44px;color:#fff">Risk Profile Assessment</div>
<div class="risk-display">
<div class="risk-circle" style="border-color:${riskColor}"><div class="score" style="color:${riskColor}">${riskScore}</div><div class="label">Risk Score</div></div>
<div class="risk-details">
<div class="risk-item"><h4>Category: ${ra.category || 'Moderate'} | Trend: ${ra.trend_indicator || 'Stable'}</h4><p>${ra.score_rationale || 'Population health risks identified from demographic analysis.'}</p></div>
${(ra.top_risks || [{risk:'Chronic Disease',severity:'High',affected:'Gen X and Boomers',why_matters:'Drives 60% of costs'}]).slice(0,2).map(r => `<div class="risk-item"><h4>${r.risk || 'Risk'} <span class="severity">${r.severity || 'Medium'}</span></h4><p><strong>${r.affected || 'Population'}</strong>: ${r.why_matters || 'Monitor closely.'}</p></div>`).join('')}
</div>
</div>
<div class="page-num">${hasEnhancedData ? '08' : '07'}</div>
</div>

<!-- SLIDE: INDUSTRY INTEL -->
<div class="slide section-slide">
<h2>Industry Intelligence</h2>
<div class="headline">What's Happening in Healthcare</div>
<div class="subhead">Our position on developments affecting your plan | Updated ${today}</div>
<div class="intel-grid">
${intelData.slice(0,4).map(i => `<div class="intel-card"><div class="intel-header"><span class="intel-category">${i.category}</span></div><h4>${i.headline}</h4><div class="intel-impact">${i.insight}</div><div class="canon-position"><strong>Our Position:</strong> ${i.canon_position}</div></div>`).join('')}
</div>
<div class="page-num">${hasEnhancedData ? '09' : '08'}</div>
</div>

<!-- SLIDE: COST MITIGATION -->
<div class="slide section-slide">
<h2>Cost Mitigation Strategies</h2>
<div class="headline">${costMitData.headline || 'Evidence-Based Savings'}</div>
<div class="subhead">${costMitData.intro || 'Proven strategies to reduce spend.'}</div>
<table class="strategy-table">
<thead><tr><th>Strategy</th><th>Typical Savings</th><th>Complexity</th><th>Notes</th></tr></thead>
<tbody>
${(costMitData.strategies || []).filter(s => s.recommended_for === 'All' || (isSelfFunded && s.recommended_for === 'Self-Funded')).slice(0,6).map(s => `
<tr>
<td class="strategy-name">${s.strategy || ''}</td>
<td class="savings">${s.typical_savings || ''}</td>
<td><span class="complexity-badge ${(s.complexity || 'medium').toLowerCase()}">${s.complexity || 'MEDIUM'}</span></td>
<td style="font-size:11px;color:#94a3b8">${s.compliance_notes || ''}</td>
</tr>
`).join('')}
</tbody>
</table>
<div class="priority-list">
${(costMitData.priority_ranking || []).slice(0,3).map(p => `
<div class="priority-item">
<div class="rank">#${p.rank || '?'}</div>
<div class="name">${p.strategy || ''}</div>
<div class="reason">${p.reason || ''}</div>
</div>
`).join('')}
</div>
<div class="page-num">${hasEnhancedData ? '10' : '09'}</div>
</div>

<!-- SLIDES: ACTION PLANS -->
${actionData.slice(0,3).map((action, idx) => `
<div class="slide action-slide">
<h2>Turning Insight Into Action</h2>
<div class="headline"><div class="action-number">${action.action_number || idx + 1}</div>${action.title || 'Action Plan'}</div>
<div class="why-now">${action.why_now || action.rationale || ''}</div>
<div class="context">Investment from: <span class="funding-source">${action.funding_source || 'Wellness Fund'}</span></div>
<div class="action-grid">
${(action.tactics || []).slice(0,3).map((t, i) => `<div class="action-card"><div class="action-label">Action ${t.letter || String.fromCharCode(65 + i)}</div><h3>${t.name || ''}</h3><div class="action-detail">${t.description || ''}</div><div class="action-metrics"><div class="action-metric"><div class="metric-value">${t.eligible_count || 'â€”'}</div><div class="metric-label">Eligible</div></div><div class="action-metric"><div class="metric-value">${t.estimated_cost || t.cost || 'â€”'}</div><div class="metric-label">Cost</div></div></div><div class="vendor-tag">ðŸ’¡ ${(t.vendor_recommendations || []).map(v => v.vendor || v).slice(0,2).join(', ') || 'Contact for recommendations'}</div></div>`).join('')}
</div>
<div class="page-num">${hasEnhancedData ? 11 + idx : 10 + idx}</div>
</div>
`).join('')}

<!-- SLIDE: WELLNESS FUND DEPLOYMENT -->
<div class="slide section-slide">
<h2>Strategic Fund Deployment</h2>
<div class="headline">${wfdData.headline || 'Putting Your Wellness Budget to Work'}</div>

${hasClientFund ? `
<div class="fund-comparison">
<div class="fund-comparison-box client">
<div class="fund-label">Your Wellness Fund</div>
<div class="fund-value">$${clientWellnessFund.toLocaleString()}</div>
<div class="fund-source">Client Provided</div>
</div>
<div class="fund-comparison-box benchmark">
<div class="fund-label">Suggested Range</div>
<div class="fund-value">${wellnessTier.display}</div>
<div class="fund-source">For ${employees} employees</div>
<div class="fund-suggested">Midpoint: ${wellnessTier.suggested}</div>
</div>
</div>
<div class="fund-status ${fundStatus}">
<div class="status-icon">${fundStatus === 'above' || fundStatus === 'within' ? 'âœ…' : 'âš ï¸'}</div>
<div class="status-text">${fundStatus === 'above' ? 'Your fund exceeds the suggested range â€” excellent' : fundStatus === 'within' ? 'Your fund is within range â€” well positioned' : 'Your fund is below range â€” consider increasing'}</div>
</div>
` : `
<div class="fund-comparison">
<div class="fund-comparison-box benchmark" style="grid-column: span 2;">
<div class="fund-label">Suggested Wellness Fund</div>
<div class="fund-value">${wellnessTier.display}</div>
<div class="fund-source">For ${employees} employees</div>
<div class="fund-suggested">Suggested Midpoint: ${wellnessTier.suggested}</div>
</div>
</div>
<div class="fund-status unknown">
<div class="status-icon">ðŸ’¡</div>
<div class="status-text">Confirm your actual fund with HR/Finance</div>
</div>
`}

<div class="zero-cost-banner">
<div class="amount">$0</div>
<div class="label">Net New Budget Required</div>
<div class="emphasis">${wfdData.key_message || "Strategic redeploymentâ€”not new spending."}</div>
</div>

<div class="allocation-grid">
${(wfdData.allocations || []).slice(0,4).map(a => `
<div class="allocation-card">
<div class="finding-name">${a.finding || ''} <span style="float:right;color:#64748b;font-size:12px">${a.pct || ''}</span></div>
<div class="allocation-amount">${a.allocation || ''}</div>
<div class="roi">ðŸ“ˆ ${a.roi_projection || ''}</div>
</div>
`).join('')}
</div>
<div class="page-num">${hasEnhancedData ? '14' : '13'}</div>
</div>

<!-- SLIDE: POPULATION HEALTH VENDORS -->
<div class="slide concierge-slide">
<h2>Population Health Solutions</h2>
<div class="headline" style="margin-bottom:12px">${vendorRecsData.headline || 'Vendor Recommendations'}</div>
<div class="subhead" style="margin-bottom:36px">${vendorRecsData.intro || 'Vendors for your entire population:'}</div>
<div class="concierge-grid">
${(vendorRecsData.priority_recommendations || []).slice(0,4).map(rec => `<div class="concierge-card"><div class="cat">${rec.category || ''}</div><div class="need">${rec.why_you_need_it || ''}</div>${(rec.top_picks || []).slice(0,2).map(v => `<div class="vendor-pick"><div class="vendor-name">${v.vendor || ''}</div><div class="vendor-positioning">${v.positioning || ''}</div><div class="vendor-cost">${v.cost_range || ''}</div></div>`).join('')}</div>`).join('')}
</div>
<div class="next-steps-box"><h4>Next Steps</h4><ol>${(vendorRecsData.next_steps || ['Schedule vendor calls', 'Request case studies', 'Pilot with 10-15%', 'Set baseline metrics']).map(s => `<li>${s}</li>`).join('')}</ol></div>
<div class="page-num">${hasEnhancedData ? '15' : '14'}</div>
</div>

<!-- SLIDE: EXECUTIVE HEALTH PROGRAM -->
<div class="slide section-slide">
<h2>C-Suite Protection</h2>
<div class="headline">${execHealthData.headline || 'Executive Health Programs'}</div>
<div class="subhead">${execHealthData.intro || 'Comprehensive physicals for your top leaders.'}</div>

<div class="exec-health-why">
<h4>Why This Matters</h4>
<p>${execHealthData.why_it_matters || 'Key person risk is real. Protecting executives with world-class preventive care is both a retention tool and fiduciary responsibility.'}</p>
</div>

<div class="exec-health-grid">
${(execHealthData.programs || []).slice(0,6).map(p => `
<div class="exec-health-card">
<div class="provider">${p.provider || ''}</div>
<div class="location">ðŸ“ ${p.location || ''}</div>
<div class="cost-duration">
<span class="cost">${p.cost_range || ''}</span>
<span class="duration">${p.duration || ''}</span>
</div>
<div class="highlights">${p.highlights || ''}</div>
</div>
`).join('')}
</div>

<div style="padding:18px;background:rgba(74,222,128,0.1);border:1px solid rgba(74,222,128,0.3);border-radius:12px;text-align:center">
<span style="font-size:14px;color:#4ade80"><strong>Recommendation:</strong> ${execHealthData.recommendation || 'Offer executive physicals to your top 5-10 leaders annually.'}</span>
</div>
<div class="page-num">${hasEnhancedData ? '16' : '15'}</div>
</div>

<!-- SLIDE: CTA -->
<div class="slide cta-slide">
<h2>${closing.headline || 'The Patterns Are Clear.<br>The Path Is Ready.'}</h2>
<p class="urgency">${closing.urgency || 'Every month of delay is another month where preventable conditions go undetected.'}</p>
<p>${closing.message || `Your census data has revealed specific opportunities. The question is not whether to actâ€”it's which actions to prioritize first.`}</p>
<p class="human-reminder">${closing.human_reminder || 'Behind every data point is a personâ€”someone\'s parent, someone\'s partner, someone\'s child.'}</p>
<p class="cta-mission">${closing.tagline || 'Putting the Human back in Human Capital.'}</p>
<div class="cta-buttons">
<button class="cta-btn primary">${closing.cta_primary || "Let's Build Your Action Plan"}</button>
<button class="cta-btn secondary">${closing.cta_secondary || 'Request Claims Analysis'}</button>
</div>
<div class="page-num">${hasEnhancedData ? '17' : '16'}</div>
</div>

</body>
</html>`;
        };
        
        // ============================================================
        // PPT EXPORT FUNCTION
        // ============================================================
        const generatePPT = (findings, client) => {
            const f = findings || {};
            const cp = f.census_profile || {};
            const employees = parseInt(cp.total_employees) || client?.employee_count || 200;
            const avgAge = cp.average_age || 42;
            const fundingType = f.funding_analysis?.type || client?.funding_type || 'Self-Funded';
            const today = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            const wellnessTier = getWellnessFundTier(employees);
            
            const pptx = new PptxGenJS();
            pptx.layout = 'LAYOUT_16x9';
            pptx.title = `Workforce Health Intelligence - ${client?.company_name || 'Client'}`;
            pptx.author = 'Canon Echo';
            
            // Color scheme
            const colors = {
                dark: '0F172A',
                amber: 'F59E0B',
                blue: '3B82F6',
                green: '22C55E',
                white: 'FFFFFF',
                gray: '94A3B8'
            };
            
            // SLIDE 1: Cover
            let slide = pptx.addSlide();
            slide.background = { color: colors.dark };
            slide.addText(client?.company_name || 'Client Company', { x: 0.5, y: 1.5, w: '100%', h: 0.5, fontSize: 14, color: colors.gray, align: 'center', fontFace: 'Arial' });
            slide.addText('Workforce Health', { x: 0.5, y: 2.5, w: '100%', h: 0.8, fontSize: 44, color: colors.white, bold: true, align: 'center', fontFace: 'Arial' });
            slide.addText('Intelligence', { x: 0.5, y: 3.2, w: '100%', h: 0.8, fontSize: 44, color: colors.amber, bold: true, align: 'center', fontFace: 'Arial' });
            slide.addText(`${employees.toLocaleString()} employees | ${fundingType}`, { x: 0.5, y: 4.2, w: '100%', h: 0.4, fontSize: 16, color: colors.gray, align: 'center', fontFace: 'Arial' });
            slide.addText(`Analysis Date: ${today}`, { x: 0.5, y: 4.8, w: '100%', h: 0.3, fontSize: 12, color: colors.gray, align: 'center', fontFace: 'Arial' });
            
            // SLIDE 2: Census
            slide = pptx.addSlide();
            slide.background = { color: colors.dark };
            slide.addText('Census Profile', { x: 0.5, y: 0.5, w: 9, h: 0.6, fontSize: 28, color: colors.white, bold: true, fontFace: 'Arial' });
            slide.addText(`${employees.toLocaleString()}`, { x: 0.5, y: 1.5, w: 3, h: 1, fontSize: 48, color: colors.blue, bold: true, align: 'center', fontFace: 'Arial' });
            slide.addText('Employees', { x: 0.5, y: 2.4, w: 3, h: 0.4, fontSize: 14, color: colors.gray, align: 'center', fontFace: 'Arial' });
            slide.addText(`${Math.round(employees * 2.4).toLocaleString()}`, { x: 3.5, y: 1.5, w: 3, h: 1, fontSize: 48, color: colors.amber, bold: true, align: 'center', fontFace: 'Arial' });
            slide.addText('Total Lives', { x: 3.5, y: 2.4, w: 3, h: 0.4, fontSize: 14, color: colors.gray, align: 'center', fontFace: 'Arial' });
            slide.addText(`${avgAge}`, { x: 6.5, y: 1.5, w: 3, h: 1, fontSize: 48, color: colors.green, bold: true, align: 'center', fontFace: 'Arial' });
            slide.addText('Average Age', { x: 6.5, y: 2.4, w: 3, h: 0.4, fontSize: 14, color: colors.gray, align: 'center', fontFace: 'Arial' });
            slide.addText(f.executive_summary || 'Your workforce demographics reveal important patterns.', { x: 0.5, y: 3.2, w: 9, h: 1.5, fontSize: 14, color: colors.gray, fontFace: 'Arial', valign: 'top' });
            
            // SLIDE 3: Wellness Fund
            slide = pptx.addSlide();
            slide.background = { color: colors.dark };
            slide.addText('Wellness Fund Analysis', { x: 0.5, y: 0.5, w: 9, h: 0.6, fontSize: 28, color: colors.white, bold: true, fontFace: 'Arial' });
            slide.addText(`Suggested: ${wellnessTier.suggested}`, { x: 0.5, y: 1.5, w: 4.5, h: 0.8, fontSize: 32, color: colors.amber, bold: true, align: 'center', fontFace: 'Arial' });
            slide.addText(`Range: ${wellnessTier.display}`, { x: 0.5, y: 2.3, w: 4.5, h: 0.5, fontSize: 16, color: colors.gray, align: 'center', fontFace: 'Arial' });
            slide.addText(`For ${employees} employees`, { x: 0.5, y: 2.8, w: 4.5, h: 0.4, fontSize: 12, color: colors.gray, align: 'center', fontFace: 'Arial' });
            if (client?.wellness_fund) {
                slide.addText(`Your Fund: $${client.wellness_fund.toLocaleString()}`, { x: 5, y: 1.5, w: 4.5, h: 0.8, fontSize: 32, color: colors.blue, bold: true, align: 'center', fontFace: 'Arial' });
                slide.addText('Client Provided', { x: 5, y: 2.3, w: 4.5, h: 0.5, fontSize: 16, color: colors.gray, align: 'center', fontFace: 'Arial' });
            }
            
            // SLIDE 4: Executive Health
            slide = pptx.addSlide();
            slide.background = { color: colors.dark };
            slide.addText('Executive Health Programs', { x: 0.5, y: 0.5, w: 9, h: 0.6, fontSize: 28, color: colors.white, bold: true, fontFace: 'Arial' });
            slide.addText('Comprehensive physicals for C-suite and key leaders', { x: 0.5, y: 1.1, w: 9, h: 0.4, fontSize: 14, color: colors.gray, fontFace: 'Arial' });
            const execPrograms = [
                { name: 'Mayo Clinic', cost: '$5,000-$10,000' },
                { name: 'Cleveland Clinic', cost: '$4,000-$8,000' },
                { name: 'Johns Hopkins', cost: '$3,500-$6,000' },
                { name: 'NYU Langone', cost: '$3,000-$6,000' },
                { name: 'Inova 360Â°', cost: '$2,500-$5,000' },
                { name: 'Atlantic Health', cost: '$3,000-$5,000' }
            ];
            execPrograms.forEach((p, i) => {
                const row = Math.floor(i / 2);
                const col = i % 2;
                slide.addText(p.name, { x: 0.5 + col * 4.75, y: 1.8 + row * 1.2, w: 4.5, h: 0.5, fontSize: 16, color: colors.white, bold: true, fontFace: 'Arial' });
                slide.addText(p.cost, { x: 0.5 + col * 4.75, y: 2.2 + row * 1.2, w: 4.5, h: 0.4, fontSize: 14, color: colors.green, fontFace: 'Arial' });
            });
            
            // SLIDE 5: Call to Action
            slide = pptx.addSlide();
            slide.background = { color: '1E40AF' };
            slide.addText('The Patterns Are Clear.', { x: 0.5, y: 2, w: 9, h: 0.8, fontSize: 36, color: colors.white, bold: true, align: 'center', fontFace: 'Arial' });
            slide.addText('The Path Is Ready.', { x: 0.5, y: 2.7, w: 9, h: 0.8, fontSize: 36, color: colors.white, bold: true, align: 'center', fontFace: 'Arial' });
            slide.addText('Putting the Human back in Human Capital.', { x: 0.5, y: 4, w: 9, h: 0.5, fontSize: 18, color: colors.amber, align: 'center', fontFace: 'Arial' });
            
            return pptx;
        };
        
        // Summary View Component
        const SummaryView = ({ findings }) => {
            const f = findings || {};
            const ra = f.risk_assessment || {};
            const costMit = f.cost_mitigation_strategies || {};
            
            return (
                <div className="space-y-4">
                    {f.executive_summary && <div className="bg-gradient-to-r from-blue-600/20 to-purple-600/20 border border-blue-500/30 rounded-xl p-4"><h4 className="text-sm font-semibold text-blue-400 uppercase tracking-wider mb-2">Executive Summary</h4><p className="text-white leading-relaxed">{f.executive_summary}</p></div>}
                    
                    {ra.overall_score && <div className="bg-slate-900/50 rounded-xl p-4"><h4 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3">Risk Assessment</h4><div className="flex items-center gap-6"><div className="text-center"><div className={`text-4xl font-bold ${ra.overall_score < 40 ? 'text-green-400' : ra.overall_score < 70 ? 'text-amber-400' : 'text-red-400'}`}>{ra.overall_score}</div><div className="text-slate-500 text-sm">Risk Score</div></div></div></div>}
                    
                    {f.action_plan?.length > 0 && <div className="bg-slate-900/50 rounded-xl p-4"><h4 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3">Action Plan</h4><div className="space-y-2">{f.action_plan.slice(0,3).map((a, i) => <div key={i} className="bg-slate-800/50 rounded-lg p-3"><div className="flex items-center gap-3"><span className="w-6 h-6 bg-amber-500 text-black rounded-full flex items-center justify-center text-xs font-bold">{a.action_number || i+1}</span><div><span className="text-white font-medium">{a.title}</span></div></div></div>)}</div></div>}
                </div>
            );
        };
        
        // Upload & Analyze Component with PDF + PPT Export
        const UploadAnalyze = ({ client, onComplete, onCancel }) => {
            const [dragOver, setDragOver] = useState(false);
            const [file, setFile] = useState(null);
            const [csvData, setCsvData] = useState(null);
            const [analyzing, setAnalyzing] = useState(false);
            const [results, setResults] = useState(null);
            const [error, setError] = useState(null);
            const [viewMode, setViewMode] = useState('summary');
            const [progress, setProgress] = useState('');
            const [exporting, setExporting] = useState(false);
            const fileInputRef = useRef(null);
            
            const processFile = (f) => {
                setFile(f); setError(null);
                const ext = f.name.split('.').pop().toLowerCase();
                if (ext === 'csv') { Papa.parse(f, { header: true, complete: (r) => setCsvData(r.data.filter(row => Object.values(row).some(v => v))), error: (e) => setError('Parse error: ' + e.message) }); }
                else if (['xlsx', 'xls'].includes(ext)) { const reader = new FileReader(); reader.onload = (e) => { try { const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' }); setCsvData(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: '' }).filter(row => Object.values(row).some(v => v))); } catch (err) { setError('Excel error: ' + err.message); } }; reader.readAsArrayBuffer(f); }
                else { setError('Unsupported file type. Please upload CSV or Excel.'); }
            };
            
            const runAnalysis = async () => {
                if (!csvData) return; 
                setAnalyzing(true); 
                setError(null);
                setProgress('Uploading census data...');
                
                try {
                    const csvString = Papa.unparse(csvData);
                    const { data: uploadData, error: uploadError } = await supabase.from('uploads').insert([{ client_id: client.id, file_name: file.name, file_type: file.type || 'text/csv', file_url: 'local', status: 'analyzing' }]).select().single();
                    if (uploadError) throw uploadError;
                    
                    setProgress('Running AI analysis (up to 60 seconds)...');
                    const response = await fetch('/api/analyze', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ censusData: csvString, companyName: client.company_name, employeeCount: client.employee_count, fundingType: client.funding_type, industry: client.industry, wellnessFund: client.wellness_fund }) });
                    if (!response.ok) throw new Error(`Analysis failed (${response.status})`);
                    const result = await response.json();
                    if (!result.success) throw new Error(result.message || 'Analysis failed');
                    
                    setProgress('Saving results...');
                    await supabase.from('uploads').update({ status: 'complete' }).eq('id', uploadData.id);
                    await supabase.from('analyses').insert([{ client_id: client.id, upload_id: uploadData.id, findings: result.findings, status: 'complete' }]);
                    setResults(result.findings);
                    setProgress('');
                } catch (err) { 
                    setError(err.message || 'Analysis failed'); 
                    setProgress('');
                } finally { 
                    setAnalyzing(false); 
                }
            };
            
            const downloadHTML = () => { 
                const html = generateFullReportHTML(results, client); 
                const blob = new Blob([html], { type: 'text/html' }); 
                const a = document.createElement('a'); 
                a.href = URL.createObjectURL(blob); 
                a.download = `${client.company_name.replace(/\s+/g, '_')}_Canon_Echo_Report.html`; 
                a.click(); 
            };
            
            const downloadPDF = async () => {
                setExporting(true);
                try {
                    const html = generateFullReportHTML(results, client);
                    const container = document.createElement('div');
                    container.innerHTML = html;
                    container.style.width = '1200px';
                    document.body.appendChild(container);
                    
                    const opt = {
                        margin: 0,
                        filename: `${client.company_name.replace(/\s+/g, '_')}_Canon_Echo_Report.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true },
                        jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' },
                        pagebreak: { mode: 'css', before: '.slide' }
                    };
                    
                    await html2pdf().set(opt).from(container).save();
                    document.body.removeChild(container);
                } catch (err) {
                    console.error('PDF export error:', err);
                    alert('PDF export failed. Try downloading HTML instead.');
                } finally {
                    setExporting(false);
                }
            };
            
            const downloadPPT = async () => {
                setExporting(true);
                try {
                    const pptx = generatePPT(results, client);
                    await pptx.writeFile({ fileName: `${client.company_name.replace(/\s+/g, '_')}_Canon_Echo_Report.pptx` });
                } catch (err) {
                    console.error('PPT export error:', err);
                    alert('PPT export failed.');
                } finally {
                    setExporting(false);
                }
            };
            
            const tier = getWellnessFundTier(client?.employee_count);
            
            return (
                <div className="space-y-4">
                    {!results ? (
                        <>
                            <div className={`drop-zone rounded-xl p-8 text-center cursor-pointer ${dragOver ? 'drag-over' : ''}`} 
                                onDragOver={(e) => { e.preventDefault(); setDragOver(true); }} 
                                onDragLeave={() => setDragOver(false)} 
                                onDrop={(e) => { e.preventDefault(); setDragOver(false); processFile(e.dataTransfer.files[0]); }} 
                                onClick={() => fileInputRef.current?.click()}>
                                <input ref={fileInputRef} type="file" accept=".csv,.xlsx,.xls" onChange={(e) => processFile(e.target.files[0])} className="hidden" />
                                <div className="text-slate-400 mb-3">{Icons.file}</div>
                                <p className="text-white font-medium mb-1">{file ? file.name : 'Drop census file here'}</p>
                                <p className="text-slate-500 text-sm">{file ? `${csvData?.length || 0} rows loaded` : 'CSV or Excel'}</p>
                            </div>
                            {client.wellness_fund ? (
                                <div className="bg-green-500/10 border border-green-500/30 rounded-xl p-3 text-green-400 text-sm">
                                    ðŸ’° Wellness Fund: ${client.wellness_fund.toLocaleString()} | Suggested: {tier.suggested} (Range: {tier.display})
                                </div>
                            ) : client.employee_count && (
                                <div className="bg-amber-500/10 border border-amber-500/30 rounded-xl p-3 text-amber-400 text-sm">
                                    ðŸ’¡ No fund entered. Suggested: {tier.suggested} (Range: {tier.display})
                                </div>
                            )}
                            {error && <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4 text-red-400 text-sm">{error}</div>}
                            {progress && <div className="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4 text-blue-400 text-sm flex items-center gap-3">{Icons.loader} {progress}</div>}
                            <div className="flex gap-3">
                                <button onClick={onCancel} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Cancel</button>
                                <button onClick={runAnalysis} disabled={!csvData || analyzing} className="flex-1 px-4 py-2.5 bg-blue-600 hover:bg-blue-500 disabled:bg-slate-600 disabled:cursor-not-allowed rounded-lg font-medium flex items-center justify-center gap-2">
                                    {analyzing ? <>{Icons.loader} Analyzing...</> : <>{Icons.sparkles} Run Analysis</>}
                                </button>
                            </div>
                        </>
                    ) : (
                        <div className="space-y-4">
                            <div className="flex items-center justify-between flex-wrap gap-2">
                                <div className="flex bg-slate-800 rounded-lg p-1">
                                    <button onClick={() => setViewMode('summary')} className={`px-4 py-2 rounded-md text-sm font-medium ${viewMode === 'summary' ? 'bg-blue-600 text-white' : 'text-slate-400'}`}>Summary</button>
                                    <button onClick={() => setViewMode('full')} className={`px-4 py-2 rounded-md text-sm font-medium ${viewMode === 'full' ? 'bg-blue-600 text-white' : 'text-slate-400'}`}>Full Report</button>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={downloadHTML} disabled={exporting} className="flex items-center gap-2 px-3 py-2 bg-green-600 hover:bg-green-500 rounded-lg text-sm font-medium">{Icons.download} HTML</button>
                                    <button onClick={downloadPDF} disabled={exporting} className="flex items-center gap-2 px-3 py-2 bg-red-600 hover:bg-red-500 rounded-lg text-sm font-medium">{exporting ? Icons.loader : Icons.pdf} PDF</button>
                                    <button onClick={downloadPPT} disabled={exporting} className="flex items-center gap-2 px-3 py-2 bg-orange-600 hover:bg-orange-500 rounded-lg text-sm font-medium">{exporting ? Icons.loader : Icons.ppt} PPT</button>
                                </div>
                            </div>
                            <div className="max-h-[60vh] overflow-y-auto">
                                {viewMode === 'summary' ? <SummaryView findings={results} /> : (
                                    <div className="bg-slate-900 rounded-xl p-6 text-center">
                                        <p className="text-white text-lg mb-4">Your complete executive report is ready!</p>
                                        <ul className="text-slate-300 text-sm text-left max-w-md mx-auto space-y-1">
                                            <li>âœ“ Cover + Mission</li>
                                            <li>âœ“ Census Profile</li>
                                            <li>âœ“ Funding Analysis</li>
                                            <li>âœ“ Generational Breakdown</li>
                                            <li>âœ“ Cancer Screening</li>
                                            <li>âœ“ Risk Assessment</li>
                                            <li>âœ“ Industry Intelligence</li>
                                            <li>âœ“ Cost Mitigation</li>
                                            <li>âœ“ 3 Action Plans</li>
                                            <li>âœ“ Wellness Fund Deployment</li>
                                            <li>âœ“ Population Health Vendors</li>
                                            <li>âœ“ Executive Health Programs</li>
                                            <li>âœ“ Call to Action</li>
                                        </ul>
                                        <p className="text-amber-400 text-sm mt-4">Download as HTML, PDF, or PPT above</p>
                                    </div>
                                )}
                            </div>
                            <button onClick={onComplete} className="w-full px-4 py-2.5 bg-green-600 hover:bg-green-500 rounded-lg font-medium">Done</button>
                        </div>
                    )}
                </div>
            );
        };
        
        // Analysis Detail Slide-over with Export buttons
        const AnalysisDetail = ({ analysis, client, onClose }) => {
            const f = analysis.findings || {};
            const [exporting, setExporting] = useState(false);
            
            const downloadHTML = () => { 
                const html = generateFullReportHTML(f, client); 
                const blob = new Blob([html], { type: 'text/html' }); 
                const a = document.createElement('a'); 
                a.href = URL.createObjectURL(blob); 
                a.download = `Canon_Echo_Report.html`; 
                a.click(); 
            };
            
            const downloadPPT = async () => {
                setExporting(true);
                try {
                    const pptx = generatePPT(f, client);
                    await pptx.writeFile({ fileName: `Canon_Echo_Report.pptx` });
                } catch (err) {
                    alert('PPT export failed.');
                } finally {
                    setExporting(false);
                }
            };
            
            return (
                <div className="fixed inset-0 z-50 flex"><div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative ml-auto w-full max-w-4xl bg-slate-850 border-l border-slate-700 h-full overflow-hidden flex flex-col animate-fade-in">
                        <div className="p-5 border-b border-slate-700 flex items-center justify-between">
                            <div><h2 className="text-xl font-bold text-white">Analysis Results</h2><p className="text-slate-400 text-sm">{new Date(analysis.created_at).toLocaleString()}</p></div>
                            <div className="flex items-center gap-2">
                                <button onClick={downloadHTML} className="flex items-center gap-2 px-3 py-2 bg-green-600 hover:bg-green-500 rounded-lg text-sm font-medium">{Icons.download} HTML</button>
                                <button onClick={downloadPPT} disabled={exporting} className="flex items-center gap-2 px-3 py-2 bg-orange-600 hover:bg-orange-500 rounded-lg text-sm font-medium">{exporting ? Icons.loader : Icons.ppt} PPT</button>
                                <button onClick={onClose} className="p-2 hover:bg-slate-700 rounded-lg">{Icons.close}</button>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-5"><SummaryView findings={f} /></div>
                    </div>
                </div>
            );
        };
        
        // Client Detail Slide-over
        const ClientDetail = ({ client, uploads, analyses, onClose, onUploadAnalyze }) => {
            const clientAnalyses = analyses.filter(a => a.client_id === client.id);
            const [selectedAnalysis, setSelectedAnalysis] = useState(null);
            const tier = getWellnessFundTier(client?.employee_count);
            
            return (
                <div className="fixed inset-0 z-50 flex"><div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative ml-auto w-full max-w-2xl bg-slate-850 border-l border-slate-700 h-full overflow-y-auto animate-fade-in">
                        <div className="sticky top-0 bg-slate-850 border-b border-slate-700 p-5 flex items-center justify-between"><div><h2 className="text-xl font-bold text-white">{client.company_name}</h2><p className="text-slate-400 text-sm">{client.industry || 'No industry'} â€¢ {client.funding_type || 'No funding type'}</p></div><button onClick={onClose} className="p-2 hover:bg-slate-700 rounded-lg">{Icons.close}</button></div>
                        <div className="p-5 space-y-6">
                            <button onClick={() => onUploadAnalyze(client)} className="w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 rounded-xl font-medium flex items-center justify-center gap-2">{Icons.sparkles} Upload Census & Run Analysis</button>
                            <div className="bg-slate-900/50 rounded-xl p-4"><h3 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3">Details</h3><div className="space-y-2"><div className="flex justify-between"><span className="text-slate-400">Contact</span><span className="text-white">{client.contact_name || 'â€”'}</span></div><div className="flex justify-between"><span className="text-slate-400">Email</span><span className="text-white">{client.contact_email || 'â€”'}</span></div><div className="flex justify-between"><span className="text-slate-400">Employees</span><span className="text-white">{client.employee_count?.toLocaleString() || 'â€”'}</span></div><div className="flex justify-between"><span className="text-slate-400">Wellness Fund</span><span className={client.wellness_fund ? 'text-green-400' : 'text-slate-500'}>{client.wellness_fund ? `$${client.wellness_fund.toLocaleString()}` : 'Not set'}</span></div><div className="flex justify-between"><span className="text-slate-400">Suggested</span><span className="text-amber-400">{tier.suggested} ({tier.display})</span></div></div></div>
                            <div><h3 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3">Analyses ({clientAnalyses.length})</h3>{clientAnalyses.length === 0 ? <div className="bg-slate-900/50 rounded-xl p-6 text-center text-slate-500">No analyses yet</div> : <div className="space-y-2">{clientAnalyses.map(a => <div key={a.id} className="bg-slate-900/50 rounded-xl p-4 flex items-center justify-between cursor-pointer hover:bg-slate-800/50" onClick={() => setSelectedAnalysis(a)}><div><p className="text-white font-medium">{a.findings?.executive_summary?.substring(0,50) || 'Analysis'}...</p><p className="text-slate-500 text-sm">{new Date(a.created_at).toLocaleDateString()}</p></div><div className="flex items-center gap-2"><StatusBadge status={a.status} />{Icons.eye}</div></div>)}</div>}</div>
                        </div>
                    </div>
                    {selectedAnalysis && <AnalysisDetail analysis={selectedAnalysis} client={client} onClose={() => setSelectedAnalysis(null)} />}
                </div>
            );
        };
        
        // Main App
        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [clients, setClients] = useState([]);
            const [uploads, setUploads] = useState([]);
            const [analyses, setAnalyses] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showAddClient, setShowAddClient] = useState(false);
            const [selectedClient, setSelectedClient] = useState(null);
            const [analyzeClient, setAnalyzeClient] = useState(null);
            const [selectedAnalysis, setSelectedAnalysis] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            
            const fetchData = useCallback(async () => { setLoading(true); try { const [c, u, a] = await Promise.all([supabase.from('clients').select('*').order('created_at', { ascending: false }), supabase.from('uploads').select('*').order('uploaded_at', { ascending: false }), supabase.from('analyses').select('*').order('created_at', { ascending: false })]); setClients(c.data || []); setUploads(u.data || []); setAnalyses(a.data || []); } catch (err) { console.error(err); } finally { setLoading(false); } }, []);
            useEffect(() => { fetchData(); }, [fetchData]);
            const handleAddClient = async (data) => { try { const { data: d, error: e } = await supabase.from('clients').insert([data]).select(); if (e) throw e; setClients([d[0], ...clients]); setShowAddClient(false); } catch (err) { alert('Error: ' + err.message); } };
            const handleDeleteClient = async (id) => { if (!confirm('Delete this client?')) return; try { await supabase.from('clients').delete().eq('id', id); setClients(clients.filter(c => c.id !== id)); } catch (err) { alert('Error: ' + err.message); } };
            const getClientById = (id) => clients.find(c => c.id === id);
            const filteredClients = clients.filter(c => c.company_name?.toLowerCase().includes(searchTerm.toLowerCase()));
            const stats = { totalClients: clients.length, activeClients: clients.filter(c => c.status === 'active').length, pendingUploads: uploads.filter(u => u.status === 'pending').length, completedAnalyses: analyses.filter(a => a.status === 'complete').length };
            
            return (
                <div className="min-h-screen flex">
                    <div className="w-64 bg-slate-850 border-r border-slate-700/50 flex flex-col">
                        <div className="p-5 border-b border-slate-700/50"><h1 className="text-xl font-bold text-white flex items-center gap-2"><span className="text-2xl">â—‰</span>Canon Echo</h1><p className="text-slate-500 text-sm mt-1">Workforce Health Intelligence</p></div>
                        <nav className="flex-1 p-3">{[{ id: 'dashboard', label: 'Dashboard', icon: Icons.dashboard }, { id: 'clients', label: 'Clients', icon: Icons.clients }, { id: 'uploads', label: 'Uploads', icon: Icons.uploads }, { id: 'analyses', label: 'Analyses', icon: Icons.analyses }].map(item => <button key={item.id} onClick={() => setActiveTab(item.id)} className={`w-full flex items-center gap-3 px-4 py-2.5 rounded-lg text-left mb-1 ${activeTab === item.id ? 'bg-blue-600/20 text-blue-400 border border-blue-500/30' : 'text-slate-400 hover:bg-slate-700/50'}`}>{item.icon}<span className="font-medium">{item.label}</span></button>)}</nav>
                        <div className="p-4 border-t border-slate-700/50"><div className="bg-slate-900/50 rounded-xl p-4 flex items-center gap-2"><div className="w-2 h-2 bg-green-500 rounded-full animate-pulse-subtle"></div><span className="text-sm text-slate-300">Canon Echo v4.3</span></div></div>
                    </div>
                    <div className="flex-1 overflow-auto">
                        <div className="sticky top-0 z-10 bg-slate-950/80 backdrop-blur-xl border-b border-slate-700/50 px-8 py-4 flex items-center justify-between"><h2 className="text-2xl font-bold text-white capitalize">{activeTab}</h2><div className="flex items-center gap-3"><button onClick={fetchData} className="p-2 text-slate-400 hover:text-white hover:bg-slate-700 rounded-lg">{Icons.refresh}</button>{activeTab === 'clients' && <button onClick={() => setShowAddClient(true)} className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg font-medium">{Icons.plus}Add Client</button>}</div></div>
                        <div className="p-8">
                            {loading ? <div className="text-center py-20 text-slate-500">Loading...</div> : (
                                <>
                                    {activeTab === 'dashboard' && <div className="space-y-8"><div className="grid grid-cols-4 gap-6"><StatCard title="Total Clients" value={stats.totalClients} icon={Icons.clients} color="bg-blue-500/20 text-blue-400" /><StatCard title="Active" value={stats.activeClients} icon={Icons.check} color="bg-green-500/20 text-green-400" /><StatCard title="Pending" value={stats.pendingUploads} icon={Icons.uploads} color="bg-amber-500/20 text-amber-400" /><StatCard title="Analyses" value={stats.completedAnalyses} icon={Icons.analyses} color="bg-purple-500/20 text-purple-400" /></div><div className="grid grid-cols-2 gap-6"><div className="bg-slate-850 border border-slate-700/50 rounded-xl"><div className="p-5 border-b border-slate-700/50"><h3 className="font-semibold text-white">Recent Clients</h3></div><div className="p-2">{clients.slice(0,5).map(c => <div key={c.id} className="p-3 hover:bg-slate-700/30 rounded-lg cursor-pointer flex items-center justify-between" onClick={() => setSelectedClient(c)}><p className="text-white font-medium">{c.company_name}</p><StatusBadge status={c.status} /></div>)}{clients.length === 0 && <p className="p-3 text-slate-500">No clients yet</p>}</div></div><div className="bg-slate-850 border border-slate-700/50 rounded-xl"><div className="p-5 border-b border-slate-700/50"><h3 className="font-semibold text-white">Recent Analyses</h3></div><div className="p-2">{analyses.slice(0,5).map(a => <div key={a.id} className="p-3 hover:bg-slate-700/30 rounded-lg cursor-pointer" onClick={() => setSelectedAnalysis(a)}><p className="text-white font-medium">{a.findings?.executive_summary?.substring(0,40) || 'Analysis'}...</p></div>)}{analyses.length === 0 && <p className="p-3 text-slate-500">No analyses yet</p>}</div></div></div></div>}
                                    {activeTab === 'clients' && <div className="space-y-6"><div className="relative"><div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-500">{Icons.search}</div><input type="text" placeholder="Search clients..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full bg-slate-850 border border-slate-700 rounded-xl pl-12 pr-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500" /></div><div className="bg-slate-850 border border-slate-700/50 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-slate-700/50"><th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">Company</th><th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">Industry</th><th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">Funding</th><th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">Wellness Fund</th><th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">Status</th><th className="text-right px-6 py-4 text-sm font-semibold text-slate-400">Actions</th></tr></thead><tbody>{filteredClients.map((c, i) => <tr key={c.id} className={`border-b border-slate-700/30 hover:bg-slate-700/20 cursor-pointer ${i % 2 ? 'bg-slate-900/20' : ''}`} onClick={() => setSelectedClient(c)}><td className="px-6 py-4 text-white font-medium">{c.company_name}</td><td className="px-6 py-4 text-slate-300">{c.industry || 'â€”'}</td><td className="px-6 py-4 text-slate-300">{c.funding_type || 'â€”'}</td><td className="px-6 py-4 text-slate-300">{c.wellness_fund ? <span className="text-green-400">${c.wellness_fund.toLocaleString()}</span> : <span className="text-slate-500">â€”</span>}</td><td className="px-6 py-4"><StatusBadge status={c.status} /></td><td className="px-6 py-4 text-right" onClick={e => e.stopPropagation()}><button className="p-2 text-slate-400 hover:text-blue-400" onClick={() => setAnalyzeClient(c)}>{Icons.sparkles}</button><button className="p-2 text-slate-400 hover:text-red-400" onClick={() => handleDeleteClient(c.id)}>{Icons.trash}</button></td></tr>)}{filteredClients.length === 0 && <tr><td colSpan="6" className="px-6 py-8 text-center text-slate-500">No clients found</td></tr>}</tbody></table></div></div>}
                                    {activeTab === 'uploads' && <div className="bg-slate-850 border border-slate-700/50 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-slate-700/50"><th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">File</th><th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">Date</th><th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">Status</th></tr></thead><tbody>{uploads.map((u, i) => <tr key={u.id} className={`border-b border-slate-700/30 ${i % 2 ? 'bg-slate-900/20' : ''}`}><td className="px-6 py-4 text-white">{u.file_name}</td><td className="px-6 py-4 text-slate-300 mono text-sm">{new Date(u.uploaded_at).toLocaleString()}</td><td className="px-6 py-4"><StatusBadge status={u.status} /></td></tr>)}{uploads.length === 0 && <tr><td colSpan="3" className="px-6 py-8 text-center text-slate-500">No uploads yet</td></tr>}</tbody></table></div>}
                                    {activeTab === 'analyses' && <div className="bg-slate-850 border border-slate-700/50 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-slate-700/50"><th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">Summary</th><th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">Date</th><th className="text-left px-6 py-4 text-sm font-semibold text-slate-400">Status</th></tr></thead><tbody>{analyses.map((a, i) => <tr key={a.id} className={`border-b border-slate-700/30 hover:bg-slate-700/20 cursor-pointer ${i % 2 ? 'bg-slate-900/20' : ''}`} onClick={() => setSelectedAnalysis(a)}><td className="px-6 py-4 text-white">{a.findings?.executive_summary?.substring(0,60) || 'Analysis'}...</td><td className="px-6 py-4 text-slate-300 mono text-sm">{new Date(a.created_at).toLocaleString()}</td><td className="px-6 py-4"><StatusBadge status={a.status} /></td></tr>)}{analyses.length === 0 && <tr><td colSpan="3" className="px-6 py-8 text-center text-slate-500">No analyses yet</td></tr>}</tbody></table></div>}
                                </>
                            )}
                        </div>
                    </div>
                    <Modal isOpen={showAddClient} onClose={() => setShowAddClient(false)} title="Add Client"><AddClientForm onSubmit={handleAddClient} onCancel={() => setShowAddClient(false)} /></Modal>
                    <Modal isOpen={!!analyzeClient} onClose={() => setAnalyzeClient(null)} title={`Analyze: ${analyzeClient?.company_name || ''}`} wide>{analyzeClient && <UploadAnalyze client={analyzeClient} onComplete={() => { setAnalyzeClient(null); fetchData(); }} onCancel={() => setAnalyzeClient(null)} />}</Modal>
                    {selectedClient && <ClientDetail client={selectedClient} uploads={uploads} analyses={analyses} onClose={() => setSelectedClient(null)} onUploadAnalyze={(c) => { setSelectedClient(null); setAnalyzeClient(c); }} />}
                    {selectedAnalysis && !selectedClient && <AnalysisDetail analysis={selectedAnalysis} client={getClientById(selectedAnalysis.client_id)} onClose={() => setSelectedAnalysis(null)} />}
                </div>
            );
        };
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
